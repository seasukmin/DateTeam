Tmap.Class=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d="function"==typeof c.initialize?c.initialize:function(){b.prototype.initialize.apply(this,arguments)};if(a>1){var e=[d,b].concat(Array.prototype.slice.call(arguments).slice(1,a-1),c);Tmap.inherit.apply(null,e)}else d.prototype=c;return d},Tmap.inherit=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c;var d,e,f;for(d=2,e=arguments.length;e>d;d++)f=arguments[d],"function"==typeof f&&(f=f.prototype),Tmap.Util.extend(a.prototype,f)},Tmap.Util=Tmap.Util||{},Tmap.Util.extend=function(a,b){if(a=a||{},b){for(var c in b){var d=b[c];void 0!==d&&(a[c]=d)}var e="function"==typeof window.Event&&b instanceof window.Event;!e&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&(a.toString=b.toString)}return a},Tmap.Util=Tmap.Util||{},Tmap.Util.getElement=function(){for(var a=[],b=0,c=arguments.length;c>b;b++){var d=arguments[b];if("string"==typeof d&&(d=document.getElementById(d)),1==arguments.length)return d;a.push(d)}return a},Tmap.Util.isElement=function(a){return!(!a||1!==a.nodeType)},Tmap.Util.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},Tmap.Util.removeItem=function(a,b){for(var c=a.length-1;c>=0;c--)a[c]==b&&a.splice(c,1);return a},Tmap.Util.indexOf=function(a,b){if("function"==typeof a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;d>c;c++)if(a[c]==b)return c;return-1},Tmap.Util.dotless=/\./g,Tmap.Util.modifyDOMElement=function(a,b,c,d,e,f,g,h){b&&(a.id=b.replace(Tmap.Util.dotless,"_")),c&&(a.style.left=c.x+"px",a.style.top=c.y+"px"),d&&(a.style.width=d.w+"px",a.style.height=d.h+"px"),e&&(a.style.position=e),f&&(a.style.border=f),g&&(a.style.overflow=g),parseFloat(h)>=0&&parseFloat(h)<1?(a.style.filter="alpha(opacity="+100*h+")",a.style.opacity=h):1==parseFloat(h)&&(a.style.filter="",a.style.opacity="")},Tmap.Util.createDiv=function(a,b,c,d,e,f,g,h){var i=document.createElement("div");return d&&(i.style.backgroundImage="url("+d+")"),a||(a=Tmap.Util.createUniqueID("TmapDiv")),e||(e="absolute"),Tmap.Util.modifyDOMElement(i,a,b,c,e,f,g,h),i},Tmap.Util.createImage=function(a,b,c,d,e,f,g,h){function i(){j.style.display="",Tmap.Event.stopObservingElement(j)}var j=document.createElement("img");return a||(a=Tmap.Util.createUniqueID("TmapDiv")),e||(e="relative"),Tmap.Util.modifyDOMElement(j,a,b,c,e,f,null,g),h&&(j.style.display="none",Tmap.Event.observe(j,"load",i),Tmap.Event.observe(j,"error",i)),j.style.alt=a,j.galleryImg="no",d&&(j.src=d),j},Tmap.IMAGE_RELOAD_ATTEMPTS=0,Tmap.Util.alphaHackNeeded=null,Tmap.Util.alphaHack=function(){if(null==Tmap.Util.alphaHackNeeded){var a=navigator.appVersion.split("MSIE"),b=parseFloat(a[1]),c=!1;try{c=!!document.body.filters}catch(d){}Tmap.Util.alphaHackNeeded=c&&b>=5.5&&7>b}return Tmap.Util.alphaHackNeeded},Tmap.Util.modifyAlphaImageDiv=function(a,b,c,d,e,f,g,h,i){Tmap.Util.modifyDOMElement(a,b,c,d,f,null,null,i);var j=a.childNodes[0];e&&(j.src=e),Tmap.Util.modifyDOMElement(j,a.id+"_innerImage",null,d,"relative",g),Tmap.Util.alphaHack()&&("none"!=a.style.display&&(a.style.display="inline-block"),null==h&&(h="scale"),a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+j.src+"', sizingMethod='"+h+"')",parseFloat(a.style.opacity)>=0&&parseFloat(a.style.opacity)<1&&(a.style.filter+=" alpha(opacity="+100*a.style.opacity+")"),j.style.filter="alpha(opacity=0)")},Tmap.Util.createAlphaImageDiv=function(a,b,c,d,e,f,g,h,i){var j=Tmap.Util.createDiv(),k=Tmap.Util.createImage(null,null,null,null,null,null,null,i);return k.className="olAlphaImg",j.appendChild(k),Tmap.Util.modifyAlphaImageDiv(j,a,b,c,d,e,f,g,h),j},Tmap.Util.upperCaseObject=function(a){var b={};for(var c in a)b[c.toUpperCase()]=a[c];return b},Tmap.Util.applyDefaults=function(a,b){a=a||{};var c="function"==typeof window.Event&&b instanceof window.Event;for(var d in b)(void 0===a[d]||!c&&b.hasOwnProperty&&b.hasOwnProperty(d)&&!a.hasOwnProperty(d))&&(a[d]=b[d]);return!c&&b&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&!a.hasOwnProperty("toString")&&(a.toString=b.toString),a},Tmap.Util.getParameterString=function(a){var b=[];for(var c in a){var d=a[c];if(null!=d&&"function"!=typeof d){var e;if("object"==typeof d&&d.constructor==Array){for(var f,g=[],h=0,i=d.length;i>h;h++)f=d[h],g.push(encodeURIComponent(null===f||void 0===f?"":f));e=g.join(",")}else e=encodeURIComponent(d);b.push(encodeURIComponent(c)+"="+e)}}return b.join("&")},Tmap.Util.urlAppend=function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=" "===d.pop()?b:d.length?"&"+b:"?"+b}return c},Tmap.Util.getImagesLocation=function(){return Tmap.ImgPath||Tmap._getScriptLocation()+"img/"},Tmap.Util.getImageLocation=function(a){return Tmap.Util.getImagesLocation()+a},Tmap.Util.Try=function(){for(var a=null,b=0,c=arguments.length;c>b;b++){var d=arguments[b];try{a=d();break}catch(e){}}return a},Tmap.Util.getXmlNodeValue=function(a){var b=null;return Tmap.Util.Try(function(){b=a.text,b||(b=a.textContent),b||(b=a.firstChild.nodeValue)},function(){b=a.textContent}),b},Tmap.Util.mouseLeft=function(a,b){for(var c=a.relatedTarget?a.relatedTarget:a.toElement;c!=b&&null!=c;)c=c.parentNode;return c!=b},Tmap.Util.DEFAULT_PRECISION=14,Tmap.Util.toFloat=function(a,b){return null==b&&(b=Tmap.Util.DEFAULT_PRECISION),"number"!=typeof a&&(a=parseFloat(a)),0===b?a:parseFloat(a.toPrecision(b))},Tmap.Util.rad=function(a){return a*Math.PI/180},Tmap.Util.deg=function(a){return 180*a/Math.PI},Tmap.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563},Tmap.Util.distVincenty=function(a,b){for(var c=Tmap.Util.VincentyConstants,d=c.a,e=c.b,f=c.f,g=Tmap.Util.rad(b.lon-a.lon),h=Math.atan((1-f)*Math.tan(Tmap.Util.rad(a.lat))),i=Math.atan((1-f)*Math.tan(Tmap.Util.rad(b.lat))),j=Math.sin(h),k=Math.cos(h),l=Math.sin(i),m=Math.cos(i),n=g,o=2*Math.PI,p=20;Math.abs(n-o)>1e-12&&--p>0;){var q=Math.sin(n),r=Math.cos(n),s=Math.sqrt(m*q*(m*q)+(k*l-j*m*r)*(k*l-j*m*r));if(0==s)return 0;var t=j*l+k*m*r,u=Math.atan2(s,t),v=Math.asin(k*m*q/s),w=Math.cos(v)*Math.cos(v),x=t-2*j*l/w,y=f/16*w*(4+f*(4-3*w));o=n,n=g+(1-y)*f*Math.sin(v)*(u+y*s*(x+y*t*(-1+2*x*x)))}if(0==p)return NaN;var z=w*(d*d-e*e)/(e*e),A=1+z/16384*(4096+z*(-768+z*(320-175*z))),B=z/1024*(256+z*(-128+z*(74-47*z))),C=B*s*(x+B/4*(t*(-1+2*x*x)-B/6*x*(-3+4*s*s)*(-3+4*x*x))),D=e*A*(u-C),E=D.toFixed(3)/1e3;return E},Tmap.Util.destinationVincenty=function(a,b,c){for(var d=Tmap.Util,e=d.VincentyConstants,f=e.a,g=e.b,h=e.f,i=a.lon,j=a.lat,k=c,l=d.rad(b),m=Math.sin(l),n=Math.cos(l),o=(1-h)*Math.tan(d.rad(j)),p=1/Math.sqrt(1+o*o),q=o*p,r=Math.atan2(o,n),s=p*m,t=1-s*s,u=t*(f*f-g*g)/(g*g),v=1+u/16384*(4096+u*(-768+u*(320-175*u))),w=u/1024*(256+u*(-128+u*(74-47*u))),x=k/(g*v),y=2*Math.PI;Math.abs(x-y)>1e-12;){var z=Math.cos(2*r+x),A=Math.sin(x),B=Math.cos(x),C=w*A*(z+w/4*(B*(-1+2*z*z)-w/6*z*(-3+4*A*A)*(-3+4*z*z)));y=x,x=k/(g*v)+C}var D=q*A-p*B*n,E=Math.atan2(q*B+p*A*n,(1-h)*Math.sqrt(s*s+D*D)),F=Math.atan2(A*m,p*B-q*A*n),G=h/16*t*(4+h*(4-3*t)),H=F-(1-G)*h*s*(x+G*A*(z+G*B*(-1+2*z*z)));Math.atan2(s,-D);return new Tmap.LonLat(i+d.deg(H),d.deg(E))},Tmap.Util.getParameters=function(a){a=null===a||void 0===a?window.location.href:a;var b="";if(Tmap.String.contains(a,"?")){var c=a.indexOf("?")+1,d=Tmap.String.contains(a,"#")?a.indexOf("#"):a.length;b=a.substring(c,d)}for(var e={},f=b.split(/[&;]/),g=0,h=f.length;h>g;++g){var i=f[g].split("=");if(i[0]){var j=i[0];try{j=decodeURIComponent(j)}catch(k){j=unescape(j)}var l=(i[1]||"").replace(/\+/g," ");try{l=decodeURIComponent(l)}catch(k){l=unescape(l)}l=l.split(","),1==l.length&&(l=l[0]),e[j]=l}}return e},Tmap.Util.lastSeqID=0,Tmap.Util.createUniqueID=function(a){return a=null==a?"id_":a.replace(Tmap.Util.dotless,"_"),Tmap.Util.lastSeqID+=1,a+Tmap.Util.lastSeqID},Tmap.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:39.37,km:39370,dd:4374754,yd:36},Tmap.INCHES_PER_UNIT["in"]=Tmap.INCHES_PER_UNIT.inches,Tmap.INCHES_PER_UNIT.degrees=Tmap.INCHES_PER_UNIT.dd,Tmap.INCHES_PER_UNIT.nmi=1852*Tmap.INCHES_PER_UNIT.m,Tmap.METERS_PER_INCH=.0254000508001016,Tmap.Util.extend(Tmap.INCHES_PER_UNIT,{Inch:Tmap.INCHES_PER_UNIT.inches,Meter:1/Tmap.METERS_PER_INCH,Foot:.3048006096012192/Tmap.METERS_PER_INCH,IFoot:.3048/Tmap.METERS_PER_INCH,ClarkeFoot:.3047972651151/Tmap.METERS_PER_INCH,SearsFoot:.30479947153867626/Tmap.METERS_PER_INCH,GoldCoastFoot:.3047997101815088/Tmap.METERS_PER_INCH,IInch:.0254/Tmap.METERS_PER_INCH,MicroInch:254e-7/Tmap.METERS_PER_INCH,Mil:2.54e-8/Tmap.METERS_PER_INCH,Centimeter:.01/Tmap.METERS_PER_INCH,Kilometer:1e3/Tmap.METERS_PER_INCH,Yard:.9144018288036576/Tmap.METERS_PER_INCH,SearsYard:.914398414616029/Tmap.METERS_PER_INCH,IndianYard:.9143985307444408/Tmap.METERS_PER_INCH,IndianYd37:.91439523/Tmap.METERS_PER_INCH,IndianYd62:.9143988/Tmap.METERS_PER_INCH,IndianYd75:.9143985/Tmap.METERS_PER_INCH,IndianFoot:.30479951/Tmap.METERS_PER_INCH,IndianFt37:.30479841/Tmap.METERS_PER_INCH,IndianFt62:.3047996/Tmap.METERS_PER_INCH,IndianFt75:.3047995/Tmap.METERS_PER_INCH,Mile:1609.3472186944373/Tmap.METERS_PER_INCH,IYard:.9144/Tmap.METERS_PER_INCH,IMile:1609.344/Tmap.METERS_PER_INCH,NautM:1852/Tmap.METERS_PER_INCH,"Lat-66":110943.31648893273/Tmap.METERS_PER_INCH,"Lat-83":110946.25736872235/Tmap.METERS_PER_INCH,Decimeter:.1/Tmap.METERS_PER_INCH,Millimeter:.001/Tmap.METERS_PER_INCH,Dekameter:10/Tmap.METERS_PER_INCH,Decameter:10/Tmap.METERS_PER_INCH,Hectometer:100/Tmap.METERS_PER_INCH,GermanMeter:1.0000135965/Tmap.METERS_PER_INCH,CaGrid:.999738/Tmap.METERS_PER_INCH,ClarkeChain:20.1166194976/Tmap.METERS_PER_INCH,GunterChain:20.11684023368047/Tmap.METERS_PER_INCH,BenoitChain:20.116782494375872/Tmap.METERS_PER_INCH,SearsChain:20.11676512155/Tmap.METERS_PER_INCH,ClarkeLink:.201166194976/Tmap.METERS_PER_INCH,GunterLink:.2011684023368047/Tmap.METERS_PER_INCH,BenoitLink:.20116782494375873/Tmap.METERS_PER_INCH,SearsLink:.2011676512155/Tmap.METERS_PER_INCH,Rod:5.02921005842012/Tmap.METERS_PER_INCH,IntnlChain:20.1168/Tmap.METERS_PER_INCH,IntnlLink:.201168/Tmap.METERS_PER_INCH,Perch:5.02921005842012/Tmap.METERS_PER_INCH,Pole:5.02921005842012/Tmap.METERS_PER_INCH,Furlong:201.1684023368046/Tmap.METERS_PER_INCH,Rood:3.778266898/Tmap.METERS_PER_INCH,CapeFoot:.3047972615/Tmap.METERS_PER_INCH,Brealey:375/Tmap.METERS_PER_INCH,ModAmFt:.304812252984506/Tmap.METERS_PER_INCH,Fathom:1.8288/Tmap.METERS_PER_INCH,"NautM-UK":1853.184/Tmap.METERS_PER_INCH,"50kilometers":5e4/Tmap.METERS_PER_INCH,"150kilometers":15e4/Tmap.METERS_PER_INCH}),Tmap.Util.extend(Tmap.INCHES_PER_UNIT,{mm:Tmap.INCHES_PER_UNIT.Meter/1e3,cm:Tmap.INCHES_PER_UNIT.Meter/100,dm:100*Tmap.INCHES_PER_UNIT.Meter,km:1e3*Tmap.INCHES_PER_UNIT.Meter,kmi:Tmap.INCHES_PER_UNIT.nmi,fath:Tmap.INCHES_PER_UNIT.Fathom,ch:Tmap.INCHES_PER_UNIT.IntnlChain,link:Tmap.INCHES_PER_UNIT.IntnlLink,"us-in":Tmap.INCHES_PER_UNIT.inches,"us-ft":Tmap.INCHES_PER_UNIT.Foot,"us-yd":Tmap.INCHES_PER_UNIT.Yard,"us-ch":Tmap.INCHES_PER_UNIT.GunterChain,"us-mi":Tmap.INCHES_PER_UNIT.Mile,"ind-yd":Tmap.INCHES_PER_UNIT.IndianYd37,"ind-ft":Tmap.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/Tmap.METERS_PER_INCH}),Tmap.DOTS_PER_INCH=72,Tmap.Util.normalizeScale=function(a){var b=a>1?1/a:a;return b},Tmap.Util.getResolutionFromScale=function(a,b){var c;if(a){null==b&&(b="degrees");var d=Tmap.Util.normalizeScale(a);c=1/(d*Tmap.INCHES_PER_UNIT[b]*Tmap.DOTS_PER_INCH)}return c},Tmap.Util.getScaleFromResolution=function(a,b){null==b&&(b="degrees");var c=a*Tmap.INCHES_PER_UNIT[b]*Tmap.DOTS_PER_INCH;return c},Tmap.Util.pagePosition=function(a){var b=[0,0],c=Tmap.Util.getViewportElement();if(!a||a==window||a==c)return b;var d,e=Tmap.IS_GECKO&&document.getBoxObjectFor&&"absolute"==Tmap.Element.getStyle(a,"position")&&(""==a.style.top||""==a.style.left),f=null;if(a.getBoundingClientRect){d=a.getBoundingClientRect();var g=window.pageYOffset||c.scrollTop,h=window.pageXOffset||c.scrollLeft;b[0]=d.left+h,b[1]=d.top+g}else if(document.getBoxObjectFor&&!e){d=document.getBoxObjectFor(a);var i=document.getBoxObjectFor(c);b[0]=d.screenX-i.screenX,b[1]=d.screenY-i.screenY}else{if(b[0]=a.offsetLeft,b[1]=a.offsetTop,f=a.offsetParent,f!=a)for(;f;)b[0]+=f.offsetLeft,b[1]+=f.offsetTop,f=f.offsetParent;var j=Tmap.BROWSER_NAME;for(("opera"==j||"safari"==j&&"absolute"==Tmap.Element.getStyle(a,"position"))&&(b[1]-=document.body.offsetTop),f=a.offsetParent;f&&f!=document.body;)b[0]-=f.scrollLeft,("opera"!=j||"TR"!=f.tagName)&&(b[1]-=f.scrollTop),f=f.offsetParent}return b},Tmap.Util.getViewportElement=function(){var a=arguments.callee.viewportElement;return void 0==a&&(a="msie"==Tmap.BROWSER_NAME&&"CSS1Compat"!=document.compatMode?document.body:document.documentElement,arguments.callee.viewportElement=a),a},Tmap.Util.isEquivalentUrl=function(a,b,c){c=c||{},Tmap.Util.applyDefaults(c,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0});var d=Tmap.Util.createUrlObject(a,c),e=Tmap.Util.createUrlObject(b,c);for(var f in d)if("args"!==f&&d[f]!=e[f])return!1;for(var f in d.args){if(d.args[f]!=e.args[f])return!1;delete e.args[f]}for(var f in e.args)return!1;return!0},Tmap.Util.createUrlObject=function(a,b){if(b=b||{},!/^\w+:\/\//.test(a)){var c=window.location,d=c.port?":"+c.port:"",e=c.protocol+"//"+c.host.split(":").shift()+d;if(0===a.indexOf("/"))a=e+a;else{var f=c.pathname.split("/");f.pop(),a=e+f.join("/")+"/"+a}}b.ignoreCase&&(a=a.toLowerCase());var g=document.createElement("a");g.href=a;var h={};h.host=g.host.split(":").shift(),h.protocol=g.protocol,b.ignorePort80?h.port="80"==g.port||"0"==g.port?"":g.port:h.port=""==g.port||"0"==g.port?"80":g.port,h.hash=b.ignoreHash||"#"===g.hash?"":g.hash;var i=g.search;if(!i){var j=a.indexOf("?");i=-1!=j?a.substr(j):""}return h.args=Tmap.Util.getParameters(i),h.pathname="/"==g.pathname.charAt(0)?g.pathname:"/"+g.pathname,h},Tmap.Util.removeTail=function(a){var b=null,c=a.indexOf("?"),d=a.indexOf("#");return b=-1==c?-1!=d?a.substr(0,d):a:-1!=d?a.substr(0,Math.min(c,d)):a.substr(0,c)},Tmap.IS_GECKO=function(){var a=navigator.userAgent.toLowerCase();return-1==a.indexOf("webkit")&&-1!=a.indexOf("gecko")}(),Tmap.CANVAS_SUPPORTED=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}(),Tmap.BROWSER_NAME=function(){var a="",b=navigator.userAgent.toLowerCase();return-1!=b.indexOf("opera")?a="opera":-1!=b.indexOf("msie")?a="msie":-1!=b.indexOf("safari")?a="safari":-1!=b.indexOf("mozilla")&&(a=-1!=b.indexOf("firefox")?"firefox":"mozilla"),a}(),Tmap.Util.getBrowserName=function(){return Tmap.BROWSER_NAME},Tmap.Util.getRenderedDimensions=function(a,b,c){var d,e,f=document.createElement("div");f.style.visibility="hidden";for(var g=c&&c.containerElement?c.containerElement:document.body,h=!1,i=null,j=g;j&&"body"!=j.tagName.toLowerCase();){var k=Tmap.Element.getStyle(j,"position");if("absolute"==k){h=!0;break}if(k&&"static"!=k)break;j=j.parentNode}!h||0!==g.clientHeight&&0!==g.clientWidth||(i=document.createElement("div"),i.style.visibility="hidden",i.style.position="absolute",i.style.overflow="visible",i.style.width=document.body.clientWidth+"px",i.style.height=document.body.clientHeight+"px",i.appendChild(f)),f.style.position="absolute",b&&(b.w?(d=b.w,f.style.width=d+"px"):b.h&&(e=b.h,f.style.height=e+"px")),c&&c.displayClass&&(f.className=c.displayClass);var l=document.createElement("div");if(l.innerHTML=a,l.style.overflow="visible",l.childNodes)for(var m=0,n=l.childNodes.length;n>m;m++)l.childNodes[m].style&&(l.childNodes[m].style.overflow="visible");return f.appendChild(l),i?g.appendChild(i):g.appendChild(f),d||(d=parseInt(l.scrollWidth),f.style.width=d+"px"),e||(e=parseInt(l.scrollHeight)),f.removeChild(l),i?(i.removeChild(f),g.removeChild(i)):g.removeChild(f),new Tmap.Size(d,e)},Tmap.Util.getScrollbarWidth=function(){var a=Tmap.Util._scrollbarWidth;if(null==a){var b=null,c=null,d=0,e=0;b=document.createElement("div"),b.style.position="absolute",b.style.top="-1000px",b.style.left="-1000px",b.style.width="100px",b.style.height="50px",b.style.overflow="hidden",c=document.createElement("div"),c.style.width="100%",c.style.height="200px",b.appendChild(c),document.body.appendChild(b),d=c.offsetWidth,b.style.overflow="scroll",e=c.offsetWidth,document.body.removeChild(document.body.lastChild),Tmap.Util._scrollbarWidth=d-e,a=Tmap.Util._scrollbarWidth}return a},Tmap.Util.getFormattedLonLat=function(a,b,c){c||(c="dms"),a=(a+540)%360-180;var d=Math.abs(a),e=Math.floor(d),f=(d-e)/(1/60),g=f;f=Math.floor(f);var h=(g-f)/(1/60);h=Math.round(10*h),h/=10,h>=60&&(h-=60,f+=1,f>=60&&(f-=60,e+=1)),10>e&&(e="0"+e);var i=e+"\xb0";return c.indexOf("dm")>=0&&(10>f&&(f="0"+f),i+=f+"'",c.indexOf("dms")>=0&&(10>h&&(h="0"+h),i+=h+'"')),i+="lon"==b?0>a?Tmap.i18n("W"):Tmap.i18n("E"):0>a?Tmap.i18n("S"):Tmap.i18n("N")},Tmap.Util=Tmap.Util||{},Tmap.Util.vendorPrefix=function(){"use strict";function a(a){return a?a.replace(/([A-Z])/g,function(a){return"-"+a.toLowerCase()}).replace(/^ms-/,"-ms-"):null}function b(b){if(void 0===g[b]){var c=b.replace(/(-[\s\S])/g,function(a){return a.charAt(1).toUpperCase()}),e=d(c);g[b]=a(e)}return g[b]}function c(a,b){if(void 0===h[b]){var c,d,f=0,g=e.length,i="undefined"!=typeof a.cssText;for(h[b]=null;g>f;f++)if(d=e[f],d?(i||(d=d.toLowerCase()),c=d+b.charAt(0).toUpperCase()+b.slice(1)):c=b,void 0!==a[c]){h[b]=c;break}}return h[b]}function d(a){return c(f,a)}var e=["","O","ms","Moz","Webkit"],f=document.createElement("div").style,g={},h={};return{css:b,js:c,style:d,cssCache:g,jsCache:h}}(),Tmap.Animation=function(a){function b(a,b,c){b=b>0?b:Number.POSITIVE_INFINITY;var d=++g,e=+new Date;return h[d]=function(){h[d]&&+new Date-e<=b?(a(),h[d]&&f(h[d],c)):delete h[d]},f(h[d],c),d}function c(a){delete h[a]}var d=Tmap.Util.vendorPrefix.js(a,"requestAnimationFrame"),e=!!d,f=function(){var b=a[d]||function(b,c){a.setTimeout(b,16)};return function(c,d){b.apply(a,[c,d])}}(),g=0,h={};return{isNative:e,requestFrame:f,start:b,stop:c}}(window),Tmap.String={startsWith:function(a,b){return 0==a.indexOf(b)},contains:function(a,b){return-1!=a.indexOf(b)},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(a){for(var b=a.split("-"),c=b[0],d=1,e=b.length;e>d;d++){var f=b[d];c+=f.charAt(0).toUpperCase()+f.substring(1)}return c},format:function(a,b,c){b||(b=window);var d=function(a,d){for(var e,f=d.split(/\.+/),g=0;g<f.length;g++)0==g&&(e=b),e=e[f[g]];return"function"==typeof e&&(e=c?e.apply(null,c):e()),"undefined"==typeof e?"undefined":e};return a.replace(Tmap.String.tokenRegEx,d)},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(a){return Tmap.String.numberRegEx.test(a)},numericIf:function(a,b){var c=a;return b===!0&&null!=a&&a.replace&&(a=a.replace(/^\s*|\s*$/g,"")),Tmap.String.isNumeric(a)?parseFloat(a):c}},Tmap.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(a,b){var c=0;return b>0&&(c=parseFloat(a.toPrecision(b))),c},format:function(a,b,c,d){b="undefined"!=typeof b?b:0,c="undefined"!=typeof c?c:Tmap.Number.thousandsSeparator,d="undefined"!=typeof d?d:Tmap.Number.decimalSeparator,null!=b&&(a=parseFloat(a.toFixed(b)));var e=a.toString().split(".");1==e.length&&null==b&&(b=0);var f=e[0];if(c)for(var g=/(-?[0-9]+)([0-9]{3})/;g.test(f);)f=f.replace(g,"$1"+c+"$2");var h;if(0==b)h=f;else{var i=e.length>1?e[1]:"0";null!=b&&(i+=new Array(b-i.length+1).join("0")),h=f+d+i}return h},zeroPad:function(a,b,c){for(var d=a.toString(c||10);d.length<b;)d="0"+d;return d}},Tmap.Function={bind:function(a,b){var c=Array.prototype.slice.apply(arguments,[2]);return function(){var d=c.concat(Array.prototype.slice.apply(arguments,[0]));return a.apply(b,d)}},bindAsEventListener:function(a,b){return function(c){return a.call(b,c||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}},Tmap.Array={filter:function(a,b,c){var d=[];if(Array.prototype.filter)d=a.filter(b,c);else{var e=a.length;if("function"!=typeof b)throw new TypeError;for(var f=0;e>f;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&&d.push(g)}}return d}},Tmap.Bounds=Tmap.Class({left:null,bottom:null,right:null,top:null,centerLonLat:null,initialize:function(a,b,c,d){Tmap.Util.isArray(a)&&(d=a[3],c=a[2],b=a[1],a=a[0]),null!=a&&(this.left=Tmap.Util.toFloat(a)),null!=b&&(this.bottom=Tmap.Util.toFloat(b)),null!=c&&(this.right=Tmap.Util.toFloat(c)),null!=d&&(this.top=Tmap.Util.toFloat(d))},clone:function(){return new Tmap.Bounds(this.left,this.bottom,this.right,this.top)},equals:function(a){var b=!1;return null!=a&&(b=this.left==a.left&&this.right==a.right&&this.top==a.top&&this.bottom==a.bottom),b},toString:function(){return[this.left,this.bottom,this.right,this.top].join(",")},toArray:function(a){return a===!0?[this.bottom,this.left,this.top,this.right]:[this.left,this.bottom,this.right,this.top]},toBBOX:function(a,b){null==a&&(a=6);var c=Math.pow(10,a),d=Math.round(this.left*c)/c,e=Math.round(this.bottom*c)/c,f=Math.round(this.right*c)/c,g=Math.round(this.top*c)/c;return b===!0?e+","+d+","+g+","+f:d+","+e+","+f+","+g},toGeometry:function(){return new Tmap.Geometry.Polygon([new Tmap.Geometry.LinearRing([new Tmap.Geometry.Point(this.left,this.bottom),new Tmap.Geometry.Point(this.right,this.bottom),new Tmap.Geometry.Point(this.right,this.top),new Tmap.Geometry.Point(this.left,this.top)])])},getWidth:function(){return this.right-this.left},getHeight:function(){return this.top-this.bottom},getSize:function(){return new Tmap.Size(this.getWidth(),this.getHeight())},getCenterPixel:function(){return new Tmap.Pixel((this.left+this.right)/2,(this.bottom+this.top)/2)},getCenterLonLat:function(){return this.centerLonLat||(this.centerLonLat=new Tmap.LonLat((this.left+this.right)/2,(this.bottom+this.top)/2)),this.centerLonLat},scale:function(a,b){null==b&&(b=this.getCenterLonLat());var c,d;"Tmap.LonLat"==b.CLASS_NAME?(c=b.lon,d=b.lat):(c=b.x,d=b.y);var e=(this.left-c)*a+c,f=(this.bottom-d)*a+d,g=(this.right-c)*a+c,h=(this.top-d)*a+d;return new Tmap.Bounds(e,f,g,h)},add:function(a,b){if(null==a||null==b)throw new TypeError("Bounds.add cannot receive null values");return new Tmap.Bounds(this.left+a,this.bottom+b,this.right+a,this.top+b)},extend:function(a){var b=null;if(a){switch(a.CLASS_NAME){case"Tmap.LonLat":b=new Tmap.Bounds(a.lon,a.lat,a.lon,a.lat);break;case"Tmap.Geometry.Point":b=new Tmap.Bounds(a.x,a.y,a.x,a.y);break;case"Tmap.Bounds":b=a}b&&(this.centerLonLat=null,(null==this.left||b.left<this.left)&&(this.left=b.left),(null==this.bottom||b.bottom<this.bottom)&&(this.bottom=b.bottom),(null==this.right||b.right>this.right)&&(this.right=b.right),(null==this.top||b.top>this.top)&&(this.top=b.top))}},containsLonLat:function(a,b){"boolean"==typeof b&&(b={inclusive:b}),b=b||{};var c=this.contains(a.lon,a.lat,b.inclusive),d=b.worldBounds;if(d&&!c){var e=d.getWidth(),f=(d.left+d.right)/2,g=Math.round((a.lon-f)/e);c=this.containsLonLat({lon:a.lon-g*e,lat:a.lat},{inclusive:b.inclusive})}return c},containsPixel:function(a,b){return this.contains(a.x,a.y,b)},contains:function(a,b,c){if(null==c&&(c=!0),null==a||null==b)return!1;a=Tmap.Util.toFloat(a),b=Tmap.Util.toFloat(b);var d=!1;return d=c?a>=this.left&&a<=this.right&&b>=this.bottom&&b<=this.top:a>this.left&&a<this.right&&b>this.bottom&&b<this.top},intersectsBounds:function(a,b){if("boolean"==typeof b&&(b={inclusive:b}),b=b||{},b.worldBounds){var c=this.wrapDateLine(b.worldBounds);a=a.wrapDateLine(b.worldBounds)}else c=this;null==b.inclusive&&(b.inclusive=!0);var d=!1,e=c.left==a.right||c.right==a.left||c.top==a.bottom||c.bottom==a.top;if(b.inclusive||!e){var f=a.bottom>=c.bottom&&a.bottom<=c.top||c.bottom>=a.bottom&&c.bottom<=a.top,g=a.top>=c.bottom&&a.top<=c.top||c.top>a.bottom&&c.top<a.top,h=a.left>=c.left&&a.left<=c.right||c.left>=a.left&&c.left<=a.right,i=a.right>=c.left&&a.right<=c.right||c.right>=a.left&&c.right<=a.right;d=(f||g)&&(h||i)}if(b.worldBounds&&!d){var j=b.worldBounds,k=j.getWidth(),l=!j.containsBounds(c),m=!j.containsBounds(a);l&&!m?(a=a.add(-k,0),d=c.intersectsBounds(a,{inclusive:b.inclusive})):m&&!l&&(c=c.add(-k,0),d=a.intersectsBounds(c,{inclusive:b.inclusive}))}return d},containsBounds:function(a,b,c){null==b&&(b=!1),null==c&&(c=!0);var d=this.contains(a.left,a.bottom,c),e=this.contains(a.right,a.bottom,c),f=this.contains(a.left,a.top,c),g=this.contains(a.right,a.top,c);return b?d||e||f||g:d&&e&&f&&g},determineQuadrant:function(a){var b="",c=this.getCenterLonLat();return b+=a.lat<c.lat?"b":"t",b+=a.lon<c.lon?"l":"r"},transform:function(a,b){this.centerLonLat=null;var c=Tmap.Projection.transform({x:this.left,y:this.bottom},a,b),d=Tmap.Projection.transform({x:this.right,y:this.bottom},a,b),e=Tmap.Projection.transform({x:this.left,y:this.top},a,b),f=Tmap.Projection.transform({x:this.right,y:this.top},a,b);return this.left=Math.min(c.x,e.x),this.bottom=Math.min(c.y,d.y),this.right=Math.max(d.x,f.x),this.top=Math.max(e.y,f.y),this},wrapDateLine:function(a,b){b=b||{};var c=b.leftTolerance||0,d=b.rightTolerance||0,e=this.clone();if(a){for(var f=a.getWidth();e.left<a.left&&e.right-d<=a.left;)e=e.add(f,0);for(;e.left+c>=a.right&&e.right>a.right;)e=e.add(-f,0);var g=e.left+c;g<a.right&&g>a.left&&e.right-d>a.right&&(e=e.add(-f,0))}return e},CLASS_NAME:"Tmap.Bounds"}),Tmap.Bounds.fromString=function(a,b){var c=a.split(",");return Tmap.Bounds.fromArray(c,b)},Tmap.Bounds.fromArray=function(a,b){return b===!0?new Tmap.Bounds(a[1],a[0],a[3],a[2]):new Tmap.Bounds(a[0],a[1],a[2],a[3])},Tmap.Bounds.fromSize=function(a){return new Tmap.Bounds(0,a.h,a.w,0)},Tmap.Bounds.oppositeQuadrant=function(a){var b="";return b+="t"==a.charAt(0)?"b":"t",b+="l"==a.charAt(1)?"r":"l"},Tmap.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:function(){return"toISOString"in Date.prototype?function(a){return a.toISOString()}:function(a){var b;return b=isNaN(a.getTime())?"Invalid Date":a.getUTCFullYear()+"-"+Tmap.Number.zeroPad(a.getUTCMonth()+1,2)+"-"+Tmap.Number.zeroPad(a.getUTCDate(),2)+"T"+Tmap.Number.zeroPad(a.getUTCHours(),2)+":"+Tmap.Number.zeroPad(a.getUTCMinutes(),2)+":"+Tmap.Number.zeroPad(a.getUTCSeconds(),2)+"."+Tmap.Number.zeroPad(a.getUTCMilliseconds(),3)+"Z"}}(),parse:function(a){var b,c=a.match(this.dateRegEx);if(c&&(c[1]||c[7])){var d=parseInt(c[1],10)||0,e=parseInt(c[2],10)-1||0,f=parseInt(c[3],10)||1;b=new Date(Date.UTC(d,e,f));var g=c[7];if(g){var h=parseInt(c[4],10),i=parseInt(c[5],10),j=parseFloat(c[6]),k=0|j,l=Math.round(1e3*(j-k));if(b.setUTCHours(h,i,k,l),"Z"!==g){var m=parseInt(g,10),n=parseInt(c[8],10)||0,o=-1e3*(60*(60*m)+60*n);b=new Date(b.getTime()+o)}}}else b=new Date("invalid");return b}},Tmap.Element={visible:function(a){return"none"!=Tmap.Util.getElement(a).style.display},toggle:function(){for(var a=0,b=arguments.length;b>a;a++){var c=Tmap.Util.getElement(arguments[a]),d=Tmap.Element.visible(c)?"none":"";c.style.display=d}},remove:function(a){a=Tmap.Util.getElement(a),a.parentNode.removeChild(a)},getHeight:function(a){return a=Tmap.Util.getElement(a),a.offsetHeight},hasClass:function(a,b){var c=a.className;return!!c&&new RegExp("(^|\\s)"+b+"(\\s|$)").test(c)},addClass:function(a,b){return Tmap.Element.hasClass(a,b)||(a.className+=(a.className?" ":"")+b),a},removeClass:function(a,b){var c=a.className;return c&&(a.className=Tmap.String.trim(c.replace(new RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))),a},toggleClass:function(a,b){return Tmap.Element.hasClass(a,b)?Tmap.Element.removeClass(a,b):Tmap.Element.addClass(a,b),a},getStyle:function(a,b){a=Tmap.Util.getElement(a);var c=null;if(a&&a.style){if(c=a.style[Tmap.String.camelize(b)],!c)if(document.defaultView&&document.defaultView.getComputedStyle){var d=document.defaultView.getComputedStyle(a,null);c=d?d.getPropertyValue(b):null}else a.currentStyle&&(c=a.currentStyle[Tmap.String.camelize(b)]);var e=["left","top","right","bottom"];window.opera&&-1!=Tmap.Util.indexOf(e,b)&&"static"==Tmap.Element.getStyle(a,"position")&&(c="auto")}return"auto"==c?null:c}},Tmap.LonLat=Tmap.Class({lon:0,lat:0,initialize:function(a,b){Tmap.Util.isArray(a)&&(b=a[1],a=a[0]),this.lon=Tmap.Util.toFloat(a),this.lat=Tmap.Util.toFloat(b)},toString:function(){return"lon="+this.lon+",lat="+this.lat},toShortString:function(){return this.lon+", "+this.lat},clone:function(){return new Tmap.LonLat(this.lon,this.lat)},add:function(a,b){if(null==a||null==b)throw new TypeError("LonLat.add cannot receive null values");return new Tmap.LonLat(this.lon+Tmap.Util.toFloat(a),this.lat+Tmap.Util.toFloat(b))},equals:function(a){var b=!1;return null!=a&&(b=this.lon==a.lon&&this.lat==a.lat||isNaN(this.lon)&&isNaN(this.lat)&&isNaN(a.lon)&&isNaN(a.lat)),b},transform:function(a,b){var c=Tmap.Projection.transform({x:this.lon,y:this.lat},a,b);return this.lon=c.x,this.lat=c.y,this},wrapDateLine:function(a){var b=this.clone();if(a){for(;b.lon<a.left;)b.lon+=a.getWidth();for(;b.lon>a.right;)b.lon-=a.getWidth()}return b},CLASS_NAME:"Tmap.LonLat"}),Tmap.LonLat.fromString=function(a){var b=a.split(",");return new Tmap.LonLat(b[0],b[1])},Tmap.LonLat.fromArray=function(a){var b=Tmap.Util.isArray(a),c=b&&a[0],d=b&&a[1];return new Tmap.LonLat(c,d)},Tmap.Pixel=Tmap.Class({x:0,y:0,initialize:function(a,b){this.x=parseFloat(a),this.y=parseFloat(b)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new Tmap.Pixel(this.x,this.y)},equals:function(a){var b=!1;return null!=a&&(b=this.x==a.x&&this.y==a.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(a.x)&&isNaN(a.y)),b},distanceTo:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},add:function(a,b){if(null==a||null==b)throw new TypeError("Pixel.add cannot receive null values");return new Tmap.Pixel(this.x+a,this.y+b)},offset:function(a){var b=this.clone();return a&&(b=this.add(a.x,a.y)),b},CLASS_NAME:"Tmap.Pixel"}),Tmap.Size=Tmap.Class({w:0,h:0,initialize:function(a,b){this.w=parseFloat(a),this.h=parseFloat(b)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new Tmap.Size(this.w,this.h)},equals:function(a){var b=!1;return null!=a&&(b=this.w==a.w&&this.h==a.h||isNaN(this.w)&&isNaN(this.h)&&isNaN(a.w)&&isNaN(a.h)),b},CLASS_NAME:"Tmap.Size"}),Tmap.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(a){alert(a)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"Tmap.Console"},function(){for(var a=document.getElementsByTagName("script"),b=0,c=a.length;c>b;++b)if(-1!=a[b].src.indexOf("firebug.js")&&console){Tmap.Util.extend(Tmap.Console,console);break}}(),Tmap.Tween=Tmap.Class({easing:null,begin:null,finish:null,duration:null,callbacks:null,time:null,minFrameRate:null,startTime:null,animationId:null,playing:!1,initialize:function(a){this.easing=a?a:Tmap.Easing.Expo.easeOut},start:function(a,b,c,d){this.playing=!0,this.begin=a,this.finish=b,this.duration=c,this.callbacks=d.callbacks,this.minFrameRate=d.minFrameRate||30,this.time=0,this.startTime=(new Date).getTime(),Tmap.Animation.stop(this.animationId),this.animationId=null,this.callbacks&&this.callbacks.start&&this.callbacks.start.call(this,this.begin),this.animationId=Tmap.Animation.start(Tmap.Function.bind(this.play,this))},stop:function(){this.playing&&(this.callbacks&&this.callbacks.done&&this.callbacks.done.call(this,this.finish),Tmap.Animation.stop(this.animationId),this.animationId=null,this.playing=!1)},play:function(){var a={};for(var b in this.begin){var c=this.begin[b],d=this.finish[b];if(null==c||null==d||isNaN(c)||isNaN(d))throw new TypeError("invalid value for Tween");var e=d-c;a[b]=this.easing.apply(this,[this.time,c,e,this.duration])}this.time++,this.callbacks&&this.callbacks.eachStep&&((new Date).getTime()-this.startTime)/this.time<=1e3/this.minFrameRate&&this.callbacks.eachStep.call(this,a),this.time>this.duration&&this.stop()},CLASS_NAME:"Tmap.Tween"}),Tmap.Easing={CLASS_NAME:"Tmap.Easing"},Tmap.Easing.Linear={easeIn:function(a,b,c,d){
return c*a/d+b},easeOut:function(a,b,c,d){return c*a/d+b},easeInOut:function(a,b,c,d){return c*a/d+b},CLASS_NAME:"Tmap.Easing.Linear"},Tmap.Easing.Expo={easeIn:function(a,b,c,d){return 0==a?b:c*Math.pow(2,10*(a/d-1))+b},easeOut:function(a,b,c,d){return a==d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},easeInOut:function(a,b,c,d){return 0==a?b:a==d?b+c:(a/=d/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},CLASS_NAME:"Tmap.Easing.Expo"},Tmap.Easing.Quad={easeIn:function(a,b,c,d){return c*(a/=d)*a+b},easeOut:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},easeInOut:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},CLASS_NAME:"Tmap.Easing.Quad"},Tmap.Kinetic=Tmap.Class({threshold:0,deceleration:.0035,nbPoints:100,delay:200,points:void 0,timerId:void 0,initialize:function(a){Tmap.Util.extend(this,a)},begin:function(){Tmap.Animation.stop(this.timerId),this.timerId=void 0,this.points=[]},update:function(a){this.points.unshift({xy:a,tick:(new Date).getTime()}),this.points.length>this.nbPoints&&this.points.pop()},end:function(a){for(var b,c,d=(new Date).getTime(),e=0,f=this.points.length;f>e&&(c=this.points[e],!(d-c.tick>this.delay));e++)b=c;if(b){var g=(new Date).getTime()-b.tick,h=Math.sqrt(Math.pow(a.x-b.xy.x,2)+Math.pow(a.y-b.xy.y,2)),i=h/g;if(!(0==i||i<this.threshold)){var j=Math.asin((a.y-b.xy.y)/h);return b.xy.x<=a.x&&(j=Math.PI-j),{speed:i,theta:j}}}},move:function(a,b){var c=a.speed,d=Math.cos(a.theta),e=-Math.sin(a.theta),f=(new Date).getTime(),g=0,h=0,i=function(){if(null!=this.timerId){var a=(new Date).getTime()-f,i=-this.deceleration*Math.pow(a,2)/2+c*a,j=i*d,k=i*e,l={};l.end=!1;var m=-this.deceleration*a+c;0>=m&&(Tmap.Animation.stop(this.timerId),this.timerId=null,l.end=!0),l.x=j-g,l.y=k-h,g=j,h=k,b(l.x,l.y,l.end)}};this.timerId=Tmap.Animation.start(Tmap.Function.bind(i,this))},CLASS_NAME:"Tmap.Kinetic"}),Tmap.Console.warn("Tmap.Rico is deprecated"),Tmap.Rico=Tmap.Rico||{},Tmap.Rico.Corner={round:function(a,b){a=Tmap.Util.getElement(a),this._setOptions(b);var c=this.options.color;"fromElement"==this.options.color&&(c=this._background(a));var d=this.options.bgColor;"fromParent"==this.options.bgColor&&(d=this._background(a.offsetParent)),this._roundCornersImpl(a,c,d)},changeColor:function(a,b){a.style.backgroundColor=b;for(var c=a.parentNode.getElementsByTagName("span"),d=0;d<c.length;d++)c[d].style.backgroundColor=b},changeOpacity:function(a,b){var c=b,d="alpha(opacity="+100*b+")";a.style.opacity=c,a.style.filter=d;for(var e=a.parentNode.getElementsByTagName("span"),f=0;f<e.length;f++)e[f].style.opacity=c,e[f].style.filter=d},reRound:function(a,b){var c=a.parentNode.childNodes[0],d=a.parentNode.childNodes[2];a.parentNode.removeChild(c),a.parentNode.removeChild(d),this.round(a.parentNode,b)},_roundCornersImpl:function(a,b,c){this.options.border&&this._renderBorder(a,c),this._isTopRounded()&&this._roundTopCorners(a,b,c),this._isBottomRounded()&&this._roundBottomCorners(a,b,c)},_renderBorder:function(a,b){var c="1px solid "+this._borderColor(b),d="border-left: "+c,e="border-right: "+c,f="style='"+d+";"+e+"'";a.innerHTML="<div "+f+">"+a.innerHTML+"</div>"},_roundTopCorners:function(a,b,c){for(var d=this._createCorner(c),e=0;e<this.options.numSlices;e++)d.appendChild(this._createCornerSlice(b,c,e,"top"));a.style.paddingTop=0,a.insertBefore(d,a.firstChild)},_roundBottomCorners:function(a,b,c){for(var d=this._createCorner(c),e=this.options.numSlices-1;e>=0;e--)d.appendChild(this._createCornerSlice(b,c,e,"bottom"));a.style.paddingBottom=0,a.appendChild(d)},_createCorner:function(a){var b=document.createElement("div");return b.style.backgroundColor=this._isTransparent()?"transparent":a,b},_createCornerSlice:function(a,b,c,d){var e=document.createElement("span"),f=e.style;f.backgroundColor=a,f.display="block",f.height="1px",f.overflow="hidden",f.fontSize="1px";var g=this._borderColor(a,b);return this.options.border&&0==c?(f.borderTopStyle="solid",f.borderTopWidth="1px",f.borderLeftWidth="0px",f.borderRightWidth="0px",f.borderBottomWidth="0px",f.height="0px",f.borderColor=g):g&&(f.borderColor=g,f.borderStyle="solid",f.borderWidth="0px 1px"),this.options.compact||c!=this.options.numSlices-1||(f.height="2px"),this._setMargin(e,c,d),this._setBorder(e,c,d),e},_setOptions:function(a){this.options={corners:"all",color:"fromElement",bgColor:"fromParent",blend:!0,border:!1,compact:!1},Tmap.Util.extend(this.options,a||{}),this.options.numSlices=this.options.compact?2:4,this._isTransparent()&&(this.options.blend=!1)},_whichSideTop:function(){return this._hasString(this.options.corners,"all","top")?"":this.options.corners.indexOf("tl")>=0&&this.options.corners.indexOf("tr")>=0?"":this.options.corners.indexOf("tl")>=0?"left":this.options.corners.indexOf("tr")>=0?"right":""},_whichSideBottom:function(){return this._hasString(this.options.corners,"all","bottom")?"":this.options.corners.indexOf("bl")>=0&&this.options.corners.indexOf("br")>=0?"":this.options.corners.indexOf("bl")>=0?"left":this.options.corners.indexOf("br")>=0?"right":""},_borderColor:function(a,b){return"transparent"==a?b:this.options.border?this.options.border:this.options.blend?this._blend(b,a):""},_setMargin:function(a,b,c){var d=this._marginSize(b),e="top"==c?this._whichSideTop():this._whichSideBottom();"left"==e?(a.style.marginLeft=d+"px",a.style.marginRight="0px"):"right"==e?(a.style.marginRight=d+"px",a.style.marginLeft="0px"):(a.style.marginLeft=d+"px",a.style.marginRight=d+"px")},_setBorder:function(a,b,c){var d=this._borderSize(b),e="top"==c?this._whichSideTop():this._whichSideBottom();"left"==e?(a.style.borderLeftWidth=d+"px",a.style.borderRightWidth="0px"):"right"==e?(a.style.borderRightWidth=d+"px",a.style.borderLeftWidth="0px"):(a.style.borderLeftWidth=d+"px",a.style.borderRightWidth=d+"px"),0!=this.options.border&&(a.style.borderLeftWidth=d+"px",a.style.borderRightWidth=d+"px")},_marginSize:function(a){if(this._isTransparent())return 0;var b=[5,3,2,1],c=[3,2,1,0],d=[2,1],e=[1,0];return this.options.compact&&this.options.blend?e[a]:this.options.compact?d[a]:this.options.blend?c[a]:b[a]},_borderSize:function(a){var b=[5,3,2,1],c=[2,1,1,1],d=[1,0],e=[0,2,0,0];return this.options.compact&&(this.options.blend||this._isTransparent())?1:this.options.compact?d[a]:this.options.blend?c[a]:this.options.border?e[a]:this._isTransparent()?b[a]:0},_hasString:function(a){for(var b=1;b<arguments.length;b++)if(a.indexOf(arguments[b])>=0)return!0;return!1},_blend:function(a,b){var c=Tmap.Rico.Color.createFromHex(a);return c.blend(Tmap.Rico.Color.createFromHex(b)),c},_background:function(a){try{return Tmap.Rico.Color.createColorFromBackground(a).asHex()}catch(b){return"#ffffff"}},_isTransparent:function(){return"transparent"==this.options.color},_isTopRounded:function(){return this._hasString(this.options.corners,"all","top","tl","tr")},_isBottomRounded:function(){return this._hasString(this.options.corners,"all","bottom","bl","br")},_hasSingleTextChild:function(a){return 1==a.childNodes.length&&3==a.childNodes[0].nodeType}},Tmap.Console.warn("Tmap.Rico is deprecated"),Tmap.Rico=Tmap.Rico||{},Tmap.Rico.Color=Tmap.Class({initialize:function(a,b,c){this.rgb={r:a,g:b,b:c}},setRed:function(a){this.rgb.r=a},setGreen:function(a){this.rgb.g=a},setBlue:function(a){this.rgb.b=a},setHue:function(a){var b=this.asHSB();b.h=a,this.rgb=Tmap.Rico.Color.HSBtoRGB(b.h,b.s,b.b)},setSaturation:function(a){var b=this.asHSB();b.s=a,this.rgb=Tmap.Rico.Color.HSBtoRGB(b.h,b.s,b.b)},setBrightness:function(a){var b=this.asHSB();b.b=a,this.rgb=Tmap.Rico.Color.HSBtoRGB(b.h,b.s,b.b)},darken:function(a){var b=this.asHSB();this.rgb=Tmap.Rico.Color.HSBtoRGB(b.h,b.s,Math.max(b.b-a,0))},brighten:function(a){var b=this.asHSB();this.rgb=Tmap.Rico.Color.HSBtoRGB(b.h,b.s,Math.min(b.b+a,1))},blend:function(a){this.rgb.r=Math.floor((this.rgb.r+a.rgb.r)/2),this.rgb.g=Math.floor((this.rgb.g+a.rgb.g)/2),this.rgb.b=Math.floor((this.rgb.b+a.rgb.b)/2)},isBright:function(){this.asHSB();return this.asHSB().b>.5},isDark:function(){return!this.isBright()},asRGB:function(){return"rgb("+this.rgb.r+","+this.rgb.g+","+this.rgb.b+")"},asHex:function(){return"#"+this.rgb.r.toColorPart()+this.rgb.g.toColorPart()+this.rgb.b.toColorPart()},asHSB:function(){return Tmap.Rico.Color.RGBtoHSB(this.rgb.r,this.rgb.g,this.rgb.b)},toString:function(){return this.asHex()}}),Tmap.Rico.Color.createFromHex=function(a){if(4==a.length)for(var b=a,a="#",c=1;4>c;c++)a+=b.charAt(c)+b.charAt(c);0==a.indexOf("#")&&(a=a.substring(1));var d=a.substring(0,2),e=a.substring(2,4),f=a.substring(4,6);return new Tmap.Rico.Color(parseInt(d,16),parseInt(e,16),parseInt(f,16))},Tmap.Rico.Color.createColorFromBackground=function(a){var b=Tmap.Element.getStyle(Tmap.Util.getElement(a),"backgroundColor");if("transparent"==b&&a.parentNode)return Tmap.Rico.Color.createColorFromBackground(a.parentNode);if(null==b)return new Tmap.Rico.Color(255,255,255);if(0==b.indexOf("rgb(")){var c=b.substring(4,b.length-1),d=c.split(",");return new Tmap.Rico.Color(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]))}return 0==b.indexOf("#")?Tmap.Rico.Color.createFromHex(b):new Tmap.Rico.Color(255,255,255)},Tmap.Rico.Color.HSBtoRGB=function(a,b,c){var d=0,e=0,f=0;if(0==b)d=parseInt(255*c+.5),e=d,f=d;else{var g=6*(a-Math.floor(a)),h=g-Math.floor(g),i=c*(1-b),j=c*(1-b*h),k=c*(1-b*(1-h));switch(parseInt(g)){case 0:d=255*c+.5,e=255*k+.5,f=255*i+.5;break;case 1:d=255*j+.5,e=255*c+.5,f=255*i+.5;break;case 2:d=255*i+.5,e=255*c+.5,f=255*k+.5;break;case 3:d=255*i+.5,e=255*j+.5,f=255*c+.5;break;case 4:d=255*k+.5,e=255*i+.5,f=255*c+.5;break;case 5:d=255*c+.5,e=255*i+.5,f=255*j+.5}}return{r:parseInt(d),g:parseInt(e),b:parseInt(f)}},Tmap.Rico.Color.RGBtoHSB=function(a,b,c){var d,e,f,g=a>b?a:b;c>g&&(g=c);var h=b>a?a:b;if(h>c&&(h=c),f=g/255,e=0!=g?(g-h)/g:0,0==e)d=0;else{var i=(g-a)/(g-h),j=(g-b)/(g-h),k=(g-c)/(g-h);d=a==g?k-j:b==g?2+i-k:4+j-i,d/=6,0>d&&(d+=1)}return{h:d,s:e,b:f}},Tmap.Event={observers:!1,KEY_SPACE:32,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(a){return a.target||a.srcElement},isSingleTouch:function(a){return a.touches&&1==a.touches.length},isMultiTouch:function(a){return a.touches&&a.touches.length>1},isLeftClick:function(a){return a.which&&1==a.which||a.button&&1==a.button},isRightClick:function(a){return a.which&&3==a.which||a.button&&2==a.button},stop:function(a,b,c){b||Tmap.Event.preventDefault(a),c&&(a.stopPropagation?a.stopPropagation():a.cancelBubble=!0)},preventDefault:function(event){wDelta=event.wheelDelta;if(event.preventDefault){if(!wDelta){event.preventDefault()}}else{event.returnValue=false}},findElement:function(a,b){for(var c=Tmap.Event.element(a);c.parentNode&&(!c.tagName||c.tagName.toUpperCase()!=b.toUpperCase());)c=c.parentNode;return c},observe:function(a,b,c,d){var e=Tmap.Util.getElement(a);if(d=d||!1,"keypress"==b&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||e.attachEvent)&&(b="keydown"),this.observers||(this.observers={}),!e._eventCacheID){var f="eventCacheID_";e.id&&(f=e.id+"_"+f),e._eventCacheID=Tmap.Util.createUniqueID(f)}var g=e._eventCacheID;this.observers[g]||(this.observers[g]=[]),this.observers[g].push({element:e,name:b,observer:c,useCapture:d}),e.addEventListener?e.addEventListener(b,c,d):e.attachEvent&&e.attachEvent("on"+b,c)},stopObservingElement:function(a){var b=Tmap.Util.getElement(a),c=b._eventCacheID;this._removeElementObservers(Tmap.Event.observers[c])},_removeElementObservers:function(a){if(a)for(var b=a.length-1;b>=0;b--){var c=a[b];Tmap.Event.stopObserving.apply(this,[c.element,c.name,c.observer,c.useCapture])}},stopObserving:function(a,b,c,d){d=d||!1;var e=Tmap.Util.getElement(a),f=e._eventCacheID;"keypress"==b&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||e.detachEvent)&&(b="keydown");var g=!1,h=Tmap.Event.observers[f];if(h)for(var i=0;!g&&i<h.length;){var j=h[i];if(j.name==b&&j.observer==c&&j.useCapture==d){h.splice(i,1),0==h.length&&delete Tmap.Event.observers[f],g=!0;break}i++}return g&&(e.removeEventListener?e.removeEventListener(b,c,d):e&&e.detachEvent&&e.detachEvent("on"+b,c)),g},unloadCache:function(){if(Tmap.Event&&Tmap.Event.observers){for(var a in Tmap.Event.observers){var b=Tmap.Event.observers[a];Tmap.Event._removeElementObservers.apply(this,[b])}Tmap.Event.observers=!1}},CLASS_NAME:"Tmap.Event"},Tmap.Event.observe(window,"unload",Tmap.Event.unloadCache,!1),Tmap.Events=Tmap.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend","keydown"],listeners:null,object:null,element:null,eventHandler:null,fallThrough:null,includeXY:!1,extensions:null,extensionCount:null,clearMouseListener:null,initialize:function(a,b,c,d,e){Tmap.Util.extend(this,e),this.object=a,this.fallThrough=d,this.listeners={},this.extensions={},this.extensionCount={},null!=b&&this.attachToElement(b)},destroy:function(){for(var a in this.extensions)"boolean"!=typeof this.extensions[a]&&this.extensions[a].destroy();this.extensions=null,this.element&&(Tmap.Event.stopObservingElement(this.element),this.element.hasScrollEvent&&Tmap.Event.stopObserving(window,"scroll",this.clearMouseListener)),this.element=null,this.listeners=null,this.object=null,this.fallThrough=null,this.eventHandler=null},addEventType:function(a){},attachToElement:function(a){this.element?Tmap.Event.stopObservingElement(this.element):(this.eventHandler=Tmap.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=Tmap.Function.bind(this.clearMouseCache,this)),this.element=a;for(var b=0,c=this.BROWSER_EVENTS.length;c>b;b++)Tmap.Event.observe(a,this.BROWSER_EVENTS[b],this.eventHandler);Tmap.Event.observe(a,"dragstart",Tmap.Event.stop)},on:function(a){for(var b in a)"scope"!=b&&a.hasOwnProperty(b)&&this.register(b,a.scope,a[b])},register:function(a,b,c,d){if(a in Tmap.Events&&!this.extensions[a]&&(this.extensions[a]=new Tmap.Events[a](this)),null!=c){null==b&&(b=this.object);var e=this.listeners[a];e||(e=[],this.listeners[a]=e,this.extensionCount[a]=0);var f={obj:b,func:c};d?(e.splice(this.extensionCount[a],0,f),"object"==typeof d&&d.extension&&this.extensionCount[a]++):e.push(f)}},registerPriority:function(a,b,c){this.register(a,b,c,!0)},un:function(a){for(var b in a)"scope"!=b&&a.hasOwnProperty(b)&&this.unregister(b,a.scope,a[b])},unregister:function(a,b,c){null==b&&(b=this.object);var d=this.listeners[a];if(null!=d)for(var e=0,f=d.length;f>e;e++)if(d[e].obj==b&&d[e].func==c){d.splice(e,1);break}},remove:function(a){null!=this.listeners[a]&&(this.listeners[a]=[])},triggerEvent:function(a,b){var c=this.listeners[a];if(c&&0!=c.length){null==b&&(b={}),b.object=this.object,b.element=this.element,b.type||(b.type=a),c=c.slice();for(var d,e=0,f=c.length;f>e;e++){var g=c[e];if(d=g.func.apply(g.obj,[b]),void 0!=d&&0==d)break}return this.fallThrough||Tmap.Event.stop(b,!0),d}},handleBrowserEvent:function(a){var b=a.type,c=this.listeners[b];if(c&&0!=c.length){var d=a.touches;if(d&&d[0]){for(var e,f=0,g=0,h=d.length,i=0;h>i;++i)e=this.getTouchClientXY(d[i]),f+=e.clientX,g+=e.clientY;a.clientX=f/h,a.clientY=g/h}this.includeXY&&(a.xy=this.getMousePosition(a)),this.triggerEvent(b,a)}},getTouchClientXY:function(a){var b=window.olMockWin||window,c=b.pageXOffset,d=b.pageYOffset,e=a.clientX,f=a.clientY;return 0===a.pageY&&Math.floor(f)>Math.floor(a.pageY)||0===a.pageX&&Math.floor(e)>Math.floor(a.pageX)?(e-=c,f-=d):(f<a.pageY-d||e<a.pageX-c)&&(e=a.pageX-c,f=a.pageY-d),a.olClientX=e,a.olClientY=f,{clientX:e,clientY:f}},clearMouseCache:function(){this.element.scrolls=null,this.element.lefttop=null,this.element.offsets=null},getMousePosition:function(a){if(this.includeXY?this.element.hasScrollEvent||(Tmap.Event.observe(window,"scroll",this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache(),!this.element.scrolls){var b=Tmap.Util.getViewportElement();this.element.scrolls=[window.pageXOffset||b.scrollLeft,window.pageYOffset||b.scrollTop]}return this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]),this.element.offsets||(this.element.offsets=Tmap.Util.pagePosition(this.element)),new Tmap.Pixel(a.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],a.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1])},CLASS_NAME:"Tmap.Events"}),Tmap.Events.buttonclick=Tmap.Class({target:null,events:["mousedown","mouseup","click","dblclick","touchstart","touchmove","touchend","keydown"],startRegEx:/^mousedown|touchstart$/,cancelRegEx:/^touchmove$/,completeRegEx:/^mouseup|touchend$/,initialize:function(a){this.target=a;for(var b=this.events.length-1;b>=0;--b)this.target.register(this.events[b],this,this.buttonClick,{extension:!0})},destroy:function(){for(var a=this.events.length-1;a>=0;--a)this.target.unregister(this.events[a],this,this.buttonClick);delete this.target},getPressedButton:function(a){var b,c=3;do{if(Tmap.Element.hasClass(a,"tmButton")){b=a;break}a=a.parentNode}while(--c>0&&a);return b},ignore:function(a){var b=3,c=!1;do{if("a"===a.nodeName.toLowerCase()){c=!0;break}a=a.parentNode}while(--b>0&&a);return c},buttonClick:function(a){var b=!0,c=Tmap.Event.element(a);if(c&&(Tmap.Event.isLeftClick(a)||!~a.type.indexOf("mouse"))){var d=this.getPressedButton(c);if(d){if("keydown"===a.type)switch(a.keyCode){case Tmap.Event.KEY_RETURN:case Tmap.Event.KEY_SPACE:this.target.triggerEvent("buttonclick",{buttonElement:d}),Tmap.Event.stop(a),b=!1}else if(this.startEvt){if(this.completeRegEx.test(a.type)){var e=Tmap.Util.pagePosition(d),f=Tmap.Util.getViewportElement(),g=window.pageYOffset||f.scrollTop,h=window.pageXOffset||f.scrollLeft;e[0]=e[0]-h,e[1]=e[1]-g,this.target.triggerEvent("buttonclick",{buttonElement:d,buttonXY:{x:this.startEvt.clientX-e[0],y:this.startEvt.clientY-e[1]}})}this.cancelRegEx.test(a.type)&&delete this.startEvt,Tmap.Event.stop(a),b=!1}this.startRegEx.test(a.type)&&(this.startEvt=a,Tmap.Event.stop(a),b=!1)}else b=!this.ignore(Tmap.Event.element(a)),delete this.startEvt}return b}}),Tmap.ProxyHost="",Tmap.Request||(Tmap.Request={}),Tmap.Util.extend(Tmap.Request,{DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:Tmap.ProxyHost,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,events:new Tmap.Events(this),makeSameOrigin:function(a,b){var c=0!==a.indexOf("http"),d=!c&&a.match(this.URL_SPLIT_REGEX);if(d){var e=window.location;c=d[1]==e.protocol&&d[3]==e.hostname;var f=d[4],g=e.port;(80!=f&&""!=f||"80"!=g&&""!=g)&&(c=c&&f==g)}return c||b&&(a="function"==typeof b?b(a):b+encodeURIComponent(a)),a},issue:function(a){var b=Tmap.Util.extend(this.DEFAULT_CONFIG,{proxy:Tmap.ProxyHost});a=a||{},a.headers=a.headers||{},a=Tmap.Util.applyDefaults(a,b),a.headers=Tmap.Util.applyDefaults(a.headers,b.headers);var c,d=!1;for(c in a.headers)a.headers.hasOwnProperty(c)&&"x-requested-with"===c.toLowerCase()&&(d=!0);d===!1&&(a.headers["X-Requested-With"]="XMLHttpRequest");var e=new Tmap.Request.XMLHttpRequest,f=Tmap.Util.urlAppend(a.url,Tmap.Util.getParameterString(a.params||{}));f=Tmap.Request.makeSameOrigin(f,a.proxy),e.open(a.method,f,a.async,a.user,a.password);for(var g in a.headers)e.setRequestHeader(g,a.headers[g]);var h=this.events,i=this;return e.onreadystatechange=function(){if(e.readyState==Tmap.Request.XMLHttpRequest.DONE){var b=h.triggerEvent("complete",{request:e,config:a,requestUrl:f});b!==!1&&i.runCallbacks({request:e,config:a,requestUrl:f})}},a.async===!1?e.send(a.data):window.setTimeout(function(){0!==e.readyState&&e.send(a.data)},0),e},runCallbacks:function(a){var b,c=a.request,d=a.config,e=d.scope?Tmap.Function.bind(d.callback,d.scope):d.callback;d.success&&(b=d.scope?Tmap.Function.bind(d.success,d.scope):d.success);var f;d.failure&&(f=d.scope?Tmap.Function.bind(d.failure,d.scope):d.failure),"file:"==Tmap.Util.createUrlObject(d.url).protocol&&c.responseText&&(c.status=200),e(c),(!c.status||c.status>=200&&c.status<300)&&(this.events.triggerEvent("success",a),b&&b(c)),c.status&&(c.status<200||c.status>=300)&&(this.events.triggerEvent("failure",a),f&&f(c))},GET:function(a){return a=Tmap.Util.extend(a,{method:"GET"}),Tmap.Request.issue(a)},POST:function(a){return a=Tmap.Util.extend(a,{method:"POST"}),a.headers=a.headers?a.headers:{},"CONTENT-TYPE"in Tmap.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml"),Tmap.Request.issue(a)},PUT:function(a){return a=Tmap.Util.extend(a,{method:"PUT"}),a.headers=a.headers?a.headers:{},"CONTENT-TYPE"in Tmap.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml"),Tmap.Request.issue(a)},DELETE:function(a){return a=Tmap.Util.extend(a,{method:"DELETE"}),Tmap.Request.issue(a)},HEAD:function(a){return a=Tmap.Util.extend(a,{method:"HEAD"}),Tmap.Request.issue(a)},OPTIONS:function(a){return a=Tmap.Util.extend(a,{method:"OPTIONS"}),Tmap.Request.issue(a)}}),function(){function a(){this._object=h&&!k?new h:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function b(){return new a}function c(a){if(a._object.send(a._data),i&&!a._async)for(a.readyState=b.OPENED,f(a);a.readyState<b.DONE;)if(a.readyState++,d(a),a._aborted)return}function d(a){b.onreadystatechange&&b.onreadystatechange.apply(a),a.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function e(a){var b=a.responseXML,c=a.responseText;return j&&c&&b&&!b.documentElement&&a.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(b=new window.ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.validateOnParse=!1,b.loadXML(c)),b&&(j&&0!=b.parseError||!b.documentElement||b.documentElement&&"parsererror"==b.documentElement.tagName)?null:b}function f(a){try{a.responseText=a._object.responseText}catch(b){}try{a.responseXML=e(a._object)}catch(b){}try{a.status=a._object.status}catch(b){}try{a.statusText=a._object.statusText}catch(b){}}function g(a){a._object.onreadystatechange=new window.Function}var h=window.XMLHttpRequest,i=!!window.controllers,j=window.document.all&&!window.opera,k=j&&window.navigator.userAgent.match(/MSIE 7.0/);b.prototype=a.prototype,i&&h.wrapped&&(b.wrapped=h.wrapped),b.UNSENT=0,b.OPENED=1,b.HEADERS_RECEIVED=2,b.LOADING=3,b.DONE=4,b.prototype.readyState=b.UNSENT,b.prototype.responseText="",b.prototype.responseXML=null,b.prototype.status=0,b.prototype.statusText="",b.prototype.priority="NORMAL",b.prototype.onreadystatechange=null,b.onreadystatechange=null,b.onopen=null,b.onsend=null,b.onabort=null,b.prototype.open=function(a,c,e,h,k){delete this._headers,arguments.length<3&&(e=!0),this._async=e;var l,m=this,n=this.readyState;j&&e&&(l=function(){n!=b.DONE&&(g(m),m.abort())},window.attachEvent("onunload",l)),b.onopen&&b.onopen.apply(this,arguments),arguments.length>4?this._object.open(a,c,e,h,k):arguments.length>3?this._object.open(a,c,e,h):this._object.open(a,c,e),this.readyState=b.OPENED,d(this),this._object.onreadystatechange=function(){if(!i||e){if(m.readyState=m._object.readyState,f(m),m._aborted)return void(m.readyState=b.UNSENT);m.readyState==b.DONE&&(delete m._data,g(m),j&&e&&window.detachEvent("onunload",l)),n!=m.readyState&&d(m),n=m.readyState}}},b.prototype.send=function(a){b.onsend&&b.onsend.apply(this,arguments),arguments.length||(a=null),a&&a.nodeType&&(a=window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):a.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=a,c(this)},b.prototype.abort=function(){b.onabort&&b.onabort.apply(this,arguments),this.readyState>b.UNSENT&&(this._aborted=!0),this._object.abort(),g(this),this.readyState=b.UNSENT,delete this._data},b.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},b.prototype.getResponseHeader=function(a){return this._object.getResponseHeader(a)},b.prototype.setRequestHeader=function(a,b){return this._headers||(this._headers={}),this._headers[a]=b,this._object.setRequestHeader(a,b)},b.prototype.addEventListener=function(a,b,c){for(var d,e=0;d=this._listeners[e];e++)if(d[0]==a&&d[1]==b&&d[2]==c)return;this._listeners.push([a,b,c])},b.prototype.removeEventListener=function(a,b,c){for(var d,e=0;(d=this._listeners[e])&&(d[0]!=a||d[1]!=b||d[2]!=c);e++);d&&this._listeners.splice(e,1)},b.prototype.dispatchEvent=function(a){var b={type:a.type,target:this,currentTarget:this,eventPhase:2,bubbles:a.bubbles,cancelable:a.cancelable,timeStamp:a.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==b.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[b]);for(var c,d=0;c=this._listeners[d];d++)c[0]!=b.type||c[2]||(c[1].handleEvent||c[1]).apply(this,[b])},b.prototype.toString=function(){return"[object XMLHttpRequest]"},b.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(a,b){b||(b=[]),a.__func=this,a.__func(b[0],b[1],b[2],b[3],b[4]),delete a.__func}),Tmap.Request||(Tmap.Request={}),Tmap.Request.XMLHttpRequest=b}(),Tmap.TData=Tmap.Class({events:null,responseXML:null,httpModule:null,scopeTData:null,format:"xml",httpArray:[],protocol:"",version:2,appKey:"",noFinger:!1,cache:[],initialize:function(a){this.protocol=location.protocol,"https:"==this.protocol?(this.version=1,this.httpArray=["https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap","https://apis.openapi.sk.com/tmap"]):(this.version=2,this.httpArray=["http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap","http://apis.openapi.sk.com/tmap"]),scopeTData=this,this.events=new Tmap.Events,this.appKey=Tmap.Util.getParameterFromURL("appKey"),Tmap.Util.extend(this,a)},cbFunc:function(a){if(a.readyState)if(4==a.readyState)if(a.responseXML)this.responseXML=a.responseXML,"error"==this.responseXML.firstChild.nodeName&&this.events.listeners.onError?this.events.triggerEvent("onError"):this.events.triggerEvent("onComplete");else if(a.responseText){if(window.DOMParser){var b=new DOMParser;this.responseXML=b.parseFromString(a.responseText,"text/xml")}else{var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";var d=c.loadXML(a.responseText);if(!d)return void this.events.triggerEvent("onError");this.responseXML=c}"error"==this.responseXML.firstChild.nodeName&&this.events.listeners.onError?this.events.triggerEvent("onError"):this.events.triggerEvent("onComplete")}else this.events.triggerEvent("onError");else this.events.triggerEvent("onProgress");else;},cbFuncIE:function(a,b){switch(b){case"onComplete":if(a.responseText)if(window.DOMParser){var c=new DOMParser;this.responseXML=c.parseFromString(a.responseText,"text/xml")}else{var d=new ActiveXObject("Microsoft.XMLDOM");d.async="false",d.loadXML(a.responseText),this.responseXML=d}else b="onError";this.events.triggerEvent(b);break;case"onProgress":case"onError":this.events.triggerEvent(b)}},getXMLHttpRequest:function(){if(window.XDomainRequest)try{return this.httpModule="XDomainRequest",new XDomainRequest}catch(a){return this.httpModule=null,null}else{if(!window.ActiveXObject)return window.XMLHttpRequest?(this.httpModule="XMLHttpRequest",new Tmap.Request.XMLHttpRequest):(this.httpModule=null,null);try{return this.httpModule="XMLHTTP",new ActiveXObject("Microsoft.XMLHTTP")}catch(a){return this.httpModule=null,null}}},getRoutePlan:function(){var a=arguments[0].lon,b=arguments[0].lat,c=arguments[1].lon,d=arguments[1].lat,e=this.getXMLHttpRequest(),f=[],g=arguments[2],h={format:"xml",version:this.version,appKey:this.appKey,endX:c,endY:d,startX:a,startY:b};for(var i in h)g&&g[i]&&delete g[i],this.setKeyValueFromObject(f,h,i);if(g)for(var j in g)this.setKeyValueFromObject(f,g,j);e.open("GET",this.httpArray[0]+"/routes?"+f.join("&")+this.getFingerKeyValue()),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},getRoutePlanForPeople:function(){var a=arguments[0].lon,b=arguments[0].lat,c=arguments[1].lon,d=arguments[1].lat,e=arguments[2],f=arguments[3],g=this.getXMLHttpRequest(),h=[],i=arguments[4],j={format:"xml",version:this.version,appKey:this.appKey,endX:c,endY:d,startX:a,startY:b,startName:e,endName:f};for(var k in j)i&&i[k]&&delete i[k],this.setKeyValueFromObject(h,j,k);if(i)for(var l in i)this.setKeyValueFromObject(h,i,l);g.open("GET",this.httpArray[1]+"/routes/pedestrian?"+h.join("&")+this.getFingerKeyValue()),"XDomainRequest"==this.httpModule?(g.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},g.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},g.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):g.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},g.send()},getRoutePlanForBycle:function(){var a=arguments[0].lon,b=arguments[0].lat,c=arguments[1].lon,d=arguments[1].lat,e=this.getXMLHttpRequest(),f=[],g=arguments[2],h={format:"xml",version:this.version,appKey:this.appKey,startX:a,startY:b,endX:c,endY:d};for(var i in h)g&&g[i]&&delete g[i],this.setKeyValueFromObject(f,h,i);if(g)for(var j in g)this.setKeyValueFromObject(f,g,j);e.open("GET",this.httpArray[2]+"/routes/bicycle?"+f.join("&")+this.getFingerKeyValue()),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},getRealTimeTraffic:function(){var a=arguments[0].bottom,b=arguments[0].left,c=arguments[0].top,d=arguments[0].right,e=arguments[1],f=this.getXMLHttpRequest(),g=[],h=arguments[2],i={format:"xml",version:this.version,appKey:this.appKey,minLat:a,minLon:b,maxLat:c,maxLon:d,zoomLevel:e};for(var j in i)h&&h[j]&&delete h[j],this.setKeyValueFromObject(g,i,j);if(h)for(var k in h)this.setKeyValueFromObject(g,h,k);f.open("GET",this.httpArray[3]+"/traffic?"+g.join("&")+this.getFingerKeyValue()),"XDomainRequest"==this.httpModule?(f.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},f.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},f.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):f.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},f.send()},getPOIDataFromSearch:function(){var a=arguments[0],b=this.getXMLHttpRequest(),c=[],d=arguments[1],e={format:"xml",version:this.version,appKey:this.appKey,searchKeyword:a};for(var f in e)d&&d[f]&&delete d[f],this.setKeyValueFromObject(c,e,f);if(d)for(var g in d)this.setKeyValueFromObject(c,d,g);b.open("GET",this.httpArray[4]+"/pois?"+c.join("&")),
"XDomainRequest"==this.httpModule?(b.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},b.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},b.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):b.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},b.send()},getPOICategory:function(){var a=this.getXMLHttpRequest(),b=[],c=arguments[0],d={format:"xml",version:this.version,appKey:this.appKey};for(var e in d)c&&c[e]&&delete c[e],this.setKeyValueFromObject(b,d,e);if(c)for(var f in c)this.setKeyValueFromObject(b,c,f);a.open("GET",this.httpArray[5]+"/poi/categories?"+b.join("&")),"XDomainRequest"==this.httpModule?(a.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},a.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},a.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):a.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},a.send()},getPOILocalCode:function(){var a=this.getXMLHttpRequest(),b=[],c=arguments[0],d={format:"xml",version:this.version,appKey:this.appKey};for(var e in d)c&&c[e]&&delete c[e],this.setKeyValueFromObject(b,d,e);if(c)for(var f in c)this.setKeyValueFromObject(b,c,f);a.open("GET",this.httpArray[6]+"/poi/areas?"+b.join("&")),"XDomainRequest"==this.httpModule?(a.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},a.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},a.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):a.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},a.send()},getPOIDataFromLonLat:function(){var a=arguments[0].lat,b=arguments[0].lon,c=arguments[1],d=this.getXMLHttpRequest(),e=[],f=arguments[2],g={format:"xml",version:this.version,appKey:this.appKey,centerLon:b,centerLat:a,categories:c};for(var h in g)f&&f[h]&&delete f[h],this.setKeyValueFromObject(e,g,h);if(f)for(var i in f)this.setKeyValueFromObject(e,f,i);d.open("GET",this.httpArray[7]+"/pois/search/around?"+e.join("&")),"XDomainRequest"==this.httpModule?(d.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},d.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},d.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):d.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},d.send()},getPOIDataFromId:function(){var a=arguments[0],b=this.getXMLHttpRequest(),c=[],d=arguments[1];arguments[1]&&arguments[1].poiId&&(a=arguments[1].poiId);var e={format:"xml",version:this.version,appKey:this.appKey};for(var f in e)d&&d[f]&&delete d[f],this.setKeyValueFromObject(c,e,f);if(d)for(var g in d)this.setKeyValueFromObject(c,d,g);b.open("GET",this.httpArray[8]+"/pois/"+a+"?"+c.join("&")),"XDomainRequest"==this.httpModule?(b.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},b.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},b.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):b.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},b.send()},getGeoFromAddress:function(){var a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3],e=this.getXMLHttpRequest(),f=[],g=arguments[4],h={format:"xml",version:this.version,appKey:this.appKey,city_do:a,gu_gun:b,dong:c,bunji:d};for(var i in h)g&&g[i]&&delete g[i],this.setKeyValueFromObject(f,h,i);if(g)for(var j in g)this.setKeyValueFromObject(f,g,j);e.open("GET",this.httpArray[9]+"/geo/geocoding?"+f.join("&")),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},getAddressFromLonLat:function(){var a=arguments[0].lat,b=arguments[0].lon,c=this.getXMLHttpRequest(),d=[],e=arguments[1],f={format:"xml",version:this.version,appKey:this.appKey,lat:a,lon:b};for(var g in f)e&&e[g]&&delete e[g],this.setKeyValueFromObject(d,f,g);if(e)for(var h in e)this.setKeyValueFromObject(d,e,h);c.open("GET",this.httpArray[10]+"/geo/reversegeocoding?"+d.join("&")),"XDomainRequest"==this.httpModule?(c.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},c.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},c.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):c.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},c.send()},projCodeToOptionString:function(a){return a=a.replace(":",""),"EPSG4326"==a&&(a="WGS84GEO"),a},transform:function(){var a=arguments[0].lat,b=arguments[0].lon,c=arguments[1]?this.projCodeToOptionString(arguments[1].projCode):"",d=arguments[2]?this.projCodeToOptionString(arguments[2].projCode):"",e=this.getXMLHttpRequest(),f=[],g=arguments[3],h={format:"xml",version:this.version,appKey:this.appKey,lat:a,lon:b,fromCoord:c,toCoord:d};for(var i in h)g&&g[i]&&delete g[i],this.setKeyValueFromObject(f,h,i);if(g)for(var j in g)this.setKeyValueFromObject(f,g,j);e.open("GET",this.httpArray[11]+"/geo/coordconvert?"+f.join("&")),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},getGeofencingFromSearch:function(){var a=arguments[0],b=arguments[1].toUpperCase(),c=arguments[2],d=arguments[3],e=this.getXMLHttpRequest(),f=[],g=arguments[4],h={format:"xml",version:this.version,appKey:this.appKey,categories:a,searchType:b,count:d};"KEYWORD"==b?h.searchKeyword=c:"COORDINATES"==b&&(h.reqLon=c.lon,h.reqLat=c.lat);for(var i in h)g&&g[i]&&delete g[i],this.setKeyValueFromObject(f,h,i);if(g)for(var j in g)this.setKeyValueFromObject(f,g,j);e.open("GET",this.httpArray[13]+"/geofencing/regions?"+f.join("&")),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},getGeofencingFromId:function(){var a=arguments[0],b=this.getXMLHttpRequest(),c=[],d=arguments[1];arguments[1]&&arguments[1].poiId&&(a=arguments[1].poiId);var e={format:"xml",version:this.version,appKey:this.appKey};for(var f in e)d&&d[f]&&delete d[f],this.setKeyValueFromObject(c,e,f);if(d)for(var g in d)this.setKeyValueFromObject(c,d,g);b.open("GET",this.httpArray[14]+"/geofencing/regions/"+a+"?"+c.join("&")),"XDomainRequest"==this.httpModule?(b.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},b.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},b.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):b.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},b.send()},getCache:function(a){for(var b=this.cache.length,c=0;b>c;c++)if(this.cache[c][0]==a)return this.cache[c][1];return!1},setCache:function(a,b){return this.getCache(a)?void 0:(this.cache.length>=10&&this.cache.shift(),void this.cache.push([a,b]))},getKey:function(){return this.keywordForAutocomplete},setKey:function(a){this.keywordForAutocomplete=a},removeKey:function(){this.keywordForAutocomplete=""},keywordForAutocomplete:"",getAutoCompleteSearch:function(){if(arguments[1].timeout){window.tDataTimeoutScope=this,window.tDataTimeoutArgs=arguments;var a=arguments[1].timeout;return window.tDataTimeoutID&&clearTimeout(window.tDataTimeoutID),window.tDataTimeoutID=setTimeout(function(){window.tDataTimeoutScope.getAutoCompleteSearch.apply(window.tDataTimeoutScope,window.tDataTimeoutArgs)},a),void delete arguments[1].timeout}var b=arguments[0];b=b.trim();var c=this.getXMLHttpRequest(),d=[],e=arguments[1],f={format:"xml",version:this.version,appKey:this.appKey,searchKeyword:b},g=this.getCache(b);if(g)return void scopeTData.cbFunc.call(scopeTData,g);this.removeKey(),this.setKey(b);for(var h in f)e&&e[h]&&delete e[h],this.setKeyValueFromObject(d,f,h);if(e)for(var i in e)this.setKeyValueFromObject(d,e,i);c.open("GET",this.httpArray[15]+"/poi/autoComplete?"+d.join("&")),"XDomainRequest"==this.httpModule?(c.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},c.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},c.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):c.onreadystatechange=function(){scopeTData.setCache(scopeTData.getKey(),this),scopeTData.cbFunc.call(scopeTData,this)},c.send()},rtti:function(){var a=this.getXMLHttpRequest();a.open("GET",this.httpArray[12]+"/rttiDaemonTest?version="+this.version),"XDomainRequest"==this.httpModule?(a.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},a.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},a.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):a.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},a.send()},getCustomAPI:function(a,b){var c=[];if(b)for(var d in b)this.setKeyValueFromObject(c,b,d);var e=this.getXMLHttpRequest();e.open("GET",this.httpArray[16]+a+"?version="+this.version+"&"+c.join("&")),"XDomainRequest"==this.httpModule?(e.onload=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onComplete")},e.onprogress=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onProgress")},e.onerror=function(){scopeTData.cbFuncIE.call(scopeTData,this,"onError")}):e.onreadystatechange=function(){scopeTData.cbFunc.call(scopeTData,this)},e.send()},setKeyValueFromObject:function(){var a=arguments[0],b=arguments[1],c=arguments[2];if(arguments.length>2)var d=arguments[3];if(b[c])"version"==c?"https:"==this.protocol?a.push(c+"=1"):a.push(c+"=2"):"string"==typeof b[c]&&b[c].match(decodeURIComponent(".*%5B%E3%84%B1-%E3%85%8E%E3%85%8F-%E3%85%A3%EA%B0%80-%ED%9E%A3%5D%2B.*"))?a.push(c+"="+encodeURIComponent(b[c])):a.push(c+"="+b[c]);else{if(!d)return;a.push(c+"="+d)}},getFingerKeyValue:function(){if(this.noFinger)return"";var a=(new Date).getTime();return"&finger="+a},destroy:function(){this.httpModule=null,this.responseXML=null,this.events=null},CLASS_NAME:"Tmap.TData"}),Tmap.Projection=Tmap.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(a,b){Tmap.Util.extend(this,b),this.projCode=a,"object"==typeof Proj4js&&(this.proj=new Proj4js.Proj(a))},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(a){var b=a,c=!1;if(b)if(b instanceof Tmap.Projection||(b=new Tmap.Projection(b)),"object"==typeof Proj4js&&this.proj.defData&&b.proj.defData)c=this.proj.defData.replace(this.titleRegEx,"")==b.proj.defData.replace(this.titleRegEx,"");else if(b.getCode){var d=this.getCode(),e=b.getCode();c=d==e||!!Tmap.Projection.transforms[d]&&Tmap.Projection.transforms[d][e]===Tmap.Projection.nullTransform}return c},destroy:function(){delete this.proj,delete this.projCode},CLASS_NAME:"Tmap.Projection"}),Tmap.Projection.transforms={},Tmap.Projection.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-20037508.34,-20037508.34,20037508.34,20037508.34]}},Tmap.Projection.addTransform=function(a,b,c){if(c===Tmap.Projection.nullTransform){var d=Tmap.Projection.defaults[a];d&&!Tmap.Projection.defaults[b]&&(Tmap.Projection.defaults[b]=d)}Tmap.Projection.transforms[a]||(Tmap.Projection.transforms[a]={}),Tmap.Projection.transforms[a][b]=c},Tmap.Projection.transform=function(a,b,c){if(b&&c)if(b instanceof Tmap.Projection||(b=new Tmap.Projection(b)),c instanceof Tmap.Projection||(c=new Tmap.Projection(c)),b.proj&&c.proj)a=Proj4js.transform(b.proj,c.proj,a);else{var d=b.getCode(),e=c.getCode(),f=Tmap.Projection.transforms;f[d]&&f[d][e]&&f[d][e](a)}return a},Tmap.Projection.nullTransform=function(a){return a},function(){function a(a){return a.x=180*a.x/q,a.y=180/Math.PI*(2*Math.atan(Math.exp(a.y/q*Math.PI))-Math.PI/2),a}function b(a){a.x=a.x*q/180;var b=Math.log(Math.tan((90+a.y)*Math.PI/360))/Math.PI*q;return a.y=Math.max(-20037508.34,Math.min(b,20037508.34)),a}function c(a){var b=6377397.155,c=.006674372231802,d=.006719218799175,e=.9999,f=.001674184801115,g=4e5,h=6e5,i=2.23402144255274,j=4207077.70785048,k=j+(a.y-h)/e,l=k/b/(1-c/4-3*Math.pow(c,2)/64-5*Math.pow(c,3)/256),m=l+(3*f/2-27*Math.pow(f,3)/32)*Math.sin(2*l)+(21*Math.pow(f,2)/16-55*Math.pow(f,4)/32)*Math.sin(4*l)+151*Math.pow(f,3)/96*Math.sin(6*l)+1097*Math.pow(f,4)/512*Math.sin(8*l),n=b/Math.pow(1-c*Math.pow(Math.sin(m),2),.5),o=b*(1-c)/Math.pow(1-c*Math.pow(Math.sin(m),2),1.5),p=Math.pow(Math.tan(m),2),q=d*Math.pow(Math.cos(m),2),r=(a.x-g)/n/e,s=m-n*Math.tan(m)/o*Math.pow(r,2)/2-(5+3*p+10*q-4*Math.pow(q,2)-9*d)*Math.pow(r,4)/24+(61+90*p+298*q+45*Math.pow(p,2)-252*d-3*Math.pow(q,2))*Math.pow(r,6)/720,t=i+(r-(1+2*p+q)*Math.pow(r,3)/6+(5-2*q+28*p-3*Math.pow(q,2)+8*d+24*Math.pow(p,2))*Math.pow(r,5)/120)/Math.cos(m),u=Math.round(180*t/3.141592653589793*1e7)/1e7,v=Math.round(180*s/3.141592653589793*1e7)/1e7,w={};w.x=u,w.y=v;var x=w.x,y=w.y,b=6377397.155,z=.0033427731821748,c=.006674372,A=-128,B=481,C=664,D=739.845,E=10037499008e-15,F=.0174532925199433*y,G=.0174532925199433*x,H=b*(1-c)/Math.pow(1-c*Math.pow(Math.sin(F),2),1.5),I=b/Math.pow(1-c*Math.pow(Math.sin(F),2),.5),J=(-1*A*Math.sin(F)*Math.cos(G)-B*Math.sin(F)*Math.sin(G)+C*Math.cos(F)+(b*E+z*D)*Math.sin(2*F))/(H*Math.sin(484813681109536e-20)),K=(-1*A*Math.sin(G)+B*Math.cos(G))/(I*Math.cos(F)*Math.sin(484813681109536e-20));return w.x=Math.round(1e7*(x+K/3600))/1e7,w.y=Math.round(1e7*(y+J/3600))/1e7,a.x=w.x,a.y=w.y,a}function d(a){var b=6378137,c=.0033528106647362,d=.00669438,e=128,f=-481,g=-664,h=-739.845,i=-10037499008e-15,j=.0174532925199433*a.y,k=.0174532925199433*a.x,l=b*(1-d)/Math.pow(1-d*Math.pow(Math.sin(j),2),1.5),m=b/Math.pow(1-d*Math.pow(Math.sin(j),2),.5),n=(-1*e*Math.sin(j)*Math.cos(k)-f*Math.sin(j)*Math.sin(k)+g*Math.cos(j)+(b*i+c*h)*Math.sin(2*j))/(l*Math.sin(484813681109536e-20)),o=(-1*e*Math.sin(k)+f*Math.cos(k))/(m*Math.cos(j)*Math.sin(484813681109536e-20)),p={};p.x=a.x+o/3600,p.y=a.y+n/3600;var q=p.x,r=p.y,b=6377397.155,d=.006674372,s=.00672,t=.9999,u=4e5,v=6e5,w=2.234021442552742,x=4207077.70785048,j=.0174532925199433*r,k=.0174532925199433*q,m=b/Math.pow(1-d*Math.pow(Math.sin(j),2),.5),y=Math.pow(Math.tan(j),2),z=s*Math.pow(Math.cos(j),2),A=(k-w)*Math.cos(j),B=b*((1-d/4-3*Math.pow(d,2)/64-5*Math.pow(d,3)/256)*j-(3*d/8+3*Math.pow(d,2)/32+45*Math.pow(d,3)/1024)*Math.sin(2*j)+(15*Math.pow(d,2)/256+45*Math.pow(d,3)/1024)*Math.sin(4*j)-35*Math.pow(d,3)/3072*Math.sin(6*j)),C=u+t*m*(A+(1-y+z)*Math.pow(A,3)/6+(5-18*y+Math.pow(y,2)+72*z-58*s)*Math.pow(A,5)/120),D=v+t*(B-x+m*Math.tan(j)*(Math.pow(A,2)/2+(5-y+9*z+4*Math.pow(z,2))*Math.pow(A,4)/24+(61-58*y+Math.pow(y,2)+600*z-330*s)*Math.pow(A,6)/720));return a.x=Math.round(C),a.y=Math.round(D),a}function e(a){var b=6377397.155,c=.006674372231802,d=.006719218799175,e=.9999,f=.001674184801115,g=4e5,h=6e5,i=2.23402144255274,j=4207077.70785048,k=j+(a.y-h)/e,l=k/b/(1-c/4-3*Math.pow(c,2)/64-5*Math.pow(c,3)/256),m=l+(3*f/2-27*Math.pow(f,3)/32)*Math.sin(2*l)+(21*Math.pow(f,2)/16-55*Math.pow(f,4)/32)*Math.sin(4*l)+151*Math.pow(f,3)/96*Math.sin(6*l)+1097*Math.pow(f,4)/512*Math.sin(8*l),n=b/Math.pow(1-c*Math.pow(Math.sin(m),2),.5),o=b*(1-c)/Math.pow(1-c*Math.pow(Math.sin(m),2),1.5),p=Math.pow(Math.tan(m),2),q=d*Math.pow(Math.cos(m),2),r=(a.x-g)/n/e,s=m-n*Math.tan(m)/o*Math.pow(r,2)/2-(5+3*p+10*q-4*Math.pow(q,2)-9*d)*Math.pow(r,4)/24+(61+90*p+298*q+45*Math.pow(p,2)-252*d-3*Math.pow(q,2))*Math.pow(r,6)/720,t=i+(r-(1+2*p+q)*Math.pow(r,3)/6+(5-2*q+28*p-3*Math.pow(q,2)+8*d+24*Math.pow(p,2))*Math.pow(r,5)/120)/Math.cos(m),u=Math.round(180*t/3.141592653589793*1e7)/1e7,v=Math.round(180*s/3.141592653589793*1e7)/1e7,w={};w.x=u,w.y=v;var x=w.x,y=w.y,b=6377397.155,z=.0033427731821748,c=.006674372,A=-128,B=481,C=664,D=739.845,E=10037499008e-15,F=.0174532925199433*y,G=.0174532925199433*x,H=b*(1-c)/Math.pow(1-c*Math.pow(Math.sin(F),2),1.5),I=b/Math.pow(1-c*Math.pow(Math.sin(F),2),.5),J=(-1*A*Math.sin(F)*Math.cos(G)-B*Math.sin(F)*Math.sin(G)+C*Math.cos(F)+(b*E+z*D)*Math.sin(2*F))/(H*Math.sin(484813681109536e-20)),K=(-1*A*Math.sin(G)+B*Math.cos(G))/(I*Math.cos(F)*Math.sin(484813681109536e-20));w.x=Math.round(1e7*(x+K/3600))/1e7,w.y=Math.round(1e7*(y+J/3600))/1e7,a.x=w.x,a.y=w.y;var L=20037508.34;return a.x=a.x*L/180,a.y=Math.log(Math.tan((90+a.y)*Math.PI/360))/Math.PI*L,a}function f(a){var b=20037508.34;a.x=180*a.x/b,a.y=180/Math.PI*(2*Math.atan(Math.exp(a.y/b*Math.PI))-Math.PI/2);var c=6378137,d=.0033528106647362,e=.00669438,f=128,g=-481,h=-664,i=-739.845,j=-10037499008e-15,k=.0174532925199433*a.y,l=.0174532925199433*a.x,m=c*(1-e)/Math.pow(1-e*Math.pow(Math.sin(k),2),1.5),n=c/Math.pow(1-e*Math.pow(Math.sin(k),2),.5),o=(-1*f*Math.sin(k)*Math.cos(l)-g*Math.sin(k)*Math.sin(l)+h*Math.cos(k)+(c*j+d*i)*Math.sin(2*k))/(m*Math.sin(484813681109536e-20)),p=(-1*f*Math.sin(l)+g*Math.cos(l))/(n*Math.cos(k)*Math.sin(484813681109536e-20)),q={};q.x=a.x+p/3600,q.y=a.y+o/3600;var r=q.x,s=q.y,c=6377397.155,e=.006674372,t=.00672,u=.9999,v=4e5,w=6e5,x=2.234021442552742,y=4207077.70785048,k=.0174532925199433*s,l=.0174532925199433*r,n=c/Math.pow(1-e*Math.pow(Math.sin(k),2),.5),z=Math.pow(Math.tan(k),2),A=t*Math.pow(Math.cos(k),2),B=(l-x)*Math.cos(k),C=c*((1-e/4-3*Math.pow(e,2)/64-5*Math.pow(e,3)/256)*k-(3*e/8+3*Math.pow(e,2)/32+45*Math.pow(e,3)/1024)*Math.sin(2*k)+(15*Math.pow(e,2)/256+45*Math.pow(e,3)/1024)*Math.sin(4*k)-35*Math.pow(e,3)/3072*Math.sin(6*k)),D=v+u*n*(B+(1-z+A)*Math.pow(B,3)/6+(5-18*z+Math.pow(z,2)+72*A-58*t)*Math.pow(B,5)/120),E=w+u*(C-y+n*Math.tan(k)*(Math.pow(B,2)/2+(5-z+9*A+4*Math.pow(A,2))*Math.pow(B,4)/24+(61-58*z+Math.pow(z,2)+600*A-330*t)*Math.pow(B,6)/720));return a.x=Math.round(D),a.y=Math.round(E),a}function g(c,d){var e,f,g,h,i,j=Tmap.Projection.addTransform,k=Tmap.Projection.nullTransform;for(e=0,f=d.length;f>e;++e)for(g=d[e],j(c,g,b),j(g,c,a),i=e+1;f>i;++i)h=d[i],j(g,h,k),j(h,g,k)}function h(a,b){var e,f,g,h,i,j=Tmap.Projection.addTransform,k=Tmap.Projection.nullTransform;for(e=0,f=b.length;f>e;++e)for(g=b[e],j(a,g,c),j(g,a,d),i=e+1;f>i;++i)h=b[i],j(g,h,k),j(h,g,k)}function i(a,b){var c,d,g,h,i,j=Tmap.Projection.addTransform,k=Tmap.Projection.nullTransform;for(c=0,d=b.length;d>c;++c)for(g=b[c],j(a,g,e),j(g,a,f),i=c+1;d>i;++i)h=b[i],j(g,h,k),j(h,g,k)}function j(a,b){var c,d,e,f,g,h=Tmap.Projection.addTransform,i=Tmap.Projection.nullTransform;for(c=0,d=b.length;d>c;++c)for(e=b[c],h(a,e,o),h(e,a,n),g=c+1;d>g;++g)f=b[g],h(e,f,i),h(f,e,i)}function k(a,b){var c,d,e,f,g,h=Tmap.Projection.addTransform,i=Tmap.Projection.nullTransform;for(c=0,d=b.length;d>c;++c)for(e=b[c],h(a,e,l),h(e,a,m),g=c+1;d>g;++g)f=b[g],h(e,f,i),h(f,e,i)}function l(a){return b(o(a))}function m(b){return a(n(b))}function n(a){var b=a.y,c=a.x,d=6378137,e=.0033528106647362,f=.00669438,g=128,h=-481,i=-664,j=-739.845,k=-10037499008e-15,l=.0174532925199433*b,m=.0174532925199433*c,n=d*(1-f)/Math.pow(1-f*Math.pow(Math.sin(l),2),1.5),o=d/Math.pow(1-f*Math.pow(Math.sin(l),2),.5),p=(-1*g*Math.sin(l)*Math.cos(m)-h*Math.sin(l)*Math.sin(m)+i*Math.cos(l)+(d*k+e*j)*Math.sin(2*l))/(n*Math.sin(484813681109536e-20)),q=(-1*g*Math.sin(m)+h*Math.cos(m))/(o*Math.cos(l)*Math.sin(484813681109536e-20));return{x:c+q/3600,y:b+p/3600}}function o(a){var b=a.y,c=a.x,d=6377397.155,e=.0033427731821748,f=.006674372,g=-128,h=481,i=664,j=739.845,k=10037499008e-15,l=.0174532925199433*b,m=.0174532925199433*c,n=d*(1-f)/Math.pow(1-f*Math.pow(Math.sin(l),2),1.5),o=d/Math.pow(1-f*Math.pow(Math.sin(l),2),.5),p=(-1*g*Math.sin(l)*Math.cos(m)-h*Math.sin(l)*Math.sin(m)+i*Math.cos(l)+(d*k+e*j)*Math.sin(2*l))/(n*Math.sin(484813681109536e-20)),q=(-1*g*Math.sin(m)+h*Math.cos(m))/(o*Math.cos(l)*Math.sin(484813681109536e-20));return{x:c+q/3600,y:b+p/3600}}var p,q=20037508.34,r=["EPSG:900913","EPSG:3857","EPSG:102113","EPSG:102100"],s=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"],t=["KATECH","TM128","katech"],u=["BESSEL","bessel"];for(p=r.length-1;p>=0;--p)g(r[p],s);for(p=s.length-1;p>=0;--p)g(s[p],r);for(p=t.length-1;p>=0;--p)h(t[p],s),i(t[p],r);for(p=u.length-1;p>=0;--p)j(u[p],s),k(u[p],r)}(),Tmap.Projection.convertBesselToWgs84=function(a){if(a instanceof Array){var b=[];for(var c in a){var d=Tmap.Projection.transforms.BESSEL["EPSG:4326"]({x:a[c].lon,y:a[c].lat});b.push(new Tmap.LonLat(d.x,d.y))}return b}var d=Tmap.Projection.transforms.BESSEL["EPSG:4326"]({x:a.lon,y:a.lat});return new Tmap.LonLat(d.x,d.y)},Tmap.theMap=Tmap.Class({Z_INDEX_BASE:{BaseLayer:100,Overlay:325,Feature:725,Popup:750,Control:1e3},id:null,fractionalZoom:!1,events:null,allOverlays:!1,div:null,dragging:!1,size:null,viewPortDiv:null,layerContainerOrigin:null,layerContainerDiv:null,layers:null,controls:null,popups:null,baseLayer:null,center:null,resolution:null,zoom:0,panRatio:1.5,options:null,tileSize:null,projection:"EPSG:4326",units:null,resolutions:null,maxResolution:null,minResolution:null,maxScale:null,minScale:null,maxExtent:null,minExtent:null,restrictedExtent:null,numZoomLevels:16,theme:null,displayProjection:null,tileManager:null,fallThrough:!1,autoUpdateSize:!0,eventListeners:null,panTween:null,panMethod:Tmap.Easing.Expo.easeOut,panDuration:50,zoomTween:null,zoomMethod:Tmap.Easing.Quad.easeOut,zoomDuration:20,paddingForPopups:null,layerContainerOriginPx:null,minPx:null,maxPx:null,initialize:function(a,b){1===arguments.length&&"object"==typeof a&&(b=a,a=b&&b.div),b.mapTileWidth?this.tileSize=new Tmap.Size(b.mapTileWidth,b.mapTileHeight):this.tileSize=new Tmap.Size(256,256),this.paddingForPopups=new Tmap.Bounds(15,15,15,15),this.theme=Tmap._getScriptLocation()+"theme/default/style.css",this.options=Tmap.Util.extend({},b),Tmap.Util.extend(this,b);var c=this.projection instanceof Tmap.Projection?this.projection.projCode:this.projection;Tmap.Util.applyDefaults(this,Tmap.Projection.defaults[c]),!this.maxExtent||this.maxExtent instanceof Tmap.Bounds||(this.maxExtent=new Tmap.Bounds(this.maxExtent)),!this.minExtent||this.minExtent instanceof Tmap.Bounds||(this.minExtent=new Tmap.Bounds(this.minExtent)),!this.restrictedExtent||this.restrictedExtent instanceof Tmap.Bounds||(this.restrictedExtent=new Tmap.Bounds(this.restrictedExtent)),!this.center||this.center instanceof Tmap.LonLat||(this.center=new Tmap.LonLat(this.center)),this.layers=[],this.id=Tmap.Util.createUniqueID("Tmap.Map_"),this.div=Tmap.Util.getElement(a),this.div||(this.div=document.createElement("div"),this.div.style.height="1px",this.div.style.width="1px"),Tmap.Element.addClass(this.div,"tmMap");var d=this.id+"_Tmap_ViewPort";if(this.viewPortDiv=Tmap.Util.createDiv(d,null,null,null,"relative",null,"hidden"),this.viewPortDiv.style.width="100%",this.viewPortDiv.style.height="100%",this.viewPortDiv.className="tmMapViewport",this.div.appendChild(this.viewPortDiv),this.events=new Tmap.Events(this,this.viewPortDiv,null,this.fallThrough,{includeXY:!0}),this.tileManager&&this.tileManager.addMap(this),d=this.id+"_Tmap_Container",this.layerContainerDiv=Tmap.Util.createDiv(d),this.layerContainerDiv.style.zIndex=this.Z_INDEX_BASE.Popup-1,this.layerContainerOriginPx={x:0,y:0},this.applyTransform(),this.viewPortDiv.appendChild(this.layerContainerDiv),this.updateSize(),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),this.autoUpdateSize===!0&&(this.updateSizeDestroy=Tmap.Function.bind(this.updateSize,this),Tmap.Event.observe(window,"resize",this.updateSizeDestroy)),this.theme){for(var e=!0,f=document.getElementsByTagName("link"),g=0,h=f.length;h>g;++g)if(Tmap.Util.isEquivalentUrl(f.item(g).href,this.theme)){e=!1;break}if(e){var i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",this.theme),document.getElementsByTagName("head")[0].appendChild(i)}}null==this.controls&&(this.controls=[],null!=Tmap.Control&&(Tmap.Control.Navigation?this.controls.push(new Tmap.Control.Navigation):Tmap.Control.TouchNavigation&&this.controls.push(new Tmap.Control.TouchNavigation),Tmap.Control.Zoom?this.controls.push(new Tmap.Control.Zoom):Tmap.Control.PanZoom&&this.controls.push(new Tmap.Control.PanZoom),Tmap.Control.ArgParser&&this.controls.push(new Tmap.Control.ArgParser),Tmap.Control.Attribution&&this.controls.push(new Tmap.Control.Attribution)));for(var g=0,h=this.controls.length;h>g;g++)this.addControlToMap(this.controls[g]);this.popups=[],this.unloadDestroy=Tmap.Function.bind(this.destroy,this),Tmap.Event.observe(window,"unload",this.unloadDestroy),b&&b.layers&&(delete this.center,delete this.zoom,this.addLayers(b.layers),b.center&&!this.getCenter()&&this.setCenter(b.center,b.zoom)),this.panMethod&&(this.panTween=new Tmap.Tween(this.panMethod)),this.zoomMethod&&this.applyTransform.transform&&(this.zoomTween=new Tmap.Tween(this.zoomMethod))},getViewport:function(){return this.viewPortDiv},render:function(a){this.div=Tmap.Util.getElement(a),Tmap.Element.addClass(this.div,"tmMap"),this.viewPortDiv.parentNode.removeChild(this.viewPortDiv),this.div.appendChild(this.viewPortDiv),this.updateSize()},unloadDestroy:null,updateSizeDestroy:null,destroy:function(){if(!this.unloadDestroy)return!1;if(this.panTween&&(this.panTween.stop(),this.panTween=null),this.zoomTween&&(this.zoomTween.stop(),this.zoomTween=null),Tmap.Event.stopObserving(window,"unload",this.unloadDestroy),this.unloadDestroy=null,this.updateSizeDestroy&&Tmap.Event.stopObserving(window,"resize",this.updateSizeDestroy),this.paddingForPopups=null,null!=this.controls){for(var a=this.controls.length-1;a>=0;--a)this.controls[a].destroy();this.controls=null}if(null!=this.layers){for(var a=this.layers.length-1;a>=0;--a)this.layers[a].destroy(!1);this.layers=null}this.viewPortDiv&&this.viewPortDiv.parentNode&&this.viewPortDiv.parentNode.removeChild(this.viewPortDiv),this.viewPortDiv=null,this.tileManager&&(this.tileManager.removeMap(this),this.tileManager=null),this.eventListeners&&(this.events.un(this.eventListeners),this.eventListeners=null),this.events.destroy(),this.events=null,this.options=null},setOptions:function(a){var b=this.minPx&&a.restrictedExtent!=this.restrictedExtent;Tmap.Util.extend(this,a),b&&this.moveTo(this.getCachedCenter(),this.zoom,{forceZoomChange:!0})},getTileSize:function(){return this.tileSize},getBy:function(a,b,c){var d="function"==typeof c.test,e=Tmap.Array.filter(this[a],function(a){return a[b]==c||d&&c.test(a[b])});return e},getLayersBy:function(a,b){return this.getBy("layers",a,b)},getLayersByName:function(a){return this.getLayersBy("name",a)},getLayersByClass:function(a){return this.getLayersBy("CLASS_NAME",a)},getControlsBy:function(a,b){return this.getBy("controls",a,b)},getControlsByClass:function(a){return this.getControlsBy("CLASS_NAME",a)},getLayer:function(a){for(var b=null,c=0,d=this.layers.length;d>c;c++){var e=this.layers[c];if(e.id==a){b=e;break}}return b},setLayerZIndex:function(a,b){a.setZIndex(this.Z_INDEX_BASE[a.isBaseLayer?"BaseLayer":"Overlay"]+5*b)},resetLayersZIndex:function(){for(var a=0,b=this.layers.length;b>a;a++){var c=this.layers[a];this.setLayerZIndex(c,a)}},addLayer:function(a){for(var b=0,c=this.layers.length;c>b;b++)if(this.layers[b]==a)return!1;return this.events.triggerEvent("preaddlayer",{layer:a})===!1?!1:(this.allOverlays&&(a.isBaseLayer=!1),a.div.className="tmLayerDiv",a.div.style.overflow="",this.setLayerZIndex(a,this.layers.length),a.isFixed?this.viewPortDiv.appendChild(a.div):this.layerContainerDiv.appendChild(a.div),this.layers.push(a),a.setMap(this),a.isBaseLayer||this.allOverlays&&!this.baseLayer?null==this.baseLayer?this.setBaseLayer(a):a.setVisibility(!1):a.redraw(),this.events.triggerEvent("addlayer",{layer:a}),a.events.triggerEvent("added",{map:this,layer:a}),a.afterAdd(),!0)},addLayers:function(a){for(var b=0,c=a.length;c>b;b++)this.addLayer(a[b])},removeLayer:function(a,b){if(this.events.triggerEvent("preremovelayer",{layer:a})!==!1){if(null==b&&(b=!0),a.isFixed?this.viewPortDiv.removeChild(a.div):this.layerContainerDiv.removeChild(a.div),Tmap.Util.removeItem(this.layers,a),a.removeMap(this),a.map=null,this.baseLayer==a&&(this.baseLayer=null,b))for(var c=0,d=this.layers.length;d>c;c++){var e=this.layers[c];if(e.isBaseLayer||this.allOverlays){this.setBaseLayer(e);break}}this.resetLayersZIndex(),this.events.triggerEvent("removelayer",{layer:a}),a.events.triggerEvent("removed",{map:this,layer:a})}},getNumLayers:function(){return this.layers.length},getLayerIndex:function(a){return Tmap.Util.indexOf(this.layers,a)},setLayerIndex:function(a,b){var c=this.getLayerIndex(a);if(0>b?b=0:b>this.layers.length&&(b=this.layers.length),c!=b){this.layers.splice(c,1),this.layers.splice(b,0,a);for(var d=0,e=this.layers.length;e>d;d++)this.setLayerZIndex(this.layers[d],d);this.events.triggerEvent("changelayer",{layer:a,property:"order"}),this.allOverlays&&(0===b?this.setBaseLayer(a):this.baseLayer!==this.layers[0]&&this.setBaseLayer(this.layers[0]))}},raiseLayer:function(a,b){var c=this.getLayerIndex(a)+b;this.setLayerIndex(a,c)},setBaseLayer:function(a){if(a!=this.baseLayer&&-1!=Tmap.Util.indexOf(this.layers,a)){var b=this.getCachedCenter(),c=Tmap.Util.getResolutionFromScale(this.getScale(),a.units);if(null==this.baseLayer||this.allOverlays||this.baseLayer.setVisibility(!1),this.baseLayer=a,(!this.allOverlays||this.baseLayer.visibility)&&(this.baseLayer.setVisibility(!0),this.baseLayer.inRange===!1&&this.baseLayer.redraw()),null!=b){var d=this.getZoomForResolution(c||this.resolution,!0);this.setCenter(b,d,!1,!0)}this.events.triggerEvent("changebaselayer",{layer:this.baseLayer})}},addControl:function(a,b){this.controls.push(a),this.addControlToMap(a,b)},addControls:function(a,b){for(var c=1===arguments.length?[]:b,d=0,e=a.length;e>d;d++){var f=a[d],g=c[d]?c[d]:null;this.addControl(f,g)}},addControlToMap:function(a,b){a.outsideViewport=null!=a.div,this.displayProjection&&!a.displayProjection&&(a.displayProjection=this.displayProjection),a.setMap(this);var c=a.draw(b);c&&(a.outsideViewport||(c.style.zIndex=this.Z_INDEX_BASE.Control+this.controls.length,this.viewPortDiv.appendChild(c))),a.autoActivate&&a.activate()},getControl:function(a){for(var b=null,c=0,d=this.controls.length;d>c;c++){var e=this.controls[c];if(e.id==a){b=e;break}}return b},removeControl:function(a){a&&a==this.getControl(a.id)&&(a.div&&a.div.parentNode==this.viewPortDiv&&this.viewPortDiv.removeChild(a.div),Tmap.Util.removeItem(this.controls,a))},addPopup:function(a,b){if(b)for(var c=this.popups.length-1;c>=0;--c)this.removePopup(this.popups[c]);if(a.map=this,a.projection){var d=a.projection,e=this.projection;d.toString()!=e.toString()&&(a.isTransform||(a.lonlat.transform(d,e),a.isTransform=!0))}this.popups.push(a);var f=a.draw();f&&(f.style.zIndex=this.Z_INDEX_BASE.Popup+this.popups.length,this.layerContainerDiv.appendChild(f))},removeAllPopup:function(){for(var a=this.popups.length-1;a>=0;--a)this.removePopup(this.popups[a])},removePopup:function(a){if(Tmap.Util.removeItem(this.popups,a),a.div)try{this.layerContainerDiv.removeChild(a.div)}catch(b){}a.map=null},getSize:function(){var a=null;return null!=this.size&&(a=this.size.clone()),a},updateSize:function(){var a=this.getCurrentSize();if(a&&!isNaN(a.h)&&!isNaN(a.w)){this.events.clearMouseCache();var b=this.getSize();if(null==b&&(this.size=b=a),!a.equals(b)){this.size=a;for(var c=0,d=this.layers.length;d>c;c++)this.layers[c].onMapResize();var e=this.getCachedCenter();if(null!=this.baseLayer&&null!=e){var f=this.getZoom();
this.zoom=null,this.setCenter(e,f)}}}this.events.triggerEvent("updatesize")},getCurrentSize:function(){var a=new Tmap.Size(this.div.clientWidth,this.div.clientHeight);return(0==a.w&&0==a.h||isNaN(a.w)&&isNaN(a.h))&&(a.w=this.div.offsetWidth,a.h=this.div.offsetHeight),(0==a.w&&0==a.h||isNaN(a.w)&&isNaN(a.h))&&(a.w=parseInt(this.div.style.width),a.h=parseInt(this.div.style.height)),a},calculateBounds:function(a,b){var c=null;if(null==a&&(a=this.getCachedCenter()),null==b&&(b=this.getResolution()),null!=a&&null!=b){var d=this.size.w*b/2,e=this.size.h*b/2;c=new Tmap.Bounds(a.lon-d,a.lat-e,a.lon+d,a.lat+e)}return c},getCenter:function(){var a=null,b=this.getCachedCenter();return b&&(a=b.clone()),a},getCachedCenter:function(){return!this.center&&this.size&&(this.center=this.getLonLatFromViewPortPx({x:this.size.w/2,y:this.size.h/2})),this.center},getZoom:function(){return this.zoom},pan:function(a,b,c){if(c=Tmap.Util.applyDefaults(c,{animate:!0,dragging:!1}),c.dragging)(0!=a||0!=b)&&this.moveByPx(a,b);else{var d=this.getViewPortPxFromLonLat(this.getCachedCenter()),e=d.add(a,b);if(this.dragging||!e.equals(d)){var f=this.getLonLatFromViewPortPx(e);c.animate?this.panTo(f):(this.moveTo(f),this.dragging&&(this.dragging=!1,this.events.triggerEvent("moveend")))}}},panTo:function(a){if(this.panTween&&this.getExtent().scale(this.panRatio).containsLonLat(a)){var b=this.getCachedCenter();if(a.equals(b))return;var c=this.getPixelFromLonLat(b),d=this.getPixelFromLonLat(a),e={x:d.x-c.x,y:d.y-c.y},f={x:0,y:0};this.panTween.start({x:0,y:0},e,this.panDuration,{callbacks:{eachStep:Tmap.Function.bind(function(a){var b=a.x-f.x,c=a.y-f.y;this.moveByPx(b,c),f.x=Math.round(a.x),f.y=Math.round(a.y)},this),done:Tmap.Function.bind(function(b){this.moveTo(a),this.dragging=!1,this.events.triggerEvent("moveend")},this)}})}else this.setCenter(a)},setCenter:function(a,b,c,d){this.panTween&&this.panTween.stop(),this.zoomTween&&this.zoomTween.stop(),this.moveTo(a,b,{dragging:c,forceZoomChange:d})},moveByPx:function(a,b){var c=this.size.w/2,d=this.size.h/2,e=c+a,f=d+b,g=this.baseLayer.wrapDateLine,h=0,i=0;if(this.restrictedExtent&&(h=c,i=d,g=!1),a=g||e<=this.maxPx.x-h&&e>=this.minPx.x+h?Math.round(a):0,b=f<=this.maxPx.y-i&&f>=this.minPx.y+i?Math.round(b):0,a||b){this.dragging||(this.dragging=!0,this.events.triggerEvent("movestart")),this.center=null,a&&(this.layerContainerOriginPx.x-=a,this.minPx.x-=a,this.maxPx.x-=a),b&&(this.layerContainerOriginPx.y-=b,this.minPx.y-=b,this.maxPx.y-=b),this.applyTransform();var j,k,l;for(k=0,l=this.layers.length;l>k;++k)j=this.layers[k],j.visibility&&(j===this.baseLayer||j.inRange)&&(j.moveByPx(a,b),j.events.triggerEvent("move"));this.events.triggerEvent("move")}},adjustZoom:function(a){if(this.baseLayer&&this.baseLayer.wrapDateLine){var b=this.baseLayer.resolutions,c=this.getMaxExtent().getWidth()/this.size.w;if(this.getResolutionForZoom(a)>c)if(this.fractionalZoom)a=this.getZoomForResolution(c);else for(var d=0|a,e=b.length;e>d;++d)if(b[d]<=c){a=d;break}}return a},getMinZoom:function(){return this.adjustZoom(0)},moveTo:function(a,b,c){null==a||a instanceof Tmap.LonLat||(a=new Tmap.LonLat(a)),c||(c={}),null!=b&&(b=parseFloat(b),this.fractionalZoom||(b=Math.round(b)));var d=b;b=this.adjustZoom(b),b!==d&&(a=this.getCenter());var e=c.dragging||this.dragging,f=c.forceZoomChange;if(this.getCachedCenter()||this.isValidLonLat(a)||(a=this.maxExtent.getCenterLonLat(),this.center=a.clone()),null!=this.restrictedExtent){null==a&&(a=this.center),null==b&&(b=this.getZoom());var g=this.getResolutionForZoom(b),h=this.calculateBounds(a,g);if(!this.restrictedExtent.containsBounds(h)){var i=this.restrictedExtent.getCenterLonLat();h.getWidth()>this.restrictedExtent.getWidth()?a=new Tmap.LonLat(i.lon,a.lat):h.left<this.restrictedExtent.left?a=a.add(this.restrictedExtent.left-h.left,0):h.right>this.restrictedExtent.right&&(a=a.add(this.restrictedExtent.right-h.right,0)),h.getHeight()>this.restrictedExtent.getHeight()?a=new Tmap.LonLat(a.lon,i.lat):h.bottom<this.restrictedExtent.bottom?a=a.add(0,this.restrictedExtent.bottom-h.bottom):h.top>this.restrictedExtent.top&&(a=a.add(0,this.restrictedExtent.top-h.top))}}var j=f||this.isValidZoomLevel(b)&&b!=this.getZoom(),k=this.isValidLonLat(a)&&!a.equals(this.center);if(j||k||e){e||this.events.triggerEvent("movestart",{zoomChanged:j}),k&&(!j&&this.center&&this.centerLayerContainer(a),this.center=a.clone());var l=j?this.getResolutionForZoom(b):this.getResolution();if(j||null==this.layerContainerOrigin){this.layerContainerOrigin=this.getCachedCenter(),this.layerContainerOriginPx.x=0,this.layerContainerOriginPx.y=0,this.applyTransform();var m=this.getMaxExtent({restricted:!0}),n=m.getCenterLonLat(),o=this.center.lon-n.lon,p=n.lat-this.center.lat,q=Math.round(m.getWidth()/l),r=Math.round(m.getHeight()/l);this.minPx={x:(this.size.w-q)/2-o/l,y:(this.size.h-r)/2-p/l},this.maxPx={x:this.minPx.x+Math.round(m.getWidth()/l),y:this.minPx.y+Math.round(m.getHeight()/l)}}j&&(this.zoom=b,this.resolution=l);var s=this.getExtent();this.baseLayer.visibility&&(this.baseLayer.moveTo(s,j,c.dragging),c.dragging||this.baseLayer.events.triggerEvent("moveend",{zoomChanged:j})),s=this.baseLayer.getExtent();for(var t=this.layers.length-1;t>=0;--t){var u=this.layers[t];if(u!==this.baseLayer&&!u.isBaseLayer){var v=u.calculateInRange();u.inRange!=v&&(u.inRange=v,v||u.display(!1)),v&&u.visibility&&(u.moveTo(s,j,c.dragging),c.dragging||u.events.triggerEvent("moveend",{zoomChanged:j}))}}if(this.events.triggerEvent("move"),e||this.events.triggerEvent("moveend"),j){for(var t=0,w=this.popups.length;w>t;t++)this.popups[t].updatePosition();this.events.triggerEvent("zoomend")}}},centerLayerContainer:function(a){var b=this.getViewPortPxFromLonLat(this.layerContainerOrigin),c=this.getViewPortPxFromLonLat(a);if(null!=b&&null!=c){var d=this.layerContainerOriginPx.x,e=this.layerContainerOriginPx.y,f=Math.round(b.x-c.x),g=Math.round(b.y-c.y);this.applyTransform(this.layerContainerOriginPx.x=f,this.layerContainerOriginPx.y=g);var h=d-f,i=e-g;this.minPx.x-=h,this.maxPx.x-=h,this.minPx.y-=i,this.maxPx.y-=i}},isValidZoomLevel:function(a){return null!=a&&a>=0&&a<this.getNumZoomLevels()},isValidLonLat:function(a){var b=!1;if(null!=a){var c=this.getMaxExtent(),d=this.baseLayer.wrapDateLine&&c;b=c.containsLonLat(a,{worldBounds:d})}return b},getProjection:function(){var a=this.getProjectionObject();return a?a.getCode():null},getProjectionObject:function(){var a=null;return null!=this.baseLayer&&(a=this.baseLayer.projection),a},getMaxResolution:function(){var a=null;return null!=this.baseLayer&&(a=this.baseLayer.maxResolution),a},getMaxExtent:function(a){var b=null;return a&&a.restricted&&this.restrictedExtent?b=this.restrictedExtent:null!=this.baseLayer&&(b=this.baseLayer.maxExtent),b},getNumZoomLevels:function(){var a=null;return null!=this.baseLayer&&(a=this.baseLayer.numZoomLevels),a},getExtent:function(){var a=null;return null!=this.baseLayer&&(a=this.baseLayer.getExtent()),a},getResolution:function(){var a=null;return null!=this.baseLayer?a=this.baseLayer.getResolution():this.allOverlays===!0&&this.layers.length>0&&(a=this.layers[0].getResolution()),a},getUnits:function(){var a=null;return null!=this.baseLayer&&(a=this.baseLayer.units),a},getScale:function(){var a=null;if(null!=this.baseLayer){var b=this.getResolution(),c=this.baseLayer.units;a=Tmap.Util.getScaleFromResolution(b,c)}return a},getZoomForExtent:function(a,b){var c=null;return null!=this.baseLayer&&(c=this.baseLayer.getZoomForExtent(a,b)),c},getResolutionForZoom:function(a){var b=null;return this.baseLayer&&(b=this.baseLayer.getResolutionForZoom(a)),b},getZoomForResolution:function(a,b){var c=null;return null!=this.baseLayer&&(c=this.baseLayer.getZoomForResolution(a,b)),c},zoomTo:function(a,b){var c=this;if(c.isValidZoomLevel(a))if(c.baseLayer.wrapDateLine&&(a=c.adjustZoom(a)),c.zoomTween){var d=c.getResolution(),e=c.getResolutionForZoom(a),f={scale:1},g={scale:d/e};if(c.zoomTween.playing&&c.zoomTween.duration<3*c.zoomDuration)c.zoomTween.finish={scale:c.zoomTween.finish.scale*g.scale};else{if(!b){var h=c.getSize();b={x:h.w/2,y:h.h/2}}c.zoomTween.start(f,g,c.zoomDuration,{minFrameRate:50,callbacks:{eachStep:function(a){var d=c.layerContainerOriginPx,e=a.scale,f=(e-1)*(d.x-b.x)|0,g=(e-1)*(d.y-b.y)|0;c.applyTransform(d.x+f,d.y+g,e)},done:function(a){c.applyTransform();var d=c.getResolution()/a.scale,e=c.getZoomForResolution(d,!0);c.moveTo(c.getZoomTargetCenter(b,d),e,!0)}}})}}else{var i=b?c.getZoomTargetCenter(b,c.getResolutionForZoom(a)):null;c.setCenter(i,a)}},zoomIn:function(){this.zoomTo(this.getZoom()+1)},zoomOut:function(){this.zoomTo(this.getZoom()-1)},zoomToExtent:function(a,b){a instanceof Tmap.Bounds||(a=new Tmap.Bounds(a));var c=a.getCenterLonLat();if(this.baseLayer.wrapDateLine){var d=this.getMaxExtent();for(a=a.clone();a.right<a.left;)a.right+=d.getWidth();c=a.getCenterLonLat().wrapDateLine(d)}this.setCenter(c,this.getZoomForExtent(a,b))},zoomToMaxExtent:function(a){var b=a?a.restricted:!0,c=this.getMaxExtent({restricted:b});this.zoomToExtent(c)},zoomToScale:function(a,b){var c=Tmap.Util.getResolutionFromScale(a,this.baseLayer.units),d=this.size.w*c/2,e=this.size.h*c/2,f=this.getCachedCenter(),g=new Tmap.Bounds(f.lon-d,f.lat-e,f.lon+d,f.lat+e);this.zoomToExtent(g,b)},getLonLatFromViewPortPx:function(a){var b=null;return null!=this.baseLayer&&(b=this.baseLayer.getLonLatFromViewPortPx(a)),b},getViewPortPxFromLonLat:function(a){var b=null;return null!=this.baseLayer&&(b=this.baseLayer.getViewPortPxFromLonLat(a)),b},getZoomTargetCenter:function(a,b){var c=null,d=this.getSize(),e=d.w/2-a.x,f=a.y-d.h/2,g=this.getLonLatFromPixel(a);return g&&(c=new Tmap.LonLat(g.lon+e*b,g.lat+f*b)),c},getLonLatFromPixel:function(a){return this.getLonLatFromViewPortPx(a)},getPixelFromLonLat:function(a){var b=this.getViewPortPxFromLonLat(a);return b.x=Math.round(b.x),b.y=Math.round(b.y),b},getGeodesicPixelSize:function(a){var b=a?this.getLonLatFromPixel(a):this.getCachedCenter()||new Tmap.LonLat(0,0),c=this.getResolution(),d=b.add(-c/2,0),e=b.add(c/2,0),f=b.add(0,-c/2),g=b.add(0,c/2),h=new Tmap.Projection("EPSG:4326"),i=this.getProjectionObject()||h;return i.equals(h)||(d.transform(i,h),e.transform(i,h),f.transform(i,h),g.transform(i,h)),new Tmap.Size(Tmap.Util.distVincenty(d,e),Tmap.Util.distVincenty(f,g))},getViewPortPxFromLayerPx:function(a){var b=null;if(null!=a){var c=this.layerContainerOriginPx.x,d=this.layerContainerOriginPx.y;b=a.add(c,d)}return b},getLayerPxFromViewPortPx:function(a){var b=null;if(null!=a){var c=-this.layerContainerOriginPx.x,d=-this.layerContainerOriginPx.y;b=a.add(c,d),(isNaN(b.x)||isNaN(b.y))&&(b=null)}return b},getLonLatFromLayerPx:function(a){return a=this.getViewPortPxFromLayerPx(a),this.getLonLatFromViewPortPx(a)},getLayerPxFromLonLat:function(a){var b=this.getPixelFromLonLat(a);return this.getLayerPxFromViewPortPx(b)},applyTransform:function(a,b,c){c=c||1;var d=this.layerContainerOriginPx,e=1!==c;a=a||d.x,b=b||d.y;var f=this.layerContainerDiv.style,g=this.applyTransform.transform,h=this.applyTransform.template;if(void 0===g&&(g=Tmap.Util.vendorPrefix.style("transform"),this.applyTransform.transform=g,g)){var i=Tmap.Element.getStyle(this.viewPortDiv,Tmap.Util.vendorPrefix.css("transform"));i&&"none"===i||(h=["translate3d(",",0) ","scale3d(",",1)"],f[g]=[h[0],"0,0",h[1]].join("")),h&&~f[g].indexOf(h[0])||(h=["translate(",") ","scale(",")"]),this.applyTransform.template=h}null===g||"translate3d("!==h[0]&&e!==!0?(f.left=a+"px",f.top=b+"px",null!==g&&(f[g]="")):(e===!0&&"translate("===h[0]&&(a-=d.x,b-=d.y,f.left=d.x+"px",f.top=d.y+"px"),f[g]=[h[0],a,"px,",b,"px",h[1],h[2],c,",",c,h[3]].join(""))},CLASS_NAME:"Tmap.theMap"}),Tmap.Map=Tmap.Class(Tmap.theMap,{initCenterLon:14135907.985445,initCenterLat:4518362.8579052,initZoomLevel:15,mapTileType:"hd",transitionEffect:null,animation:!0,initProj:new Tmap.Projection("EPSG:3857"),numZoomLevels:20,minZoom:0,maxZoom:19,restrictedExtent:null,mapTileSize:256,bufferSize:2,TMSParam:"",width:"",height:"",attribution:"<img src = 'https://topopentile1.tmap.co.kr/tmaplibv20/img/powered-by-T-map_comms.png' />",bLayer:{},oLayer:{},iLayer:null,indoor:null,infoLayer:{},ctrl_nav:{},ctrl_panzoom:{},ctrl_scale:{},ctrl_arg:{},ctrl_info:{},ctrl_cache_r:{},ctrl_permalink:{},invokeClass:{},ignoreOSM:!1,baseProjection:null,language:"KR",contrast:"normal",bizAppId:null,bdValidated:!0,httpModule:null,attributionAlign:null,httpsMode:false,initialize:function(){if(arguments[0].div){var a=arguments[0],b=document.getElementById(a.div);if(a.httpsMode){this.httpsMode=a.httpsMode};a.attribution&&(this.attribution=a.attribution),a.type&&(this.mapTileType=a.type),a.baseProjection&&(this.baseProjection=a.baseProjection),a.width&&("number"==typeof a.width?b.style.width=a.width+"px":b.style.width=a.width),this.width=b.style.width,a.height&&("number"==typeof a.height?b.style.height=a.height+"px":b.style.height=a.height),this.height=b.style.height,(1==a.animation||1==this.animation)&&(a.transitionEffect="resize",this.transitionEffect="resize"),this.getBranch()>0&&(this.bufferSize=0),512==parseInt(a.mapTileSize,10)&&(this.mapTileSize=512),this.ctrl_nav=new Tmap.Control.Navigation({documentDrag:!0}),this.getBranch()>0?this.ctrl_panzoom=new Tmap.Control.Zoom:this.ctrl_panzoom=new Tmap.Control.ZoomBar,this.ctrl_scale=new Tmap.Control.ScaleLine({geodesic:!0}),this.ctrl_arg=new Tmap.Control.ArgParser,this.ctrl_info=new Tmap.Control.Attribution;var c=Tmap.Util.extend({},a);c.maxResolution=156543.033928041,c.units="m",c.projection||(c.projection=this.initProj),c.mapTileWidth=this.mapTileSize,c.mapTileHeight=this.mapTileSize,c.mapTileType=this.mapTileType,c.controls=[this.ctrl_nav,this.ctrl_panzoom,this.ctrl_scale,this.ctrl_arg,this.ctrl_info];var d=[a.div,c];if(Tmap.theMap.prototype.initialize.apply(this,d),this.attributionAlign&&this.ctrl_info.setAlignH(this.attributionAlign),this.oLayer=new Tmap.Layer.OSM("osm",null,{isBaseLayer:!0,numZoomLevels:this.numZoomLevels}),this.bLayer=this.getCurrentBaseTile(),this.validateIndoorInfo()){switch(this.indoor.bldId){case"L03000000200025":this.setIndoorDatasToAreaManager(15);break;default:this.setIndoorDatasToAreaManager(17)}this.restrictedExtent=this.areaManager.getRestrictedExtent("indoor"),this.minZoom=this.areaManager.getMinZoom("indoor"),this.maxZoom=this.areaManager.getMaxZoom("indoor"),this.numZoomLevels=this.areaManager.getNumZoomLevels("indoor"),this.iLayer=this.getIndoorTile(),this.addLayers([this.iLayer]),this.setCenter(this.areaManager.getCenter("indoor"),this.areaManager.getMinZoom("indoor"))}else this.addLayers([this.bLayer]);this.events.register("moveend",this,this.onSwitchOSMAndTmap),this.setParamInfo(),this.moveToCenter(),Tmap.TmapAppInvoke&&(this.invokeClass=new Tmap.TmapAppInvoke(this))}else Tmap.theMap.prototype.initialize.apply(this,arguments)},setIndoorDatasToAreaManager:function(a){this.areaManager.setRestrictedExtent("common",this.restrictedExtent),this.areaManager.setCenter("common",this.center),this.areaManager.setZoomDatas("common",this.minZoom,this.maxZoom,this.numZoomLevels),a=a?a:17,this.areaManager.setZoomDatas("indoor",a,21,22),this.areaManager.setRestrictedExtent("indoor",this.indoor.restrictedExtent),this.areaManager.setCenter("indoor",this.indoor.centerLonLat)},getCurrentBaseTile:function(){this.tileParamFunc();var a;return a="high"==this.contrast?new Tmap.Layer.TMS("TmapBaseTile","http://topkoctile.tmap.co.kr/tms/",{displayInLayerSwitcher:!1,isBaseLayer:!0,layername:this.srvNameObj.KR.sd.layername.high,type:"png",numZoomLevels:this.numZoomLevels,buffer:this.bufferSize,transitionEffect:this.transitionEffect,attribution:this.attribution}):new Tmap.Layer.TMS("TmapBaseTile",this.httpsMode === true ? this.srvNameObj[this.language][this.mapTileType].urlhttps : this.srvNameObj[this.language][this.mapTileType].url,{displayInLayerSwitcher:!1,isBaseLayer:!0,layername:this.srvNameObj[this.language][this.mapTileType].layername[this.contrast],type:"png",numZoomLevels:this.numZoomLevels,buffer:this.bufferSize,transitionEffect:this.transitionEffect,attribution:this.attribution})},getMapArea:function(a,b){return this.ignoreOSM?"b":a>5?this.baseProjection?"b":a>=14&&16>=a?b.lon>13837150&&b.lon<14692611&&b.lat>3698690&&b.lat<3863450||b.lon>136e5&&b.lon<148e5&&b.lat>38e5&&b.lat<48e5?"b":"o":a>=17&&19>=a?b.lon>13912701&&b.lon<13940681&&b.lat>3758406&&b.lat<3787201||b.lon>136e5&&b.lon<148e5&&b.lat>38e5&&b.lat<48e5?"b":"o":b.lon>13e6&&b.lon<148e5&&b.lat>37e5&&b.lat<48e5?"b":"o":"b"},onSwitchOSMAndTmap:function(a){this.ignoreOSM||this.switchTile(this.getMapArea(this.getZoom(),this.getCenter()))},switchTile:function(a){switch(a){case"b":"osm"==this.baseLayer.name&&(this.removeLayer(this.oLayer),this.addLayer(this.bLayer));break;case"o":"osm"!=this.baseLayer.name&&(this.removeLayer(this.bLayer),this.addLayer(this.oLayer))}},removeAllControls:function(){for(var a=this.controls.length,b=0;a>b;b++)this.removeControl(this.controls[0])},addMarker:function(){"Tmap.Marker"==arguments[0].CLASS_NAME?Tmap.theMap.prototype.addMarker.apply(this,arguments):"Tmap.Popup"==arguments[0].CLASS_NAME&&Tmap.theMap.prototype.addPopup.apply(this,arguments)},setParamInfo:function(){this.TMSParam="?bizAppId="+Tmap.Util.getParameterFromURL("appKey"),this.tileVersion?this.TMSParam+="?v="+this.tileVersion+"&version=20220406":this.TMSParam+="?v="+Tmap.VERSION_NUMBER+"&version=20220406"},getBranch:function(){var a=navigator.userAgent.toLowerCase();return a=a.match(/iphone/i)?1:a.match(/android/i)?2:a.match(/ipod/i)?3:a.match(/blackberry/i)?4:a.match(/webos/i)?5:a.match(/ipad/i)?6:0},removeZoomControl:function(){for(var a=0;a<this.controls.length;a++)if(this.ctrl_panzoom==this.controls[a]){this.removeControl(this.ctrl_panzoom);break}},addZoomControl:function(){for(var a=0;a<this.controls.length;a++)if(this.ctrl_panzoom==this.controls[a])return;this.getBranch()>0?this.ctrl_panzoom=new Tmap.Control.Zoom:this.ctrl_panzoom=new Tmap.Control.ZoomBar,this.addControl(this.ctrl_panzoom)},moveToCenter:function(){this.getCenter()||this.setCenter(new Tmap.LonLat(this.initCenterLon,this.initCenterLat),this.initZoomLevel)},tmapAppInvoke:function(a){this.invokeClass.invoke(a)},setContrast:function(a,b){0!=this.bdValidated&&(this.contrast=a,"KR"!=this.language&&(this.language="KR"),this.tileParamFunc(),b||(this.baseLayer.url=this.srvNameObj[this.language][this.mapTileType].url,this.baseLayer.layername=this.srvNameObj[this.language][this.mapTileType].layername[this.contrast],"high"==a&&(this.baseLayer.url="http://topkoctile.tmap.co.kr/tms/",this.baseLayer.layername=this.srvNameObj.KR.sd.layername.high),this.baseLayer.redraw()))},setLanguage:function(a,b){0!=this.bdValidated&&(this.contrast="normal",this.language=a,this.tileParamFunc(),b||(this.baseLayer.url=this.srvNameObj[this.language][this.mapTileType].url,this.baseLayer.layername=this.srvNameObj[this.language][this.mapTileType].layername[this.contrast],this.baseLayer.redraw()))},tileParamFunc:function(){try{var a=this.srvNameObj[this.language][this.mapTileType].paramname[this.contrast],b=this.getXMLHttpRequest(),c="";c="http:"==location.protocol?"http://apis.openapi.sk.com/tmap/js?version=2&type=":"https://apis.openapi.sk.com/tmap/js?version=1&type=",c+="&appKey="+Tmap.Util.getParameterFromURL("appKey")/*,b.scope=this,b.open("GET",c,!1),b.send()*/}catch(d){}},setBizAppIdValidate:function(a){this.bdValidated=a,a?(this.language&&this.setLanguage(this.language,!0),this.contrast&&this.setContrast(this.contrast,!0)):(this.language=Tmap.LANGUAGE_KOREAN,this.contrast=Tmap.CONTRAST_NORMAL)},validateBzId:function(){return void this.setBizAppIdValidate(!0)},cbFunc:function(a){if(a.readyState){if(4==a.readyState)if(a.responseXML)this.responseXML=a.responseXML,"OK"==this.responseXML.firstChild.firstChild.textContent?this.setBizAppIdValidate(!0):this.setBizAppIdValidate(!1);else if(a.responseText)if(window.DOMParser){var b=new DOMParser;this.responseXML=b.parseFromString(a.responseText,"text/xml")}else{var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";var d=c.loadXML(a.responseText);if(!d)return void this.setBizAppIdValidate(!1);this.responseXML=c,"OK"==this.responseXML.firstChild.firstChild.textContent?this.setBizAppIdValidate(!0):this.setBizAppIdValidate(!1)}}else;},cbFuncIE:function(a,b){switch(b){case"onComplete":var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false",c.loadXML(a.responseText),this.responseXML=c,"OK"==this.responseXML.firstChild.firstChild.textContent?this.setBizAppIdValidate(!0):this.setBizAppIdValidate(!1);break;case"onError":this.setBizAppIdValidate(!1)}},getXMLHttpRequest:function(){if(window.XDomainRequest)try{return this.httpModule="XDomainRequest",new XDomainRequest}catch(a){return this.httpModule=null,null}else{if(!window.ActiveXObject)return window.XMLHttpRequest?(this.httpModule="XMLHttpRequest",new Tmap.Request.XMLHttpRequest):(this.httpModule=null,null);try{return this.httpModule="XMLHTTP",new ActiveXObject("Microsoft.XMLHTTP")}catch(a){return this.httpModule=null,null}}},getXMLHttpRequestIE8:function(){if(!window.ActiveXObject)return window.XMLHttpRequest?(this.httpModule="XMLHttpRequest",new Tmap.Request.XMLHttpRequest):(this.httpModule=null,null);try{return this.httpModule="XMLHTTP",new ActiveXObject("Microsoft.XMLHTTP")}catch(a){return this.httpModule=null,null}},srvNameObj:{CN:{sd:{url:"http://topcnbtile.tmap.co.kr/tms/",paramname:{normal:"jsTileCnHd",high:"jsTileCnHd"},layername:{normal:"topCnBase",high:"topCnBase"}},hd:{url:"http://topcnbtile.tmap.co.kr/tms/",paramname:{normal:"jsTileCnHd",high:"jsTileCnHd"},layername:{normal:"topCnBase",high:"topCnBase"}}},EN:{sd:{url:"http://topenbtile.tmap.co.kr/tms/",paramname:{normal:"jsTileEnHd",high:"jsTileEnHd"},layername:{normal:"topEnBase",high:"topEnBase"}},hd:{url:"http://topenbtile.tmap.co.kr/tms/",paramname:{normal:"jsTileEnHd",high:"jsTileEnHd"},layername:{normal:"topEnBase",high:"topEnBase"}}},KR:{sd:{url:"http://topsdbtile.tmap.co.kr/tms/",paramname:{normal:"jsTileKoSd",high:"jsTileKoHc"},layername:{normal:"topKoBaseSD",high:"topKoContrast"}},hd:{url:["http://topopentile1.tmap.co.kr/tms/","http://topopentile2.tmap.co.kr/tms/","http://topopentile3.tmap.co.kr/tms/"],urlhttps:["https://topopentile1.tmap.co.kr/tms/","https://topopentile2.tmap.co.kr/tms/","https://topopentile3.tmap.co.kr/tms/"],paramname:{normal:"jsTileKoHd",high:"jsTileKoHc"},layername:{normal:"hd_tile",high:"hd_tile"}}}},getIndoorTile:function(){var a;return a=new Tmap.Layer.TMS("indoor","http://1.234.67.20/tms/",{displayInLayerSwitcher:!1,isBaseLayer:!0,layername:"indoor/"+this.indoor.bldId+"/"+this.indoor.floorId,type:"png",buffer:this.bufferSize,transitionEffect:this.transitionEffect,attribution:this.attribution})},indoorMode:function(a){if(a){if(!this.validateIndoorInfo()){var b="indoor%20%EC%98%B5%EC%85%98%20%EC%A0%95%EB%B3%B4%EA%B0%80%20%EC%97%86%EC%8A%B5%EB%8B%88%EB%8B%A4.%20indoor%20%EB%AA%A8%EB%93%9C%EB%A5%BC%20%EC%82%AC%EC%9A%A9%20%ED%95%A0%20%EC%88%98%20%EC%97%86%EC%8A%B5%EB%8B%88%EB%8B%A4.",c=decodeURIComponent(b);return void alert(c)}if("indoor"!=this.baseLayer.name){var d=this.indoor.restrictedExtent.containsLonLat(this.getCenter());this.removeLayer(this.bLayer),this.minZoom=this.areaManager.getMinZoom("indoor"),this.maxZoom=this.areaManager.getMaxZoom("indoor"),this.numZoomLevels=this.areaManager.getNumZoomLevels("indoor"),this.restrictedExtent=this.areaManager.getRestrictedExtent("indoor"),this.addLayer(this.iLayer),0==d&&this.setCenter(this.indoor.centerLonLat)}}else"indoor"==this.baseLayer.name&&(this.removeLayer(this.iLayer),this.minZoom=this.areaManager.getMinZoom("common"),this.maxZoom=this.areaManager.getMaxZoom("common"),this.numZoomLevels=this.areaManager.getNumZoomLevels("common"),this.restrictedExtent=this.areaManager.getRestrictedExtent("common"),this.addLayer(this.bLayer))},changeFloor:function(a,b){if("indoor"!=this.baseLayer.name){var c="%EC%A7%80%EB%8F%84%EC%9D%98%20%EB%A7%B5%20%ED%83%80%EC%9D%BC%EC%9D%B4%20indoor%20%EB%AA%A8%EB%93%9C%EA%B0%80%20%EC%95%84%EB%8B%99%EB%8B%88%EB%8B%A4.%20changeFloor%ED%95%A8%EC%88%98%EB%8A%94%20indoor%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C%EB%A7%8C%20%EC%82%AC%EC%9A%A9%ED%95%A0%20%EC%88%98%20%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4.",d=decodeURIComponent(c);alert(d)}else this.indoor.floorId=a,this.baseLayer.layername="indoor/"+this.indoor.bldId+"/"+a,b&&this.zoomToExtent(this.indoor.restrictedExtent),this.baseLayer.redraw()},validateIndoorInfo:function(){return this.indoor?!0:!1},areaManager:{common:{},indoor:{},getMinZoom:function(a){return this[a].minZoom},setMinZoom:function(a,b){this[a].minZoom=b},getMaxZoom:function(a){return this[a].maxZoom},setMaxZoom:function(a,b){this[a].maxZoom=b},getNumZoomLevels:function(a){return this[a].numZoomLevels},setNumZoomLevels:function(a,b){this[a].numZoomLevels=b},getRestrictedExtent:function(a){return this[a].restrictedExtent},setRestrictedExtent:function(a,b){this[a].restrictedExtent=b},getCenter:function(a){return this[a].center},setCenter:function(a,b){this[a].center=b},setZoomDatas:function(a,b,c,d){this[a].minZoom=b,this[a].maxZoom=c,this[a].numZoomLevels=d}},CLASS_NAME:"Tmap.Map"}),Tmap.LANGUAGE_KOREAN="KR",Tmap.LANGUAGE_CHINESE="CN",Tmap.LANGUAGE_ENGLISH="EN",Tmap.CONTRAST_NORMAL="normal",Tmap.CONTRAST_HIGH="high",Tmap.Layer=Tmap.Class({id:null,name:null,div:null,opacity:1,alwaysInRange:null,RESOLUTION_PROPERTIES:["scales","resolutions","maxScale","minScale","maxResolution","minResolution","numZoomLevels","maxZoomLevel"],events:null,map:null,isBaseLayer:!1,alpha:!1,displayInLayerSwitcher:!0,visibility:!0,attribution:null,inRange:!1,imageSize:null,options:null,eventListeners:null,gutter:0,projection:null,units:null,scales:null,resolutions:null,maxExtent:null,minExtent:null,maxResolution:null,minResolution:null,numZoomLevels:null,minScale:null,maxScale:null,displayOutsideMaxExtent:!1,wrapDateLine:!1,metadata:null,initialize:function(a,b){this.metadata={},b=Tmap.Util.extend({},b),null!=this.alwaysInRange&&(b.alwaysInRange=this.alwaysInRange),this.addOptions(b),this.name=a,null==this.id&&(this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_"),this.div=Tmap.Util.createDiv(this.id),this.div.style.width="100%",this.div.style.height="100%",this.div.dir="ltr",this.events=new Tmap.Events(this,this.div),this.eventListeners instanceof Object&&this.events.on(this.eventListeners))},destroy:function(a){null==a&&(a=!0),null!=this.map&&this.map.removeLayer(this,a),this.projection=null,this.map=null,this.name=null,this.div=null,this.options=null,this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy()),this.eventListeners=null,this.events=null},clone:function(a){return null==a&&(a=new Tmap.Layer(this.name,this.getOptions())),Tmap.Util.applyDefaults(a,this),a.map=null,a},getOptions:function(){var a={};for(var b in this.options)a[b]=this[b];return a},setName:function(a){a!=this.name&&(this.name=a,null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"name"}))},addOptions:function(a,b){if(null==this.options&&(this.options={}),a&&("string"==typeof a.projection&&(a.projection=new Tmap.Projection(a.projection)),a.projection&&Tmap.Util.applyDefaults(a,Tmap.Projection.defaults[a.projection.getCode()]),!a.maxExtent||a.maxExtent instanceof Tmap.Bounds||(a.maxExtent=new Tmap.Bounds(a.maxExtent)),!a.minExtent||a.minExtent instanceof Tmap.Bounds||(a.minExtent=new Tmap.Bounds(a.minExtent))),Tmap.Util.extend(this.options,a),Tmap.Util.extend(this,a),this.projection&&this.projection.getUnits()&&(this.units=this.projection.getUnits()),this.map){var c=this.map.getResolution(),d=this.RESOLUTION_PROPERTIES.concat(["projection","units","minExtent","maxExtent"]);for(var e in a)if(a.hasOwnProperty(e)&&Tmap.Util.indexOf(d,e)>=0){this.initResolutions(),b&&this.map.baseLayer===this&&(this.map.setCenter(this.map.getCenter(),this.map.getZoomForResolution(c),!1,!0),this.map.events.triggerEvent("changebaselayer",{layer:this}));break}}},onMapResize:function(){},redraw:function(){var a=!1;if(this.map){this.inRange=this.calculateInRange();var b=this.getExtent();if(b&&this.inRange&&this.visibility){var c=!0;this.moveTo(b,c,!1),this.events.triggerEvent("moveend",{zoomChanged:c}),a=!0}}return a},moveTo:function(a,b,c){var d=this.visibility;this.isBaseLayer||(d=d&&this.inRange),this.display(d)},moveByPx:function(a,b){},setMap:function(a){if(null==this.map){if(this.map=a,this.maxExtent=this.maxExtent||this.map.maxExtent,this.minExtent=this.minExtent||this.map.minExtent,this.projection=this.projection||this.map.projection,"string"==typeof this.projection&&(this.projection=new Tmap.Projection(this.projection)),this.units=this.projection.getUnits()||this.units||this.map.units,this.initResolutions(),!this.isBaseLayer){this.inRange=this.calculateInRange();var b=this.visibility&&this.inRange;this.div.style.display=b?"":"none"}this.setTileSize()}},afterAdd:function(){},removeMap:function(a){},getImageSize:function(a){return this.imageSize||this.tileSize},setTileSize:function(a){var b=a?a:this.tileSize?this.tileSize:this.map.getTileSize();this.tileSize=b,this.gutter&&(this.imageSize=new Tmap.Size(b.w+2*this.gutter,b.h+2*this.gutter))},getVisibility:function(){return this.visibility},setVisibility:function(a){a!=this.visibility&&(this.visibility=a,this.display(a),this.redraw(),this.events.triggerEvent("visibilitychanged"))},display:function(a){a!=("none"!=this.div.style.display)&&(this.div.style.display=a&&this.calculateInRange()?"block":"none",this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"visibility"}))},calculateInRange:function(){var a=!1;if(this.alwaysInRange)a=!0;else if(this.map){var b=this.map.getResolution();a=b>=this.minResolution&&b<=this.maxResolution}return a},setIsBaseLayer:function(a){a!=this.isBaseLayer&&(this.isBaseLayer=a,null!=this.map&&this.map.events.triggerEvent("changebaselayer",{layer:this}))},initResolutions:function(){var a,b,c,d={},e=!0;for(a=0,b=this.RESOLUTION_PROPERTIES.length;b>a;a++)c=this.RESOLUTION_PROPERTIES[a],d[c]=this.options[c],e&&this.options[c]&&(e=!1);if(null==this.options.alwaysInRange&&(this.alwaysInRange=e),null==d.resolutions&&(d.resolutions=this.resolutionsFromScales(d.scales)),null==d.resolutions&&(d.resolutions=this.calculateResolutions(d)),null==d.resolutions){for(a=0,b=this.RESOLUTION_PROPERTIES.length;b>a;a++)c=this.RESOLUTION_PROPERTIES[a],d[c]=null!=this.options[c]?this.options[c]:this.map[c];null==d.resolutions&&(d.resolutions=this.resolutionsFromScales(d.scales)),null==d.resolutions&&(d.resolutions=this.calculateResolutions(d))}var f;this.options.maxResolution&&"auto"!==this.options.maxResolution&&(f=this.options.maxResolution),this.options.minScale&&(f=Tmap.Util.getResolutionFromScale(this.options.minScale,this.units));var g;if(this.options.minResolution&&"auto"!==this.options.minResolution&&(g=this.options.minResolution),this.options.maxScale&&(g=Tmap.Util.getResolutionFromScale(this.options.maxScale,this.units)),d.resolutions&&(d.resolutions.sort(function(a,b){return b-a}),f||(f=d.resolutions[0]),!g)){var h=d.resolutions.length-1;g=d.resolutions[h]}if(this.resolutions=d.resolutions,this.resolutions){for(b=this.resolutions.length,this.scales=new Array(b),a=0;b>a;a++)this.scales[a]=Tmap.Util.getScaleFromResolution(this.resolutions[a],this.units);this.numZoomLevels=b}this.minResolution=g,g&&(this.maxScale=Tmap.Util.getScaleFromResolution(g,this.units)),this.maxResolution=f,f&&(this.minScale=Tmap.Util.getScaleFromResolution(f,this.units))},resolutionsFromScales:function(a){if(null!=a){var b,c,d;for(d=a.length,b=new Array(d),c=0;d>c;c++)b[c]=Tmap.Util.getResolutionFromScale(a[c],this.units);return b}},calculateResolutions:function(a){var b,c,d,e=a.maxResolution;null!=a.minScale?e=Tmap.Util.getResolutionFromScale(a.minScale,this.units):"auto"==e&&null!=this.maxExtent&&(b=this.map.getSize(),c=this.maxExtent.getWidth()/b.w,d=this.maxExtent.getHeight()/b.h,e=Math.max(c,d));var f=a.minResolution;if(null!=a.maxScale?f=Tmap.Util.getResolutionFromScale(a.maxScale,this.units):"auto"==a.minResolution&&null!=this.minExtent&&(b=this.map.getSize(),c=this.minExtent.getWidth()/b.w,d=this.minExtent.getHeight()/b.h,f=Math.max(c,d)),"number"!=typeof e&&"number"!=typeof f&&null!=this.maxExtent){var g=this.map.getTileSize();e=Math.max(this.maxExtent.getWidth()/g.w,this.maxExtent.getHeight()/g.h)}var h=a.maxZoomLevel,i=a.numZoomLevels;
if("number"==typeof f&&"number"==typeof e&&void 0===i){var j=e/f;i=Math.floor(Math.log(j)/Math.log(2))+1}else void 0===i&&null!=h&&(i=h+1);if(!("number"!=typeof i||0>=i||"number"!=typeof e&&"number"!=typeof f)){var k=new Array(i),l=2;"number"==typeof f&&"number"==typeof e&&(l=Math.pow(e/f,1/(i-1)));var m;if("number"==typeof e)for(m=0;i>m;m++)k[m]=e/Math.pow(l,m);else for(m=0;i>m;m++)k[i-1-m]=f*Math.pow(l,m);return k}},getResolution:function(){var a=this.map.getZoom();return this.getResolutionForZoom(a)},getExtent:function(){return this.map.calculateBounds()},getZoomForExtent:function(a,b){var c=this.map.getSize(),d=Math.max(a.getWidth()/c.w,a.getHeight()/c.h);return this.getZoomForResolution(d,b)},getDataExtent:function(){},getResolutionForZoom:function(a){a=Math.max(0,Math.min(a,this.resolutions.length-1));var b;if(this.map.fractionalZoom){var c=Math.floor(a),d=Math.ceil(a);b=this.resolutions[c]-(a-c)*(this.resolutions[c]-this.resolutions[d])}else b=this.resolutions[Math.round(a)];return b},getZoomForResolution:function(a,b){var c,d,e;if(this.map.fractionalZoom){var f,g=0,h=this.resolutions.length-1,i=this.resolutions[g],j=this.resolutions[h];for(d=0,e=this.resolutions.length;e>d;++d)if(f=this.resolutions[d],f>=a&&(i=f,g=d),a>=f){j=f,h=d;break}var k=i-j;c=k>0?g+(i-a)/k:g}else{var l,m=Number.POSITIVE_INFINITY;for(d=0,e=this.resolutions.length;e>d;d++)if(b){if(l=Math.abs(this.resolutions[d]-a),l>m)break;m=l}else if(this.resolutions[d]<a)break;c=Math.max(0,d-1)}return c},getLonLatFromViewPortPx:function(a){var b=null,c=this.map;if(null!=a&&c.minPx){var d=c.getResolution(),e=c.getMaxExtent({restricted:!0}),f=(a.x-c.minPx.x)*d+e.left,g=(c.minPx.y-a.y)*d+e.top;b=new Tmap.LonLat(f,g),this.wrapDateLine&&(b=b.wrapDateLine(this.maxExtent))}return b},getViewPortPxFromLonLat:function(a,b){var c=null;if(null!=a){b=b||this.map.getResolution();var d=this.map.calculateBounds(null,b);c=new Tmap.Pixel(1/b*(a.lon-d.left),1/b*(d.top-a.lat))}return c},setOpacity:function(a){if(a!=this.opacity){this.opacity=a;for(var b=this.div.childNodes,c=0,d=b.length;d>c;++c){var e=b[c].firstChild||b[c],f=b[c].lastChild;f&&"iframe"===f.nodeName.toLowerCase()&&(e=f.parentNode),Tmap.Util.modifyDOMElement(e,null,null,null,null,null,null,a)}null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"opacity"})}},getZIndex:function(){return this.div.style.zIndex},setZIndex:function(a){this.div.style.zIndex=a},adjustBounds:function(a){if(this.gutter){var b=this.gutter*this.map.getResolution();a=new Tmap.Bounds(a.left-b,a.bottom-b,a.right+b,a.top+b)}if(this.wrapDateLine){var c={rightTolerance:this.getResolution(),leftTolerance:this.getResolution()};a=a.wrapDateLine(this.maxExtent,c)}return a},CLASS_NAME:"Tmap.Layer"}),Tmap.Icon=Tmap.Class({url:null,size:null,offset:null,calculateOffset:null,imageDiv:null,px:null,initialize:function(a,b,c,d){this.url=a,this.size=b||{w:20,h:20},this.offset=c||{x:-(this.size.w/2),y:-(this.size.h/2)},this.calculateOffset=d;var e=Tmap.Util.createUniqueID("OL_Icon_");this.imageDiv=Tmap.Util.createAlphaImageDiv(e)},destroy:function(){this.erase(),Tmap.Event.stopObservingElement(this.imageDiv.firstChild),this.imageDiv.innerHTML="",this.imageDiv=null},clone:function(){return new Tmap.Icon(this.url,this.size,this.offset,this.calculateOffset)},setSize:function(a){null!=a&&(this.size=a),this.draw()},setUrl:function(a){null!=a&&(this.url=a),this.draw()},draw:function(a){return Tmap.Util.modifyAlphaImageDiv(this.imageDiv,null,null,this.size,this.url,"absolute"),this.moveTo(a),this.imageDiv},erase:function(){null!=this.imageDiv&&null!=this.imageDiv.parentNode&&Tmap.Element.remove(this.imageDiv)},setOpacity:function(a){Tmap.Util.modifyAlphaImageDiv(this.imageDiv,null,null,null,null,null,null,null,a)},moveTo:function(a){null!=a&&(this.px=a),null!=this.imageDiv&&(null==this.px?this.display(!1):(this.calculateOffset&&(this.offset=this.calculateOffset(this.size)),Tmap.Util.modifyAlphaImageDiv(this.imageDiv,null,{x:this.px.x+this.offset.x,y:this.px.y+this.offset.y})))},display:function(a){this.imageDiv.style.display=a?"":"none"},isDrawn:function(){var a=this.imageDiv&&this.imageDiv.parentNode&&11!=this.imageDiv.parentNode.nodeType;return a},CLASS_NAME:"Tmap.Icon"}),Tmap.Marker=Tmap.Class({icon:null,lonlat:null,events:null,map:null,initialize:function(a,b){this.lonlat=a;var c=b?b:Tmap.Marker.defaultIcon();null==this.icon?this.icon=c:(this.icon.url=c.url,this.icon.size=c.size,this.icon.offset=c.offset,this.icon.calculateOffset=c.calculateOffset),this.events=new Tmap.Events(this,this.icon.imageDiv)},destroy:function(){this.erase(),this.map=null,this.events.destroy(),this.events=null,null!=this.icon&&(this.icon.destroy(),this.icon=null)},draw:function(a){return this.icon.draw(a)},erase:function(){null!=this.icon&&this.icon.erase()},moveTo:function(a){null!=a&&null!=this.icon&&this.icon.moveTo(a),this.lonlat=this.map.getLonLatFromLayerPx(a)},isDrawn:function(){var a=this.icon&&this.icon.isDrawn();return a},onScreen:function(){var a=!1;if(this.map){var b=this.map.getExtent();a=b.containsLonLat(this.lonlat)}return a},inflate:function(a){this.icon&&this.icon.setSize({w:this.icon.size.w*a,h:this.icon.size.h*a})},setOpacity:function(a){this.icon.setOpacity(a)},setUrl:function(a){this.icon.setUrl(a)},display:function(a){this.icon.display(a)},CLASS_NAME:"Tmap.Marker"}),Tmap.Marker.defaultIcon=function(){return new Tmap.Icon(Tmap.Util.getImageLocation("marker.png"),{w:21,h:25},{x:-10.5,y:-25})},Tmap.Label=Tmap.Class({width:0,height:0,labelHtml:"",popupStyle:1,initialize:function(a,b){a&&(this.labelHtml=a),b&&(this.popupStyle=b)},destroy:function(){this.labelHtml=null,this.popupStyle=null,this.width=null,this.height=null},CLASS_NAME:"LABEL"}),Tmap.Markers=Tmap.Class(Tmap.Marker,{popup:{},labelHtml:"",popupStyle:null,initialize:function(){for(var a=[],b=0;2>b;b++)a.push(arguments[b]);Tmap.Marker.prototype.initialize.apply(this,a),arguments.length>2&&(arguments[2].labelHtml&&(this.labelHtml=arguments[2].labelHtml),arguments[2].popupStyle&&(this.popupStyle=arguments[2].popupStyle),arguments[2].destroy())},destroy:function(){Tmap.Marker.prototype.destroy.apply(this),this.labelHtml=null,this.popup&&""!=this.labelHtml&&this.popup.destroy()},moveTo:function(a){"Tmap.Pixel"==a.CLASS_NAME?(null!=a&&null!=this.icon&&this.icon.moveTo(a),this.lonlat=this.map.getLonLatFromLayerPx(a),this.popup&&""!=this.labelHtml&&this.popup.moveTo(a)):"Tmap.LonLat"==a.CLASS_NAME&&(null!=a&&null!=this.icon&&this.icon.moveTo(this.map.getLayerPxFromLonLat(a)),this.lonlat=a,this.popup&&""!=this.labelHtml&&this.popup.moveTo(this.map.getLayerPxFromLonLat(a)))},draw:function(a){return this.labelHtml&&this.addSimpleLabel(this.labelHtml),this.icon.draw(a)},addSimpleLabel:function(){var a=arguments[0];a&&(this.popup=new Tmap.Popup.FramedCloud("FramedLabel",this.lonlat,null,a,null,!1),this.popupStyle&&(this.popup.imageSrc=Tmap.Util.getImageLocation("cloud-popup-relative"+this.popupStyle+".png")),this.popup.panMapIfOutOfView=!1,this.popup.autoSize=!0,this.popup.positionBlocks={tl:{offset:new Tmap.Pixel(44,-20),padding:new Tmap.Bounds(8,40,8,9),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,51,22,0),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,50,0,0),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",19),anchor:new Tmap.Bounds(0,32,22,null),position:new Tmap.Pixel(0,-631)},{size:new Tmap.Size(22,18),anchor:new Tmap.Bounds(null,32,0,null),position:new Tmap.Pixel(-1238,-632)},{size:new Tmap.Size(81,35),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(0,-688)}]},tr:{offset:new Tmap.Pixel(-45,-20),padding:new Tmap.Bounds(8,40,8,9),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,51,22,0),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,50,0,0),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",19),anchor:new Tmap.Bounds(0,32,22,null),position:new Tmap.Pixel(0,-631)},{size:new Tmap.Size(22,19),anchor:new Tmap.Bounds(null,32,0,null),position:new Tmap.Pixel(-1238,-631)},{size:new Tmap.Size(81,35),anchor:new Tmap.Bounds(0,0,null,null),position:new Tmap.Pixel(-215,-687)}]},bl:{offset:new Tmap.Pixel(45,0),padding:new Tmap.Bounds(8,9,8,40),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,21,22,32),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,21,0,32),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",21),anchor:new Tmap.Bounds(0,0,22,null),position:new Tmap.Pixel(0,-629)},{size:new Tmap.Size(22,21),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(-1238,-629)},{size:new Tmap.Size(81,33),anchor:new Tmap.Bounds(null,null,0,0),position:new Tmap.Pixel(-101,-674)}]},br:{offset:new Tmap.Pixel(-44,0),padding:new Tmap.Bounds(8,9,8,40),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,21,22,32),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,21,0,32),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",21),anchor:new Tmap.Bounds(0,0,22,null),position:new Tmap.Pixel(0,-629)},{size:new Tmap.Size(22,21),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(-1238,-629)},{size:new Tmap.Size(81,33),anchor:new Tmap.Bounds(0,null,null,0),position:new Tmap.Pixel(-311,-674)}]}},this.map.addPopup(this.popup),this.popupStyle>2&&(this.popup.contentDiv.style.color="#ffffff"),this.popup.hide())}}),Tmap.IconHtml=Tmap.Class(Tmap.Icon,{htmlURL:"",initialize:function(){htmlURL=arguments[0],htmlURL=htmlURL.replace(/^\s+/,""),"<"!=htmlURL.substring(0,1)&&(htmlURL="<div>"+htmlURL+"</div>");for(var a=[""],b=1;b<arguments.length;b++)a.push(arguments[b]);Tmap.Icon.prototype.initialize.apply(this,a),this.imageDiv.innerHTML=htmlURL}}),Tmap.Marker.Box=Tmap.Class(Tmap.Marker,{bounds:null,div:null,initialize:function(a,b,c){this.bounds=a,this.div=Tmap.Util.createDiv(),this.div.style.overflow="hidden",this.events=new Tmap.Events(this,this.div),this.setBorder(b,c)},destroy:function(){this.bounds=null,this.div=null,Tmap.Marker.prototype.destroy.apply(this,arguments)},setBorder:function(a,b){a||(a="red"),b||(b=2),this.div.style.border=b+"px solid "+a},draw:function(a,b){return Tmap.Util.modifyDOMElement(this.div,null,a,b),this.div},onScreen:function(){var a=!1;if(this.map){var b=this.map.getExtent();a=b.containsBounds(this.bounds,!0,!0)}return a},display:function(a){this.div.style.display=a?"":"none"},CLASS_NAME:"Tmap.Marker.Box"}),Tmap.Popup=Tmap.Class({events:null,id:"",lonlat:null,div:null,contentSize:null,size:null,contentHTML:null,backgroundColor:"",opacity:"",border:"",contentDiv:null,groupDiv:null,closeDiv:null,autoSize:!1,minSize:null,maxSize:null,displayClass:"tmPopup",contentDisplayClass:"tmPopupContent",padding:0,disableFirefoxOverflowHack:!1,fixPadding:function(){"number"==typeof this.padding&&(this.padding=new Tmap.Bounds(this.padding,this.padding,this.padding,this.padding))},panMapIfOutOfView:!1,keepInMap:!1,closeOnMove:!1,map:null,initialize:function(a,b,c,d,e,f){null==a&&(a=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")),this.id=a,this.lonlat=b,this.contentSize=null!=c?c:new Tmap.Size(Tmap.Popup.WIDTH,Tmap.Popup.HEIGHT),null!=d&&(this.contentHTML=d),this.backgroundColor=Tmap.Popup.COLOR,this.opacity=Tmap.Popup.OPACITY,this.border=Tmap.Popup.BORDER,this.div=Tmap.Util.createDiv(this.id,null,null,null,null,null,"hidden"),this.div.className=this.displayClass;var g=this.id+"_GroupDiv";this.groupDiv=Tmap.Util.createDiv(g,null,null,null,"relative",null,"hidden");var a=this.div.id+"_contentDiv";this.contentDiv=Tmap.Util.createDiv(a,null,this.contentSize.clone(),null,"relative"),this.contentDiv.className=this.contentDisplayClass,this.groupDiv.appendChild(this.contentDiv),this.div.appendChild(this.groupDiv),e&&this.addCloseBox(f),this.registerEvents()},destroy:function(){this.id=null,this.lonlat=null,this.size=null,this.contentHTML=null,this.backgroundColor=null,this.opacity=null,this.border=null,this.closeOnMove&&this.map&&this.map.events.unregister("movestart",this,this.hide),this.events.destroy(),this.events=null,this.closeDiv&&(Tmap.Event.stopObservingElement(this.closeDiv),this.groupDiv.removeChild(this.closeDiv)),this.closeDiv=null,this.div.removeChild(this.groupDiv),this.groupDiv=null,null!=this.map&&this.map.removePopup(this),this.map=null,this.div=null,this.autoSize=null,this.minSize=null,this.maxSize=null,this.padding=null,this.panMapIfOutOfView=null},draw:function(a){return null==a&&null!=this.lonlat&&null!=this.map&&(a=this.map.getLayerPxFromLonLat(this.lonlat)),this.closeOnMove&&this.map.events.register("movestart",this,this.hide),this.disableFirefoxOverflowHack||"firefox"!=Tmap.BROWSER_NAME||(this.map.events.register("movestart",this,function(){var a=document.defaultView.getComputedStyle(this.contentDiv,null),b=a.getPropertyValue("overflow");"hidden"!=b&&(this.contentDiv._oldOverflow=b,this.contentDiv.style.overflow="hidden")}),this.map.events.register("moveend",this,function(){var a=this.contentDiv._oldOverflow;a&&(this.contentDiv.style.overflow=a,this.contentDiv._oldOverflow=null)})),this.moveTo(a),this.autoSize||this.size||this.setSize(this.contentSize),this.setBackgroundColor(),this.setOpacity(),this.setBorder(),this.setContentHTML(),this.panMapIfOutOfView&&this.panIntoView(),this.div},updatePosition:function(){if(this.lonlat&&this.map){var a=this.map.getLayerPxFromLonLat(this.lonlat);a&&this.moveTo(a)}},moveTo:function(a){null!=a&&null!=this.div&&(this.div.style.left=a.x+"px",this.div.style.top=a.y+"px")},visible:function(){return Tmap.Element.visible(this.div)},toggle:function(){this.visible()?this.hide():this.show()},show:function(){this.div.style.display="",this.panMapIfOutOfView&&this.panIntoView()},hide:function(){this.div.style.display="none"},setSize:function(a){this.size=a.clone();var b=this.getContentDivPadding(),c=b.left+b.right,d=b.top+b.bottom;if(this.fixPadding(),c+=this.padding.left+this.padding.right,d+=this.padding.top+this.padding.bottom,this.closeDiv){var e=parseInt(this.closeDiv.style.width);c+=e+b.right}this.size.w+=c,this.size.h+=d,"msie"==Tmap.BROWSER_NAME&&(this.contentSize.w+=b.left+b.right,this.contentSize.h+=b.bottom+b.top),null!=this.div&&(this.div.style.width=this.size.w+"px",this.div.style.height=this.size.h+"px"),null!=this.contentDiv&&(this.contentDiv.style.width=a.w+"px",this.contentDiv.style.height=a.h+"px")},updateSize:function(){var a="<div class='"+this.contentDisplayClass+"'>"+this.contentDiv.innerHTML+"</div>",b=this.map?this.map.div:document.body,c=Tmap.Util.getRenderedDimensions(a,null,{displayClass:this.displayClass,containerElement:b}),d=this.getSafeContentSize(c),e=null;if(d.equals(c))e=c;else{var f={w:d.w<c.w?d.w:null,h:d.h<c.h?d.h:null};if(f.w&&f.h)e=d;else{var g=Tmap.Util.getRenderedDimensions(a,f,{displayClass:this.contentDisplayClass,containerElement:b}),h=Tmap.Element.getStyle(this.contentDiv,"overflow");if("hidden"!=h&&g.equals(d)){var i=Tmap.Util.getScrollbarWidth();f.w?g.h+=i:g.w+=i}e=this.getSafeContentSize(g)}}this.setSize(e)},setBackgroundColor:function(a){void 0!=a&&(this.backgroundColor=a),null!=this.div&&(this.div.style.backgroundColor=this.backgroundColor)},setOpacity:function(a){void 0!=a&&(this.opacity=a),null!=this.div&&(this.div.style.opacity=this.opacity,this.div.style.filter="alpha(opacity="+100*this.opacity+")")},setBorder:function(a){void 0!=a&&(this.border=a),null!=this.div&&(this.div.style.border=this.border)},setContentHTML:function(a){null!=a&&(this.contentHTML=a),null!=this.contentDiv&&null!=this.contentHTML&&this.contentHTML!=this.contentDiv.innerHTML&&(this.contentDiv.innerHTML=this.contentHTML,this.autoSize&&(this.registerImageListeners(),this.updateSize()))},registerImageListeners:function(){for(var a=function(){null!==this.popup.id&&(this.popup.updateSize(),this.popup.visible()&&this.popup.panMapIfOutOfView&&this.popup.panIntoView(),Tmap.Event.stopObserving(this.img,"load",this.img._onImgLoad))},b=this.contentDiv.getElementsByTagName("img"),c=0,d=b.length;d>c;c++){var e=b[c];if(0==e.width||0==e.height){var f={popup:this,img:e};e._onImgLoad=Tmap.Function.bind(a,f),Tmap.Event.observe(e,"load",e._onImgLoad)}}},getSafeContentSize:function(a){var b=a.clone(),c=this.getContentDivPadding(),d=c.left+c.right,e=c.top+c.bottom;if(this.fixPadding(),d+=this.padding.left+this.padding.right,e+=this.padding.top+this.padding.bottom,this.closeDiv){var f=parseInt(this.closeDiv.style.width);d+=f+c.right}if(this.minSize&&(b.w=Math.max(b.w,this.minSize.w-d),b.h=Math.max(b.h,this.minSize.h-e)),this.maxSize&&(b.w=Math.min(b.w,this.maxSize.w-d),b.h=Math.min(b.h,this.maxSize.h-e)),this.map&&this.map.size){var g=0,h=0;if(this.keepInMap&&!this.panMapIfOutOfView){var i=this.map.getPixelFromLonLat(this.lonlat);switch(this.relativePosition){case"tr":g=i.x,h=this.map.size.h-i.y;break;case"tl":g=this.map.size.w-i.x,h=this.map.size.h-i.y;break;case"bl":g=this.map.size.w-i.x,h=i.y;break;case"br":g=i.x,h=i.y;break;default:g=i.x,h=this.map.size.h-i.y}}var j=this.map.size.h-this.map.paddingForPopups.top-this.map.paddingForPopups.bottom-e-h,k=this.map.size.w-this.map.paddingForPopups.left-this.map.paddingForPopups.right-d-g;b.w=Math.min(b.w,k),b.h=Math.min(b.h,j)}return b},getContentDivPadding:function(){var a=this._contentDivPadding;return a||(null==this.div.parentNode&&(this.div.style.display="none",document.body.appendChild(this.div)),a=new Tmap.Bounds(Tmap.Element.getStyle(this.contentDiv,"padding-left"),Tmap.Element.getStyle(this.contentDiv,"padding-bottom"),Tmap.Element.getStyle(this.contentDiv,"padding-right"),Tmap.Element.getStyle(this.contentDiv,"padding-top")),this._contentDivPadding=a,this.div.parentNode==document.body&&(document.body.removeChild(this.div),this.div.style.display="")),a},addCloseBox:function(a){this.closeDiv=Tmap.Util.createDiv(this.id+"_close",null,{w:17,h:17}),this.closeDiv.className="tmPopupCloseBox";var b=this.getContentDivPadding();this.closeDiv.style.right=b.right+"px",this.closeDiv.style.top=b.top+"px",this.groupDiv.appendChild(this.closeDiv);var c=a||function(a){this.hide(),Tmap.Event.stop(a)};Tmap.Event.observe(this.closeDiv,"touchend",Tmap.Function.bindAsEventListener(c,this)),Tmap.Event.observe(this.closeDiv,"click",Tmap.Function.bindAsEventListener(c,this))},panIntoView:function(){var a=this.map.getSize(),b=this.map.getViewPortPxFromLayerPx(new Tmap.Pixel(parseInt(this.div.style.left),parseInt(this.div.style.top))),c=b.clone();b.x<this.map.paddingForPopups.left?c.x=this.map.paddingForPopups.left:b.x+this.size.w>a.w-this.map.paddingForPopups.right&&(c.x=a.w-this.map.paddingForPopups.right-this.size.w),b.y<this.map.paddingForPopups.top?c.y=this.map.paddingForPopups.top:b.y+this.size.h>a.h-this.map.paddingForPopups.bottom&&(c.y=a.h-this.map.paddingForPopups.bottom-this.size.h);var d=b.x-c.x,e=b.y-c.y;this.map.pan(d,e)},registerEvents:function(){function a(a){Tmap.Event.stop(a,!0)}this.events=new Tmap.Events(this,this.div,null,!0),this.events.on({mousedown:this.onmousedown,mousemove:this.onmousemove,mouseup:this.onmouseup,click:this.onclick,mouseout:this.onmouseout,dblclick:this.ondblclick,touchstart:a,scope:this})},onmousedown:function(a){this.mousedown=!0,Tmap.Event.stop(a,!0)},onmousemove:function(a){this.mousedown&&Tmap.Event.stop(a,!0)},onmouseup:function(a){this.mousedown&&(this.mousedown=!1,Tmap.Event.stop(a,!0))},onclick:function(a){Tmap.Event.stop(a,!0)},onmouseout:function(a){this.mousedown=!1},ondblclick:function(a){Tmap.Event.stop(a,!0)},CLASS_NAME:"Tmap.Popup"}),Tmap.Popup.WIDTH=200,Tmap.Popup.HEIGHT=200,Tmap.Popup.COLOR="white",Tmap.Popup.OPACITY=1,Tmap.Popup.BORDER="0px",Tmap.Tile=Tmap.Class({events:null,eventListeners:null,id:null,layer:null,url:null,bounds:null,size:null,position:null,isLoading:!1,initialize:function(a,b,c,d,e,f){this.layer=a,this.position=b.clone(),this.setBounds(c),this.url=d,e&&(this.size=e.clone()),this.id=Tmap.Util.createUniqueID("Tile_"),Tmap.Util.extend(this,f),this.events=new Tmap.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners)},unload:function(){this.isLoading&&(this.isLoading=!1,this.events.triggerEvent("unload"))},destroy:function(){this.layer=null,this.bounds=null,this.size=null,this.position=null,this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.eventListeners=null,this.events=null},draw:function(a){a||this.clear();var b=this.shouldDraw();return b&&!a&&this.events.triggerEvent("beforedraw")===!1&&(b=null),b},shouldDraw:function(){var a=!1,b=this.layer.maxExtent;if(b){var c=this.layer.map,d=c.baseLayer.wrapDateLine&&c.getMaxExtent();this.bounds.intersectsBounds(b,{inclusive:!1,worldBounds:d})&&(a=!0)}return a||this.layer.displayOutsideMaxExtent},setBounds:function(a){if(a=a.clone(),this.layer.map.baseLayer.wrapDateLine){var b=this.layer.map.getMaxExtent(),c=this.layer.map.getResolution();a=a.wrapDateLine(b,{leftTolerance:c,rightTolerance:c})}this.bounds=a},moveTo:function(a,b,c){null==c&&(c=!0),this.setBounds(a),this.position=b.clone(),c&&this.draw()},clear:function(a){},CLASS_NAME:"Tmap.Tile"}),Tmap.Tile.Image=Tmap.Class(Tmap.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(a,b,c,d,e,f){Tmap.Tile.prototype.initialize.apply(this,arguments),this.url=d,this.layerAlphaHack=this.layer.alpha&&Tmap.Util.alphaHack(),(null!=this.maxGetUrlLength||this.layer.gutter||this.layerAlphaHack)&&(this.frame=document.createElement("div"),this.frame.style.position="absolute",this.frame.style.overflow="hidden"),null!=this.maxGetUrlLength&&Tmap.Util.extend(this,Tmap.Tile.Image.IFrame)},destroy:function(){this.imgDiv&&(this.clear(),this.imgDiv=null,this.frame=null),this.asyncRequestId=null,Tmap.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var a=Tmap.Tile.prototype.draw.apply(this,arguments);return a?(this.layer!=this.layer.map.baseLayer&&this.layer.reproject&&(this.bounds=this.getBoundsFromBaseLayer(this.position)),this.isLoading?this._loadEvent="reload":(this.isLoading=!0,this._loadEvent="loadstart"),this.renderTile(),this.positionTile()):a===!1&&this.unload(),a},renderTile:function(){if(this.layer.async){var a=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(b){a==this.asyncRequestId&&(this.url=b,this.initImage())},this)}else this.url=this.layer.getURL(this.bounds),this.initImage()},positionTile:function(){var a=this.getTile().style,b=this.frame?this.size:this.layer.getImageSize(this.bounds),c=1;this.layer instanceof Tmap.Layer.Grid&&(c=this.layer.getServerResolution()/this.layer.map.getResolution()),a.left=this.position.x+"px",a.top=this.position.y+"px",a.width=Math.round(c*b.w)+"px",a.height=Math.round(c*b.h)+"px"},clear:function(){Tmap.Tile.prototype.clear.apply(this,arguments);var a=this.imgDiv;if(a){var b=this.getTile();b.parentNode===this.layer.div&&this.layer.div.removeChild(b),this.setImgSrc(),this.layerAlphaHack===!0&&(a.style.filter=""),Tmap.Element.removeClass(a,"tmImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=Tmap.Tile.Image.IMAGE.cloneNode(!1);var a=this.imgDiv.style;if(this.frame){var b=0,c=0;this.layer.gutter&&(b=this.layer.gutter/this.layer.tileSize.w*100,c=this.layer.gutter/this.layer.tileSize.h*100),a.left=-b+"%",a.top=-c+"%",a.width=2*b+100+"%",a.height=2*c+100+"%"}a.visibility="hidden",a.opacity=0,this.layer.opacity<1&&(a.filter="alpha(opacity="+100*this.layer.opacity+")"),a.position="absolute",this.layerAlphaHack&&(a.paddingTop=a.height,a.height="0",a.width="100%"),this.frame&&this.frame.appendChild(this.imgDiv)}return this.imgDiv},setImage:function(a){this.imgDiv=a},initImage:function(){this.events.triggerEvent("beforeload"),this.layer.div.appendChild(this.getTile()),this.events.triggerEvent(this._loadEvent);var a=this.getImage();this.url&&a.getAttribute("src")==this.url?this._loadTimeout=window.setTimeout(Tmap.Function.bind(this.onImageLoad,this),0):(this.stopLoading(),this.crossOriginKeyword&&a.removeAttribute("crossorigin"),Tmap.Event.observe(a,"load",Tmap.Function.bind(this.onImageLoad,this)),Tmap.Event.observe(a,"error",Tmap.Function.bind(this.onImageError,this)),this.imageReloadAttempts=0,this.setImgSrc(this.url))},setImgSrc:function(a){var b=this.imgDiv;a?(b.style.visibility="hidden",b.style.opacity=0,this.crossOriginKeyword&&("data:"!==a.substr(0,5)?b.setAttribute("crossorigin",this.crossOriginKeyword):b.removeAttribute("crossorigin")),b.src=a):(this.stopLoading(),this.imgDiv=null,b.parentNode&&b.parentNode.removeChild(b))},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(this.imgDiv&&!this.isLoading){var a;return this.frame?(a=this.frame.cloneNode(!1),a.appendChild(this.imgDiv)):a=this.imgDiv,this.imgDiv=null,a}},onImageLoad:function(){var a=this.imgDiv;this.stopLoading(),a.style.visibility="inherit",a.style.opacity=this.layer.opacity,this.isLoading=!1,this.canvasContext=null,this.events.triggerEvent("loadend"),this.layerAlphaHack===!0&&(a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a.src+"', sizingMethod='scale')")},onImageError:function(){var a=this.imgDiv;null!=a.src&&(this.imageReloadAttempts++,this.imageReloadAttempts<=Tmap.IMAGE_RELOAD_ATTEMPTS?this.setImgSrc(this.layer.getURL(this.bounds)):(Tmap.Element.addClass(a,"tmImageLoadError"),this.events.triggerEvent("loaderror"),this.onImageLoad()))},stopLoading:function(){Tmap.Event.stopObservingElement(this.imgDiv),window.clearTimeout(this._loadTimeout),delete this._loadTimeout},getCanvasContext:function(){if(Tmap.CANVAS_SUPPORTED&&this.imgDiv&&!this.isLoading){if(!this.canvasContext){var a=document.createElement("canvas");a.width=this.size.w,a.height=this.size.h,this.canvasContext=a.getContext("2d"),this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"Tmap.Tile.Image"}),Tmap.Tile.Image.IMAGE=function(){var a=new Image;return a.className="tmTileImage",a.galleryImg="no",a}(),Tmap.Tile.Image.IFrame={useIFrame:null,blankImageUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",draw:function(){var a=Tmap.Tile.Image.prototype.shouldDraw.call(this);if(a){var b=this.layer.getURL(this.bounds),c=this.useIFrame;this.useIFrame=null!==this.maxGetUrlLength&&!this.layer.async&&b.length>this.maxGetUrlLength;var d=c&&!this.useIFrame,e=!c&&this.useIFrame;(d||e)&&(this.imgDiv&&this.imgDiv.parentNode===this.frame&&this.frame.removeChild(this.imgDiv),this.imgDiv=null,d&&this.frame.removeChild(this.frame.firstChild))}return Tmap.Tile.Image.prototype.draw.apply(this,arguments)},getImage:function(){if(this.useIFrame===!0){if(!this.frame.childNodes.length){var a=document.createElement("div"),b=a.style;b.position="absolute",b.width="100%",b.height="100%",b.zIndex=1,b.backgroundImage="url("+this.blankImageUrl+")",this.frame.appendChild(a)}var c,d=this.id+"_iFrame";return parseFloat(navigator.appVersion.split("MSIE")[1])<9?(c=document.createElement('<iframe name="'+d+'">'),c.style.backgroundColor="#FFFFFF",c.style.filter="chroma(color=#FFFFFF)"):(c=document.createElement("iframe"),c.style.backgroundColor="transparent",c.name=d),c.scrolling="no",c.marginWidth="0px",c.marginHeight="0px",c.frameBorder="0",c.style.position="absolute",c.style.width="100%",c.style.height="100%",this.layer.opacity<1&&Tmap.Util.modifyDOMElement(c,null,null,null,null,null,null,this.layer.opacity),this.frame.appendChild(c),this.imgDiv=c,c}return Tmap.Tile.Image.prototype.getImage.apply(this,arguments)},createRequestForm:function(){var a=document.createElement("form");a.method="POST";var b=this.layer.params._TMSALT;b=(b?b+"_":"")+this.bounds.toBBOX(),a.action=Tmap.Util.urlAppend(this.layer.url,b),a.target=this.id+"_iFrame";var c,d=(this.layer.getImageSize(),Tmap.Util.getParameters(this.url));for(var e in d)c=document.createElement("input"),c.type="hidden",c.name=e,c.value=d[e],a.appendChild(c);return a},setImgSrc:function(a){if(this.useIFrame===!0)if(a){var b=this.createRequestForm();this.frame.appendChild(b),b.submit(),this.frame.removeChild(b)}else this.imgDiv.parentNode===this.frame&&(this.frame.removeChild(this.imgDiv),this.imgDiv=null);else Tmap.Tile.Image.prototype.setImgSrc.apply(this,arguments)},onImageLoad:function(){Tmap.Tile.Image.prototype.onImageLoad.apply(this,arguments),this.useIFrame===!0&&(this.imgDiv.style.opacity=1,this.frame.style.opacity=this.layer.opacity)},createBackBuffer:function(){var a;return this.useIFrame===!1&&(a=Tmap.Tile.Image.prototype.createBackBuffer.call(this)),a}},Tmap.Tile.UTFGrid=Tmap.Class(Tmap.Tile,{url:null,utfgridResolution:2,json:null,format:null,destroy:function(){this.clear(),Tmap.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var a=Tmap.Tile.prototype.draw.apply(this,arguments);if(a)if(this.isLoading?(this.abortLoading(),this.events.triggerEvent("reload")):(this.isLoading=!0,this.events.triggerEvent("loadstart")),this.url=this.layer.getURL(this.bounds),this.layer.useJSONP){var b=new Tmap.Protocol.Script({url:this.url,callback:function(a){this.isLoading=!1,this.events.triggerEvent("loadend"),this.json=a.data},scope:this});b.read(),this.request=b}else this.request=Tmap.Request.GET({url:this.url,callback:function(a){this.isLoading=!1,this.events.triggerEvent("loadend"),200===a.status&&this.parseData(a.responseText)},scope:this});else this.unload();return a},abortLoading:function(){this.request&&(this.request.abort(),delete this.request),this.isLoading=!1},getFeatureInfo:function(a,b){var c=null;if(this.json){var d=this.getFeatureId(a,b);null!==d&&(c={id:d,data:this.json.data[d]})}return c},getFeatureId:function(a,b){var c=null;if(this.json){var d=this.utfgridResolution,e=Math.floor(b/d),f=Math.floor(a/d),g=this.json.grid[e].charCodeAt(f),h=this.indexFromCharCode(g),i=this.json.keys;!isNaN(h)&&h in i&&(c=i[h])}return c},indexFromCharCode:function(a){return a>=93&&a--,a>=35&&a--,a-32},parseData:function(a){this.format||(this.format=new Tmap.Format.JSON),this.json=this.format.read(a)},clear:function(){this.json=null},CLASS_NAME:"Tmap.Tile.UTFGrid"}),Tmap.Layer.SphericalMercator={getExtent:function(){var a=null;return a=this.sphericalMercator?this.map.calculateBounds():Tmap.Layer.FixedZoomLevels.prototype.getExtent.apply(this)},getLonLatFromViewPortPx:function(a){return Tmap.Layer.prototype.getLonLatFromViewPortPx.apply(this,arguments)},getViewPortPxFromLonLat:function(a){return Tmap.Layer.prototype.getViewPortPxFromLonLat.apply(this,arguments)},initMercatorParameters:function(){this.RESOLUTIONS=[];for(var a=156543.03390625,b=0;b<=this.MAX_ZOOM_LEVEL;++b)this.RESOLUTIONS[b]=a/Math.pow(2,b);this.units="m",this.projection=this.projection||"EPSG:900913"},forwardMercator:function(){var a=new Tmap.Projection("EPSG:4326"),b=new Tmap.Projection("EPSG:900913");return function(c,d){var e=Tmap.Projection.transform({x:c,y:d},a,b);return new Tmap.LonLat(e.x,e.y)}}(),inverseMercator:function(){var a=new Tmap.Projection("EPSG:4326"),b=new Tmap.Projection("EPSG:900913");return function(c,d){var e=Tmap.Projection.transform({x:c,y:d},b,a);return new Tmap.LonLat(e.x,e.y)}}()},Tmap.Layer.EventPane=Tmap.Class(Tmap.Layer,{smoothDragPan:!0,isBaseLayer:!0,isFixed:!0,pane:null,mapObject:null,initialize:function(a,b){Tmap.Layer.prototype.initialize.apply(this,arguments),null==this.pane&&(this.pane=Tmap.Util.createDiv(this.div.id+"_EventPane"))},destroy:function(){this.mapObject=null,this.pane=null,Tmap.Layer.prototype.destroy.apply(this,arguments)},setMap:function(a){Tmap.Layer.prototype.setMap.apply(this,arguments),this.pane.style.zIndex=parseInt(this.div.style.zIndex)+1,this.pane.style.display=this.div.style.display,this.pane.style.width="100%",this.pane.style.height="100%","msie"==Tmap.BROWSER_NAME&&(this.pane.style.background="url("+Tmap.Util.getImageLocation("blank.gif")+")"),this.isFixed?this.map.viewPortDiv.appendChild(this.pane):this.map.layerContainerDiv.appendChild(this.pane),
this.loadMapObject(),null==this.mapObject&&this.loadWarningMessage()},removeMap:function(a){this.pane&&this.pane.parentNode&&this.pane.parentNode.removeChild(this.pane),Tmap.Layer.prototype.removeMap.apply(this,arguments)},loadWarningMessage:function(){this.div.style.backgroundColor="darkblue";var a=this.map.getSize(),b=Math.min(a.w,300),c=Math.min(a.h,200),d=new Tmap.Size(b,c),e=new Tmap.Pixel(a.w/2,a.h/2),f=e.add(-d.w/2,-d.h/2),g=Tmap.Util.createDiv(this.name+"_warning",f,d,null,null,null,"auto");g.style.padding="7px",g.style.backgroundColor="yellow",g.innerHTML=this.getWarningHTML(),this.div.appendChild(g)},getWarningHTML:function(){return""},display:function(a){Tmap.Layer.prototype.display.apply(this,arguments),this.pane.style.display=this.div.style.display},setZIndex:function(a){Tmap.Layer.prototype.setZIndex.apply(this,arguments),this.pane.style.zIndex=parseInt(this.div.style.zIndex)+1},moveByPx:function(a,b){Tmap.Layer.prototype.moveByPx.apply(this,arguments),this.dragPanMapObject?this.dragPanMapObject(a,-b):this.moveTo(this.map.getCachedCenter())},moveTo:function(a,b,c){if(Tmap.Layer.prototype.moveTo.apply(this,arguments),null!=this.mapObject){var d=this.map.getCenter(),e=this.map.getZoom();if(null!=d){var f=this.getMapObjectCenter(),g=this.getOLLonLatFromMapObjectLonLat(f),h=this.getMapObjectZoom(),i=this.getOLZoomFromMapObjectZoom(h);if(!d.equals(g)||e!=i)if(!b&&g&&this.dragPanMapObject&&this.smoothDragPan){var j=this.map.getViewPortPxFromLonLat(g),k=this.map.getViewPortPxFromLonLat(d);this.dragPanMapObject(k.x-j.x,j.y-k.y)}else{var l=this.getMapObjectLonLatFromTMLonLat(d),m=this.getMapObjectZoomFromTMZoom(e);this.setMapObjectCenter(l,m,c)}}}},getLonLatFromViewPortPx:function(a){var b=null;if(null!=this.mapObject&&null!=this.getMapObjectCenter()){var c=this.getMapObjectPixelFromTMPixel(a),d=this.getMapObjectLonLatFromMapObjectPixel(c);b=this.getOLLonLatFromMapObjectLonLat(d)}return b},getViewPortPxFromLonLat:function(a){var b=null;if(null!=this.mapObject&&null!=this.getMapObjectCenter()){var c=this.getMapObjectLonLatFromOLLonLat(a),d=this.getMapObjectPixelFromMapObjectLonLat(c);b=this.getOLPixelFromMapObjectPixel(d)}return b},getTMLonLatFromMapObjectLonLat:function(a){var b=null;if(null!=a){var c=this.getLongitudeFromMapObjectLonLat(a),d=this.getLatitudeFromMapObjectLonLat(a);b=new Tmap.LonLat(c,d)}return b},getMapObjectLonLatFromTMLonLat:function(a){var b=null;return null!=a&&(b=this.getMapObjectLonLatFromLonLat(a.lon,a.lat)),b},getTMPixelFromMapObjectPixel:function(a){var b=null;if(null!=a){var c=this.getXFromMapObjectPixel(a),d=this.getYFromMapObjectPixel(a);b=new Tmap.Pixel(c,d)}return b},getMapObjectPixelFromTMPixel:function(a){var b=null;return null!=a&&(b=this.getMapObjectPixelFromXY(a.x,a.y)),b},CLASS_NAME:"Tmap.Layer.EventPane"}),Tmap.Layer.FixedZoomLevels=Tmap.Class({initialize:function(){},initResolutions:function(){for(var a=["minZoomLevel","maxZoomLevel","numZoomLevels"],b=0,c=a.length;c>b;b++){var d=a[b];this[d]=null!=this.options[d]?this.options[d]:this.map[d]}(null==this.minZoomLevel||this.minZoomLevel<this.MIN_ZOOM_LEVEL)&&(this.minZoomLevel=this.MIN_ZOOM_LEVEL);var e,f=this.MAX_ZOOM_LEVEL-this.minZoomLevel+1;if(e=null==this.options.numZoomLevels&&null!=this.options.maxZoomLevel||null==this.numZoomLevels&&null!=this.maxZoomLevel?this.maxZoomLevel-this.minZoomLevel+1:this.numZoomLevels,null!=e?this.numZoomLevels=Math.min(e,f):this.numZoomLevels=f,this.maxZoomLevel=this.minZoomLevel+this.numZoomLevels-1,null!=this.RESOLUTIONS){var g=0;this.resolutions=[];for(var b=this.minZoomLevel;b<=this.maxZoomLevel;b++)this.resolutions[g++]=this.RESOLUTIONS[b];this.maxResolution=this.resolutions[0],this.minResolution=this.resolutions[this.resolutions.length-1]}},getResolution:function(){if(null!=this.resolutions)return Tmap.Layer.prototype.getResolution.apply(this,arguments);var a=null,b=this.map.getSize(),c=this.getExtent();return null!=b&&null!=c&&(a=Math.max(c.getWidth()/b.w,c.getHeight()/b.h)),a},getExtent:function(){var a=this.map.getSize(),b=this.getLonLatFromViewPortPx({x:0,y:0}),c=this.getLonLatFromViewPortPx({x:a.w,y:a.h});return null!=b&&null!=c?new Tmap.Bounds(b.lon,c.lat,c.lon,b.lat):null},getZoomForResolution:function(a){if(null!=this.resolutions)return Tmap.Layer.prototype.getZoomForResolution.apply(this,arguments);var b=Tmap.Layer.prototype.getExtent.apply(this,[]);return this.getZoomForExtent(b)},getTMZoomFromMapObjectZoom:function(a){var b=null;return null!=a&&(b=a-this.minZoomLevel,this.map.baseLayer!==this&&(b=this.map.baseLayer.getZoomForResolution(this.getResolutionForZoom(b)))),b},getMapObjectZoomFromTMZoom:function(a){var b=null;return null!=a&&(b=a+this.minZoomLevel,this.map.baseLayer!==this&&(b=this.getZoomForResolution(this.map.baseLayer.getResolutionForZoom(b)))),b},CLASS_NAME:"Tmap.Layer.FixedZoomLevels"}),Tmap.Layer.HTTPRequest=Tmap.Class(Tmap.Layer,{URL_HASH_FACTOR:(Math.sqrt(5)-1)/2,url:null,params:null,reproject:!1,initialize:function(a,b,c,d){Tmap.Layer.prototype.initialize.apply(this,[a,d]),this.url=b,this.params||(this.params=Tmap.Util.extend({},c))},destroy:function(){this.url=null,this.params=null,Tmap.Layer.prototype.destroy.apply(this,arguments)},clone:function(a){return null==a&&(a=new Tmap.Layer.HTTPRequest(this.name,this.url,this.params,this.getOptions())),a=Tmap.Layer.prototype.clone.apply(this,[a])},setUrl:function(a){this.url=a},mergeNewParams:function(a){this.params=Tmap.Util.extend(this.params,a);var b=this.redraw();return null!=this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"params"}),b},redraw:function(a){return a?this.mergeNewParams({_tmSalt:Math.random()}):Tmap.Layer.prototype.redraw.apply(this,[])},selectUrl:function(a,b){for(var c=1,d=0,e=a.length;e>d;d++)c*=a.charCodeAt(d)*this.URL_HASH_FACTOR,c-=Math.floor(c);return b[Math.floor(c*b.length)]},getFullRequestString:function(a,b){var c=b||this.url,d=Tmap.Util.extend({},this.params);d=Tmap.Util.extend(d,a);var e=Tmap.Util.getParameterString(d);Tmap.Util.isArray(c)&&(c=this.selectUrl(e,c));var f=Tmap.Util.upperCaseObject(Tmap.Util.getParameters(c));for(var g in d)g.toUpperCase()in f&&delete d[g];return e=Tmap.Util.getParameterString(d),Tmap.Util.urlAppend(c,e)},CLASS_NAME:"Tmap.Layer.HTTPRequest"}),Tmap.Layer.Grid=Tmap.Class(Tmap.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:Tmap.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:null,numLoadingTiles:0,serverResolutions:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,gridLayout:null,rowSign:null,transitionendEvents:["transitionend","webkitTransitionEnd","otransitionend","oTransitionEnd"],initialize:function(a,b,c,d){Tmap.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.grid=[],this._removeBackBuffer=Tmap.Function.bind(this.removeBackBuffer,this),this.initProperties(),this.rowSign="t"===this.tileOriginCorner.substr(0,1)?1:-1},initProperties:function(){void 0===this.options.removeBackBufferDelay&&(this.removeBackBufferDelay=this.singleTile?0:2500),void 0===this.options.className&&(this.className=this.singleTile?"tmLayerGridSingleTile":"tmLayerGrid")},setMap:function(a){Tmap.Layer.HTTPRequest.prototype.setMap.call(this,a),Tmap.Element.addClass(this.div,this.className)},removeMap:function(a){this.removeBackBuffer()},destroy:function(){this.removeBackBuffer(),this.clearGrid(),this.grid=null,this.tileSize=null,Tmap.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var a=0,b=this.grid.length;b>a;a++)for(var c=this.grid[a],d=0,e=c.length;e>d;d++){var f=c[d];this.destroyTile(f)}this.grid=[],this.gridResolution=null,this.gridLayout=null}},addOptions:function(a,b){var c=void 0!==a.singleTile&&a.singleTile!==this.singleTile;Tmap.Layer.HTTPRequest.prototype.addOptions.apply(this,arguments),this.map&&c&&(this.initProperties(),this.clearGrid(),this.tileSize=this.options.tileSize,this.setTileSize(),this.moveTo(null,!0))},clone:function(a){return null==a&&(a=new Tmap.Layer.Grid(this.name,this.url,this.params,this.getOptions())),a=Tmap.Layer.HTTPRequest.prototype.clone.apply(this,[a]),null!=this.tileSize&&(a.tileSize=this.tileSize.clone()),a.grid=[],a.gridResolution=null,a.backBuffer=null,a.backBufferTimerId=null,a.loading=!1,a.numLoadingTiles=0,a},moveTo:function(a,b,c){if(Tmap.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),a=a||this.map.getExtent(),null!=a){var d=!this.grid.length||b,e=this.getTilesBounds(),f=this.map.getResolution();this.getServerResolution(f);this.singleTile?(d||!c&&!e.containsBounds(a))&&(b&&"resize"!==this.transitionEffect&&this.removeBackBuffer(),b&&"resize"!==this.transitionEffect||this.applyBackBuffer(f),this.initSingleTile(a)):(d=d||!e.intersectsBounds(a,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()}),d?(!b||"resize"!==this.transitionEffect&&this.gridResolution!==f||this.applyBackBuffer(f),this.initGriddedTiles(a)):this.moveGriddedTiles())}},getTileData:function(a){var b=null,c=a.lon,d=a.lat,e=this.grid.length;if(this.map&&e){var f=this.map.getResolution(),g=this.tileSize.w,h=this.tileSize.h,i=this.grid[0][0].bounds,j=i.left,k=i.top;if(j>c&&this.map.baseLayer.wrapDateLine){var l=this.map.getMaxExtent().getWidth(),m=Math.ceil((j-c)/l);c+=l*m}var n=(c-j)/(f*g),o=(k-d)/(f*h),p=Math.floor(n),q=Math.floor(o);if(q>=0&&e>q){var r=this.grid[q][p];r&&(b={tile:r,i:Math.floor((n-p)*g),j:Math.floor((o-q)*h)})}}return b},destroyTile:function(a){this.removeTileMonitoringHooks(a),a.destroy()},getServerResolution:function(a){var b=Number.POSITIVE_INFINITY;if(a=a||this.map.getResolution(),this.serverResolutions&&-1===Tmap.Util.indexOf(this.serverResolutions,a)){var c,d,e,f;for(c=this.serverResolutions.length-1;c>=0&&(e=this.serverResolutions[c],d=Math.abs(e-a),!(d>b));c--)b=d,f=e;a=f}return a},getServerZoom:function(){var a=this.getServerResolution();return this.serverResolutions?Tmap.Util.indexOf(this.serverResolutions,a):this.map.getZoomForResolution(a)+(this.zoomOffset||0)},applyBackBuffer:function(a){null!==this.backBufferTimerId&&this.removeBackBuffer();var b=this.backBuffer;if(!b){if(b=this.createBackBuffer(),!b)return;a===this.gridResolution?this.div.insertBefore(b,this.div.firstChild):this.map.baseLayer.div.parentNode.insertBefore(b,this.map.baseLayer.div),this.backBuffer=b;var c=this.grid[0][0].bounds;this.backBufferLonLat={lon:c.left,lat:c.top},this.backBufferResolution=this.gridResolution}for(var d,e=this.backBufferResolution/a,f=b.childNodes,g=f.length-1;g>=0;--g)d=f[g],d.style.top=(e*d._i*d._h|0)+"px",d.style.left=(e*d._j*d._w|0)+"px",d.style.width=Math.round(e*d._w)+"px",d.style.height=Math.round(e*d._h)+"px";var h=this.getViewPortPxFromLonLat(this.backBufferLonLat,a),i=this.map.layerContainerOriginPx.x,j=this.map.layerContainerOriginPx.y;b.style.left=Math.round(h.x-i)+"px",b.style.top=Math.round(h.y-j)+"px"},createBackBuffer:function(){var a;if(this.grid.length>0){a=document.createElement("div"),a.id=this.div.id+"_bb",a.className="tmBackBuffer",a.style.position="absolute";for(var b=0,c=this.grid.length;c>b;b++)for(var d=0,e=this.grid[b].length;e>d;d++){var f=this.grid[b][d],g=this.grid[b][d].createBackBuffer();g&&(g._i=b,g._j=d,g._w=f.size.w,g._h=f.size.h,g.id=f.id+"_bb",a.appendChild(g))}}return a},removeBackBuffer:function(){if(this._transitionElement){for(var a=this.transitionendEvents.length-1;a>=0;--a)Tmap.Event.stopObserving(this._transitionElement,this.transitionendEvents[a],this._removeBackBuffer);delete this._transitionElement}this.backBuffer&&(this.backBuffer.parentNode&&this.backBuffer.parentNode.removeChild(this.backBuffer),this.backBuffer=null,this.backBufferResolution=null,null!==this.backBufferTimerId&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(a,b){this.singleTile||this.moveGriddedTiles()},setTileSize:function(a){this.singleTile&&(a=this.map.getSize(),a.h=parseInt(a.h*this.ratio,10),a.w=parseInt(a.w*this.ratio,10)),Tmap.Layer.HTTPRequest.prototype.setTileSize.apply(this,[a])},getTilesBounds:function(){var a=null,b=this.grid.length;if(b){var c=this.grid[b-1][0].bounds,d=this.grid[0].length*c.getWidth(),e=this.grid.length*c.getHeight();a=new Tmap.Bounds(c.left,c.bottom,c.left+d,c.bottom+e)}return a},initSingleTile:function(a){this.events.triggerEvent("retile");var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio,d=a.getHeight()*this.ratio,e=new Tmap.Bounds(b.lon-c/2,b.lat-d/2,b.lon+c/2,b.lat+d/2),f=this.map.getLayerPxFromLonLat({lon:e.left,lat:e.top});this.grid.length||(this.grid[0]=[]);var g=this.grid[0][0];g?g.moveTo(e,f):(g=this.addTile(e,f),this.addTileMonitoringHooks(g),g.draw(),this.grid[0][0]=g),this.removeExcessTiles(1,1),this.gridResolution=this.getServerResolution()},calculateGridLayout:function(a,b,c){var d=c*this.tileSize.w,e=c*this.tileSize.h,f=a.left-b.lon,g=Math.floor(f/d)-this.buffer,h=this.rowSign,i=h*(b.lat-a.top+e),j=Math[~h?"floor":"ceil"](i/e)-this.buffer*h;return{tilelon:d,tilelat:e,startcol:g,startrow:j}},getTileOrigin:function(){var a=this.tileOrigin;if(!a){var b=this.getMaxExtent(),c={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];a=new Tmap.LonLat(b[c[0]],b[c[1]])}return a},getTileBoundsForGridIndex:function(a,b){var c=this.getTileOrigin(),d=this.gridLayout,e=d.tilelon,f=d.tilelat,g=d.startcol,h=d.startrow,i=this.rowSign;return new Tmap.Bounds(c.lon+(g+b)*e,c.lat-(h+a*i)*f*i,c.lon+(g+b+1)*e,c.lat-(h+(a-1)*i)*f*i)},initGriddedTiles:function(a){this.events.triggerEvent("retile");var b=this.map.getSize(),c=this.getTileOrigin(),d=this.map.getResolution(),e=this.getServerResolution(),f=d/e,g={w:this.tileSize.w/f,h:this.tileSize.h/f},h=Math.ceil(b.h/g.h)+2*this.buffer+1,i=Math.ceil(b.w/g.w)+2*this.buffer+1,j=this.calculateGridLayout(a,c,e);this.gridLayout=j;var k=j.tilelon,l=j.tilelat,m=this.map.layerContainerOriginPx.x,n=this.map.layerContainerOriginPx.y,o=this.getTileBoundsForGridIndex(0,0),p=this.map.getViewPortPxFromLonLat(new Tmap.LonLat(o.left,o.top));p.x=Math.round(p.x)-m,p.y=Math.round(p.y)-n;var q=[],r=this.map.getCenter(),s=0;do{var t=this.grid[s];t||(t=[],this.grid.push(t));var u=0;do{o=this.getTileBoundsForGridIndex(s,u);var v=p.clone();v.x=v.x+u*Math.round(g.w),v.y=v.y+s*Math.round(g.h);var w=t[u];w?w.moveTo(o,v,!1):(w=this.addTile(o,v),this.addTileMonitoringHooks(w),t.push(w));var x=o.getCenterLonLat();q.push({tile:w,distance:Math.pow(x.lon-r.lon,2)+Math.pow(x.lat-r.lat,2)}),u+=1}while(o.right<=a.right+k*this.buffer||i>u);s+=1}while(o.bottom>=a.bottom-l*this.buffer||h>s);this.removeExcessTiles(s,u);var d=this.getServerResolution();this.gridResolution=d,q.sort(function(a,b){return a.distance-b.distance});for(var y=0,z=q.length;z>y;++y)q[y].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(a,b){var c=new this.tileClass(this,b,a,null,this.tileSize,this.tileOptions);return this.events.triggerEvent("addtile",{tile:c}),c},addTileMonitoringHooks:function(a){var b="olTileReplacing";a.onLoadStart=function(){this.loading===!1&&(this.loading=!0,this.events.triggerEvent("loadstart")),this.events.triggerEvent("tileloadstart",{tile:a}),this.numLoadingTiles++,!this.singleTile&&this.backBuffer&&this.gridResolution===this.backBufferResolution&&Tmap.Element.addClass(a.imgDiv,b)},a.onLoadEnd=function(c){this.numLoadingTiles--;var d="unload"===c.type;if(this.events.triggerEvent("tileloaded",{tile:a,aborted:d}),!this.singleTile&&!d&&this.backBuffer&&this.gridResolution===this.backBufferResolution){if("none"===Tmap.Element.getStyle(a.imgDiv,"display")){var e=document.getElementById(a.id+"_bb");e&&e.parentNode.removeChild(e)}Tmap.Element.removeClass(a.imgDiv,b)}if(0===this.numLoadingTiles){if(this.backBuffer){this._transitionElement=a.imgDiv;for(var f=this.transitionendEvents.length-1;f>=0;--f)Tmap.Event.observe(this._transitionElement,this.transitionendEvents[f],this._removeBackBuffer);this.backBufferTimerId=window.setTimeout(this._removeBackBuffer,this.removeBackBufferDelay)}this.loading=!1,this.events.triggerEvent("loadend")}},a.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:a})},a.events.on({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,loaderror:a.onLoadError,scope:this})},removeTileMonitoringHooks:function(a){a.unload(),a.events.un({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,loaderror:a.onLoadError,scope:this})},moveGriddedTiles:function(){for(var a=this.buffer+1;;){var b=this.grid[0][0],c={x:b.position.x+this.map.layerContainerOriginPx.x,y:b.position.y+this.map.layerContainerOriginPx.y},d=this.getServerResolution()/this.map.getResolution(),e={w:Math.round(this.tileSize.w*d),h:Math.round(this.tileSize.h*d)};if(c.x>-e.w*(a-1))this.shiftColumn(!0,e);else if(c.x<-e.w*a)this.shiftColumn(!1,e);else if(c.y>-e.h*(a-1))this.shiftRow(!0,e);else{if(!(c.y<-e.h*a))break;this.shiftRow(!1,e)}}},shiftRow:function(a,b){var c=this.grid,d=a?0:c.length-1,e=a?-1:1,f=this.rowSign,g=this.gridLayout;g.startrow+=e*f;for(var h=c[d],i=c[a?"pop":"shift"](),j=0,k=i.length;k>j;j++){var l=i[j],m=h[j].position.clone();m.y+=b.h*e,l.moveTo(this.getTileBoundsForGridIndex(d,j),m)}c[a?"unshift":"push"](i)},shiftColumn:function(a,b){var c=this.grid,d=a?0:c[0].length-1,e=a?-1:1,f=this.gridLayout;f.startcol+=e;for(var g=0,h=c.length;h>g;g++){var i=c[g],j=i[d].position.clone(),k=i[a?"pop":"shift"]();j.x+=b.w*e,k.moveTo(this.getTileBoundsForGridIndex(g,d),j),i[a?"unshift":"push"](k)}},removeExcessTiles:function(a,b){for(var c,d;this.grid.length>a;){var e=this.grid.pop();for(c=0,d=e.length;d>c;c++){var f=e[c];this.destroyTile(f)}}for(c=0,d=this.grid.length;d>c;c++)for(;this.grid[c].length>b;){var e=this.grid[c],f=e.pop();this.destroyTile(f)}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(a){var b=this.maxExtent,c=this.getResolution(),d=c*this.tileSize.w,e=c*this.tileSize.h,f=this.getLonLatFromViewPortPx(a),g=b.left+d*Math.floor((f.lon-b.left)/d),h=b.bottom+e*Math.floor((f.lat-b.bottom)/e);return new Tmap.Bounds(g,h,g+d,h+e)},CLASS_NAME:"Tmap.Layer.Grid"}),Tmap.Layer.MapServer=Tmap.Class(Tmap.Layer.Grid,{DEFAULT_PARAMS:{mode:"map",map_imagetype:"png"},initialize:function(a,b,c,d){Tmap.Layer.Grid.prototype.initialize.apply(this,arguments),this.params=Tmap.Util.applyDefaults(this.params,this.DEFAULT_PARAMS),(null==d||null==d.isBaseLayer)&&(this.isBaseLayer="true"!=this.params.transparent&&1!=this.params.transparent)},clone:function(a){return null==a&&(a=new Tmap.Layer.MapServer(this.name,this.url,this.params,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=[a.left,a.bottom,a.right,a.top],c=this.getImageSize(),d=this.getFullRequestString({mapext:b,imgext:b,map_size:[c.w,c.h],imgx:c.w/2,imgy:c.h/2,imgxy:[c.w,c.h]});return d},getFullRequestString:function(a,b){var c=null==b?this.url:b,d=Tmap.Util.extend({},this.params);d=Tmap.Util.extend(d,a);var e=Tmap.Util.getParameterString(d);Tmap.Util.isArray(c)&&(c=this.selectUrl(e,c));var f=Tmap.Util.upperCaseObject(Tmap.Util.getParameters(c));for(var g in d)g.toUpperCase()in f&&delete d[g];e=Tmap.Util.getParameterString(d);var h=c;if(e=e.replace(/,/g,"+"),""!=e){var i=c.charAt(c.length-1);h+="&"==i||"?"==i?e:-1==c.indexOf("?")?"?"+e:"&"+e}return h},CLASS_NAME:"Tmap.Layer.MapServer"}),Tmap.Layer.Markers=Tmap.Class(Tmap.Layer,{isBaseLayer:!1,markers:null,drawn:!1,initialize:function(a,b){Tmap.Layer.prototype.initialize.apply(this,arguments),this.markers=[]},destroy:function(){this.clearMarkers(),this.markers=null,Tmap.Layer.prototype.destroy.apply(this,arguments)},setOpacity:function(a){if(a!=this.opacity){this.opacity=a;for(var b=0,c=this.markers.length;c>b;b++)this.markers[b].setOpacity(this.opacity)}},moveTo:function(a,b,c){if(Tmap.Layer.prototype.moveTo.apply(this,arguments),b||!this.drawn){for(var d=0,e=this.markers.length;e>d;d++)this.drawMarker(this.markers[d]);this.drawn=!0}},addMarker:function(a){this.markers.push(a),this.opacity<1&&a.setOpacity(this.opacity),this.map&&this.map.getExtent()&&(a.map=this.map,this.drawMarker(a))},removeMarker:function(a){this.markers&&this.markers.length&&(Tmap.Util.removeItem(this.markers,a),a.erase())},clearMarkers:function(){if(null!=this.markers)for(;this.markers.length>0;)this.removeMarker(this.markers[0])},drawMarker:function(a){var b=this.map.getLayerPxFromLonLat(a.lonlat);if(null==b)a.display(!1);else if(a.isDrawn())a.icon&&a.icon.moveTo(b);else{var c=a.draw(b);this.div.appendChild(c)}},getDataExtent:function(){var a=null;if(this.markers&&this.markers.length>0)for(var a=new Tmap.Bounds,b=0,c=this.markers.length;c>b;b++){var d=this.markers[b];a.extend(d.lonlat)}return a},CLASS_NAME:"Tmap.Layer.Markers"}),Tmap.Layer.Text=Tmap.Class(Tmap.Layer.Markers,{location:null,features:null,formatOptions:null,selectedFeature:null,initialize:function(a,b){Tmap.Layer.Markers.prototype.initialize.apply(this,arguments),this.features=[]},destroy:function(){Tmap.Layer.Markers.prototype.destroy.apply(this,arguments),this.clearFeatures(),this.features=null},loadText:function(){if(!this.loaded&&null!=this.location){var a=function(a){this.events.triggerEvent("loadend")};this.events.triggerEvent("loadstart"),Tmap.Request.GET({url:this.location,success:this.parseData,failure:a,scope:this}),this.loaded=!0}},moveTo:function(a,b,c){Tmap.Layer.Markers.prototype.moveTo.apply(this,arguments),this.visibility&&!this.loaded&&this.loadText()},parseData:function(a){var b=a.responseText,c={};Tmap.Util.extend(c,this.formatOptions),this.map&&!this.projection.equals(this.map.getProjectionObject())&&(c.externalProjection=this.projection,c.internalProjection=this.map.getProjectionObject());for(var d=new Tmap.Format.Text(c),e=d.read(b),f=0,g=e.length;g>f;f++){var h,i,j,k={},l=e[f];h=new Tmap.LonLat(l.geometry.x,l.geometry.y),l.style.graphicWidth&&l.style.graphicHeight&&(i=new Tmap.Size(l.style.graphicWidth,l.style.graphicHeight)),void 0!==l.style.graphicXOffset&&void 0!==l.style.graphicYOffset&&(j=new Tmap.Pixel(l.style.graphicXOffset,l.style.graphicYOffset)),null!=l.style.externalGraphic?k.icon=new Tmap.Icon(l.style.externalGraphic,i,j):(k.icon=Tmap.Marker.defaultIcon(),null!=i&&k.icon.setSize(i)),null!=l.attributes.title&&null!=l.attributes.description&&(k.popupContentHTML="<h2>"+l.attributes.title+"</h2><p>"+l.attributes.description+"</p>"),k.overflow=l.attributes.overflow||"auto";var m=new Tmap.Feature(this,h,k);this.features.push(m);var n=m.createMarker();null!=l.attributes.title&&null!=l.attributes.description&&n.events.register("click",m,this.markerClick),this.addMarker(n)}this.events.triggerEvent("loadend")},markerClick:function(a){var b=this==this.layer.selectedFeature;this.layer.selectedFeature=b?null:this;for(var c=0,d=this.layer.map.popups.length;d>c;c++)this.layer.map.removePopup(this.layer.map.popups[c]);b||this.layer.map.addPopup(this.createPopup()),Tmap.Event.stop(a)},clearFeatures:function(){if(null!=this.features)for(;this.features.length>0;){var a=this.features[0];Tmap.Util.removeItem(this.features,a),a.destroy()}},CLASS_NAME:"Tmap.Layer.Text"}),Tmap.Layer.WorldWind=Tmap.Class(Tmap.Layer.Grid,{DEFAULT_PARAMS:{},isBaseLayer:!0,lzd:null,zoomLevels:null,initialize:function(a,b,c,d,e,f){this.lzd=c,this.zoomLevels=d;var g=[];g.push(a,b,e,f),Tmap.Layer.Grid.prototype.initialize.apply(this,g),this.params=Tmap.Util.applyDefaults(this.params,this.DEFAULT_PARAMS)},getZoom:function(){var a=this.map.getZoom();this.map.getMaxExtent();return a-=Math.log(this.maxResolution/(this.lzd/512))/Math.log(2)},getURL:function(a){a=this.adjustBounds(a);var b=this.getZoom(),c=this.map.getMaxExtent(),d=this.lzd/Math.pow(2,this.getZoom()),e=Math.floor((a.left-c.left)/d),f=Math.floor((a.bottom-c.bottom)/d);return this.map.getResolution()<=this.lzd/512&&this.getZoom()<=this.zoomLevels?this.getFullRequestString({L:b,X:e,Y:f}):Tmap.Util.getImageLocation("blank.gif")},CLASS_NAME:"Tmap.Layer.WorldWind"}),Tmap.Layer.WMS=Tmap.Class(Tmap.Layer.Grid,{DEFAULT_PARAMS:{service:"WMS",version:"1.1.1",request:"GetMap",styles:"",format:"image/jpeg"},isBaseLayer:!0,encodeBBOX:!1,noMagic:!1,yx:{},initialize:function(a,b,c,d){var e=[];c=Tmap.Util.upperCaseObject(c),parseFloat(c.VERSION)>=1.3&&!c.EXCEPTIONS&&(c.EXCEPTIONS="INIMAGE"),e.push(a,b,c,d),Tmap.Layer.Grid.prototype.initialize.apply(this,e),Tmap.Util.applyDefaults(this.params,Tmap.Util.upperCaseObject(this.DEFAULT_PARAMS)),!this.noMagic&&this.params.TRANSPARENT&&"true"==this.params.TRANSPARENT.toString().toLowerCase()&&(null!=d&&d.isBaseLayer||(this.isBaseLayer=!1),"image/jpeg"==this.params.FORMAT&&(this.params.FORMAT=Tmap.Util.alphaHack()?"image/gif":"image/png"))},clone:function(a){return null==a&&(a=new Tmap.Layer.WMS(this.name,this.url,this.params,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},reverseAxisOrder:function(){var a=this.projection.getCode();return parseFloat(this.params.VERSION)>=1.3&&!!(this.yx[a]||Tmap.Projection.defaults[a]&&Tmap.Projection.defaults[a].yx)},getURL:function(a){a=this.adjustBounds(a);var b=this.getImageSize(),c={},d=this.reverseAxisOrder();c.BBOX=this.encodeBBOX?a.toBBOX(null,d):a.toArray(d),c.WIDTH=b.w,c.HEIGHT=b.h;var e=this.getFullRequestString(c);return e},mergeNewParams:function(a){var b=Tmap.Util.upperCaseObject(a),c=[b];return Tmap.Layer.Grid.prototype.mergeNewParams.apply(this,c)},getFullRequestString:function(a,b){var c=this.map.getProjectionObject(),d=this.projection&&this.projection.equals(c)?this.projection.getCode():c.getCode(),e="none"==d?null:d;return parseFloat(this.params.VERSION)>=1.3?this.params.CRS=e:this.params.SRS=e,"boolean"==typeof this.params.TRANSPARENT&&(a.TRANSPARENT=this.params.TRANSPARENT?"TRUE":"FALSE"),Tmap.Layer.Grid.prototype.getFullRequestString.apply(this,arguments)},CLASS_NAME:"Tmap.Layer.WMS"}),Tmap.Layer.Boxes=Tmap.Class(Tmap.Layer.Markers,{drawMarker:function(a){var b=this.map.getLayerPxFromLonLat({lon:a.bounds.left,lat:a.bounds.top}),c=this.map.getLayerPxFromLonLat({lon:a.bounds.right,lat:a.bounds.bottom});if(null==c||null==b)a.display(!1);else{var d=a.draw(b,{w:Math.max(1,c.x-b.x),h:Math.max(1,c.y-b.y)});a.drawn||(this.div.appendChild(d),a.drawn=!0)}},removeMarker:function(a){Tmap.Util.removeItem(this.markers,a),null!=a.div&&a.div.parentNode==this.div&&this.div.removeChild(a.div)},CLASS_NAME:"Tmap.Layer.Boxes"}),Tmap.Layer.XYZ=Tmap.Class(Tmap.Layer.Grid,{isBaseLayer:!0,sphericalMercator:!1,zoomOffset:0,serverResolutions:null,initialize:function(a,b,c){(c&&c.sphericalMercator||this.sphericalMercator)&&(c=Tmap.Util.extend({projection:"EPSG:900913",numZoomLevels:19},c)),Tmap.Layer.Grid.prototype.initialize.apply(this,[a||this.name,b||this.url,{},c])},clone:function(a){return null==a&&(a=new Tmap.Layer.XYZ(this.name,this.url,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){var b=this.getXYZ(a),c=this.url;if(Tmap.Util.isArray(c)){var d=""+b.x+b.y+b.z;c=this.selectUrl(d,c)}return Tmap.String.format(c,b)},getXYZ:function(a){var b=this.getServerResolution(),c=Math.round((a.left-this.maxExtent.left)/(b*this.tileSize.w)),d=Math.round((this.maxExtent.top-a.top)/(b*this.tileSize.h)),e=this.getServerZoom();if(this.wrapDateLine){var f=Math.pow(2,e);c=(c%f+f)%f}return{x:c,y:d,z:e}},setMap:function(a){Tmap.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin||(this.tileOrigin=new Tmap.LonLat(this.maxExtent.left,this.maxExtent.bottom))},CLASS_NAME:"Tmap.Layer.XYZ"}),Tmap.Layer.UTFGrid=Tmap.Class(Tmap.Layer.XYZ,{isBaseLayer:!1,projection:new Tmap.Projection("EPSG:900913"),useJSONP:!1,tileClass:Tmap.Tile.UTFGrid,initialize:function(a){Tmap.Layer.Grid.prototype.initialize.apply(this,[a.name,a.url,{},a]),this.tileOptions=Tmap.Util.extend({utfgridResolution:this.utfgridResolution},this.tileOptions)},createBackBuffer:function(){},clone:function(a){return null==a&&(a=new Tmap.Layer.UTFGrid(this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getFeatureInfo:function(a){var b=null,c=this.getTileData(a);return c&&c.tile&&(b=c.tile.getFeatureInfo(c.i,c.j)),b},getFeatureId:function(a){var b=null,c=this.getTileData(a);return c.tile&&(b=c.tile.getFeatureId(c.i,c.j)),b},CLASS_NAME:"Tmap.Layer.UTFGrid"}),Tmap.Layer.OSM=Tmap.Class(Tmap.Layer.XYZ,{name:"OpenStreetMap",url:["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"],attribution:"&copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",sphericalMercator:!0,wrapDateLine:!0,tileOptions:null,initialize:function(a,b,c){Tmap.Layer.XYZ.prototype.initialize.apply(this,arguments),this.tileOptions=Tmap.Util.extend({crossOriginKeyword:"anonymous"},this.options&&this.options.tileOptions)},clone:function(a){return null==a&&(a=new Tmap.Layer.OSM(this.name,this.url,this.getOptions())),a=Tmap.Layer.XYZ.prototype.clone.apply(this,[a])},CLASS_NAME:"Tmap.Layer.OSM"}),Tmap.Layer.TMAP=Tmap.Class(Tmap.Layer.Grid,{serviceVersion:"1.0.0",layername:null,type:null,isBaseLayer:!0,tileOrigin:null,serverResolutions:null,zoomOffset:0,initialize:function(a,b,c){var d=[];d.push(a,b,{},c),Tmap.Layer.Grid.prototype.initialize.apply(this,d)},clone:function(a){return null==a&&(a=new Tmap.Layer.TMS(this.name,this.url,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=this.getServerResolution(),c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w)),d=Math.round((a.bottom-this.tileOrigin.lat)/(b*this.tileSize.h)),e=null!=this.serverResolutions?Tmap.Util.indexOf(this.serverResolutions,b):this.getServerZoom()+this.zoomOffset,f=this.serviceVersion+"/"+this.layername+"/"+e+"/"+c+"/"+d+"."+this.type,g=this.url;return Tmap.Util.isArray(g)&&(g=this.selectUrl(f,g)),c="C"+this.zeroPad(c,8,16),d="R"+this.zeroPad(d,8,16),e="L"+this.zeroPad(e,2,16),g=g+"/${z}/${y}/${x}."+this.type,g=Tmap.String.format(g,{x:c,y:d,z:e}),Tmap.Util.urlAppend(g,Tmap.Util.getParameterString(this.params))},intToString:function(a){return a>9?a.toString():"0"+a.toString()},zeroPad:function(a,b,c){for(var d=a.toString(c||10);d.length<b;)d="0"+d;return d},setMap:function(a){Tmap.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin||(this.tileOrigin=new Tmap.LonLat(this.map.maxExtent.left,this.map.maxExtent.bottom))},CLASS_NAME:"Tmap.Layer.TMS"}),Tmap.Layer.TMS=Tmap.Class(Tmap.Layer.Grid,{serviceVersion:"1.0.0",layername:null,type:null,isBaseLayer:!0,tileOrigin:null,serverResolutions:null,zoomOffset:0,initialize:function(a,b,c){var d=[];d.push(a,b,{},c),Tmap.Layer.Grid.prototype.initialize.apply(this,d)},clone:function(a){return null==a&&(a=new Tmap.Layer.TMS(this.name,this.url,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=this.getServerResolution(),c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w)),d=Math.round((a.bottom-this.tileOrigin.lat)/(b*this.tileSize.h)),e=this.getServerZoom(),f=this.serviceVersion+"/"+this.layername+"/"+e+"/"+c+"/"+d+"."+this.type,g=this.url;return Tmap.Util.isArray(g)&&(g=this.selectUrl(f,g)),g+f},setMap:function(a){Tmap.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin||(this.tileOrigin=new Tmap.LonLat(this.map.maxExtent.left,this.map.maxExtent.bottom))},CLASS_NAME:"Tmap.Layer.TMS"}),Tmap.Layer.TileCache=Tmap.Class(Tmap.Layer.Grid,{isBaseLayer:!0,format:"image/png",serverResolutions:null,initialize:function(a,b,c,d){this.layername=c,Tmap.Layer.Grid.prototype.initialize.apply(this,[a,b,{},d]),this.extension=this.format.split("/")[1].toLowerCase(),this.extension="jpg"==this.extension?"jpeg":this.extension},clone:function(a){return null==a&&(a=new Tmap.Layer.TileCache(this.name,this.url,this.layername,this.getOptions())),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){
var b=this.getServerResolution(),c=this.maxExtent,d=this.tileSize,e=Math.round((a.left-c.left)/(b*d.w)),f=Math.round((a.bottom-c.bottom)/(b*d.h)),g=null!=this.serverResolutions?Tmap.Util.indexOf(this.serverResolutions,b):this.map.getZoom(),h=[this.layername,Tmap.Number.zeroPad(g,2),Tmap.Number.zeroPad(parseInt(e/1e6),3),Tmap.Number.zeroPad(parseInt(e/1e3)%1e3,3),Tmap.Number.zeroPad(parseInt(e)%1e3,3),Tmap.Number.zeroPad(parseInt(f/1e6),3),Tmap.Number.zeroPad(parseInt(f/1e3)%1e3,3),Tmap.Number.zeroPad(parseInt(f)%1e3,3)+"."+this.extension],i=h.join("/"),j=this.url;return Tmap.Util.isArray(j)&&(j=this.selectUrl(i,j)),j="/"==j.charAt(j.length-1)?j:j+"/",j+i},CLASS_NAME:"Tmap.Layer.TileCache"}),Tmap.Layer.Zoomify=Tmap.Class(Tmap.Layer.Grid,{size:null,isBaseLayer:!0,standardTileSize:256,tileOriginCorner:"tl",numberOfTiers:0,tileCountUpToTier:null,tierSizeInTiles:null,tierImageSize:null,initialize:function(a,b,c,d){this.initializeZoomify(c),Tmap.Layer.Grid.prototype.initialize.apply(this,[a,b,c,{},d])},initializeZoomify:function(a){var b=a.clone();this.size=a.clone();var c=new Tmap.Size(Math.ceil(b.w/this.standardTileSize),Math.ceil(b.h/this.standardTileSize));for(this.tierSizeInTiles=[c],this.tierImageSize=[b];b.w>this.standardTileSize||b.h>this.standardTileSize;)b=new Tmap.Size(Math.floor(b.w/2),Math.floor(b.h/2)),c=new Tmap.Size(Math.ceil(b.w/this.standardTileSize),Math.ceil(b.h/this.standardTileSize)),this.tierSizeInTiles.push(c),this.tierImageSize.push(b);this.tierSizeInTiles.reverse(),this.tierImageSize.reverse(),this.numberOfTiers=this.tierSizeInTiles.length;var d=[1];this.tileCountUpToTier=[0];for(var e=1;e<this.numberOfTiers;e++)d.unshift(Math.pow(2,e)),this.tileCountUpToTier.push(this.tierSizeInTiles[e-1].w*this.tierSizeInTiles[e-1].h+this.tileCountUpToTier[e-1]);this.serverResolutions||(this.serverResolutions=d)},destroy:function(){Tmap.Layer.Grid.prototype.destroy.apply(this,arguments),this.tileCountUpToTier.length=0,this.tierSizeInTiles.length=0,this.tierImageSize.length=0},clone:function(a){return null==a&&(a=new Tmap.Layer.Zoomify(this.name,this.url,this.size,this.options)),a=Tmap.Layer.Grid.prototype.clone.apply(this,[a])},getURL:function(a){a=this.adjustBounds(a);var b=this.getServerResolution(),c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w)),d=Math.round((this.tileOrigin.lat-a.top)/(b*this.tileSize.h)),e=this.getZoomForResolution(b),f=c+d*this.tierSizeInTiles[e].w+this.tileCountUpToTier[e],g="TileGroup"+Math.floor(f/256)+"/"+e+"-"+c+"-"+d+".jpg",h=this.url;return Tmap.Util.isArray(h)&&(h=this.selectUrl(g,h)),h+g},getImageSize:function(){if(arguments.length>0){var a=this.adjustBounds(arguments[0]),b=this.getServerResolution(),c=Math.round((a.left-this.tileOrigin.lon)/(b*this.tileSize.w)),d=Math.round((this.tileOrigin.lat-a.top)/(b*this.tileSize.h)),e=this.getZoomForResolution(b),f=this.standardTileSize,g=this.standardTileSize;if(c==this.tierSizeInTiles[e].w-1)var f=this.tierImageSize[e].w%this.standardTileSize;if(d==this.tierSizeInTiles[e].h-1)var g=this.tierImageSize[e].h%this.standardTileSize;return new Tmap.Size(f,g)}return this.tileSize},setMap:function(a){Tmap.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin=new Tmap.LonLat(this.map.maxExtent.left,this.map.maxExtent.top)},CLASS_NAME:"Tmap.Layer.Zoomify"}),Tmap.Popup.Anchored=Tmap.Class(Tmap.Popup,{relativePosition:null,keepInMap:!0,anchor:null,initialize:function(a,b,c,d,e,f,g){var h=[a,b,c,d,f,g];Tmap.Popup.prototype.initialize.apply(this,h),this.anchor=null!=e?e:{size:new Tmap.Size(0,0),offset:new Tmap.Pixel(0,0)}},destroy:function(){this.anchor=null,this.relativePosition=null,Tmap.Popup.prototype.destroy.apply(this,arguments)},show:function(){this.updatePosition(),Tmap.Popup.prototype.show.apply(this,arguments)},moveTo:function(a){var b=this.relativePosition;this.relativePosition=this.calculateRelativePosition(a),Tmap.Popup.prototype.moveTo.call(this,this.calculateNewPx(a)),this.relativePosition!=b&&this.updateRelativePosition()},setSize:function(a){if(Tmap.Popup.prototype.setSize.apply(this,arguments),this.lonlat&&this.map){var b=this.map.getLayerPxFromLonLat(this.lonlat);this.moveTo(b)}},calculateRelativePosition:function(a){var b=this.map.getLonLatFromLayerPx(a),c=this.map.getExtent(),d=c.determineQuadrant(b);return Tmap.Bounds.oppositeQuadrant(d)},updateRelativePosition:function(){},calculateNewPx:function(a){var b=a.offset(this.anchor.offset),c=this.size||this.contentSize,d="t"==this.relativePosition.charAt(0);b.y+=d?-c.h:this.anchor.size.h;var e="l"==this.relativePosition.charAt(1);return b.x+=e?-c.w:this.anchor.size.w,b},CLASS_NAME:"Tmap.Popup.Anchored"}),Tmap.Popup.AnchoredBubble=Tmap.Class(Tmap.Popup.Anchored,{rounded:!1,initialize:function(a,b,c,d,e,f,g){Tmap.Console.warn("AnchoredBubble is deprecated"),this.padding=new Tmap.Bounds(0,Tmap.Popup.AnchoredBubble.CORNER_SIZE,0,Tmap.Popup.AnchoredBubble.CORNER_SIZE),Tmap.Popup.Anchored.prototype.initialize.apply(this,arguments)},draw:function(a){return Tmap.Popup.Anchored.prototype.draw.apply(this,arguments),this.setContentHTML(),this.setBackgroundColor(),this.setOpacity(),this.div},updateRelativePosition:function(){this.setRicoCorners()},setSize:function(a){Tmap.Popup.Anchored.prototype.setSize.apply(this,arguments),this.setRicoCorners()},setBackgroundColor:function(a){void 0!=a&&(this.backgroundColor=a),null!=this.div&&null!=this.contentDiv&&(this.div.style.background="transparent",Tmap.Rico.Corner.changeColor(this.groupDiv,this.backgroundColor))},setOpacity:function(a){Tmap.Popup.Anchored.prototype.setOpacity.call(this,a),null!=this.div&&null!=this.groupDiv&&Tmap.Rico.Corner.changeOpacity(this.groupDiv,this.opacity)},setBorder:function(a){this.border=0},setRicoCorners:function(){var a=this.getCornersToRound(this.relativePosition),b={corners:a,color:this.backgroundColor,bgColor:"transparent",blend:!1};this.rounded?(Tmap.Rico.Corner.reRound(this.groupDiv,b),this.setBackgroundColor(),this.setOpacity()):(Tmap.Rico.Corner.round(this.div,b),this.rounded=!0)},getCornersToRound:function(){var a=["tl","tr","bl","br"],b=Tmap.Bounds.oppositeQuadrant(this.relativePosition);return Tmap.Util.removeItem(a,b),a.join(" ")},CLASS_NAME:"Tmap.Popup.AnchoredBubble"}),Tmap.Popup.AnchoredBubble.CORNER_SIZE=5,Tmap.Popup.Framed=Tmap.Class(Tmap.Popup.Anchored,{imageSrc:null,imageSize:null,isAlphaImage:!1,positionBlocks:null,blocks:null,fixedRelativePosition:!1,initialize:function(a,b,c,d,e,f,g){Tmap.Popup.Anchored.prototype.initialize.apply(this,arguments),this.fixedRelativePosition&&(this.updateRelativePosition(),this.calculateRelativePosition=function(a){return this.relativePosition}),this.contentDiv.style.position="absolute",this.contentDiv.style.zIndex=1,f&&(this.closeDiv.style.zIndex=1),this.groupDiv.style.position="absolute",this.groupDiv.style.top="0px",this.groupDiv.style.left="0px",this.groupDiv.style.height="100%",this.groupDiv.style.width="100%"},destroy:function(){this.imageSrc=null,this.imageSize=null,this.isAlphaImage=null,this.fixedRelativePosition=!1,this.positionBlocks=null;for(var a=0;a<this.blocks.length;a++){var b=this.blocks[a];b.image&&b.div.removeChild(b.image),b.image=null,b.div&&this.groupDiv.removeChild(b.div),b.div=null}this.blocks=null,Tmap.Popup.Anchored.prototype.destroy.apply(this,arguments)},setBackgroundColor:function(a){},setBorder:function(){},setOpacity:function(a){},setSize:function(a){Tmap.Popup.Anchored.prototype.setSize.apply(this,arguments),this.updateBlocks()},updateRelativePosition:function(){if(this.padding=this.positionBlocks[this.relativePosition].padding,this.closeDiv){var a=this.getContentDivPadding();this.closeDiv.style.right=a.right+this.padding.right+"px",this.closeDiv.style.top=a.top+this.padding.top+"px"}this.updateBlocks()},calculateNewPx:function(a){var b=Tmap.Popup.Anchored.prototype.calculateNewPx.apply(this,arguments);return b=b.offset(this.positionBlocks[this.relativePosition].offset)},createBlocks:function(){this.blocks=[];var a=null;for(var b in this.positionBlocks){a=b;break}for(var c=this.positionBlocks[a],d=0;d<c.blocks.length;d++){var e={};this.blocks.push(e);var f=this.id+"_FrameDecorationDiv_"+d;e.div=Tmap.Util.createDiv(f,null,null,null,"absolute",null,"hidden",null);var g=this.id+"_FrameDecorationImg_"+d,h=this.isAlphaImage?Tmap.Util.createAlphaImageDiv:Tmap.Util.createImage;e.image=h(g,null,this.imageSize,this.imageSrc,"absolute",null,null,null),e.div.appendChild(e.image),this.groupDiv.appendChild(e.div)}},updateBlocks:function(){if(this.blocks||this.createBlocks(),this.size&&this.relativePosition){for(var a=this.positionBlocks[this.relativePosition],b=0;b<a.blocks.length;b++){var c=a.blocks[b],d=this.blocks[b],e=c.anchor.left,f=c.anchor.bottom,g=c.anchor.right,h=c.anchor.top,i=isNaN(c.size.w)?this.size.w-(g+e):c.size.w,j=isNaN(c.size.h)?this.size.h-(f+h):c.size.h;d.div.style.width=(0>i?0:i)+"px",d.div.style.height=(0>j?0:j)+"px",d.div.style.left=null!=e?e+"px":"",d.div.style.bottom=null!=f?f+"px":"",d.div.style.right=null!=g?g+"px":"",d.div.style.top=null!=h?h+"px":"",d.image.style.left=c.position.x+"px",d.image.style.top=c.position.y+"px"}this.contentDiv.style.left=this.padding.left+"px",this.contentDiv.style.top=this.padding.top+"px"}},CLASS_NAME:"Tmap.Popup.Framed"}),Tmap.Popup.FramedCloud=Tmap.Class(Tmap.Popup.Framed,{contentDisplayClass:"tmFramedCloudPopupContent",autoSize:!0,panMapIfOutOfView:!0,imageSize:new Tmap.Size(1276,736),isAlphaImage:!1,fixedRelativePosition:!1,positionBlocks:{tl:{offset:new Tmap.Pixel(44,0),padding:new Tmap.Bounds(8,40,8,9),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,51,22,0),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,50,0,0),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",19),anchor:new Tmap.Bounds(0,32,22,null),position:new Tmap.Pixel(0,-631)},{size:new Tmap.Size(22,18),anchor:new Tmap.Bounds(null,32,0,null),position:new Tmap.Pixel(-1238,-632)},{size:new Tmap.Size(81,35),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(0,-688)}]},tr:{offset:new Tmap.Pixel(-45,0),padding:new Tmap.Bounds(8,40,8,9),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,51,22,0),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,50,0,0),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",19),anchor:new Tmap.Bounds(0,32,22,null),position:new Tmap.Pixel(0,-631)},{size:new Tmap.Size(22,19),anchor:new Tmap.Bounds(null,32,0,null),position:new Tmap.Pixel(-1238,-631)},{size:new Tmap.Size(81,35),anchor:new Tmap.Bounds(0,0,null,null),position:new Tmap.Pixel(-215,-687)}]},bl:{offset:new Tmap.Pixel(45,0),padding:new Tmap.Bounds(8,9,8,40),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,21,22,32),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,21,0,32),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",21),anchor:new Tmap.Bounds(0,0,22,null),position:new Tmap.Pixel(0,-629)},{size:new Tmap.Size(22,21),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(-1238,-629)},{size:new Tmap.Size(81,33),anchor:new Tmap.Bounds(null,null,0,0),position:new Tmap.Pixel(-101,-674)}]},br:{offset:new Tmap.Pixel(-44,0),padding:new Tmap.Bounds(8,9,8,40),blocks:[{size:new Tmap.Size("auto","auto"),anchor:new Tmap.Bounds(0,21,22,32),position:new Tmap.Pixel(0,0)},{size:new Tmap.Size(22,"auto"),anchor:new Tmap.Bounds(null,21,0,32),position:new Tmap.Pixel(-1238,0)},{size:new Tmap.Size("auto",21),anchor:new Tmap.Bounds(0,0,22,null),position:new Tmap.Pixel(0,-629)},{size:new Tmap.Size(22,21),anchor:new Tmap.Bounds(null,0,0,null),position:new Tmap.Pixel(-1238,-629)},{size:new Tmap.Size(81,33),anchor:new Tmap.Bounds(0,null,null,0),position:new Tmap.Pixel(-311,-674)}]}},minSize:new Tmap.Size(105,10),maxSize:new Tmap.Size(1200,660),initialize:function(a,b,c,d,e,f,g){this.imageSrc=Tmap.Util.getImageLocation("cloud-popup-relative.png"),Tmap.Popup.Framed.prototype.initialize.apply(this,arguments),this.contentDiv.className=this.contentDisplayClass},CLASS_NAME:"Tmap.Popup.FramedCloud"}),Tmap.Feature=Tmap.Class({layer:null,id:null,lonlat:null,data:null,marker:null,popupClass:null,popup:null,initialize:function(a,b,c){this.layer=a,this.lonlat=b,this.data=null!=c?c:{},this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){null!=this.layer&&null!=this.layer.map&&null!=this.popup&&this.layer.map.removePopup(this.popup),null!=this.layer&&null!=this.marker&&this.layer.removeMarker(this.marker),this.layer=null,this.id=null,this.lonlat=null,this.data=null,null!=this.marker&&(this.destroyMarker(this.marker),this.marker=null),null!=this.popup&&(this.destroyPopup(this.popup),this.popup=null)},onScreen:function(){var a=!1;if(null!=this.layer&&null!=this.layer.map){var b=this.layer.map.getExtent();a=b.containsLonLat(this.lonlat)}return a},createMarker:function(){return null!=this.lonlat&&(this.marker=new Tmap.Marker(this.lonlat,this.data.icon)),this.marker},destroyMarker:function(){this.marker.destroy()},createPopup:function(a){if(null!=this.lonlat){if(!this.popup){var b=this.marker?this.marker.icon:null,c=this.popupClass?this.popupClass:Tmap.Popup.Anchored;this.popup=new c(this.id+"_popup",this.lonlat,this.data.popupSize,this.data.popupContentHTML,b,a)}null!=this.data.overflow&&(this.popup.contentDiv.style.overflow=this.data.overflow),this.popup.feature=this}return this.popup},destroyPopup:function(){this.popup&&(this.popup.feature=null,this.popup.destroy(),this.popup=null)},CLASS_NAME:"Tmap.Feature"}),Tmap.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"},Tmap.Feature.Vector=Tmap.Class(Tmap.Feature,{fid:null,geometry:null,attributes:null,bounds:null,state:null,style:null,url:null,renderIntent:"default",modified:null,initialize:function(a,b,c){Tmap.Feature.prototype.initialize.apply(this,[null,null,b]),this.lonlat=null,this.geometry=a?a:null,this.state=null,this.attributes={},b&&(this.attributes=Tmap.Util.extend(this.attributes,b)),this.style=c?c:null},destroy:function(){this.layer&&(this.layer.removeFeatures(this),this.layer=null),this.geometry=null,this.modified=null,Tmap.Feature.prototype.destroy.apply(this,arguments)},clone:function(){return new Tmap.Feature.Vector(this.geometry?this.geometry.clone():null,this.attributes,this.style)},onScreen:function(a){var b=!1;if(this.layer&&this.layer.map){var c=this.layer.map.getExtent();if(a){var d=this.geometry.getBounds();b=c.intersectsBounds(d)}else{var e=c.toGeometry();b=e.intersects(this.geometry)}}return b},getVisibility:function(){return!(this.style&&"none"==this.style.display||!this.layer||this.layer&&this.layer.styleMap&&"none"==this.layer.styleMap.createSymbolizer(this,this.renderIntent).display||this.layer&&!this.layer.getVisibility())},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(a,b,c){var d=!1;return this.geometry&&(d=this.geometry.atPoint(a,b,c)),d},destroyPopup:function(){},move:function(a){if(this.layer&&this.geometry.move){var b;b="Tmap.LonLat"==a.CLASS_NAME?this.layer.getViewPortPxFromLonLat(a):a;var c=this.layer.getViewPortPxFromLonLat(this.geometry.getBounds().getCenterLonLat()),d=this.layer.map.getResolution();return this.geometry.move(d*(b.x-c.x),d*(c.y-b.y)),this.layer.drawFeature(this),c}},toState:function(a){if(a==Tmap.State.UPDATE)switch(this.state){case Tmap.State.UNKNOWN:case Tmap.State.DELETE:this.state=a;break;case Tmap.State.UPDATE:case Tmap.State.INSERT:}else if(a==Tmap.State.INSERT)switch(this.state){case Tmap.State.UNKNOWN:break;default:this.state=a}else if(a==Tmap.State.DELETE)switch(this.state){case Tmap.State.INSERT:break;case Tmap.State.DELETE:break;case Tmap.State.UNKNOWN:case Tmap.State.UPDATE:this.state=a}else a==Tmap.State.UNKNOWN&&(this.state=a)},CLASS_NAME:"Tmap.Feature.Vector"}),Tmap.Feature.Vector.style={"default":{fillColor:"#ee9900",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#ee9900",strokeOpacity:1,strokeWidth:1,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},select:{fillColor:"blue",fillOpacity:.4,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"blue",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"pointer",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},temporary:{fillColor:"#66cccc",fillOpacity:.2,hoverFillColor:"white",hoverFillOpacity:.8,strokeColor:"#66cccc",strokeOpacity:1,strokeLinecap:"round",strokeWidth:2,strokeDashstyle:"solid",hoverStrokeColor:"red",hoverStrokeOpacity:1,hoverStrokeWidth:.2,pointRadius:6,hoverPointRadius:1,hoverPointUnit:"%",pointerEvents:"visiblePainted",cursor:"inherit",fontColor:"#000000",labelAlign:"cm",labelOutlineColor:"white",labelOutlineWidth:3},"delete":{display:"none"}},Tmap.Handler=Tmap.Class({id:null,control:null,map:null,keyMask:null,active:!1,evt:null,initialize:function(a,b,c){Tmap.Util.extend(this,c),this.control=a,this.callbacks=b;var d=this.map||a.map;d&&this.setMap(d),this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},setMap:function(a){this.map=a},checkModifiers:function(a){if(null==this.keyMask)return!0;var b=(a.shiftKey?Tmap.Handler.MOD_SHIFT:0)|(a.ctrlKey?Tmap.Handler.MOD_CTRL:0)|(a.altKey?Tmap.Handler.MOD_ALT:0)|(a.metaKey?Tmap.Handler.MOD_META:0);return b==this.keyMask},activate:function(){if(this.active)return!1;for(var a=Tmap.Events.prototype.BROWSER_EVENTS,b=0,c=a.length;c>b;b++)this[a[b]]&&this.register(a[b],this[a[b]]);return this.active=!0,!0},deactivate:function(){if(!this.active)return!1;for(var a=Tmap.Events.prototype.BROWSER_EVENTS,b=0,c=a.length;c>b;b++)this[a[b]]&&this.unregister(a[b],this[a[b]]);return this.active=!1,!0},callback:function(a,b){a&&this.callbacks[a]&&this.callbacks[a].apply(this.control,b)},register:function(a,b){this.map.events.registerPriority(a,this,b),this.map.events.registerPriority(a,this,this.setEvent)},unregister:function(a,b){this.map.events.unregister(a,this,b),this.map.events.unregister(a,this,this.setEvent)},setEvent:function(a){return this.evt=a,!0},destroy:function(){this.deactivate(),this.control=this.map=null},CLASS_NAME:"Tmap.Handler"}),Tmap.Handler.MOD_NONE=0,Tmap.Handler.MOD_SHIFT=1,Tmap.Handler.MOD_CTRL=2,Tmap.Handler.MOD_ALT=4,Tmap.Handler.MOD_META=8,Tmap.Handler.Click=Tmap.Class(Tmap.Handler,{delay:300,single:!0,"double":!1,pixelTolerance:0,dblclickTolerance:13,stopSingle:!1,stopDouble:!1,timerId:null,touch:!1,down:null,last:null,first:null,rightclickTimerId:null,touchstart:function(a){return this.touch||(this.unregisterMouseListeners(),this.touch=!0),this.down=this.getEventInfo(a),this.last=this.getEventInfo(a),!0},touchmove:function(a){return this.last=this.getEventInfo(a),!0},touchend:function(a){return this.down&&(a.xy=this.last.xy,a.lastTouches=this.last.touches,this.handleSingle(a),this.down=null),!0},unregisterMouseListeners:function(){this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,click:this.click,dblclick:this.dblclick,scope:this})},mousedown:function(a){return this.down=this.getEventInfo(a),this.last=this.getEventInfo(a),!0},mouseup:function(a){var b=!0;return this.checkModifiers(a)&&this.control.handleRightClicks&&Tmap.Event.isRightClick(a)&&(b=this.rightclick(a)),b},rightclick:function(a){if(this.passesTolerance(a)){if(null!=this.rightclickTimerId)return this.clearTimer(),this.callback("dblrightclick",[a]),!this.stopDouble;var b=this["double"]?Tmap.Util.extend({},a):this.callback("rightclick",[a]),c=Tmap.Function.bind(this.delayedRightCall,this,b);this.rightclickTimerId=window.setTimeout(c,this.delay)}return!this.stopSingle},delayedRightCall:function(a){this.rightclickTimerId=null,a&&this.callback("rightclick",[a])},click:function(a){return this.last||(this.last=this.getEventInfo(a)),this.handleSingle(a),!this.stopSingle},dblclick:function(a){return this.handleDouble(a),!this.stopDouble},handleDouble:function(a){this.passesDblclickTolerance(a)&&(this["double"]&&this.callback("dblclick",[a]),this.clearTimer())},handleSingle:function(a){if(this.passesTolerance(a))if(null!=this.timerId)this.last.touches&&1===this.last.touches.length&&(this["double"]&&Tmap.Event.preventDefault(a),this.handleDouble(a)),this.last.touches&&2===this.last.touches.length||this.clearTimer();else{this.first=this.getEventInfo(a);var b=this.single?Tmap.Util.extend({},a):null;this.queuePotentialClick(b)}},queuePotentialClick:function(a){this.timerId=window.setTimeout(Tmap.Function.bind(this.delayedCall,this,a),this.delay)},passesTolerance:function(a){var b=!0;if(null!=this.pixelTolerance&&this.down&&this.down.xy&&(b=this.pixelTolerance>=this.down.xy.distanceTo(a.xy),b&&this.touch&&this.down.touches.length===this.last.touches.length))for(var c=0,d=this.down.touches.length;d>c;++c)if(this.getTouchDistance(this.down.touches[c],this.last.touches[c])>this.pixelTolerance){b=!1;break}return b},getTouchDistance:function(a,b){return Math.sqrt(Math.pow(a.clientX-b.clientX,2)+Math.pow(a.clientY-b.clientY,2))},passesDblclickTolerance:function(a){var b=!0;return this.down&&this.first&&(b=this.down.xy.distanceTo(this.first.xy)<=this.dblclickTolerance),b},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),null!=this.rightclickTimerId&&(window.clearTimeout(this.rightclickTimerId),this.rightclickTimerId=null)},delayedCall:function(a){this.timerId=null,a&&this.callback("click",[a])},getEventInfo:function(a){var b;if(a.touches){var c=a.touches.length;b=new Array(c);for(var d,e=0;c>e;e++)d=a.touches[e],b[e]={clientX:d.olClientX,clientY:d.olClientY}}return{xy:a.xy,touches:b}},deactivate:function(){var a=!1;return Tmap.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),this.down=null,this.first=null,this.last=null,this.touch=!1,a=!0),a},CLASS_NAME:"Tmap.Handler.Click"}),Tmap.Handler.Hover=Tmap.Class(Tmap.Handler,{delay:500,pixelTolerance:null,stopMove:!1,px:null,timerId:null,mousemove:function(a){return this.passesTolerance(a.xy)&&(this.clearTimer(),this.callback("move",[a]),this.px=a.xy,a=Tmap.Util.extend({},a),this.timerId=window.setTimeout(Tmap.Function.bind(this.delayedCall,this,a),this.delay)),!this.stopMove},mouseout:function(a){return Tmap.Util.mouseLeft(a,this.map.viewPortDiv)&&(this.clearTimer(),this.callback("move",[a])),!0},passesTolerance:function(a){var b=!0;if(this.pixelTolerance&&this.px){var c=Math.sqrt(Math.pow(this.px.x-a.x,2)+Math.pow(this.px.y-a.y,2));c<this.pixelTolerance&&(b=!1)}return b},clearTimer:function(){null!=this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null)},delayedCall:function(a){this.callback("pause",[a])},deactivate:function(){var a=!1;return Tmap.Handler.prototype.deactivate.apply(this,arguments)&&(this.clearTimer(),a=!0),a},CLASS_NAME:"Tmap.Handler.Hover"}),Tmap.Handler.Point=Tmap.Class(Tmap.Handler,{point:null,layer:null,multi:!1,citeCompliant:!1,mouseDown:!1,stoppedDown:null,lastDown:null,lastUp:null,persist:!1,stopDown:!1,stopUp:!1,layerOptions:null,pixelTolerance:5,touch:!1,lastTouchPx:null,initialize:function(a,b,c){c&&c.layerOptions&&c.layerOptions.styleMap||(this.style=Tmap.Util.extend(Tmap.Feature.Vector.style["default"],{})),Tmap.Handler.prototype.initialize.apply(this,arguments)},activate:function(){if(!Tmap.Handler.prototype.activate.apply(this,arguments))return!1;var a=Tmap.Util.extend({displayInLayerSwitcher:!1,calculateInRange:Tmap.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);return this.layer=new Tmap.Layer.Vector(this.CLASS_NAME,a),this.map.addLayer(this.layer),!0},createFeature:function(a){var b=this.layer.getLonLatFromViewPortPx(a),c=new Tmap.Geometry.Point(b.lon,b.lat);this.point=new Tmap.Feature.Vector(c),this.callback("create",[this.point.geometry,this.point]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.point],{silent:!0})},deactivate:function(){return Tmap.Handler.prototype.deactivate.apply(this,arguments)?(this.cancel(),null!=this.layer.map&&(this.destroyFeature(!0),this.layer.destroy(!1)),this.layer=null,this.touch=!1,!0):!1},destroyFeature:function(a){!this.layer||!a&&this.persist||this.layer.destroyFeatures(),this.point=null},destroyPersistedFeature:function(){var a=this.layer;a&&a.features.length>1&&this.layer.features[0].destroy()},finalize:function(a){var b=a?"cancel":"done";this.mouseDown=!1,this.lastDown=null,this.lastUp=null,this.lastTouchPx=null,this.callback(b,[this.geometryClone()]),this.destroyFeature(a)},cancel:function(){this.finalize(!0)},click:function(a){return Tmap.Event.stop(a),!1},dblclick:function(a){return Tmap.Event.stop(a),!1},modifyFeature:function(a){this.point||this.createFeature(a);var b=this.layer.getLonLatFromViewPortPx(a);this.point.geometry.x=b.lon,this.point.geometry.y=b.lat,this.callback("modify",[this.point.geometry,this.point,!1]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.point,this.style)},getGeometry:function(){var a=this.point&&this.point.geometry;return a&&this.multi&&(a=new Tmap.Geometry.MultiPoint([a])),a},geometryClone:function(){var a=this.getGeometry();return a&&a.clone()},mousedown:function(a){return this.down(a)},touchstart:function(a){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),this.lastTouchPx=a.xy,this.down(a)},mousemove:function(a){return this.move(a)},touchmove:function(a){return this.lastTouchPx=a.xy,this.move(a)},mouseup:function(a){return this.up(a)},touchend:function(a){return a.xy=this.lastTouchPx,this.up(a)},down:function(a){return this.mouseDown=!0,this.lastDown=a.xy,this.touch||this.modifyFeature(a.xy),this.stoppedDown=this.stopDown,!this.stopDown},move:function(a){return this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(a.xy),!0},up:function(a){return this.mouseDown=!1,this.stoppedDown=this.stopDown,this.checkModifiers(a)?this.lastUp&&this.lastUp.equals(a.xy)?!0:this.lastDown&&this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)?(this.touch&&this.modifyFeature(a.xy),this.persist&&this.destroyPersistedFeature(),this.lastUp=a.xy,this.finalize(),!this.stopUp):!0:!0},mouseout:function(a){Tmap.Util.mouseLeft(a,this.map.viewPortDiv)&&(this.stoppedDown=this.stopDown,this.mouseDown=!1)},passesTolerance:function(a,b,c){var d=!0;if(null!=c&&a&&b){var e=a.distanceTo(b);e>c&&(d=!1)}return d},CLASS_NAME:"Tmap.Handler.Point"}),Tmap.Handler.Path=Tmap.Class(Tmap.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:!1,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(a){var b=this.layer.getLonLatFromViewPortPx(a),c=new Tmap.Geometry.Point(b.lon,b.lat);this.point=new Tmap.Feature.Vector(c),this.line=new Tmap.Feature.Vector(new Tmap.Geometry.LineString([this.point.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.line,this.point],{silent:!0})},destroyFeature:function(a){Tmap.Handler.Point.prototype.destroyFeature.call(this,a),this.line=null},destroyPersistedFeature:function(){var a=this.layer;a&&a.features.length>2&&this.layer.features[0].destroy()},removePoint:function(){this.point&&this.layer.removeFeatures([this.point])},addPoint:function(a){this.layer.removeFeatures([this.point]);var b=this.layer.getLonLatFromViewPortPx(a);this.point=new Tmap.Feature.Vector(new Tmap.Geometry.Point(b.lon,b.lat)),this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length),this.layer.addFeatures([this.point]),this.callback("point",[this.point.geometry,this.getGeometry()]),this.callback("modify",[this.point.geometry,this.getSketch()]),this.drawFeature(),delete this.redoStack},insertXY:function(a,b){this.line.geometry.addComponent(new Tmap.Geometry.Point(a,b),this.getCurrentPointIndex()),this.drawFeature(),delete this.redoStack},insertDeltaXY:function(a,b){var c=this.getCurrentPointIndex()-1,d=this.line.geometry.components[c];!d||isNaN(d.x)||isNaN(d.y)||this.insertXY(d.x+a,d.y+b)},insertDirectionLength:function(a,b){a*=Math.PI/180;var c=b*Math.cos(a),d=b*Math.sin(a);this.insertDeltaXY(c,d)},insertDeflectionLength:function(a,b){var c=this.getCurrentPointIndex()-1;if(c>0){var d=this.line.geometry.components[c],e=this.line.geometry.components[c-1],f=Math.atan2(d.y-e.y,d.x-e.x);this.insertDirectionLength(180*f/Math.PI+a,b)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var a=this.line.geometry,b=a.components,c=this.getCurrentPointIndex()-1,d=b[c],e=a.removeComponent(d);return e&&(this.redoStack||(this.redoStack=[]),this.redoStack.push(d),this.drawFeature()),e},redo:function(){var a=this.redoStack&&this.redoStack.pop();return a&&(this.line.geometry.addComponent(a,this.getCurrentPointIndex()),this.drawFeature()),!!a},freehandMode:function(a){return this.freehandToggle&&a[this.freehandToggle]?!this.freehand:this.freehand},modifyFeature:function(a,b){this.line||this.createFeature(a);var c=this.layer.getLonLatFromViewPortPx(a);this.point.geometry.x=c.lon,this.point.geometry.y=c.lat,this.callback("modify",[this.point.geometry,this.getSketch(),b]),this.point.geometry.clearBounds(),this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var a=this.line&&this.line.geometry;return a&&this.multi&&(a=new Tmap.Geometry.MultiLineString([a])),a},touchstart:function(a){return this.timerId&&this.passesTolerance(this.lastTouchPx,a.xy,this.doubleTouchTolerance)?(this.finishGeometry(),window.clearTimeout(this.timerId),this.timerId=null,!1):(this.timerId&&(window.clearTimeout(this.timerId),this.timerId=null),this.timerId=window.setTimeout(Tmap.Function.bind(function(){this.timerId=null},this),300),Tmap.Handler.Point.prototype.touchstart.call(this,a))},down:function(a){var b=this.stopDown;return this.freehandMode(a)&&(b=!0,this.touch&&(this.modifyFeature(a.xy,!!this.lastUp),Tmap.Event.stop(a))),this.touch||this.lastDown&&this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)||this.modifyFeature(a.xy,!!this.lastUp),this.mouseDown=!0,this.lastDown=a.xy,this.stoppedDown=b,!b},move:function(a){return this.stoppedDown&&this.freehandMode(a)?(this.persist&&this.destroyPersistedFeature(),this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices?(this.removePoint(),this.finalize()):this.addPoint(a.xy),!1):(this.touch||this.mouseDown&&!this.stoppedDown||this.modifyFeature(a.xy,!!this.lastUp),!0)},up:function(a){return!this.mouseDown||this.lastUp&&this.lastUp.equals(a.xy)||(this.stoppedDown&&this.freehandMode(a)?(this.persist&&this.destroyPersistedFeature(),this.removePoint(),this.finalize()):this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)&&(this.touch&&this.modifyFeature(a.xy),null==this.lastUp&&this.persist&&this.destroyPersistedFeature(),this.addPoint(a.xy),this.lastUp=a.xy,this.line.geometry.components.length===this.maxVertices+1&&this.finishGeometry())),this.stoppedDown=this.stopDown,this.mouseDown=!1,!this.stopUp},finishGeometry:function(){var a=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[a]),this.removePoint(),this.finalize()},dblclick:function(a){return this.freehandMode(a)||this.finishGeometry(),!1},CLASS_NAME:"Tmap.Handler.Path"}),Tmap.Handler.Polygon=Tmap.Class(Tmap.Handler.Path,{holeModifier:null,drawingHole:!1,polygon:null,createFeature:function(a){var b=this.layer.getLonLatFromViewPortPx(a),c=new Tmap.Geometry.Point(b.lon,b.lat);
this.point=new Tmap.Feature.Vector(c),this.line=new Tmap.Feature.Vector(new Tmap.Geometry.LinearRing([this.point.geometry])),this.polygon=new Tmap.Feature.Vector(new Tmap.Geometry.Polygon([this.line.geometry])),this.callback("create",[this.point.geometry,this.getSketch()]),this.point.geometry.clearBounds(),this.layer.addFeatures([this.polygon,this.point],{silent:!0})},addPoint:function(a){if(!this.drawingHole&&this.holeModifier&&this.evt&&this.evt[this.holeModifier])for(var b,c,d=this.point.geometry,e=this.control.layer.features,f=e.length-1;f>=0;--f)if(b=e[f].geometry,(b instanceof Tmap.Geometry.Polygon||b instanceof Tmap.Geometry.MultiPolygon)&&b.intersects(d)){c=e[f],this.control.layer.removeFeatures([c],{silent:!0}),this.control.layer.events.registerPriority("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology),c.geometry.addComponent(this.line.geometry),this.polygon=c,this.drawingHole=!0;break}Tmap.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(a){var b=a.vertex,c=this.line.geometry.components;if(!this.polygon.geometry.intersects(b)){var d=c[c.length-3];b.x=d.x,b.y=d.y}},finishGeometry:function(){var a=this.line.geometry.components.length-2;this.line.geometry.removeComponent(this.line.geometry.components[a]),this.removePoint(),this.finalize()},finalizeInteriorRing:function(){var a=this.line.geometry,b=0!==a.getArea();if(b){for(var c=this.polygon.geometry.components,d=c.length-2;d>=0;--d)if(a.intersects(c[d])){b=!1;break}if(b){a:for(var d=c.length-2;d>0;--d)for(var e=c[d].components,f=0,g=e.length;g>f;++f)if(a.containsPoint(e[f])){b=!1;break a}}}return b?this.polygon.state!==Tmap.State.INSERT&&(this.polygon.state=Tmap.State.UPDATE):this.polygon.geometry.removeComponent(a),this.restoreFeature(),!1},cancel:function(){return this.drawingHole&&(this.polygon.geometry.removeComponent(this.line.geometry),this.restoreFeature(!0)),Tmap.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(a){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing),this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology),this.layer.removeFeatures([this.polygon],{silent:!0}),this.control.layer.addFeatures([this.polygon],{silent:!0}),this.drawingHole=!1,a||this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})},destroyFeature:function(a){Tmap.Handler.Path.prototype.destroyFeature.call(this,a),this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style),this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var a=this.polygon&&this.polygon.geometry;return a&&this.multi&&(a=new Tmap.Geometry.MultiPolygon([a])),a},CLASS_NAME:"Tmap.Handler.Polygon"}),Tmap.Handler.Feature=Tmap.Class(Tmap.Handler,{EVENTMAP:{click:{"in":"click",out:"clickout"},mousemove:{"in":"over",out:"out"},dblclick:{"in":"dblclick",out:null},mousedown:{"in":null,out:null},mouseup:{"in":null,out:null},touchstart:{"in":"click",out:"clickout"}},feature:null,lastFeature:null,down:null,up:null,touch:!1,clickTolerance:4,geometryTypes:null,stopClick:!0,stopDown:!0,stopUp:!1,initialize:function(a,b,c,d){Tmap.Handler.prototype.initialize.apply(this,[a,c,d]),this.layer=b},touchstart:function(a){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,dblclick:this.dblclick,scope:this})),Tmap.Event.isMultiTouch(a)?!0:this.mousedown(a)},touchmove:function(a){Tmap.Event.stop(a)},mousedown:function(a){return(Tmap.Event.isLeftClick(a)||Tmap.Event.isSingleTouch(a))&&(this.down=a.xy),this.handle(a)?!this.stopDown:!0},mouseup:function(a){return this.up=a.xy,this.handle(a)?!this.stopUp:!0},click:function(a){return this.handle(a)?!this.stopClick:!0},mousemove:function(a){return this.callbacks.over||this.callbacks.out?(this.handle(a),!0):!0},dblclick:function(a){return!this.handle(a)},geometryTypeMatches:function(a){return null==this.geometryTypes||Tmap.Util.indexOf(this.geometryTypes,a.geometry.CLASS_NAME)>-1},handle:function(a){this.feature&&!this.feature.layer&&(this.feature=null);var b=a.type,c=!1,d=!!this.feature,e="click"==b||"dblclick"==b||"touchstart"==b;if(this.feature=this.layer.getFeatureFromEvent(a),this.feature&&!this.feature.layer&&(this.feature=null),this.lastFeature&&!this.lastFeature.layer&&(this.lastFeature=null),this.feature){"touchstart"===b&&Tmap.Event.stop(a);var f=this.feature!=this.lastFeature;this.geometryTypeMatches(this.feature)?(d&&f?(this.lastFeature&&this.triggerCallback(b,"out",[this.lastFeature]),this.triggerCallback(b,"in",[this.feature])):(!d||e)&&this.triggerCallback(b,"in",[this.feature]),this.lastFeature=this.feature,c=!0):(this.lastFeature&&(d&&f||e)&&this.triggerCallback(b,"out",[this.lastFeature]),this.feature=null)}else this.lastFeature&&(d||e)&&this.triggerCallback(b,"out",[this.lastFeature]);return c},triggerCallback:function(a,b,c){var d=this.EVENTMAP[a][b];if(d)if("click"==a&&this.up&&this.down){var e=Math.sqrt(Math.pow(this.up.x-this.down.x,2)+Math.pow(this.up.y-this.down.y,2));e<=this.clickTolerance&&this.callback(d,c),this.up=this.down=null}else this.callback(d,c)},activate:function(){var a=!1;return Tmap.Handler.prototype.activate.apply(this,arguments)&&(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),a=!0),a},deactivate:function(){var a=!1;return Tmap.Handler.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.feature=null,this.lastFeature=null,this.down=null,this.up=null,this.touch=!1,this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),a=!0),a},handleMapEvents:function(a){("removelayer"==a.type||"order"==a.property)&&this.moveLayerToTop()},moveLayerToTop:function(){var a=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(a)},moveLayerBack:function(){var a=this.layer.getZIndex()-1;a>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(a):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"Tmap.Handler.Feature"}),Tmap.Handler.Drag=Tmap.Class(Tmap.Handler,{started:!1,stopDown:!0,dragging:!1,touch:!1,last:null,start:null,lastMoveEvt:null,oldOnselectstart:null,interval:0,timeoutId:null,documentDrag:!1,documentEvents:null,initialize:function(a,b,c){if(Tmap.Handler.prototype.initialize.apply(this,arguments),this.documentDrag===!0){var d=this;this._docMove=function(a){d.mousemove({xy:{x:a.clientX,y:a.clientY},element:document})},this._docUp=function(a){d.mouseup({xy:{x:a.clientX,y:a.clientY}})}}},dragstart:function(a){var b=!0;return this.dragging=!1,this.checkModifiers(a)&&(Tmap.Event.isLeftClick(a)||Tmap.Event.isSingleTouch(a))?(this.started=!0,this.start=a.xy,this.last=a.xy,Tmap.Element.addClass(this.map.viewPortDiv,"tmDragDown"),this.down(a),this.callback("down",[a.xy]),Tmap.Event.preventDefault(a),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart?document.onselectstart:Tmap.Function.True),document.onselectstart=Tmap.Function.False,b=!this.stopDown):(this.started=!1,this.start=null,this.last=null),b},dragmove:function(a){return this.lastMoveEvt=a,!this.started||this.timeoutId||a.xy.x==this.last.x&&a.xy.y==this.last.y||(this.documentDrag===!0&&this.documentEvents&&(a.element===document?(this.adjustXY(a),this.setEvent(a)):this.removeDocumentEvents()),this.interval>0&&(this.timeoutId=setTimeout(Tmap.Function.bind(this.removeTimeout,this),this.interval)),this.dragging=!0,this.move(a),this.callback("move",[a.xy]),this.oldOnselectstart||(this.oldOnselectstart=document.onselectstart,document.onselectstart=Tmap.Function.False),this.last=a.xy),!0},dragend:function(a){if(this.started){this.documentDrag===!0&&this.documentEvents&&(this.adjustXY(a),this.removeDocumentEvents());var b=this.start!=this.last;this.started=!1,this.dragging=!1,Tmap.Element.removeClass(this.map.viewPortDiv,"tmDragDown"),this.up(a),this.callback("up",[a.xy]),b&&this.callback("done",[a.xy]),document.onselectstart=this.oldOnselectstart}return!0},down:function(a){},move:function(a){},up:function(a){},out:function(a){},mousedown:function(a){return this.dragstart(a)},touchstart:function(a){return this.touch||(this.touch=!0,this.map.events.un({mousedown:this.mousedown,mouseup:this.mouseup,mousemove:this.mousemove,click:this.click,scope:this})),this.dragstart(a)},mousemove:function(a){return this.dragmove(a)},touchmove:function(a){return this.dragmove(a)},removeTimeout:function(){this.timeoutId=null,this.dragging&&this.mousemove(this.lastMoveEvt)},mouseup:function(a){return this.dragend(a)},touchend:function(a){return a.xy=this.last,this.dragend(a)},mouseout:function(a){if(this.started&&Tmap.Util.mouseLeft(a,this.map.viewPortDiv))if(this.documentDrag===!0)this.addDocumentEvents();else{var b=this.start!=this.last;this.started=!1,this.dragging=!1,Tmap.Element.removeClass(this.map.viewPortDiv,"tmDragDown"),this.out(a),this.callback("out",[]),b&&this.callback("done",[a.xy]),document.onselectstart&&(document.onselectstart=this.oldOnselectstart)}return!0},click:function(a){return this.start==this.last},activate:function(){var a=!1;return Tmap.Handler.prototype.activate.apply(this,arguments)&&(this.dragging=!1,a=!0),a},deactivate:function(){var a=!1;return Tmap.Handler.prototype.deactivate.apply(this,arguments)&&(this.touch=!1,this.started=!1,this.dragging=!1,this.start=null,this.last=null,a=!0,Tmap.Element.removeClass(this.map.viewPortDiv,"tmDragDown")),a},adjustXY:function(a){var b=Tmap.Util.pagePosition(this.map.viewPortDiv);a.xy.x-=b[0],a.xy.y-=b[1]},addDocumentEvents:function(){Tmap.Element.addClass(document.body,"tmDragDown"),this.documentEvents=!0,Tmap.Event.observe(document,"mousemove",this._docMove),Tmap.Event.observe(document,"mouseup",this._docUp)},removeDocumentEvents:function(){Tmap.Element.removeClass(document.body,"tmDragDown"),this.documentEvents=!1,Tmap.Event.stopObserving(document,"mousemove",this._docMove),Tmap.Event.stopObserving(document,"mouseup",this._docUp)},CLASS_NAME:"Tmap.Handler.Drag"}),Tmap.Handler.Pinch=Tmap.Class(Tmap.Handler,{started:!1,stopDown:!1,pinching:!1,last:null,start:null,touchstart:function(a){var b=!0;if(this.pinching=!1,Tmap.Event.isMultiTouch(a))this.started=!0,this.last=this.start={distance:this.getDistance(a.touches),delta:0,scale:1},this.callback("start",[a,this.start]),b=!this.stopDown;else{if(this.started)return!1;this.started=!1,this.start=null,this.last=null}return Tmap.Event.preventDefault(a),b},touchmove:function(a){if(this.started&&Tmap.Event.isMultiTouch(a)){this.pinching=!0;var b=this.getPinchData(a);this.callback("move",[a,b]),this.last=b,Tmap.Event.stop(a)}else if(this.started)return!1;return!0},touchend:function(a){return this.started&&!Tmap.Event.isMultiTouch(a)?(this.started=!1,this.pinching=!1,this.callback("done",[a,this.start,this.last]),this.start=null,this.last=null,!1):!0},activate:function(){var a=!1;return Tmap.Handler.prototype.activate.apply(this,arguments)&&(this.pinching=!1,a=!0),a},deactivate:function(){var a=!1;return Tmap.Handler.prototype.deactivate.apply(this,arguments)&&(this.started=!1,this.pinching=!1,this.start=null,this.last=null,a=!0),a},getDistance:function(a){var b=a[0],c=a[1];return Math.sqrt(Math.pow(b.olClientX-c.olClientX,2)+Math.pow(b.olClientY-c.olClientY,2))},getPinchData:function(a){var b=this.getDistance(a.touches),c=b/this.start.distance;return{distance:b,delta:this.last.distance-b,scale:c}},CLASS_NAME:"Tmap.Handler.Pinch"}),Tmap.Handler.RegularPolygon=Tmap.Class(Tmap.Handler.Drag,{sides:4,radius:null,snapAngle:null,snapToggle:"shiftKey",layerOptions:null,persist:!1,irregular:!1,citeCompliant:!1,angle:null,fixedRadius:!1,feature:null,layer:null,origin:null,initialize:function(a,b,c){c&&c.layerOptions&&c.layerOptions.styleMap||(this.style=Tmap.Util.extend(Tmap.Feature.Vector.style["default"],{})),Tmap.Handler.Drag.prototype.initialize.apply(this,[a,b,c]),this.options=c?c:{}},setOptions:function(a){Tmap.Util.extend(this.options,a),Tmap.Util.extend(this,a)},activate:function(){var a=!1;if(Tmap.Handler.Drag.prototype.activate.apply(this,arguments)){var b=Tmap.Util.extend({displayInLayerSwitcher:!1,calculateInRange:Tmap.Function.True,wrapDateLine:this.citeCompliant},this.layerOptions);this.layer=new Tmap.Layer.Vector(this.CLASS_NAME,b),this.map.addLayer(this.layer),a=!0}return a},deactivate:function(){var a=!1;return Tmap.Handler.Drag.prototype.deactivate.apply(this,arguments)&&(this.dragging&&this.cancel(),null!=this.layer.map&&(this.layer.destroy(!1),this.feature&&this.feature.destroy()),this.layer=null,this.feature=null,a=!0),a},down:function(a){this.fixedRadius=!!this.radius;var b=this.layer.getLonLatFromViewPortPx(a.xy);this.origin=new Tmap.Geometry.Point(b.lon,b.lat),(!this.fixedRadius||this.irregular)&&(this.radius=this.map.getResolution()),this.persist&&this.clear(),this.feature=new Tmap.Feature.Vector,this.createGeometry(),this.callback("create",[this.origin,this.feature]),this.layer.addFeatures([this.feature],{silent:!0}),this.layer.drawFeature(this.feature,this.style)},move:function(a){var b=this.layer.getLonLatFromViewPortPx(a.xy),c=new Tmap.Geometry.Point(b.lon,b.lat);if(this.irregular){var d=Math.sqrt(2)*Math.abs(c.y-this.origin.y)/2;this.radius=Math.max(this.map.getResolution()/2,d)}else this.fixedRadius?this.origin=c:(this.calculateAngle(c,a),this.radius=Math.max(this.map.getResolution()/2,c.distanceTo(this.origin)));if(this.modifyGeometry(),this.irregular){var e,f=c.x-this.origin.x,g=c.y-this.origin.y;e=0==g?f/(this.radius*Math.sqrt(2)):f/g,this.feature.geometry.resize(1,this.origin,e),this.feature.geometry.move(f/2,g/2)}this.layer.drawFeature(this.feature,this.style)},up:function(a){this.finalize(),this.start==this.last&&this.callback("done",[a.xy])},out:function(a){this.finalize()},createGeometry:function(){this.angle=Math.PI*(1/this.sides-.5),this.snapAngle&&(this.angle+=this.snapAngle*(Math.PI/180)),this.feature.geometry=Tmap.Geometry.Polygon.createRegularPolygon(this.origin,this.radius,this.sides,this.snapAngle)},modifyGeometry:function(){var a,b,c=this.feature.geometry.components[0];c.components.length!=this.sides+1&&(this.createGeometry(),c=this.feature.geometry.components[0]);for(var d=0;d<this.sides;++d)b=c.components[d],a=this.angle+2*d*Math.PI/this.sides,b.x=this.origin.x+this.radius*Math.cos(a),b.y=this.origin.y+this.radius*Math.sin(a),b.clearBounds()},calculateAngle:function(a,b){var c=Math.atan2(a.y-this.origin.y,a.x-this.origin.x);if(this.snapAngle&&this.snapToggle&&!b[this.snapToggle]){var d=Math.PI/180*this.snapAngle;this.angle=Math.round(c/d)*d}else this.angle=c},cancel:function(){this.callback("cancel",null),this.finalize()},finalize:function(){this.origin=null,this.radius=this.options.radius},clear:function(){this.layer&&(this.layer.renderer.clear(),this.layer.destroyFeatures())},callback:function(a,b){this.callbacks[a]&&this.callbacks[a].apply(this.control,[this.feature.geometry.clone()]),this.persist||"done"!=a&&"cancel"!=a||this.clear()},CLASS_NAME:"Tmap.Handler.RegularPolygon"}),Tmap.Handler.Box=Tmap.Class(Tmap.Handler,{dragHandler:null,boxDivClassName:"tmHandlerBoxZoomBox",boxOffsets:null,initialize:function(a,b,c){Tmap.Handler.prototype.initialize.apply(this,arguments),this.dragHandler=new Tmap.Handler.Drag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},destroy:function(){Tmap.Handler.prototype.destroy.apply(this,arguments),this.dragHandler&&(this.dragHandler.destroy(),this.dragHandler=null)},setMap:function(a){Tmap.Handler.prototype.setMap.apply(this,arguments),this.dragHandler&&this.dragHandler.setMap(a)},startBox:function(a){this.callback("start",[]),this.zoomBox=Tmap.Util.createDiv("zoomBox",{x:-9999,y:-9999}),this.zoomBox.className=this.boxDivClassName,this.zoomBox.style.zIndex=this.map.Z_INDEX_BASE.Popup-1,this.map.viewPortDiv.appendChild(this.zoomBox),Tmap.Element.addClass(this.map.viewPortDiv,"tmDrawBox")},moveBox:function(a){var b=this.dragHandler.start.x,c=this.dragHandler.start.y,d=Math.abs(b-a.x),e=Math.abs(c-a.y),f=this.getBoxOffsets();this.zoomBox.style.width=d+f.width+1+"px",this.zoomBox.style.height=e+f.height+1+"px",this.zoomBox.style.left=(a.x<b?b-d-f.left:b-f.left)+"px",this.zoomBox.style.top=(a.y<c?c-e-f.top:c-f.top)+"px"},endBox:function(a){var b;if(Math.abs(this.dragHandler.start.x-a.x)>5||Math.abs(this.dragHandler.start.y-a.y)>5){var c=this.dragHandler.start,d=Math.min(c.y,a.y),e=Math.max(c.y,a.y),f=Math.min(c.x,a.x),g=Math.max(c.x,a.x);b=new Tmap.Bounds(f,e,g,d)}else b=this.dragHandler.start.clone();this.removeBox(),this.callback("done",[b])},removeBox:function(){this.map.viewPortDiv.removeChild(this.zoomBox),this.zoomBox=null,this.boxOffsets=null,Tmap.Element.removeClass(this.map.viewPortDiv,"tmDrawBox")},activate:function(){return Tmap.Handler.prototype.activate.apply(this,arguments)?(this.dragHandler.activate(),!0):!1},deactivate:function(){return Tmap.Handler.prototype.deactivate.apply(this,arguments)?(this.dragHandler.deactivate()&&this.zoomBox&&this.removeBox(),!0):!1},getBoxOffsets:function(){if(!this.boxOffsets){var a=document.createElement("div");a.style.position="absolute",a.style.border="1px solid black",a.style.width="3px",document.body.appendChild(a);var b=3==a.clientWidth;document.body.removeChild(a);var c=parseInt(Tmap.Element.getStyle(this.zoomBox,"border-left-width")),d=parseInt(Tmap.Element.getStyle(this.zoomBox,"border-right-width")),e=parseInt(Tmap.Element.getStyle(this.zoomBox,"border-top-width")),f=parseInt(Tmap.Element.getStyle(this.zoomBox,"border-bottom-width"));this.boxOffsets={left:c,right:d,top:e,bottom:f,width:b===!1?c+d:0,height:b===!1?e+f:0}}return this.boxOffsets},CLASS_NAME:"Tmap.Handler.Box"}),Tmap.Handler.MouseWheel=Tmap.Class(Tmap.Handler,{wheelListener:null,interval:0,maxDelta:Number.POSITIVE_INFINITY,delta:0,cumulative:!0,initialize:function(a,b,c){Tmap.Handler.prototype.initialize.apply(this,arguments),this.wheelListener=Tmap.Function.bindAsEventListener(this.onWheelEvent,this)},destroy:function(){Tmap.Handler.prototype.destroy.apply(this,arguments),this.wheelListener=null},onWheelEvent:function(a){if(this.map&&this.checkModifiers(a)){for(var b=!1,c=!1,d=!1,e=Tmap.Event.element(a);null!=e&&!d&&!b;){if(!b)try{var f;if(e.currentStyle)f=e.currentStyle.overflow;else{var g=document.defaultView.getComputedStyle(e,null);f=g.getPropertyValue("overflow")}b=f&&"auto"==f||"scroll"==f}catch(h){}if(!c&&(c=Tmap.Element.hasClass(e,"olScrollable"),!c))for(var i=0,j=this.map.layers.length;j>i;i++){var k=this.map.layers[i];if(e==k.div||e==k.pane){c=!0;break}}d=e==this.map.div,e=e.parentNode}if(!b&&d){if(c){var l=0;if(a.wheelDelta?(l=a.wheelDelta,l%160===0&&(l=.75*l),l/=120):a.detail&&(l=-(a.detail/Math.abs(a.detail))),this.delta+=l,window.clearTimeout(this._timeoutId),this.interval&&Math.abs(this.delta)<this.maxDelta){var m=Tmap.Util.extend({},a);this._timeoutId=window.setTimeout(Tmap.Function.bind(function(){this.wheelZoom(m)},this),this.interval)}else this.wheelZoom(a)}Tmap.Event.stop(a)}}},wheelZoom:function(a){var b=this.delta;this.delta=0,b&&(a.xy=this.map.events.getMousePosition(a),0>b?this.callback("down",[a,this.cumulative?Math.max(-this.maxDelta,b):-1]):this.callback("up",[a,this.cumulative?Math.min(this.maxDelta,b):1]))},activate:function(a){if(Tmap.Handler.prototype.activate.apply(this,arguments)){var b=this.wheelListener;return Tmap.Event.observe(window,"DOMMouseScroll",b),Tmap.Event.observe(window,"mousewheel",b),Tmap.Event.observe(document,"mousewheel",b),!0}return!1},deactivate:function(a){if(Tmap.Handler.prototype.deactivate.apply(this,arguments)){var b=this.wheelListener;return Tmap.Event.stopObserving(window,"DOMMouseScroll",b),Tmap.Event.stopObserving(window,"mousewheel",b),Tmap.Event.stopObserving(document,"mousewheel",b),!0}return!1},CLASS_NAME:"Tmap.Handler.MouseWheel"}),Tmap.Handler.Keyboard=Tmap.Class(Tmap.Handler,{KEY_EVENTS:["keydown","keyup"],eventListener:null,observeElement:null,initialize:function(a,b,c){Tmap.Handler.prototype.initialize.apply(this,arguments),this.eventListener=Tmap.Function.bindAsEventListener(this.handleKeyEvent,this)},destroy:function(){this.deactivate(),this.eventListener=null,Tmap.Handler.prototype.destroy.apply(this,arguments)},activate:function(){if(Tmap.Handler.prototype.activate.apply(this,arguments)){this.observeElement=this.observeElement||document;for(var a=0,b=this.KEY_EVENTS.length;b>a;a++)Tmap.Event.observe(this.observeElement,this.KEY_EVENTS[a],this.eventListener);return!0}return!1},deactivate:function(){var a=!1;if(Tmap.Handler.prototype.deactivate.apply(this,arguments)){for(var b=0,c=this.KEY_EVENTS.length;c>b;b++)Tmap.Event.stopObserving(this.observeElement,this.KEY_EVENTS[b],this.eventListener);a=!0}return a},handleKeyEvent:function(a){this.checkModifiers(a)&&this.callback(a.type,[a])},CLASS_NAME:"Tmap.Handler.Keyboard"}),Tmap.Control=Tmap.Class({id:null,map:null,div:null,type:null,allowSelection:!1,displayClass:"",title:"",autoActivate:!1,active:null,handlerOptions:null,handler:null,eventListeners:null,events:null,initialize:function(a){this.displayClass=this.CLASS_NAME.replace("Tmap.","tm").replace(/\./g,""),Tmap.Util.extend(this,a),this.events=new Tmap.Events(this),this.eventListeners instanceof Object&&this.events.on(this.eventListeners),null==this.id&&(this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_"))},destroy:function(){if(this.events&&(this.eventListeners&&this.events.un(this.eventListeners),this.events.destroy(),this.events=null),this.eventListeners=null,this.handler&&(this.handler.destroy(),this.handler=null),this.handlers){for(var a in this.handlers)this.handlers.hasOwnProperty(a)&&"function"==typeof this.handlers[a].destroy&&this.handlers[a].destroy();this.handlers=null}this.map&&(this.map.removeControl(this),this.map=null),this.div=null},setMap:function(a){this.map=a,this.handler&&this.handler.setMap(a)},draw:function(a){return null==this.div&&(this.div=Tmap.Util.createDiv(this.id),this.div.className=this.displayClass,this.allowSelection||(this.div.className+=" tmControlNoSelect",this.div.setAttribute("unselectable","on",0),this.div.onselectstart=Tmap.Function.False),""!=this.title&&(this.div.title=this.title)),null!=a&&(this.position=a.clone()),this.moveTo(this.position),this.div},moveTo:function(a){null!=a&&null!=this.div&&(this.div.style.left=a.x+"px",this.div.style.top=a.y+"px")},activate:function(){return this.active?!1:(this.handler&&this.handler.activate(),this.active=!0,this.map&&Tmap.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("activate"),!0)},deactivate:function(){return this.active?(this.handler&&this.handler.deactivate(),this.active=!1,this.map&&Tmap.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active"),this.events.triggerEvent("deactivate"),!0):!1},CLASS_NAME:"Tmap.Control"}),Tmap.Control.TYPE_BUTTON=1,Tmap.Control.TYPE_TOGGLE=2,Tmap.Control.TYPE_TOOL=3,Tmap.Control.Attribution=Tmap.Class(Tmap.Control,{separator:", ",template:"${layers}",destroy:function(){this.map.events.un({removelayer:this.updateAttribution,addlayer:this.updateAttribution,changelayer:this.updateAttribution,changebaselayer:this.updateAttribution,scope:this}),Tmap.Control.prototype.destroy.apply(this,arguments)},draw:function(){return Tmap.Control.prototype.draw.apply(this,arguments),this.map.events.on({changebaselayer:this.updateAttribution,changelayer:this.updateAttribution,addlayer:this.updateAttribution,removelayer:this.updateAttribution,scope:this}),this.updateAttribution(),this.div},updateAttribution:function(){var a=[];if(this.map&&this.map.layers){for(var b=0,c=this.map.layers.length;c>b;b++){var d=this.map.layers[b];d.attribution&&d.getVisibility()&&-1===Tmap.Util.indexOf(a,d.attribution)&&a.push(d.attribution)}this.div.innerHTML=Tmap.String.format(this.template,{layers:a.join(this.separator)})}},CLASS_NAME:"Tmap.Control.Attribution"}),Tmap.Control.Button=Tmap.Class(Tmap.Control,{type:Tmap.Control.TYPE_BUTTON,trigger:function(){},CLASS_NAME:"Tmap.Control.Button"}),Tmap.Control.CacheRead=Tmap.Class(Tmap.Control,{fetchEvent:"tileloadstart",layers:null,autoActivate:!0,setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments);var b,c=this.layers||a.layers;for(b=c.length-1;b>=0;--b)this.addLayer({layer:c[b]});this.layers||a.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(a){a.layer.events.register(this.fetchEvent,this,this.fetch)},removeLayer:function(a){a.layer.events.unregister(this.fetchEvent,this,this.fetch)},fetch:function(a){if(this.active&&window.localStorage&&a.tile instanceof Tmap.Tile.Image){var b=a.tile,c=b.url;!b.layer.crossOriginKeyword&&Tmap.ProxyHost&&0===c.indexOf(Tmap.ProxyHost)&&(c=Tmap.Control.CacheWrite.urlMap[c]);var d=window.localStorage.getItem("tmCache_"+c);d&&(b.url=d,"tileerror"===a.type&&b.setImgSrc(d))}},destroy:function(){if(this.layers||this.map){var a,b=this.layers||this.map.layers;for(a=b.length-1;a>=0;--a)this.removeLayer({layer:b[a]})}this.map&&this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this}),Tmap.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"Tmap.Control.CacheRead"}),Tmap.Control.CacheWrite=Tmap.Class(Tmap.Control,{layers:null,imageFormat:"image/png",quotaRegEx:/quota/i,setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments);var b,c=this.layers||a.layers;for(b=c.length-1;b>=0;--b)this.addLayer({layer:c[b]});this.layers||a.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(a){a.layer.events.on({tileloadstart:this.makeSameOrigin,tileloaded:this.onTileLoaded,scope:this})},removeLayer:function(a){a.layer.events.un({tileloadstart:this.makeSameOrigin,tileloaded:this.onTileLoaded,scope:this})},makeSameOrigin:function(a){if(this.active){var b=a.tile;if(b instanceof Tmap.Tile.Image&&!b.crossOriginKeyword&&"data:"!==b.url.substr(0,5)){var c=Tmap.Request.makeSameOrigin(b.url,Tmap.ProxyHost);Tmap.Control.CacheWrite.urlMap[c]=b.url,b.url=c}}},onTileLoaded:function(a){this.active&&!a.aborted&&a.tile instanceof Tmap.Tile.Image&&"data:"!==a.tile.url.substr(0,5)&&(this.cache({tile:a.tile}),delete Tmap.Control.CacheWrite.urlMap[a.tile.url])},cache:function(a){if(window.localStorage){var b=a.tile;try{var c=b.getCanvasContext();if(c){var d=Tmap.Control.CacheWrite.urlMap,e=d[b.url]||b.url;window.localStorage.setItem("tmCache_"+e,c.canvas.toDataURL(this.imageFormat))}}catch(f){var g=f.name||f.message;g&&this.quotaRegEx.test(g)?this.events.triggerEvent("cachefull",{tile:b}):Tmap.Console.error(f.toString())}}},destroy:function(){if(this.layers||this.map){var a,b=this.layers||this.map.layers;for(a=b.length-1;a>=0;--a)this.removeLayer({layer:b[a]})}this.map&&this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this}),Tmap.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"Tmap.Control.CacheWrite"}),Tmap.Control.CacheWrite.clearCache=function(){if(window.localStorage){var a,b;for(a=window.localStorage.length-1;a>=0;--a)b=window.localStorage.key(a),"tmCache_"===b.substr(0,8)&&window.localStorage.removeItem(b)}},Tmap.Control.CacheWrite.urlMap={},Tmap.Control.ZoomBox=Tmap.Class(Tmap.Control,{type:Tmap.Control.TYPE_TOOL,out:!1,keyMask:null,alwaysZoom:!1,zoomOnClick:!0,draw:function(){this.handler=new Tmap.Handler.Box(this,{done:this.zoomBox},{keyMask:this.keyMask})},zoomBox:function(a){if(a instanceof Tmap.Bounds){var b,c=a.getCenterPixel();if(this.out){var d=a.right-a.left,e=a.bottom-a.top,f=Math.min(this.map.size.h/e,this.map.size.w/d),g=this.map.getExtent(),h=this.map.getLonLatFromPixel(c),i=h.lon-g.getWidth()/2*f,j=h.lon+g.getWidth()/2*f,k=h.lat-g.getHeight()/2*f,l=h.lat+g.getHeight()/2*f;b=new Tmap.Bounds(i,k,j,l)}else{var m=this.map.getLonLatFromPixel({x:a.left,y:a.bottom}),n=this.map.getLonLatFromPixel({x:a.right,y:a.top});b=new Tmap.Bounds(m.lon,m.lat,n.lon,n.lat)}var o=this.map.getZoom(),p=this.map.getSize(),q={x:p.w/2,y:p.h/2},r=this.map.getZoomForExtent(b),s=this.map.getResolution(),t=this.map.getResolutionForZoom(r),u={x:(s*c.x-t*q.x)/(s-t),y:(s*c.y-t*q.y)/(s-t)};this.map.zoomTo(r,u),o==this.map.getZoom()&&1==this.alwaysZoom&&this.map.zoomTo(o+(this.out?-1:1))}else this.zoomOnClick&&(this.out?this.map.zoomTo(this.map.getZoom()-1,a):this.map.zoomTo(this.map.getZoom()+1,a))},CLASS_NAME:"Tmap.Control.ZoomBox"}),Tmap.Control.ZoomToMaxExtent=Tmap.Class(Tmap.Control.Button,{trigger:function(){this.map&&this.map.zoomToMaxExtent()},CLASS_NAME:"Tmap.Control.ZoomToMaxExtent"}),Tmap.Control.DragPan=Tmap.Class(Tmap.Control,{type:Tmap.Control.TYPE_TOOL,panned:!1,interval:1,documentDrag:!1,kinetic:null,enableKinetic:!0,kineticInterval:10,draw:function(){if(this.enableKinetic&&Tmap.Kinetic){var a={interval:this.kineticInterval};"object"==typeof this.enableKinetic&&(a=Tmap.Util.extend(a,this.enableKinetic)),this.kinetic=new Tmap.Kinetic(a)}this.handler=new Tmap.Handler.Drag(this,{move:this.panMap,done:this.panMapDone,down:this.panMapStart},{interval:this.interval,documentDrag:this.documentDrag})},panMapStart:function(){this.kinetic&&this.kinetic.begin()},panMap:function(a){this.kinetic&&this.kinetic.update(a),this.panned=!0,this.map.pan(this.handler.last.x-a.x,this.handler.last.y-a.y,{dragging:!0,animate:!1})},panMapDone:function(a){if(this.panned){var b=null;if(this.kinetic&&(b=this.kinetic.end(a)),this.map.pan(this.handler.last.x-a.x,this.handler.last.y-a.y,{dragging:!!b,animate:!1}),b){var c=this;this.kinetic.move(b,function(a,b,d){c.map.pan(a,b,{dragging:!d,animate:!1})})}this.panned=!1}},CLASS_NAME:"Tmap.Control.DragPan"}),Tmap.Control.Navigation=Tmap.Class(Tmap.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,documentDrag:!1,zoomBox:null,zoomBoxEnabled:!0,zoomWheelEnabled:!0,mouseWheelOptions:null,handleRightClicks:!1,zoomBoxKeyMask:Tmap.Handler.MOD_SHIFT,autoActivate:!0,initialize:function(a){this.handlers={},Tmap.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate(),this.dragPan&&this.dragPan.destroy(),this.dragPan=null,this.zoomBox&&this.zoomBox.destroy(),this.zoomBox=null,this.pinchZoom&&this.pinchZoom.destroy(),this.pinchZoom=null,Tmap.Control.prototype.destroy.apply(this,arguments)},activate:function(){return this.dragPan.activate(),this.zoomWheelEnabled&&this.handlers.wheel.activate(),this.handlers.click.activate(),this.zoomBoxEnabled&&this.zoomBox.activate(),this.pinchZoom&&this.pinchZoom.activate(),Tmap.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.pinchZoom&&this.pinchZoom.deactivate(),this.zoomBox.deactivate(),this.dragPan.deactivate(),this.handlers.click.deactivate(),this.handlers.wheel.deactivate(),Tmap.Control.prototype.deactivate.apply(this,arguments)},draw:function(){this.handleRightClicks&&(this.map.viewPortDiv.oncontextmenu=Tmap.Function.False);var a={click:this.defaultClick,dblclick:this.defaultDblClick,dblrightclick:this.defaultDblRightClick},b={"double":!0,stopDouble:!0};this.handlers.click=new Tmap.Handler.Click(this,a,b),this.dragPan=new Tmap.Control.DragPan(Tmap.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.zoomBox=new Tmap.Control.ZoomBox({map:this.map,keyMask:this.zoomBoxKeyMask}),this.dragPan.draw(),this.zoomBox.draw();var c=this.map.fractionalZoom?{}:{cumulative:!1,interval:50,maxDelta:6};this.handlers.wheel=new Tmap.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown},Tmap.Util.extend(c,this.mouseWheelOptions)),Tmap.Control.PinchZoom&&(this.pinchZoom=new Tmap.Control.PinchZoom(Tmap.Util.extend({map:this.map},this.pinchZoomOptions)))},defaultClick:function(a){a.lastTouches&&2==a.lastTouches.length&&this.map.zoomOut();
},defaultDblClick:function(a){this.map.zoomTo(this.map.zoom+1,a.xy)},defaultDblRightClick:function(a){this.map.zoomTo(this.map.zoom-1,a.xy)},wheelChange:function(a,b){this.map.fractionalZoom||(b=Math.round(b));var c=this.map.getZoom(),d=c+b;d=Math.max(d,0),d=Math.min(d,this.map.getNumZoomLevels()),d!==c&&this.map.zoomTo(d,a.xy)},wheelUp:function(a,b){this.wheelChange(a,b||1)},wheelDown:function(a,b){this.wheelChange(a,b||-1)},disableZoomBox:function(){this.zoomBoxEnabled=!1,this.zoomBox.deactivate()},enableZoomBox:function(){this.zoomBoxEnabled=!0,this.active&&this.zoomBox.activate()},disableZoomWheel:function(){this.zoomWheelEnabled=!1,this.handlers.wheel.deactivate()},enableZoomWheel:function(){this.zoomWheelEnabled=!0,this.active&&this.handlers.wheel.activate()},CLASS_NAME:"Tmap.Control.Navigation"}),Tmap.Control.PinchZoom=Tmap.Class(Tmap.Control,{type:Tmap.Control.TYPE_TOOL,pinchOrigin:null,currentCenter:null,autoActivate:!0,preserveCenter:!1,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,arguments),this.handler=new Tmap.Handler.Pinch(this,{start:this.pinchStart,move:this.pinchMove,done:this.pinchDone},this.handlerOptions)},pinchStart:function(a,b){var c=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):a.xy;this.pinchOrigin=c,this.currentCenter=c},pinchMove:function(a,b){var c=b.scale,d=this.map.layerContainerOriginPx,e=this.pinchOrigin,f=this.preserveCenter?this.map.getPixelFromLonLat(this.map.getCenter()):a.xy,g=Math.round(d.x+f.x-e.x+(c-1)*(d.x-e.x)),h=Math.round(d.y+f.y-e.y+(c-1)*(d.y-e.y));this.map.applyTransform(g,h,c),this.currentCenter=f},pinchDone:function(a,b,c){this.map.applyTransform();var d=this.map.getZoomForResolution(this.map.getResolution()/c.scale,!0);if(d!==this.map.getZoom()||!this.currentCenter.equals(this.pinchOrigin)){var e=this.map.getResolutionForZoom(d),f=this.map.getLonLatFromPixel(this.pinchOrigin),g=this.currentCenter,h=this.map.getSize();f.lon+=e*(h.w/2-g.x),f.lat-=e*(h.h/2-g.y),this.map.div.clientWidth=this.map.div.clientWidth,this.map.setCenter(f,d)}},CLASS_NAME:"Tmap.Control.PinchZoom"}),Tmap.Control.TouchNavigation=Tmap.Class(Tmap.Control,{dragPan:null,dragPanOptions:null,pinchZoom:null,pinchZoomOptions:null,clickHandlerOptions:null,documentDrag:!1,autoActivate:!0,initialize:function(a){this.handlers={},Tmap.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.deactivate(),this.dragPan&&this.dragPan.destroy(),this.dragPan=null,this.pinchZoom&&(this.pinchZoom.destroy(),delete this.pinchZoom),Tmap.Control.prototype.destroy.apply(this,arguments)},activate:function(){return Tmap.Control.prototype.activate.apply(this,arguments)?(this.dragPan.activate(),this.handlers.click.activate(),this.pinchZoom.activate(),!0):!1},deactivate:function(){return Tmap.Control.prototype.deactivate.apply(this,arguments)?(this.dragPan.deactivate(),this.handlers.click.deactivate(),this.pinchZoom.deactivate(),!0):!1},draw:function(){var a={click:this.defaultClick,dblclick:this.defaultDblClick},b=Tmap.Util.extend({"double":!0,stopDouble:!0,pixelTolerance:2},this.clickHandlerOptions);this.handlers.click=new Tmap.Handler.Click(this,a,b),this.dragPan=new Tmap.Control.DragPan(Tmap.Util.extend({map:this.map,documentDrag:this.documentDrag},this.dragPanOptions)),this.dragPan.draw(),this.pinchZoom=new Tmap.Control.PinchZoom(Tmap.Util.extend({map:this.map},this.pinchZoomOptions))},defaultClick:function(a){a.lastTouches&&2==a.lastTouches.length&&this.map.zoomOut()},defaultDblClick:function(a){this.map.zoomTo(this.map.zoom+1,a.xy)},CLASS_NAME:"Tmap.Control.TouchNavigation"}),Tmap.Control.MousePosition=Tmap.Class(Tmap.Control,{autoActivate:!0,element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,emptyString:null,lastXy:null,displayProjection:null,destroy:function(){this.deactivate(),Tmap.Control.prototype.destroy.apply(this,arguments)},activate:function(){return Tmap.Control.prototype.activate.apply(this,arguments)?(this.map.events.register("mousemove",this,this.redraw),this.map.events.register("mouseout",this,this.reset),this.redraw(),!0):!1},deactivate:function(){return Tmap.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("mousemove",this,this.redraw),this.map.events.unregister("mouseout",this,this.reset),this.element.innerHTML="",!0):!1},draw:function(){return Tmap.Control.prototype.draw.apply(this,arguments),this.element||(this.div.left="",this.div.top="",this.element=this.div),this.div},redraw:function(a){var b;if(null==a)return void this.reset();if(null==this.lastXy||Math.abs(a.xy.x-this.lastXy.x)>this.granularity||Math.abs(a.xy.y-this.lastXy.y)>this.granularity)return void(this.lastXy=a.xy);if(b=this.map.getLonLatFromPixel(a.xy)){this.displayProjection&&b.transform(this.map.getProjectionObject(),this.displayProjection),this.lastXy=a.xy;var c=this.formatOutput(b);c!=this.element.innerHTML&&(this.element.innerHTML=c)}},reset:function(a){null!=this.emptyString&&(this.element.innerHTML=this.emptyString)},formatOutput:function(a){var b=parseInt(this.numDigits),c=this.prefix+a.lon.toFixed(b)+this.separator+a.lat.toFixed(b)+this.suffix;return c},CLASS_NAME:"Tmap.Control.MousePosition"}),Tmap.Control.OverviewMap=Tmap.Class(Tmap.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,maximizeTitle:"",minimizeTitle:"",initialize:function(a){this.layers=[],this.handlers={},Tmap.Control.prototype.initialize.apply(this,[a])},destroy:function(){this.mapDiv&&(this.handlers.click&&this.handlers.click.destroy(),this.handlers.drag&&this.handlers.drag.destroy(),this.ovmap&&this.ovmap.viewPortDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&&(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&&(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&&(this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&&(this.div.removeChild(this.minimizeDiv),this.minimizeDiv=null),this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),Tmap.Control.prototype.destroy.apply(this,arguments))},draw:function(){if(Tmap.Control.prototype.draw.apply(this,arguments),0===this.layers.length){if(!this.map.baseLayer)return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;var a=this.map.baseLayer.clone();this.layers=[a]}if(this.element=document.createElement("div"),this.element.className=this.displayClass+"Element",this.element.style.display="none",this.element.style.background="#61a0ff",this.mapDiv=document.createElement("div"),this.mapDiv.style.width=this.size.w+"px",this.mapDiv.style.height=this.size.h+"px",this.mapDiv.style.position="relative",this.mapDiv.style.overflow="hidden",this.mapDiv.id=Tmap.Util.createUniqueID("overviewMap"),this.extentRectangle=document.createElement("div"),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.element.appendChild(this.mapDiv),this.div.appendChild(this.element),this.outsideViewport)this.element.style.display="";else{this.div.className+=" "+this.displayClass+"Container";var b=Tmap.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=Tmap.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,b,"absolute"),this.maximizeDiv.style.display="none",this.maximizeDiv.className=this.displayClass+"MaximizeButton tmButton",this.maximizeTitle&&(this.maximizeDiv.title=this.maximizeTitle),this.div.appendChild(this.maximizeDiv);var b=Tmap.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=Tmap.Util.createAlphaImageDiv("Tmap_Control_minimizeDiv",null,null,b,"absolute"),this.minimizeDiv.style.display="none",this.minimizeDiv.className=this.displayClass+"MinimizeButton tmButton",this.minimizeTitle&&(this.minimizeDiv.title=this.minimizeTitle),this.div.appendChild(this.minimizeDiv),this.minimizeControl()}return this.map.getExtent()&&this.update(),this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this}),this.maximized&&this.maximizeControl(),this.div},baseLayerDraw:function(){this.draw(),this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(a){var b=this.handlers.drag.last.x-a.x,c=this.handlers.drag.last.y-a.y;if(0!=b||0!=c){var d=this.rectPxBounds.top,e=this.rectPxBounds.left,f=Math.abs(this.rectPxBounds.getHeight()),g=this.rectPxBounds.getWidth(),h=Math.max(0,d-c);h=Math.min(h,this.ovmap.size.h-this.hComp-f);var i=Math.max(0,e-b);i=Math.min(i,this.ovmap.size.w-this.wComp-g),this.setRectPxBounds(new Tmap.Bounds(i,h+f,i+g,h))}},mapDivClick:function(a){var b=this.rectPxBounds.getCenterPixel(),c=a.xy.x-b.x,d=a.xy.y-b.y,e=this.rectPxBounds.top,f=this.rectPxBounds.left,g=Math.abs(this.rectPxBounds.getHeight()),h=this.rectPxBounds.getWidth(),i=Math.max(0,e+d);i=Math.min(i,this.ovmap.size.h-g);var j=Math.max(0,f+c);j=Math.min(j,this.ovmap.size.w-h),this.setRectPxBounds(new Tmap.Bounds(j,i+g,j+h,i)),this.updateMapToRect()},onButtonClick:function(a){a.buttonElement===this.minimizeDiv?this.minimizeControl():a.buttonElement===this.maximizeDiv&&this.maximizeControl()},maximizeControl:function(a){this.element.style.display="",this.showToggle(!1),null!=a&&Tmap.Event.stop(a)},minimizeControl:function(a){this.element.style.display="none",this.showToggle(!0),null!=a&&Tmap.Event.stop(a)},showToggle:function(a){this.maximizeDiv&&(this.maximizeDiv.style.display=a?"":"none"),this.minimizeDiv&&(this.minimizeDiv.style.display=a?"none":"")},update:function(){null==this.ovmap&&this.createMap(),(this.autoPan||!this.isSuitableOverview())&&this.updateOverview(),this.updateRectToMap()},isSuitableOverview:function(){var a=this.map.getExtent(),b=this.map.getMaxExtent(),c=new Tmap.Bounds(Math.max(a.left,b.left),Math.max(a.bottom,b.bottom),Math.min(a.right,b.right),Math.min(a.top,b.top));this.ovmap.getProjection()!=this.map.getProjection()&&(c=c.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var d=this.ovmap.getResolution()/this.map.getResolution();return d>this.minRatio&&d<=this.maxRatio&&this.ovmap.getExtent().containsBounds(c)},updateOverview:function(){var a=this.map.getResolution(),b=this.ovmap.getResolution(),c=b/a;c>this.maxRatio?b=this.minRatio*a:c<=this.minRatio&&(b=this.maxRatio*a);var d;this.ovmap.getProjection()!=this.map.getProjection()?(d=this.map.center.clone(),d.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())):d=this.map.center,this.ovmap.setCenter(d,this.ovmap.getZoomForResolution(b*this.resolutionFactor)),this.updateRectToMap()},createMap:function(){var a=Tmap.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);if(this.ovmap=new Tmap.Map(this.mapDiv,a),this.ovmap.viewPortDiv.appendChild(this.extentRectangle),Tmap.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy),this.ovmap.addLayers(this.layers),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(Tmap.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(Tmap.Element.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(Tmap.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(Tmap.Element.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.handlers.drag=new Tmap.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap}),this.handlers.click=new Tmap.Handler.Click(this,{click:this.mapDivClick},{single:!0,"double":!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap}),this.handlers.click.activate(),this.rectEvents=new Tmap.Events(this,this.extentRectangle,null,!0),this.rectEvents.register("mouseover",this,function(a){this.handlers.drag.active||this.map.dragging||this.handlers.drag.activate()}),this.rectEvents.register("mouseout",this,function(a){this.handlers.drag.dragging||this.handlers.drag.deactivate()}),this.ovmap.getProjection()!=this.map.getProjection()){var b=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,c=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=b&&c?Tmap.INCHES_PER_UNIT[b]/Tmap.INCHES_PER_UNIT[c]:1}},updateRectToMap:function(){var a;a=this.ovmap.getProjection()!=this.map.getProjection()?this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):this.map.getExtent();var b=this.getRectBoundsFromMapBounds(a);b&&this.setRectPxBounds(b)},updateMapToRect:function(){var a=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(a=a.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject())),this.map.panTo(a.getCenterLonLat())},setRectPxBounds:function(a){var b=Math.max(a.top,0),c=Math.max(a.left,0),d=Math.min(a.top+Math.abs(a.getHeight()),this.ovmap.size.h-this.hComp),e=Math.min(a.left+a.getWidth(),this.ovmap.size.w-this.wComp),f=Math.max(e-c,0),g=Math.max(d-b,0);if(f<this.minRectSize||g<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var h=c+f/2-this.minRectSize/2,i=b+g/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(i)+"px",this.extentRectangle.style.left=Math.round(h)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(b)+"px",this.extentRectangle.style.left=Math.round(c)+"px",this.extentRectangle.style.height=Math.round(g)+"px",this.extentRectangle.style.width=Math.round(f)+"px";this.rectPxBounds=new Tmap.Bounds(Math.round(c),Math.round(d),Math.round(e),Math.round(b))},getRectBoundsFromMapBounds:function(a){var b=this.getOverviewPxFromLonLat({lon:a.left,lat:a.bottom}),c=this.getOverviewPxFromLonLat({lon:a.right,lat:a.top}),d=null;return b&&c&&(d=new Tmap.Bounds(b.x,b.y,c.x,c.y)),d},getMapBoundsFromRectBounds:function(a){var b=this.getLonLatFromOverviewPx({x:a.left,y:a.bottom}),c=this.getLonLatFromOverviewPx({x:a.right,y:a.top});return new Tmap.Bounds(b.lon,b.lat,c.lon,c.lat)},getLonLatFromOverviewPx:function(a){var b=this.ovmap.size,c=this.ovmap.getResolution(),d=this.ovmap.getExtent().getCenterLonLat(),e=a.x-b.w/2,f=a.y-b.h/2;return{lon:d.lon+e*c,lat:d.lat-f*c}},getOverviewPxFromLonLat:function(a){var b=this.ovmap.getResolution(),c=this.ovmap.getExtent();return c?{x:Math.round(1/b*(a.lon-c.left)),y:Math.round(1/b*(c.top-a.lat))}:void 0},CLASS_NAME:"Tmap.Control.OverviewMap"}),Tmap.Control.KeyboardDefaults=Tmap.Class(Tmap.Control,{autoActivate:!0,slideFactor:75,observeElement:null,draw:function(){var a=this.observeElement||document;this.handler=new Tmap.Handler.Keyboard(this,{keydown:this.defaultKeyPress},{observeElement:a})},defaultKeyPress:function(a){var b,c=!0,d=Tmap.Event.element(a);if(!d||"INPUT"!=d.tagName&&"TEXTAREA"!=d.tagName&&"SELECT"!=d.tagName){switch(a.keyCode){case Tmap.Event.KEY_LEFT:this.map.pan(-this.slideFactor,0);break;case Tmap.Event.KEY_RIGHT:this.map.pan(this.slideFactor,0);break;case Tmap.Event.KEY_UP:this.map.pan(0,-this.slideFactor);break;case Tmap.Event.KEY_DOWN:this.map.pan(0,this.slideFactor);break;case 33:b=this.map.getSize(),this.map.pan(0,-.75*b.h);break;case 34:b=this.map.getSize(),this.map.pan(0,.75*b.h);break;case 35:b=this.map.getSize(),this.map.pan(.75*b.w,0);break;case 36:b=this.map.getSize(),this.map.pan(-.75*b.w,0);break;case 43:case 61:case 187:case 107:this.map.zoomIn();break;case 45:case 109:case 189:case 95:this.map.zoomOut();break;default:c=!1}c&&Tmap.Event.stop(a)}},CLASS_NAME:"Tmap.Control.KeyboardDefaults"}),Tmap.Control.PanZoom=Tmap.Class(Tmap.Control,{slideFactor:50,slideRatio:null,buttons:null,position:null,initialize:function(a){this.position=new Tmap.Pixel(Tmap.Control.PanZoom.X,Tmap.Control.PanZoom.Y),Tmap.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("buttonclick",this,this.onButtonClick),this.removeButtons(),this.buttons=null,this.position=null,Tmap.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments),this.map.events.register("buttonclick",this,this.onButtonClick)},draw:function(a){Tmap.Control.prototype.draw.apply(this,arguments),a=this.position,this.buttons=[];var b={w:18,h:18},c=new Tmap.Pixel(a.x+b.w/2,a.y);return this._addButton("panup","north-mini.png",c,b),a.y=c.y+b.h,this._addButton("panleft","west-mini.png",a,b),this._addButton("panright","east-mini.png",a.add(b.w,0),b),this._addButton("pandown","south-mini.png",c.add(0,2*b.h),b),this._addButton("zoomin","zoom-plus-mini.png",c.add(0,3*b.h+5),b),this._addButton("zoomworld","zoom-world-mini.png",c.add(0,4*b.h+5),b),this._addButton("zoomout","zoom-minus-mini.png",c.add(0,5*b.h+5),b),this.div},_addButton:function(a,b,c,d){var e=Tmap.Util.getImageLocation(b),f=Tmap.Util.createAlphaImageDiv(this.id+"_"+a,c,d,e,"absolute");return f.style.cursor="pointer",this.div.appendChild(f),f.action=a,f.className="tmButton",this.buttons.push(f),f},_removeButton:function(a){this.div.removeChild(a),Tmap.Util.removeItem(this.buttons,a)},removeButtons:function(){for(var a=this.buttons.length-1;a>=0;--a)this._removeButton(this.buttons[a])},onButtonClick:function(a){var b=a.buttonElement;switch(b.action){case"panup":this.map.pan(0,-this.getSlideFactor("h"));break;case"pandown":this.map.pan(0,this.getSlideFactor("h"));break;case"panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case"panright":this.map.pan(this.getSlideFactor("w"),0);break;case"zoomin":this.map.zoomIn();break;case"zoomout":this.map.zoomOut();break;case"zoomworld":this.map.zoomToMaxExtent()}},getSlideFactor:function(a){return this.slideRatio?this.map.getSize()[a]*this.slideRatio:this.slideFactor},CLASS_NAME:"Tmap.Control.PanZoom"}),Tmap.Control.PanZoom.X=4,Tmap.Control.PanZoom.Y=4,Tmap.Control.PanZoomBar=Tmap.Class(Tmap.Control.PanZoom,{zoomStopWidth:8,zoomStopHeight:6,slider:null,sliderEvents:null,zoombarDiv:null,zoomWorldIcon:!1,panIcons:!0,forceFixedZoomLevel:!1,mouseDragStart:null,deltaY:null,zoomStart:null,destroy:function(){this._removeZoomBar(),this.map.events.un({changebaselayer:this.redraw,scope:this}),Tmap.Control.PanZoom.prototype.destroy.apply(this,arguments),delete this.mouseDragStart,delete this.zoomStart},setMap:function(a){Tmap.Control.PanZoom.prototype.setMap.apply(this,arguments),this.map.events.register("changebaselayer",this,this.redraw)},redraw:function(){null!=this.div&&(this.removeButtons(),this._removeZoomBar()),this.draw()},draw:function(a){Tmap.Control.prototype.draw.apply(this,arguments),a=this.position.clone(),this.buttons=[];var b={w:18,h:18},c={w:54,h:54},d=new Tmap.Pixel(a.x+b.w/2,a.y);if(this.panIcons){d=new Tmap.Pixel(a.x,a.y),this._addButton("panBG","dial.png",d,c),d=new Tmap.Pixel(a.x+b.w/2,a.y);var e=b.w;this.zoomWorldIcon&&(d=new Tmap.Pixel(a.x+b.w,a.y)),d.x+=10,this._addButton("panup","north-mini.png",d,b),a.y=d.y+b.h-1,this._addButton("panleft","west-mini.png",a,b),this.zoomWorldIcon&&(this._addButton("zoomworld","zoom-world-mini.png",a.add(b.w,0),b),e*=2),e*=2,this._addButton("panright","east-mini.png",a.add(e,0),b),this._addButton("pandown","south-mini.png",d.add(0,2*b.h),b),this._addButton("zoomin","zoom-plus-mini.png",d.add(0,3*b.h+5),b),d=this._addZoomBar(d.add(0,4*b.h+5)),this._addButton("zoomout","zoom-minus-mini.png",d,b)}else this._addButton("zoomin","zoom-plus-mini.png",a,b),d=this._addZoomBar(a.add(0,b.h)),this._addButton("zoomout","zoom-minus-mini.png",d,b),this.zoomWorldIcon&&(d=d.add(0,b.h+3),this._addButton("zoomworld","zoom-world-mini.png",d,b));return this.div},_addZoomBar:function(a){var b=Tmap.Util.getImageLocation("slider.png"),c=this.id+"_"+this.map.id,d=this.map.getNumZoomLevels()-1-this.map.getZoom(),e=Tmap.Util.createAlphaImageDiv(c,a.add(-1,d*this.zoomStopHeight),{w:20,h:9},b,"absolute");e.style.cursor="move",this.slider=e,this.sliderEvents=new Tmap.Events(this,e,null,!0,{includeXY:!0}),this.sliderEvents.on({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp});var f={w:this.zoomStopWidth,h:this.zoomStopHeight*this.map.getNumZoomLevels()},b=Tmap.Util.getImageLocation("zoombar.png"),g=null,h=a.add(5,0);if(Tmap.Util.alphaHack()){var c=this.id+"_"+this.map.id;g=Tmap.Util.createAlphaImageDiv(c,h,{w:f.w,h:this.zoomStopHeight},b,"absolute",null,"crop"),g.style.height=f.h+"px"}else g=Tmap.Util.createDiv("Tmap_Control_PanZoomBar_Zoombar"+this.map.id,h,f,b);return g.style.cursor="pointer",g.className="tmButton",this.zoombarDiv=g,this.div.appendChild(g),this.startTop=parseInt(g.style.top),this.div.appendChild(e),this.map.events.register("zoomend",this,this.moveZoomBar),a=a.add(0,this.zoomStopHeight*this.map.getNumZoomLevels())},_removeZoomBar:function(){this.sliderEvents.un({touchstart:this.zoomBarDown,touchmove:this.zoomBarDrag,touchend:this.zoomBarUp,mousedown:this.zoomBarDown,mousemove:this.zoomBarDrag,mouseup:this.zoomBarUp}),this.sliderEvents.destroy(),this.div.removeChild(this.zoombarDiv),this.zoombarDiv=null,this.div.removeChild(this.slider),this.slider=null,this.map.events.unregister("zoomend",this,this.moveZoomBar)},onButtonClick:function(a){if(Tmap.Control.PanZoom.prototype.onButtonClick.apply(this,arguments),a.buttonElement===this.zoombarDiv){var b=a.buttonXY.y/this.zoomStopHeight;(this.forceFixedZoomLevel||!this.map.fractionalZoom)&&(b=Math.floor(b));var c=this.map.getNumZoomLevels()-1-b;c=Math.min(Math.max(c,0),this.map.getNumZoomLevels()-1),this.map.zoomTo(c)}},passEventToSlider:function(a){this.sliderEvents.handleBrowserEvent(a)},zoomBarDown:function(a){(Tmap.Event.isLeftClick(a)||Tmap.Event.isSingleTouch(a))&&(this.map.events.on({touchmove:this.passEventToSlider,mousemove:this.passEventToSlider,mouseup:this.passEventToSlider,scope:this}),this.mouseDragStart=a.xy.clone(),this.zoomStart=a.xy.clone(),this.div.style.cursor="move",this.zoombarDiv.offsets=null,Tmap.Event.stop(a,!1,!0))},zoomBarDrag:function(a){if(null!=this.mouseDragStart){var b=this.mouseDragStart.y-a.xy.y,c=Tmap.Util.pagePosition(this.zoombarDiv);if(a.clientY-c[1]>0&&a.clientY-c[1]<parseInt(this.zoombarDiv.style.height)-2){var d=parseInt(this.slider.style.top)-b;this.slider.style.top=d+"px",this.mouseDragStart=a.xy.clone()}this.deltaY=this.zoomStart.y-a.xy.y,Tmap.Event.stop(a,!1,!0)}},zoomBarUp:function(a){if((Tmap.Event.isLeftClick(a)||"touchend"===a.type)&&this.mouseDragStart){this.div.style.cursor="",this.map.events.un({touchmove:this.passEventToSlider,mouseup:this.passEventToSlider,mousemove:this.passEventToSlider,scope:this});var b=this.map.zoom;!this.forceFixedZoomLevel&&this.map.fractionalZoom?(b+=this.deltaY/this.zoomStopHeight,b=Math.min(Math.max(b,0),this.map.getNumZoomLevels()-1)):(b+=this.deltaY/this.zoomStopHeight,b=Math.max(Math.round(b),0)),this.map.zoomTo(b),this.mouseDragStart=null,this.zoomStart=null,this.deltaY=0,Tmap.Event.stop(a,!1,!0)}},moveZoomBar:function(){var a=(this.map.getNumZoomLevels()-1-this.map.getZoom())*this.zoomStopHeight+this.startTop+-2;this.slider.style.top=a+"px"},CLASS_NAME:"Tmap.Control.PanZoomBar"}),Tmap.Control.ArgParser=Tmap.Class(Tmap.Control,{center:null,zoom:null,layers:null,displayProjection:null,getParameters:function(a){a=a||window.location.href;var b=Tmap.Util.getParameters(a),c=a.indexOf("#");return c>0&&(a="?"+a.substring(c+1,a.length),Tmap.Util.extend(b,Tmap.Util.getParameters(a))),b},setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments);for(var b=0,c=this.map.controls.length;c>b;b++){var d=this.map.controls[b];if(d!=this&&"Tmap.Control.ArgParser"==d.CLASS_NAME){d.displayProjection!=this.displayProjection&&(this.displayProjection=d.displayProjection);break}}if(b==this.map.controls.length){var e=this.getParameters();e.layers&&(this.layers=e.layers,this.map.events.register("addlayer",this,this.configureLayers),this.configureLayers()),e.lat&&e.lon&&(this.center=new Tmap.LonLat(parseFloat(e.lon),parseFloat(e.lat)),e.zoom&&(this.zoom=parseFloat(e.zoom)),this.map.events.register("changebaselayer",this,this.setCenter),this.setCenter())}},setCenter:function(){this.map.baseLayer&&(this.map.events.unregister("changebaselayer",this,this.setCenter),this.displayProjection&&this.center.transform(this.displayProjection,this.map.getProjectionObject()),this.map.setCenter(this.center,this.zoom))},configureLayers:function(){if(this.layers.length==this.map.layers.length){this.map.events.unregister("addlayer",this,this.configureLayers);for(var a=0,b=this.layers.length;b>a;a++){var c=this.map.layers[a],d=this.layers.charAt(a);"B"==d?this.map.setBaseLayer(c):("T"==d||"F"==d)&&c.setVisibility("T"==d)}}},CLASS_NAME:"Tmap.Control.ArgParser"}),Tmap.Control.Permalink=Tmap.Class(Tmap.Control,{argParserClass:Tmap.Control.ArgParser,element:null,anchor:!1,base:"",displayProjection:null,initialize:function(a,b,c){null===a||"object"!=typeof a||Tmap.Util.isElement(a)?(Tmap.Control.prototype.initialize.apply(this,[c]),this.element=Tmap.Util.getElement(a),this.base=b||document.location.href):(c=a,this.base=document.location.href,Tmap.Control.prototype.initialize.apply(this,[c]),null!=this.element&&(this.element=Tmap.Util.getElement(this.element)))},destroy:function(){this.element&&this.element.parentNode==this.div&&(this.div.removeChild(this.element),this.element=null),this.map&&this.map.events.unregister("moveend",this,this.updateLink),Tmap.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments);for(var b=0,c=this.map.controls.length;c>b;b++){var d=this.map.controls[b];if(d.CLASS_NAME==this.argParserClass.CLASS_NAME){d.displayProjection!=this.displayProjection&&(this.displayProjection=d.displayProjection);break}}b==this.map.controls.length&&this.map.addControl(new this.argParserClass({displayProjection:this.displayProjection}))},draw:function(){return Tmap.Control.prototype.draw.apply(this,arguments),this.element||this.anchor||(this.element=document.createElement("a"),this.element.innerHTML=Tmap.i18n("Permalink"),this.element.href="",this.div.appendChild(this.element)),this.map.events.on({moveend:this.updateLink,changelayer:this.updateLink,changebaselayer:this.updateLink,scope:this}),this.updateLink(),this.div},updateLink:function(){var a=this.anchor?"#":"?",b=this.base,c=null;-1!=b.indexOf("#")&&0==this.anchor&&(c=b.substring(b.indexOf("#"),b.length)),-1!=b.indexOf(a)&&(b=b.substring(0,b.indexOf(a)));var d=b.split("#");b=d[0]+a+Tmap.Util.getParameterString(this.createParams()),c&&(b+=c),this.anchor&&!this.element?window.location.href=b:this.element.href=b},createParams:function(a,b,c){a=a||this.map.getCenter();var d=Tmap.Util.getParameters(this.base);if(a){d.zoom=b||this.map.getZoom();var e=a.lat,f=a.lon;if(this.displayProjection){var g=Tmap.Projection.transform({x:f,y:e},this.map.getProjectionObject(),this.displayProjection);f=g.x,e=g.y}d.lat=Math.round(1e5*e)/1e5,d.lon=Math.round(1e5*f)/1e5,c=c||this.map.layers,d.layers="";for(var h=0,i=c.length;i>h;h++){var j=c[h];j.isBaseLayer?d.layers+=j==this.map.baseLayer?"B":"0":d.layers+=j.getVisibility()?"T":"F"}}return d},CLASS_NAME:"Tmap.Control.Permalink"}),Tmap.Control.Scale=Tmap.Class(Tmap.Control,{element:null,geodesic:!1,initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]),this.element=Tmap.Util.getElement(a)},draw:function(){return Tmap.Control.prototype.draw.apply(this,arguments),this.element||(this.element=document.createElement("div"),this.div.appendChild(this.element)),this.map.events.register("moveend",this,this.updateScale),this.updateScale(),this.div},updateScale:function(){var a;if(this.geodesic===!0){var b=this.map.getUnits();if(!b)return;var c=Tmap.INCHES_PER_UNIT;a=(this.map.getGeodesicPixelSize().w||1e-6)*c.km*Tmap.DOTS_PER_INCH}else a=this.map.getScale();a&&(a=a>=9500&&95e4>=a?Math.round(a/1e3)+"K":a>=95e4?Math.round(a/1e6)+"M":Math.round(a),this.element.innerHTML=Tmap.i18n("Scale = 1 : ${scaleDenom}",{scaleDenom:a}))},CLASS_NAME:"Tmap.Control.Scale"}),Tmap.Control.ScaleLine=Tmap.Class(Tmap.Control,{maxWidth:100,topOutUnits:"km",topInUnits:"m",bottomOutUnits:"",bottomInUnits:"ft",eTop:null,eBottom:null,geodesic:!1,draw:function(){if(Tmap.Control.prototype.draw.apply(this,arguments),!this.eTop){this.eTop=document.createElement("div"),this.eTop.className=this.displayClass+"Top";this.topInUnits.length;this.div.appendChild(this.eTop),""==this.topOutUnits||""==this.topInUnits?this.eTop.style.visibility="hidden":this.eTop.style.visibility="visible",this.eBottom=document.createElement("div"),this.eBottom.className=this.displayClass+"Bottom",this.div.appendChild(this.eBottom),""==this.bottomOutUnits||""==this.bottomInUnits?this.eBottom.style.visibility="hidden":this.eBottom.style.visibility="visible"}return this.map.events.register("moveend",this,this.update),this.update(),this.div},getBarLen:function(a){var b,c=parseInt(Math.log(a)/Math.log(10)),d=Math.pow(10,c),e=parseInt(a/d);return b=e>5?5:e>2?2:1,b*d},update:function(){if(this.map){var a=this.map.getResolution();if(a){var b=this.map.getUnits(),c=Tmap.INCHES_PER_UNIT,d=this.maxWidth*a*c[b],e=1;if(this.geodesic===!0){var f=(this.map.getGeodesicPixelSize().w||1e-6)*this.maxWidth,g=d/c.km;e=f/g,d*=e}var h,i;d>1e5?(h=this.topOutUnits,i=this.bottomOutUnits):(h=this.topInUnits,i=this.bottomInUnits);var j=d/c[h],k=d/c[i],l=this.getBarLen(j),m=this.getBarLen(k);j=l/c[b]*c[h],k=m/c[b]*c[i];var n=j/a/e,o=k/a/e;"visible"==this.eBottom.style.visibility&&(this.eBottom.style.width=Math.round(o)+"px",this.eBottom.innerHTML=m+" "+i),"visible"==this.eTop.style.visibility&&(this.eTop.style.width=Math.round(n)+"px",this.eTop.innerHTML=l+" "+h)}}},CLASS_NAME:"Tmap.Control.ScaleLine"}),Tmap.Control.Snapping=Tmap.Class(Tmap.Control,{DEFAULTS:{tolerance:10,node:!0,edge:!0,vertex:!0},greedy:!0,precedence:["node","vertex","edge"],resolution:null,geoToleranceCache:null,layer:null,feature:null,point:null,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,[a]),this.options=a||{},this.options.layer&&this.setLayer(this.options.layer);var b=Tmap.Util.extend({},this.options.defaults);this.defaults=Tmap.Util.applyDefaults(b,this.DEFAULTS),this.setTargets(this.options.targets),0===this.targets.length&&this.layer&&this.addTargetLayer(this.layer),this.geoToleranceCache={}},setLayer:function(a){this.active?(this.deactivate(),this.layer=a,this.activate()):this.layer=a},setTargets:function(a){if(this.targets=[],a&&a.length)for(var b,c=0,d=a.length;d>c;++c)b=a[c],b instanceof Tmap.Layer.Vector?this.addTargetLayer(b):this.addTarget(b)},addTargetLayer:function(a){this.addTarget({layer:a})},addTarget:function(a){a=Tmap.Util.applyDefaults(a,this.defaults),a.nodeTolerance=a.nodeTolerance||a.tolerance,a.vertexTolerance=a.vertexTolerance||a.tolerance,a.edgeTolerance=a.edgeTolerance||a.tolerance,this.targets.push(a)},removeTargetLayer:function(a){for(var b,c=this.targets.length-1;c>=0;--c)b=this.targets[c],b.layer===a&&this.removeTarget(b)},removeTarget:function(a){return Tmap.Util.removeItem(this.targets,a)},activate:function(){var a=Tmap.Control.prototype.activate.call(this);return a&&this.layer&&this.layer.events&&this.layer.events.on({sketchstarted:this.onSketchModified,sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this}),a},deactivate:function(){var a=Tmap.Control.prototype.deactivate.call(this);return a&&this.layer&&this.layer.events&&this.layer.events.un({sketchstarted:this.onSketchModified,sketchmodified:this.onSketchModified,vertexmodified:this.onVertexModified,scope:this}),this.feature=null,
this.point=null,a},onSketchModified:function(a){this.feature=a.feature,this.considerSnapping(a.vertex,a.vertex)},onVertexModified:function(a){this.feature=a.feature;var b=this.layer.map.getLonLatFromViewPortPx(a.pixel);this.considerSnapping(a.vertex,new Tmap.Geometry.Point(b.lon,b.lat))},considerSnapping:function(a,b){for(var c,d,e={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY,x:null,y:null},f=!1,g=0,h=this.targets.length;h>g;++g)if(d=this.targets[g],c=this.testTarget(d,b)){if(this.greedy){e=c,e.target=d,f=!0;break}(c.rank<e.rank||c.rank===e.rank&&c.dist<e.dist)&&(e=c,e.target=d,f=!0)}if(f){var i=this.events.triggerEvent("beforesnap",{point:a,x:e.x,y:e.y,distance:e.dist,layer:e.target.layer,snapType:this.precedence[e.rank]});i!==!1?(a.x=e.x,a.y=e.y,this.point=a,this.events.triggerEvent("snap",{point:a,snapType:this.precedence[e.rank],layer:e.target.layer,distance:e.dist})):f=!1}this.point&&!f&&(a.x=b.x,a.y=b.y,this.point=null,this.events.triggerEvent("unsnap",{point:a}))},testTarget:function(a,b){var c=this.layer.map.getResolution();if("minResolution"in a&&c<a.minResolution)return null;if("maxResolution"in a&&c>=a.maxResolution)return null;for(var d,e,f,g,h,i,j,k={node:this.getGeoTolerance(a.nodeTolerance,c),vertex:this.getGeoTolerance(a.vertexTolerance,c),edge:this.getGeoTolerance(a.edgeTolerance,c)},l=Math.max(k.node,k.vertex,k.edge),m={rank:Number.POSITIVE_INFINITY,dist:Number.POSITIVE_INFINITY},n=!1,o=a.layer.features,p=this.precedence.length,q=new Tmap.LonLat(b.x,b.y),r=0,s=o.length;s>r;++r)if(d=o[r],d!==this.feature&&!d._sketch&&d.state!==Tmap.State.DELETE&&(!a.filter||a.filter.evaluate(d))&&d.atPoint(q,l,l))for(var t=0,u=Math.min(m.rank+1,p);u>t;++t)if(e=this.precedence[t],a[e])if("edge"===e){if(h=d.geometry.distanceTo(b,{details:!0}),i=h.distance,i<=k[e]&&i<m.dist){m={rank:t,dist:i,x:h.x0,y:h.y0},n=!0;break}}else{f=d.geometry.getVertices("node"===e),j=!1;for(var v=0,w=f.length;w>v;++v)g=f[v],i=g.distanceTo(b),i<=k[e]&&(t<m.rank||t===m.rank&&i<m.dist)&&(m={rank:t,dist:i,x:g.x,y:g.y},n=!0,j=!0);if(j)break}return n?m:null},getGeoTolerance:function(a,b){b!==this.resolution&&(this.resolution=b,this.geoToleranceCache={});var c=this.geoToleranceCache[a];return void 0===c&&(c=a*b,this.geoToleranceCache[a]=c),c},destroy:function(){this.active&&this.deactivate(),delete this.layer,delete this.targets,Tmap.Control.prototype.destroy.call(this)},CLASS_NAME:"Tmap.Control.Snapping"}),Tmap.Control.Split=Tmap.Class(Tmap.Control,{layer:null,source:null,sourceOptions:null,tolerance:null,edge:!0,deferDelete:!1,mutual:!0,targetFilter:null,sourceFilter:null,handler:null,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,[a]),this.options=a||{},this.options.source&&this.setSource(this.options.source)},setSource:function(a){this.active?(this.deactivate(),this.handler&&(this.handler.destroy(),delete this.handler),this.source=a,this.activate()):this.source=a},activate:function(){var a=Tmap.Control.prototype.activate.call(this);return a&&(this.source?this.source.events&&this.source.events.on({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}):(this.handler||(this.handler=new Tmap.Handler.Path(this,{done:function(a){this.onSketchComplete({feature:new Tmap.Feature.Vector(a)})}},{layerOptions:this.sourceOptions})),this.handler.activate())),a},deactivate:function(){var a=Tmap.Control.prototype.deactivate.call(this);return a&&this.source&&this.source.events&&this.source.events.un({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}),a},onSketchComplete:function(a){return this.feature=null,!this.considerSplit(a.feature)},afterFeatureModified:function(a){if(a.modified){var b=a.feature;"function"==typeof b.geometry.split&&(this.feature=a.feature,this.considerSplit(a.feature))}},removeByGeometry:function(a,b){for(var c=0,d=a.length;d>c;++c)if(a[c].geometry===b){a.splice(c,1);break}},isEligible:function(a){return a.geometry?a.state!==Tmap.State.DELETE&&"function"==typeof a.geometry.split&&this.feature!==a&&(!this.targetFilter||this.targetFilter.evaluate(a.attributes)):!1},considerSplit:function(a){var b=!1,c=!1;if(!this.sourceFilter||this.sourceFilter.evaluate(a.attributes)){for(var d,e,f,g,h,i,j,k=this.layer&&this.layer.features||[],l=[],m=[],n=this.layer===this.source&&this.mutual,o={edge:this.edge,tolerance:this.tolerance,mutual:n},p=[a.geometry],q=0,r=k.length;r>q;++q)if(g=k[q],this.isEligible(g)){h=[g.geometry];for(var s=0;s<p.length;++s){i=p[s];for(var t=0;t<h.length;++t)d=h[t],i.getBounds().intersectsBounds(d.getBounds())&&(e=i.split(d,o),e&&(f=this.events.triggerEvent("beforesplit",{source:a,target:g}),f!==!1&&(n&&(j=e[0],j.length>1&&(j.unshift(s,1),Array.prototype.splice.apply(p,j),s+=j.length-3),e=e[1]),e.length>1&&(e.unshift(t,1),Array.prototype.splice.apply(h,e),t+=e.length-3))))}h&&h.length>1&&(this.geomsToFeatures(g,h),this.events.triggerEvent("split",{original:g,features:h}),Array.prototype.push.apply(l,h),m.push(g),c=!0)}if(p&&p.length>1&&(this.geomsToFeatures(a,p),this.events.triggerEvent("split",{original:a,features:p}),Array.prototype.push.apply(l,p),m.push(a),b=!0),b||c){if(this.deferDelete){for(var u,v=[],q=0,r=m.length;r>q;++q)u=m[q],u.state===Tmap.State.INSERT?v.push(u):(u.state=Tmap.State.DELETE,this.layer.drawFeature(u));this.layer.destroyFeatures(v,{silent:!0});for(var q=0,r=l.length;r>q;++q)l[q].state=Tmap.State.INSERT}else this.layer.destroyFeatures(m,{silent:!0});this.layer.addFeatures(l,{silent:!0}),this.events.triggerEvent("aftersplit",{source:a,features:l})}}return b},geomsToFeatures:function(a,b){var c=a.clone();delete c.geometry;for(var d,e=0,f=b.length;f>e;++e)d=c.clone(),d.geometry=b[e],d.state=Tmap.State.INSERT,b[e]=d},destroy:function(){this.active&&this.deactivate(),Tmap.Control.prototype.destroy.call(this)},CLASS_NAME:"Tmap.Control.Split"}),Tmap.Control.LayerSwitcher=Tmap.Class(Tmap.Control,{roundedCorner:!1,roundedCornerColor:"darkblue",layerStates:null,layersDiv:null,baseLayersDiv:null,baseLayers:null,dataLbl:null,dataLayersDiv:null,dataLayers:null,minimizeDiv:null,maximizeDiv:null,ascending:!0,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,arguments),this.layerStates=[],this.roundedCorner&&Tmap.Console.warn("roundedCorner option is deprecated")},destroy:function(){this.clearLayersArray("base"),this.clearLayersArray("data"),this.map.events.un({buttonclick:this.onButtonClick,addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this}),this.events.unregister("buttonclick",this,this.onButtonClick),Tmap.Control.prototype.destroy.apply(this,arguments)},setMap:function(a){Tmap.Control.prototype.setMap.apply(this,arguments),this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this}),this.outsideViewport?(this.events.attachToElement(this.div),this.events.register("buttonclick",this,this.onButtonClick)):this.map.events.register("buttonclick",this,this.onButtonClick)},draw:function(){return Tmap.Control.prototype.draw.apply(this),this.loadContents(),this.outsideViewport||this.minimizeControl(),this.redraw(),this.div},onButtonClick:function(a){var b=a.buttonElement;b===this.minimizeDiv?this.minimizeControl():b===this.maximizeDiv?this.maximizeControl():b._layerSwitcher===this.id&&(b["for"]&&(b=document.getElementById(b["for"])),b.disabled||("radio"==b.type?(b.checked=!0,this.map.setBaseLayer(this.map.getLayer(b._layer))):(b.checked=!b.checked,this.updateMap())))},clearLayersArray:function(a){this[a+"LayersDiv"].innerHTML="",this[a+"Layers"]=[]},checkRedraw:function(){var a=!1;if(this.layerStates.length&&this.map.layers.length==this.layerStates.length)for(var b=0,c=this.layerStates.length;c>b;b++){var d=this.layerStates[b],e=this.map.layers[b];if(d.name!=e.name||d.inRange!=e.inRange||d.id!=e.id||d.visibility!=e.visibility){a=!0;break}}else a=!0;return a},redraw:function(){if(!this.checkRedraw())return this.div;this.clearLayersArray("base"),this.clearLayersArray("data");var a=!1,b=!1,c=this.map.layers.length;this.layerStates=new Array(c);for(var d=0;c>d;d++){var e=this.map.layers[d];this.layerStates[d]={name:e.name,visibility:e.visibility,inRange:e.inRange,id:e.id}}var f=this.map.layers.slice();this.ascending||f.reverse();for(var d=0,c=f.length;c>d;d++){var e=f[d],g=e.isBaseLayer;if(e.displayInLayerSwitcher){g?b=!0:a=!0;var h=g?e==this.map.baseLayer:e.getVisibility(),i=document.createElement("input"),j=Tmap.Util.createUniqueID(this.id+"_input_");i.id=j,i.name=g?this.id+"_baseLayers":e.name,i.type=g?"radio":"checkbox",i.value=e.name,i.checked=h,i.defaultChecked=h,i.className="tmButton",i._layer=e.id,i._layerSwitcher=this.id,g||e.inRange||(i.disabled=!0);var k=document.createElement("label");k["for"]=i.id,Tmap.Element.addClass(k,"labelSpan tmButton"),k._layer=e.id,k._layerSwitcher=this.id,g||e.inRange||(k.style.color="gray"),k.innerHTML=e.name,k.style.verticalAlign=g?"bottom":"baseline";var l=document.createElement("br"),m=g?this.baseLayers:this.dataLayers;m.push({layer:e,inputElem:i,labelSpan:k});var n=g?this.baseLayersDiv:this.dataLayersDiv;n.appendChild(i),n.appendChild(k),n.appendChild(l)}}return this.dataLbl.style.display=a?"":"none",this.baseLbl.style.display=b?"":"none",this.div},updateMap:function(){for(var a=0,b=this.baseLayers.length;b>a;a++){var c=this.baseLayers[a];c.inputElem.checked&&this.map.setBaseLayer(c.layer,!1)}for(var a=0,b=this.dataLayers.length;b>a;a++){var c=this.dataLayers[a];c.layer.setVisibility(c.inputElem.checked)}},maximizeControl:function(a){this.div.style.width="",this.div.style.height="",this.showControls(!1),null!=a&&Tmap.Event.stop(a)},minimizeControl:function(a){this.div.style.width="0px",this.div.style.height="0px",this.showControls(!0),null!=a&&Tmap.Event.stop(a)},showControls:function(a){this.maximizeDiv.style.display=a?"":"none",this.minimizeDiv.style.display=a?"none":"",this.layersDiv.style.display=a?"none":""},loadContents:function(){this.layersDiv=document.createElement("div"),this.layersDiv.id=this.id+"_layersDiv",Tmap.Element.addClass(this.layersDiv,"layersDiv"),this.baseLbl=document.createElement("div"),this.baseLbl.innerHTML=Tmap.i18n("Base Layer"),Tmap.Element.addClass(this.baseLbl,"baseLbl"),this.baseLayersDiv=document.createElement("div"),Tmap.Element.addClass(this.baseLayersDiv,"baseLayersDiv"),this.dataLbl=document.createElement("div"),this.dataLbl.innerHTML=Tmap.i18n("Overlays"),Tmap.Element.addClass(this.dataLbl,"dataLbl"),this.dataLayersDiv=document.createElement("div"),Tmap.Element.addClass(this.dataLayersDiv,"dataLayersDiv"),this.ascending?(this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv),this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv)):(this.layersDiv.appendChild(this.dataLbl),this.layersDiv.appendChild(this.dataLayersDiv),this.layersDiv.appendChild(this.baseLbl),this.layersDiv.appendChild(this.baseLayersDiv)),this.div.appendChild(this.layersDiv),this.roundedCorner&&(Tmap.Rico.Corner.round(this.div,{corners:"tl bl",bgColor:"transparent",color:this.roundedCornerColor,blend:!1}),Tmap.Rico.Corner.changeOpacity(this.layersDiv,.75));var a=Tmap.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=Tmap.Util.createAlphaImageDiv("Tmap_Control_MaximizeDiv",null,null,a,"absolute"),Tmap.Element.addClass(this.maximizeDiv,"maximizeDiv tmButton"),this.maximizeDiv.style.display="none",this.div.appendChild(this.maximizeDiv);var a=Tmap.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=Tmap.Util.createAlphaImageDiv("Tmap_Control_MinimizeDiv",null,null,a,"absolute"),Tmap.Element.addClass(this.minimizeDiv,"minimizeDiv tmButton"),this.minimizeDiv.style.display="none",this.div.appendChild(this.minimizeDiv)},CLASS_NAME:"Tmap.Control.LayerSwitcher"}),Tmap.Control.DrawFeature=Tmap.Class(Tmap.Control,{layer:null,callbacks:null,multi:!1,featureAdded:function(){},initialize:function(a,b,c){Tmap.Control.prototype.initialize.apply(this,[c]),this.callbacks=Tmap.Util.extend({done:this.drawFeature,modify:function(a,b){this.layer.events.triggerEvent("sketchmodified",{vertex:a,feature:b})},create:function(a,b){this.layer.events.triggerEvent("sketchstarted",{vertex:a,feature:b})}},this.callbacks),this.layer=a,this.handlerOptions=this.handlerOptions||{},this.handlerOptions.layerOptions=Tmap.Util.applyDefaults(this.handlerOptions.layerOptions,{renderers:a.renderers,rendererOptions:a.rendererOptions}),"multi"in this.handlerOptions||(this.handlerOptions.multi=this.multi);var d=this.layer.styleMap&&this.layer.styleMap.styles.temporary;d&&(this.handlerOptions.layerOptions=Tmap.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new Tmap.StyleMap({"default":d})})),this.handler=new b(this,this.callbacks,this.handlerOptions)},drawFeature:function(a){var b=new Tmap.Feature.Vector(a),c=this.layer.events.triggerEvent("sketchcomplete",{feature:b});c!==!1&&(b.state=Tmap.State.INSERT,this.layer.addFeatures([b]),this.featureAdded(b),this.events.triggerEvent("featureadded",{feature:b}))},insertXY:function(a,b){this.handler&&this.handler.line&&this.handler.insertXY(a,b)},insertDeltaXY:function(a,b){this.handler&&this.handler.line&&this.handler.insertDeltaXY(a,b)},insertDirectionLength:function(a,b){this.handler&&this.handler.line&&this.handler.insertDirectionLength(a,b)},insertDeflectionLength:function(a,b){this.handler&&this.handler.line&&this.handler.insertDeflectionLength(a,b)},undo:function(){return this.handler.undo&&this.handler.undo()},redo:function(){return this.handler.redo&&this.handler.redo()},finishSketch:function(){this.handler.finishGeometry()},cancel:function(){this.handler.cancel()},CLASS_NAME:"Tmap.Control.DrawFeature"}),Tmap.Control.DragFeature=Tmap.Class(Tmap.Control,{geometryTypes:null,onStart:function(a,b){},onDrag:function(a,b){},onComplete:function(a,b){},onEnter:function(a){},onLeave:function(a){},documentDrag:!1,layer:null,feature:null,dragCallbacks:{},featureCallbacks:{},lastPixel:null,initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]),this.layer=a,this.handlers={drag:new Tmap.Handler.Drag(this,Tmap.Util.extend({down:this.downFeature,move:this.moveFeature,up:this.upFeature,out:this.cancel,done:this.doneDragging},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new Tmap.Handler.Feature(this,this.layer,Tmap.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes})}},clickFeature:function(a){this.handlers.feature.touch&&!this.over&&this.overFeature(a)&&(this.handlers.drag.dragstart(this.handlers.feature.evt),this.handlers.drag.stopDown=!1)},clickoutFeature:function(a){this.handlers.feature.touch&&this.over&&(this.outFeature(a),this.handlers.drag.stopDown=!0)},destroy:function(){this.layer=null,Tmap.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.feature.activate()&&Tmap.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.handlers.drag.deactivate(),this.handlers.feature.deactivate(),this.feature=null,this.dragging=!1,this.lastPixel=null,Tmap.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),Tmap.Control.prototype.deactivate.apply(this,arguments)},overFeature:function(a){var b=!1;return this.handlers.drag.dragging?this.feature.id==a.id?this.over=!0:this.over=!1:(this.feature=a,this.handlers.drag.activate(),b=!0,this.over=!0,Tmap.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onEnter(a)),b},downFeature:function(a){this.lastPixel=a,this.onStart(this.feature,a)},moveFeature:function(a){var b=this.map.getResolution();this.feature.geometry.move(b*(a.x-this.lastPixel.x),b*(this.lastPixel.y-a.y)),this.layer.drawFeature(this.feature),this.lastPixel=a,this.onDrag(this.feature,a)},upFeature:function(a){this.over||this.handlers.drag.deactivate()},doneDragging:function(a){this.onComplete(this.feature,a)},outFeature:function(a){this.handlers.drag.dragging?this.feature.id==a.id&&(this.over=!1):(this.over=!1,this.handlers.drag.deactivate(),Tmap.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over"),this.onLeave(a),this.feature=null)},cancel:function(){this.handlers.drag.deactivate(),this.over=!1},setMap:function(a){this.handlers.drag.setMap(a),this.handlers.feature.setMap(a),Tmap.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"Tmap.Control.DragFeature"}),Tmap.Control.ModifyFeature=Tmap.Class(Tmap.Control,{documentDrag:!1,geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertex:null,vertices:null,virtualVertices:null,handlers:null,deleteCodes:null,virtualStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(a,b){b=b||{},this.layer=a,this.vertices=[],this.virtualVertices=[],this.virtualStyle=Tmap.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,b.vertexRenderIntent)),this.virtualStyle.fillOpacity=.3,this.virtualStyle.strokeOpacity=.3,this.deleteCodes=[46,68],this.mode=Tmap.Control.ModifyFeature.RESHAPE,Tmap.Control.prototype.initialize.apply(this,[b]),Tmap.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var c={down:function(a){this.vertex=null;var b=this.layer.getFeatureFromEvent(this.handlers.drag.evt);b?this.dragStart(b):this.feature&&this.clickout&&this.unselectFeature(this.feature)},move:function(a){delete this._unselect,this.vertex&&this.dragVertex(this.vertex,a)},up:function(){this.handlers.drag.stopDown=!1,this._unselect&&(this.unselectFeature(this._unselect),delete this._unselect)},done:function(a){this.vertex&&this.dragComplete(this.vertex)}},d={documentDrag:this.documentDrag,stopDown:!1},e={keydown:this.handleKeypress};this.handlers={keyboard:new Tmap.Handler.Keyboard(this,e),drag:new Tmap.Handler.Drag(this,c,d)}},destroy:function(){this.layer=null,Tmap.Control.prototype.destroy.apply(this,[])},activate:function(){return this.handlers.keyboard.activate()&&this.handlers.drag.activate()&&Tmap.Control.prototype.activate.apply(this,arguments)},deactivate:function(){var a=!1;if(Tmap.Control.prototype.deactivate.apply(this,arguments)){this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.handlers.drag.deactivate(),this.handlers.keyboard.deactivate();var b=this.feature;b&&b.geometry&&b.layer&&this.unselectFeature(b),a=!0}return a},beforeSelectFeature:function(a){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:a})},selectFeature:function(a){if(!this.geometryTypes||-1!=Tmap.Util.indexOf(this.geometryTypes,a.geometry.CLASS_NAME)){this.standalone&&this.beforeSelectFeature(a)===!1||(this.feature&&this.unselectFeature(this.feature),this.feature=a,this.layer.selectedFeatures.push(a),this.layer.drawFeature(a,"select"),this.modified=!1,this.resetVertices(),this.onModificationStart(this.feature));var b=a.modified;!a.geometry||b&&b.geometry||(this._originalGeometry=a.geometry.clone())}},unselectFeature:function(a){this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[],this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle),this.layer.drawFeature(this.feature,"default"),this.feature=null,Tmap.Util.removeItem(this.layer.selectedFeatures,a),this.onModificationEnd(a),this.layer.events.triggerEvent("afterfeaturemodified",{feature:a,modified:this.modified}),this.modified=!1},dragStart:function(a){var b="Tmap.Geometry.Point"==a.geometry.CLASS_NAME;this.standalone||(a._sketch||!b)&&a._sketch||(this.toggle&&this.feature===a&&(this._unselect=a),this.selectFeature(a)),(a._sketch||b)&&(this.vertex=a,this.handlers.drag.stopDown=!0)},dragVertex:function(a,b){var c=this.map.getLonLatFromViewPortPx(b),d=a.geometry;d.move(c.lon-d.x,c.lat-d.y),this.modified=!0,"Tmap.Geometry.Point"==this.feature.geometry.CLASS_NAME?this.layer.events.triggerEvent("vertexmodified",{vertex:a.geometry,feature:this.feature,pixel:b}):(a._index?(a.geometry.parent.addComponent(a.geometry,a._index),delete a._index,Tmap.Util.removeItem(this.virtualVertices,a),this.vertices.push(a)):a==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):a!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:a.geometry,feature:this.feature,pixel:b}),this.virtualVertices.length>0&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:"select")),this.layer.drawFeature(a)},dragComplete:function(a){this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=Tmap.State.INSERT&&this.feature.state!=Tmap.State.DELETE&&(this.feature.state=Tmap.State.UPDATE,this.modified&&this._originalGeometry)){var a=this.feature;a.modified=Tmap.Util.extend(a.modified,{geometry:this._originalGeometry}),delete this._originalGeometry}},resetVertices:function(){this.vertices.length>0&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]),this.virtualVertices.length>0&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null),this.feature&&"Tmap.Geometry.Point"!=this.feature.geometry.CLASS_NAME&&(this.mode&Tmap.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(Tmap.Control.ModifyFeature.ROTATE|Tmap.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&Tmap.Control.ModifyFeature.RESHAPE&&(this.mode&Tmap.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(a){var b=a.keyCode;if(this.feature&&-1!=Tmap.Util.indexOf(this.deleteCodes,b)){var c=this.layer.getFeatureFromEvent(this.handlers.drag.evt);c&&-1!=Tmap.Util.indexOf(this.vertices,c)&&!this.handlers.drag.dragging&&c.geometry.parent&&(c.geometry.parent.removeComponent(c.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:c.geometry,feature:this.feature,pixel:a.xy}),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))}},collectVertices:function(){function a(c){var d,e,f,g;if("Tmap.Geometry.Point"==c.CLASS_NAME)e=new Tmap.Feature.Vector(c),e._sketch=!0,e.renderIntent=b.vertexRenderIntent,b.vertices.push(e);else{var h=c.components.length;for("Tmap.Geometry.LinearRing"==c.CLASS_NAME&&(h-=1),d=0;h>d;++d)f=c.components[d],"Tmap.Geometry.Point"==f.CLASS_NAME?(e=new Tmap.Feature.Vector(f),e._sketch=!0,e.renderIntent=b.vertexRenderIntent,b.vertices.push(e)):a(f);if(b.createVertices&&"Tmap.Geometry.MultiPoint"!=c.CLASS_NAME)for(d=0,g=c.components.length;g-1>d;++d){var i=c.components[d],j=c.components[d+1];if("Tmap.Geometry.Point"==i.CLASS_NAME&&"Tmap.Geometry.Point"==j.CLASS_NAME){var k=(i.x+j.x)/2,l=(i.y+j.y)/2,m=new Tmap.Feature.Vector(new Tmap.Geometry.Point(k,l),null,b.virtualStyle);m.geometry.parent=c,m._index=d+1,m._sketch=!0,b.virtualVertices.push(m)}}}}this.vertices=[],this.virtualVertices=[];var b=this;a.call(this,this.feature.geometry),this.layer.addFeatures(this.virtualVertices,{silent:!0}),this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var a=this.feature.geometry,b=a.getBounds().getCenterLonLat(),c=new Tmap.Geometry.Point(b.lon,b.lat),d=new Tmap.Feature.Vector(c);c.move=function(b,c){Tmap.Geometry.Point.prototype.move.call(this,b,c),a.move(b,c)},d._sketch=!0,this.dragHandle=d,this.dragHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var a=this.feature.geometry,b=a.getBounds(),c=b.getCenterLonLat(),d=new Tmap.Geometry.Point(c.lon,c.lat),e=new Tmap.Geometry.Point(b.right,b.bottom),f=new Tmap.Feature.Vector(e),g=this.mode&Tmap.Control.ModifyFeature.RESIZE,h=this.mode&Tmap.Control.ModifyFeature.RESHAPE,i=this.mode&Tmap.Control.ModifyFeature.ROTATE;e.move=function(b,c){Tmap.Geometry.Point.prototype.move.call(this,b,c);var e=this.x-d.x,f=this.y-d.y,j=e-b,k=f-c;if(i){var l=Math.atan2(k,j),m=Math.atan2(f,e),n=m-l;n*=180/Math.PI,a.rotate(n,d)}if(g){var o,p;if(h)o=f/k,p=e/j/o;else{var q=Math.sqrt(j*j+k*k),r=Math.sqrt(e*e+f*f);o=r/q}a.resize(o,d,p)}},f._sketch=!0,this.radiusHandle=f,this.radiusHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(a){this.handlers.drag.setMap(a),Tmap.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"Tmap.Control.ModifyFeature"}),Tmap.Control.ModifyFeature.RESHAPE=1,Tmap.Control.ModifyFeature.RESIZE=2,Tmap.Control.ModifyFeature.ROTATE=4,Tmap.Control.ModifyFeature.DRAG=8,Tmap.Control.Panel=Tmap.Class(Tmap.Control,{controls:null,autoActivate:!0,defaultControl:null,saveState:!1,allowDepress:!1,activeState:null,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,[a]),this.controls=[],this.activeState={}},destroy:function(){this.map&&this.map.events.unregister("buttonclick",this,this.onButtonClick),Tmap.Control.prototype.destroy.apply(this,arguments);for(var a,b=this.controls.length-1;b>=0;b--)a=this.controls[b],a.events&&a.events.un({activate:this.iconOn,deactivate:this.iconOff}),a.panel_div=null;this.activeState=null},activate:function(){if(Tmap.Control.prototype.activate.apply(this,arguments)){for(var a,b=0,c=this.controls.length;c>b;b++)a=this.controls[b],(a===this.defaultControl||this.saveState&&this.activeState[a.id])&&a.activate();return this.saveState===!0&&(this.defaultControl=null),this.redraw(),!0}return!1},deactivate:function(){if(Tmap.Control.prototype.deactivate.apply(this,arguments)){for(var a,b=0,c=this.controls.length;c>b;b++)a=this.controls[b],this.activeState[a.id]=a.deactivate();return this.redraw(),!0}return!1},draw:function(){return Tmap.Control.prototype.draw.apply(this,arguments),this.outsideViewport?(this.events.attachToElement(this.div),this.events.register("buttonclick",this,this.onButtonClick)):this.map.events.register("buttonclick",this,this.onButtonClick),this.addControlsToMap(this.controls),this.div},redraw:function(){for(var a=this.div.childNodes.length,b=a-1;b>=0;b--)this.div.removeChild(this.div.childNodes[b]);if(this.div.innerHTML="",this.active)for(var b=0,c=this.controls.length;c>b;b++)this.div.appendChild(this.controls[b].panel_div)},activateControl:function(a){if(!this.active)return!1;if(a.type==Tmap.Control.TYPE_BUTTON)return void a.trigger();if(a.type==Tmap.Control.TYPE_TOGGLE)return void(a.active?a.deactivate():a.activate());if(this.allowDepress&&a.active)a.deactivate();else{for(var b,c=0,d=this.controls.length;d>c;c++)b=this.controls[c],b==a||b.type!==Tmap.Control.TYPE_TOOL&&null!=b.type||b.deactivate();a.activate()}},addControls:function(a){Tmap.Util.isArray(a)||(a=[a]),this.controls=this.controls.concat(a);for(var b=0,c=a.length;c>b;b++){var d=a[b],e=this.createControlMarkup(d);Tmap.Element.addClass(e,d.displayClass+"ItemInactive"),Tmap.Element.addClass(e,"tmButton"),""==d.title||e.title||(e.title=d.title),d.panel_div=e}this.map&&(this.addControlsToMap(a),this.redraw())},createControlMarkup:function(a){return document.createElement("div")},addControlsToMap:function(a){for(var b,c=0,d=a.length;d>c;c++)b=a[c],b.autoActivate===!0?(b.autoActivate=!1,this.map.addControl(b),b.autoActivate=!0):(this.map.addControl(b),b.deactivate()),b.events.on({activate:this.iconOn,deactivate:this.iconOff})},iconOn:function(){var a=this.panel_div,b=new RegExp("\\b("+this.displayClass+"Item)Inactive\\b");a.className=a.className.replace(b,"$1Active")},iconOff:function(){var a=this.panel_div,b=new RegExp("\\b("+this.displayClass+"Item)Active\\b");a.className=a.className.replace(b,"$1Inactive")},onButtonClick:function(a){for(var b=this.controls,c=a.buttonElement,d=b.length-1;d>=0;--d)if(b[d].panel_div===c){this.activateControl(b[d]);break}},getControlsBy:function(a,b){var c="function"==typeof b.test,d=Tmap.Array.filter(this.controls,function(d){return d[a]==b||c&&b.test(d[a])});return d},getControlsByName:function(a){return this.getControlsBy("name",a)},getControlsByClass:function(a){return this.getControlsBy("CLASS_NAME",a)},CLASS_NAME:"Tmap.Control.Panel"}),Tmap.Control.SelectFeature=Tmap.Class(Tmap.Control,{multipleKey:null,toggleKey:null,multiple:!1,clickout:!0,toggle:!1,hover:!1,highlightOnly:!1,box:!1,onBeforeSelect:function(){},onSelect:function(){},onUnselect:function(){},scope:null,geometryTypes:null,layer:null,layers:null,callbacks:null,selectStyle:null,renderIntent:"select",handlers:null,initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]),null===this.scope&&(this.scope=this),this.initLayer(a);var c={click:this.clickFeature,clickout:this.clickoutFeature};this.hover&&(c.over=this.overFeature,c.out=this.outFeature),this.callbacks=Tmap.Util.extend(c,this.callbacks),this.handlers={feature:new Tmap.Handler.Feature(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})},this.box&&(this.handlers.box=new Tmap.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"tmHandlerBoxSelectFeature"}))},initLayer:function(a){Tmap.Util.isArray(a)?(this.layers=a,this.layer=new Tmap.Layer.Vector.RootContainer(this.id+"_container",{layers:a})):this.layer=a},destroy:function(){this.active&&this.layers&&this.map.removeLayer(this.layer),Tmap.Control.prototype.destroy.apply(this,arguments),this.layers&&this.layer.destroy()},activate:function(){return this.active||(this.layers&&this.map.addLayer(this.layer),this.handlers.feature.activate(),this.box&&this.handlers.box&&this.handlers.box.activate()),Tmap.Control.prototype.activate.apply(this,arguments)},deactivate:function(){return this.active&&(this.handlers.feature.deactivate(),this.handlers.box&&this.handlers.box.deactivate(),this.layers&&this.map.removeLayer(this.layer)),Tmap.Control.prototype.deactivate.apply(this,arguments)},unselectAll:function(a){var b,c,d,e,f=this.layers||[this.layer];for(d=0;d<f.length;++d)if(b=f[d],e=0,null!=b.selectedFeatures)for(;b.selectedFeatures.length>e;)c=b.selectedFeatures[e],a&&a.except==c?++e:this.unselect(c)},clickFeature:function(a){if(!this.hover){var b=Tmap.Util.indexOf(a.layer.selectedFeatures,a)>-1;b?this.toggleSelect()?this.unselect(a):this.multipleSelect()||this.unselectAll({except:a}):(this.multipleSelect()||this.unselectAll({except:a}),this.select(a))}},multipleSelect:function(){return this.multiple||this.handlers.feature.evt&&this.handlers.feature.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handlers.feature.evt&&this.handlers.feature.evt[this.toggleKey]},clickoutFeature:function(a){!this.hover&&this.clickout&&this.unselectAll()},overFeature:function(a){var b=a.layer;this.hover&&(this.highlightOnly?this.highlight(a):-1==Tmap.Util.indexOf(b.selectedFeatures,a)&&this.select(a))},outFeature:function(a){if(this.hover)if(this.highlightOnly){if(a._lastHighlighter==this.id)if(a._prevHighlighter&&a._prevHighlighter!=this.id){delete a._lastHighlighter;var b=this.map.getControl(a._prevHighlighter);b&&b.highlight(a)}else this.unhighlight(a)}else this.unselect(a)},highlight:function(a){var b=a.layer,c=this.events.triggerEvent("beforefeaturehighlighted",{
feature:a});if(c!==!1){a._prevHighlighter=a._lastHighlighter,a._lastHighlighter=this.id;var d=this.selectStyle||this.renderIntent;b.drawFeature(a,d),this.events.triggerEvent("featurehighlighted",{feature:a})}},unhighlight:function(a){var b=a.layer;void 0==a._prevHighlighter?delete a._lastHighlighter:a._prevHighlighter==this.id?delete a._prevHighlighter:(a._lastHighlighter=a._prevHighlighter,delete a._prevHighlighter),b.drawFeature(a,a.style||a.layer.style||"default"),this.events.triggerEvent("featureunhighlighted",{feature:a})},select:function(a){var b=this.onBeforeSelect.call(this.scope,a),c=a.layer;b!==!1&&(b=c.events.triggerEvent("beforefeatureselected",{feature:a}),b!==!1&&(c.selectedFeatures.push(a),this.highlight(a),this.handlers.feature.lastFeature||(this.handlers.feature.lastFeature=c.selectedFeatures[0]),c.events.triggerEvent("featureselected",{feature:a}),this.onSelect.call(this.scope,a)))},unselect:function(a){var b=a.layer;this.unhighlight(a),Tmap.Util.removeItem(b.selectedFeatures,a),b.events.triggerEvent("featureunselected",{feature:a}),this.onUnselect.call(this.scope,a)},selectBox:function(a){if(a instanceof Tmap.Bounds){var b=this.map.getLonLatFromPixel({x:a.left,y:a.bottom}),c=this.map.getLonLatFromPixel({x:a.right,y:a.top}),d=new Tmap.Bounds(b.lon,b.lat,c.lon,c.lat);this.multipleSelect()||this.unselectAll();var e=this.multiple;this.multiple=!0;var f=this.layers||[this.layer];this.events.triggerEvent("boxselectionstart",{layers:f});for(var g,h=0;h<f.length;++h){g=f[h];for(var i=0,j=g.features.length;j>i;++i){var k=g.features[i];k.getVisibility()&&(null==this.geometryTypes||Tmap.Util.indexOf(this.geometryTypes,k.geometry.CLASS_NAME)>-1)&&d.toGeometry().intersects(k.geometry)&&-1==Tmap.Util.indexOf(g.selectedFeatures,k)&&this.select(k)}}this.multiple=e,this.events.triggerEvent("boxselectionend",{layers:f})}},setMap:function(a){this.handlers.feature.setMap(a),this.box&&this.handlers.box.setMap(a),Tmap.Control.prototype.setMap.apply(this,arguments)},setLayer:function(a){var b=this.active;this.unselectAll(),this.deactivate(),this.layers&&(this.layer.destroy(),this.layers=null),this.initLayer(a),this.handlers.feature.layer=this.layer,b&&this.activate()},CLASS_NAME:"Tmap.Control.SelectFeature"}),Tmap.Control.NavigationHistory=Tmap.Class(Tmap.Control,{type:Tmap.Control.TYPE_TOGGLE,previous:null,previousOptions:null,next:null,nextOptions:null,limit:50,autoActivate:!0,clearOnDeactivate:!1,registry:null,nextStack:null,previousStack:null,listeners:null,restoring:!1,initialize:function(a){Tmap.Control.prototype.initialize.apply(this,[a]),this.registry=Tmap.Util.extend({moveend:this.getState},this.registry);var b={trigger:Tmap.Function.bind(this.previousTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Previous"};Tmap.Util.extend(b,this.previousOptions),this.previous=new Tmap.Control.Button(b);var c={trigger:Tmap.Function.bind(this.nextTrigger,this),displayClass:this.displayClass+" "+this.displayClass+"Next"};Tmap.Util.extend(c,this.nextOptions),this.next=new Tmap.Control.Button(c),this.clear()},onPreviousChange:function(a,b){a&&!this.previous.active?this.previous.activate():!a&&this.previous.active&&this.previous.deactivate()},onNextChange:function(a,b){a&&!this.next.active?this.next.activate():!a&&this.next.active&&this.next.deactivate()},destroy:function(){Tmap.Control.prototype.destroy.apply(this),this.previous.destroy(),this.next.destroy(),this.deactivate();for(var a in this)this[a]=null},setMap:function(a){this.map=a,this.next.setMap(a),this.previous.setMap(a)},draw:function(){Tmap.Control.prototype.draw.apply(this,arguments),this.next.draw(),this.previous.draw()},previousTrigger:function(){var a=this.previousStack.shift(),b=this.previousStack.shift();return void 0!=b?(this.nextStack.unshift(a),this.previousStack.unshift(b),this.restoring=!0,this.restore(b),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)):this.previousStack.unshift(a),b},nextTrigger:function(){var a=this.nextStack.shift();return void 0!=a&&(this.previousStack.unshift(a),this.restoring=!0,this.restore(a),this.restoring=!1,this.onNextChange(this.nextStack[0],this.nextStack.length),this.onPreviousChange(this.previousStack[1],this.previousStack.length-1)),a},clear:function(){this.previousStack=[],this.previous.deactivate(),this.nextStack=[],this.next.deactivate()},getState:function(){return{center:this.map.getCenter(),resolution:this.map.getResolution(),projection:this.map.getProjectionObject(),units:this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units}},restore:function(a){var b,c;if(this.map.getProjectionObject()==a.projection)c=this.map.getZoomForResolution(a.resolution),b=a.center;else{b=a.center.clone(),b.transform(a.projection,this.map.getProjectionObject());var d=a.units,e=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,f=d&&e?Tmap.INCHES_PER_UNIT[d]/Tmap.INCHES_PER_UNIT[e]:1;c=this.map.getZoomForResolution(f*a.resolution)}this.map.setCenter(b,c)},setListeners:function(){this.listeners={};for(var a in this.registry)this.listeners[a]=Tmap.Function.bind(function(){if(!this.restoring){var b=this.registry[a].apply(this,arguments);this.previousStack.unshift(b),this.previousStack.length>1&&this.onPreviousChange(this.previousStack[1],this.previousStack.length-1),this.previousStack.length>this.limit+1&&this.previousStack.pop(),this.nextStack.length>0&&(this.nextStack=[],this.onNextChange(null,0))}return!0},this)},activate:function(){var a=!1;if(this.map&&Tmap.Control.prototype.activate.apply(this)){null==this.listeners&&this.setListeners();for(var b in this.listeners)this.map.events.register(b,this,this.listeners[b]);a=!0,0==this.previousStack.length&&this.initStack()}return a},initStack:function(){this.map.getCenter()&&this.listeners.moveend()},deactivate:function(){var a=!1;if(this.map&&Tmap.Control.prototype.deactivate.apply(this)){for(var b in this.listeners)this.map.events.unregister(b,this,this.listeners[b]);this.clearOnDeactivate&&this.clear(),a=!0}return a},CLASS_NAME:"Tmap.Control.NavigationHistory"}),Tmap.Control.Measure=Tmap.Class(Tmap.Control,{callbacks:null,displaySystem:"metric",geodesic:!1,displaySystemUnits:{geographic:["dd"],english:["mi","ft","in"],metric:["km","m"]},partialDelay:300,delayedTrigger:null,persist:!1,immediate:!1,initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]);var c={done:this.measureComplete,point:this.measurePartial};this.immediate&&(c.modify=this.measureImmediate),this.callbacks=Tmap.Util.extend(c,this.callbacks),this.handlerOptions=Tmap.Util.extend({persist:this.persist},this.handlerOptions),this.handler=new a(this,this.callbacks,this.handlerOptions)},deactivate:function(){return this.cancelDelay(),Tmap.Control.prototype.deactivate.apply(this,arguments)},cancel:function(){this.cancelDelay(),this.handler.cancel()},setImmediate:function(a){this.immediate=a,this.immediate?this.callbacks.modify=this.measureImmediate:delete this.callbacks.modify},updateHandler:function(a,b){var c=this.active;c&&this.deactivate(),this.handler=new a(this,this.callbacks,b),c&&this.activate()},measureComplete:function(a){this.cancelDelay(),this.measure(a,"measure")},measurePartial:function(a,b){this.cancelDelay(),b=b.clone(),this.handler.freehandMode(this.handler.evt)?this.measure(b,"measurepartial"):this.delayedTrigger=window.setTimeout(Tmap.Function.bind(function(){this.delayedTrigger=null,this.measure(b,"measurepartial")},this),this.partialDelay)},measureImmediate:function(a,b,c){c&&!this.handler.freehandMode(this.handler.evt)&&(this.cancelDelay(),this.measure(b.geometry,"measurepartial"))},cancelDelay:function(){null!==this.delayedTrigger&&(window.clearTimeout(this.delayedTrigger),this.delayedTrigger=null)},measure:function(a,b){var c,d;a.CLASS_NAME.indexOf("LineString")>-1?(c=this.getBestLength(a),d=1):(c=this.getBestArea(a),d=2),this.events.triggerEvent(b,{measure:c[0],units:c[1],order:d,geometry:a})},getBestArea:function(a){for(var b,c,d=this.displaySystemUnits[this.displaySystem],e=0,f=d.length;f>e&&(b=d[e],c=this.getArea(a,b),!(c>1));++e);return[c,b]},getArea:function(a,b){var c,d;this.geodesic?(c=a.getGeodesicArea(this.map.getProjectionObject()),d="m"):(c=a.getArea(),d=this.map.getUnits());var e=Tmap.INCHES_PER_UNIT[b];if(e){var f=Tmap.INCHES_PER_UNIT[d];c*=Math.pow(f/e,2)}return c},getBestLength:function(a){for(var b,c,d=this.displaySystemUnits[this.displaySystem],e=0,f=d.length;f>e&&(b=d[e],c=this.getLength(a,b),!(c>1));++e);return[c,b]},getLength:function(a,b){var c,d;this.geodesic?(c=a.getGeodesicLength(this.map.getProjectionObject()),d="m"):(c=a.getLength(),d=this.map.getUnits());var e=Tmap.INCHES_PER_UNIT[b];if(e){var f=Tmap.INCHES_PER_UNIT[d];c*=f/e}return c},CLASS_NAME:"Tmap.Control.Measure"}),Tmap.Control.WMSGetFeatureInfo=Tmap.Class(Tmap.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,initialize:function(a){if(a=a||{},a.handlerOptions=a.handlerOptions||{},Tmap.Control.prototype.initialize.apply(this,[a]),this.format||(this.format=new Tmap.Format.WMSGetFeatureInfo(a.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new Tmap.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},Tmap.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var b={};b[this.clickCallback]=this.getInfoForClick,this.handler=new Tmap.Handler.Click(this,b,this.handlerOptions.click||{})}},getInfoForClick:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy}),Tmap.Element.addClass(this.map.viewPortDiv,"tmCursorWait"),this.request(a.xy,{})},getInfoForHover:function(a){this.events.triggerEvent("beforegetfeatureinfo",{xy:a.xy}),this.request(a.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var a,b,c=this.layers||this.map.layers,d=[],e=c.length-1;e>=0;--e)a=c[e],a instanceof Tmap.Layer.WMS&&(!this.queryVisible||a.getVisibility())&&(b=Tmap.Util.isArray(a.url)?a.url[0]:a.url,this.drillDown!==!1||this.url||(this.url=b),(this.drillDown===!0||this.urlMatches(b))&&d.push(a));return d},urlMatches:function(a){var b=Tmap.Util.isEquivalentUrl(this.url,a);if(!b&&this.layerUrls)for(var c=0,d=this.layerUrls.length;d>c;++c)if(Tmap.Util.isEquivalentUrl(this.layerUrls[c],a)){b=!0;break}return b},buildWMSOptions:function(a,b,c,d){for(var e=[],f=[],g=0,h=b.length;h>g;g++)null!=b[g].params.LAYERS&&(e=e.concat(b[g].params.LAYERS),f=f.concat(this.getStyleNames(b[g])));var i=b[0],j=this.map.getProjection(),k=i.projection;k&&k.equals(this.map.getProjectionObject())&&(j=k.getCode());var l=Tmap.Util.extend({service:"WMS",version:i.params.VERSION,request:"GetFeatureInfo",exceptions:i.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,i.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:d,info_format:i.params.INFO_FORMAT||this.infoFormat},parseFloat(i.params.VERSION)>=1.3?{crs:j,i:parseInt(c.x),j:parseInt(c.y)}:{srs:j,x:parseInt(c.x),y:parseInt(c.y)});return 0!=e.length&&(l=Tmap.Util.extend({layers:e,query_layers:e,styles:f},l)),Tmap.Util.applyDefaults(l,this.vendorParams),{url:a,params:Tmap.Util.upperCaseObject(l),callback:function(b){this.handleResponse(c,b,a)},scope:this}},getStyleNames:function(a){var b;return b=a.params.STYLES?a.params.STYLES:Tmap.Util.isArray(a.params.LAYERS)?new Array(a.params.LAYERS.length):a.params.LAYERS.replace(/[^,]/g,"")},request:function(a,b){var c=this.findLayers();if(0==c.length)return this.events.triggerEvent("nogetfeatureinfo"),void Tmap.Element.removeClass(this.map.viewPortDiv,"tmCursorWait");if(b=b||{},this.drillDown===!1){var d=this.buildWMSOptions(this.url,c,a,c[0].params.FORMAT),e=Tmap.Request.GET(d);b.hover===!0&&(this.hoverRequest=e)}else{this._requestCount=0,this._numRequests=0,this.features=[];for(var f,g={},h=0,i=c.length;i>h;h++){var j=c[h];f=Tmap.Util.isArray(j.url)?j.url[0]:j.url,f in g?g[f].push(j):(this._numRequests++,g[f]=[j])}var c;for(var f in g){c=g[f];var d=this.buildWMSOptions(f,c,a,c[0].params.FORMAT);Tmap.Request.GET(d)}}},triggerGetFeatureInfo:function(a,b,c){this.events.triggerEvent("getfeatureinfo",{text:a.responseText,features:c,request:a,xy:b}),Tmap.Element.removeClass(this.map.viewPortDiv,"tmCursorWait")},handleResponse:function(a,b,c){var d=b.responseXML;d&&d.documentElement||(d=b.responseText);var e=this.format.read(d);this.drillDown===!1?this.triggerGetFeatureInfo(b,a,e):(this._requestCount++,"object"===this.output?this._features=(this._features||[]).concat({url:c,features:e}):this._features=(this._features||[]).concat(e),this._requestCount===this._numRequests&&(this.triggerGetFeatureInfo(b,a,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"Tmap.Control.WMSGetFeatureInfo"}),Tmap.Control.WMTSGetFeatureInfo=Tmap.Class(Tmap.Control,{hover:!1,requestEncoding:"KVP",drillDown:!1,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:!0,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,pending:0,initialize:function(a){if(a=a||{},a.handlerOptions=a.handlerOptions||{},Tmap.Control.prototype.initialize.apply(this,[a]),this.format||(this.format=new Tmap.Format.WMSGetFeatureInfo(a.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new Tmap.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},Tmap.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var b={};b[this.clickCallback]=this.getInfoForClick,this.handler=new Tmap.Handler.Click(this,b,this.handlerOptions.click||{})}},getInfoForClick:function(a){this.request(a.xy,{})},getInfoForHover:function(a){this.request(a.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(--this.pending,this.pending<=0&&(Tmap.Element.removeClass(this.map.viewPortDiv,"tmCursorWait"),this.pending=0),this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var a,b=this.layers||this.map.layers,c=[],d=b.length-1;d>=0&&(a=b[d],!(a instanceof Tmap.Layer.WMTS&&a.requestEncoding===this.requestEncoding)||this.queryVisible&&!a.getVisibility()||(c.push(a),this.drillDown&&!this.hover));--d);return c},buildRequestOptions:function(a,b){var c=this.map.getLonLatFromPixel(b),d=a.getURL(new Tmap.Bounds(c.lon,c.lat,c.lon,c.lat)),e=Tmap.Util.getParameters(d),f=a.getTileInfo(c);return Tmap.Util.extend(e,{service:"WMTS",version:a.version,request:"GetFeatureInfo",infoFormat:this.infoFormat,i:f.i,j:f.j}),Tmap.Util.applyDefaults(e,this.vendorParams),{url:Tmap.Util.isArray(a.url)?a.url[0]:a.url,params:Tmap.Util.upperCaseObject(e),callback:function(c){this.handleResponse(b,c,a)},scope:this}},request:function(a,b){b=b||{};var c=this.findLayers();if(c.length>0){for(var d,e,f=0,g=c.length;g>f;f++)if(e=c[f],d=this.events.triggerEvent("beforegetfeatureinfo",{xy:a,layer:e}),d!==!1){++this.pending;var h=this.buildRequestOptions(e,a),i=Tmap.Request.GET(h);b.hover===!0&&(this.hoverRequest=i)}this.pending>0&&Tmap.Element.addClass(this.map.viewPortDiv,"tmCursorWait")}},handleResponse:function(a,b,c){if(--this.pending,this.pending<=0&&(Tmap.Element.removeClass(this.map.viewPortDiv,"tmCursorWait"),this.pending=0),b.status&&(b.status<200||b.status>=300))this.events.triggerEvent("exception",{xy:a,request:b,layer:c});else{var d=b.responseXML;d&&d.documentElement||(d=b.responseText);var e,f;try{e=this.format.read(d)}catch(g){f=!0,this.events.triggerEvent("exception",{xy:a,request:b,error:g,layer:c})}f||this.events.triggerEvent("getfeatureinfo",{text:b.responseText,features:e,request:b,xy:a,layer:c})}},CLASS_NAME:"Tmap.Control.WMTSGetFeatureInfo"}),Tmap.Control.Graticule=Tmap.Class(Tmap.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:.5},labelSymbolizer:{},gratLayer:null,initialize:function(a){a=a||{},a.layerName=a.layerName||Tmap.i18n("Graticule"),Tmap.Control.prototype.initialize.apply(this,[a]),this.labelSymbolizer.stroke=!1,this.labelSymbolizer.fill=!1,this.labelSymbolizer.label="${label}",this.labelSymbolizer.labelAlign="${labelAlign}",this.labelSymbolizer.labelXOffset="${xOffset}",this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate(),Tmap.Control.prototype.destroy.apply(this,arguments),this.gratLayer&&(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){if(Tmap.Control.prototype.draw.apply(this,arguments),!this.gratLayer){var a=new Tmap.Style({},{rules:[new Tmap.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new Tmap.Layer.Vector(this.layerName,{styleMap:new Tmap.StyleMap({"default":a}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return Tmap.Control.prototype.activate.apply(this,arguments)?(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0):!1},deactivate:function(){return Tmap.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0):!1},update:function(){var a=this.map.getExtent();if(a){this.gratLayer.destroyFeatures();var b=new Tmap.Projection("EPSG:4326"),c=this.map.getProjectionObject(),d=this.map.getResolution();c.proj&&"longlat"==c.proj.projName&&(this.numPoints=1);var e=this.map.getCenter(),f=new Tmap.Pixel(e.lon,e.lat);Tmap.Projection.transform(f,c,b);var g=this.targetSize*d;g*=g;for(var h,i=0;i<this.intervals.length;++i){h=this.intervals[i];var j=h/2,k=f.offset({x:-j,y:-j}),l=f.offset({x:j,y:j});Tmap.Projection.transform(k,b,c),Tmap.Projection.transform(l,b,c);var m=(k.x-l.x)*(k.x-l.x)+(k.y-l.y)*(k.y-l.y);if(g>=m)break}f.x=Math.floor(f.x/h)*h,f.y=Math.floor(f.y/h)*h;var n,o=0,p=[f.clone()],q=f.clone();do q=q.offset({x:0,y:h}),n=Tmap.Projection.transform(q.clone(),b,c),p.unshift(q);while(a.containsPixel(n)&&++o<1e3);q=f.clone();do q=q.offset({x:0,y:-h}),n=Tmap.Projection.transform(q.clone(),b,c),p.push(q);while(a.containsPixel(n)&&++o<1e3);o=0;var r=[f.clone()];q=f.clone();do q=q.offset({x:-h,y:0}),n=Tmap.Projection.transform(q.clone(),b,c),r.unshift(q);while(a.containsPixel(n)&&++o<1e3);q=f.clone();do q=q.offset({x:h,y:0}),n=Tmap.Projection.transform(q.clone(),b,c),r.push(q);while(a.containsPixel(n)&&++o<1e3);for(var s=[],i=0;i<r.length;++i){for(var t=r[i].x,u=[],v=null,w=Math.min(p[0].y,90),x=Math.max(p[p.length-1].y,-90),y=(w-x)/this.numPoints,z=x,A=0;A<=this.numPoints;++A){var B=new Tmap.Geometry.Point(t,z);B.transform(b,c),u.push(B),z+=y,B.y>=a.bottom&&!v&&(v=B)}if(this.labelled){var C=new Tmap.Geometry.Point(v.x,a.bottom),D={value:t,label:this.labelled?Tmap.Util.getFormattedLonLat(t,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new Tmap.Feature.Vector(C,D))}var E=new Tmap.Geometry.LineString(u);s.push(new Tmap.Feature.Vector(E))}for(var A=0;A<p.length;++A)if(z=p[A].y,!(-90>z||z>90)){for(var u=[],F=r[0].x,G=r[r.length-1].x,H=(G-F)/this.numPoints,t=F,v=null,i=0;i<=this.numPoints;++i){var B=new Tmap.Geometry.Point(t,z);B.transform(b,c),u.push(B),t+=H,B.x<a.right&&(v=B)}if(this.labelled){var C=new Tmap.Geometry.Point(a.right,v.y),D={value:z,label:this.labelled?Tmap.Util.getFormattedLonLat(z,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new Tmap.Feature.Vector(C,D))}var E=new Tmap.Geometry.LineString(u);s.push(new Tmap.Feature.Vector(E))}this.gratLayer.addFeatures(s)}},CLASS_NAME:"Tmap.Control.Graticule"}),Tmap.Control.TransformFeature=Tmap.Class(Tmap.Control,{geometryTypes:null,layer:null,preserveAspectRatio:!1,rotate:!0,feature:null,renderIntent:"temporary",rotationHandleSymbolizer:null,box:null,center:null,scale:1,ratio:1,rotation:0,handles:null,rotationHandles:null,dragControl:null,irregular:!1,initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]),this.layer=a,this.rotationHandleSymbolizer||(this.rotationHandleSymbolizer={stroke:!1,pointRadius:10,fillOpacity:0,cursor:"pointer"}),this.createBox(),this.createControl()},activate:function(){var a=!1;return Tmap.Control.prototype.activate.apply(this,arguments)&&(this.dragControl.activate(),this.layer.addFeatures([this.box]),this.rotate&&this.layer.addFeatures(this.rotationHandles),this.layer.addFeatures(this.handles),a=!0),a},deactivate:function(){var a=!1;return Tmap.Control.prototype.deactivate.apply(this,arguments)&&(this.layer.removeFeatures(this.handles),this.rotate&&this.layer.removeFeatures(this.rotationHandles),this.layer.removeFeatures([this.box]),this.dragControl.deactivate(),a=!0),a},setMap:function(a){this.dragControl.setMap(a),Tmap.Control.prototype.setMap.apply(this,arguments)},setFeature:function(a,b){b=Tmap.Util.applyDefaults(b,{rotation:0,scale:1,ratio:1});var c=this.rotation,d=this.center;Tmap.Util.extend(this,b);var e=this.events.triggerEvent("beforesetfeature",{feature:a});if(e!==!1){this.feature=a,this.activate(),this._setfeature=!0;var f=this.feature.geometry.getBounds();this.box.move(f.getCenterLonLat()),this.box.geometry.rotate(-c,d),this._angle=0;var g;if(this.rotation){var h=a.geometry.clone();h.rotate(-this.rotation,this.center);var i=new Tmap.Feature.Vector(h.getBounds().toGeometry());i.geometry.rotate(this.rotation,this.center),this.box.geometry.rotate(this.rotation,this.center),this.box.move(i.geometry.getBounds().getCenterLonLat());var j=i.geometry.components[0].components[0];g=j.getBounds().getCenterLonLat()}else g=new Tmap.LonLat(f.left,f.bottom);this.handles[0].move(g),delete this._setfeature,this.events.triggerEvent("setfeature",{feature:a})}},unsetFeature:function(){this.active?this.deactivate():(this.feature=null,this.rotation=0,this.scale=1,this.ratio=1)},createBox:function(){var a=this;this.center=new Tmap.Geometry.Point(0,0),this.box=new Tmap.Feature.Vector(new Tmap.Geometry.LineString([new Tmap.Geometry.Point(-1,-1),new Tmap.Geometry.Point(0,-1),new Tmap.Geometry.Point(1,-1),new Tmap.Geometry.Point(1,0),new Tmap.Geometry.Point(1,1),new Tmap.Geometry.Point(0,1),new Tmap.Geometry.Point(-1,1),new Tmap.Geometry.Point(-1,0),new Tmap.Geometry.Point(-1,-1)]),null,"string"==typeof this.renderIntent?null:this.renderIntent),this.box.geometry.move=function(b,c){a._moving=!0,Tmap.Geometry.LineString.prototype.move.apply(this,arguments),a.center.move(b,c),delete a._moving};for(var b,c,d,e=function(a,b){Tmap.Geometry.Point.prototype.move.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.move(a,b),this._handle.geometry.move(a,b)},f=function(a,b,c){Tmap.Geometry.Point.prototype.resize.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.resize(a,b,c),this._handle.geometry.resize(a,b,c)},g=function(a,b){Tmap.Geometry.Point.prototype.rotate.apply(this,arguments),this._rotationHandle&&this._rotationHandle.geometry.rotate(a,b),this._handle.geometry.rotate(a,b)},h=function(b,c){var d=this.x,e=this.y;if(Tmap.Geometry.Point.prototype.move.call(this,b,c),!a._moving){var f=a.dragControl.handlers.drag.evt,g=!a._setfeature&&a.preserveAspectRatio,h=!(g||f&&f.shiftKey),i=new Tmap.Geometry.Point(d,e),j=a.center;this.rotate(-a.rotation,j),i.rotate(-a.rotation,j);var k=this.x-j.x,l=this.y-j.y,m=k-(this.x-i.x),n=l-(this.y-i.y);a.irregular&&!a._setfeature&&(k-=(this.x-i.x)/2,l-=(this.y-i.y)/2),this.x=d,this.y=e;var o,p=1;if(h)o=Math.abs(n)<1e-5?1:l/n,p=(Math.abs(m)<1e-5?1:k/m)/o;else{var q=Math.sqrt(m*m+n*n),r=Math.sqrt(k*k+l*l);o=r/q}if(a._moving=!0,a.box.geometry.rotate(-a.rotation,j),delete a._moving,a.box.geometry.resize(o,j,p),a.box.geometry.rotate(a.rotation,j),a.transformFeature({scale:o,ratio:p}),a.irregular&&!a._setfeature){var s=j.clone();s.x+=Math.abs(d-j.x)<1e-5?0:this.x-d,s.y+=Math.abs(e-j.y)<1e-5?0:this.y-e,a.box.geometry.move(this.x-d,this.y-e),a.transformFeature({center:s})}}},i=function(b,c){var d=this.x,e=this.y;if(Tmap.Geometry.Point.prototype.move.call(this,b,c),!a._moving){var f=a.dragControl.handlers.drag.evt,g=f&&f.shiftKey?45:1,h=a.center,i=this.x-h.x,j=this.y-h.y,k=i-b,l=j-c;this.x=d,this.y=e;var m=Math.atan2(l,k),n=Math.atan2(j,i),o=n-m;o*=180/Math.PI,a._angle=(a._angle+o)%360;var p=a.rotation%g;(Math.abs(a._angle)>=g||0!==p)&&(o=Math.round(a._angle/g)*g-p,a._angle=0,a.box.geometry.rotate(o,h),a.transformFeature({rotation:o}))}},j=new Array(8),k=new Array(4),l=["sw","s","se","e","ne","n","nw","w"],m=0;8>m;++m)b=this.box.geometry.components[m],c=new Tmap.Feature.Vector(b.clone(),{role:l[m]+"-resize"},"string"==typeof this.renderIntent?null:this.renderIntent),m%2==0&&(d=new Tmap.Feature.Vector(b.clone(),{role:l[m]+"-rotate"},"string"==typeof this.rotationHandleSymbolizer?null:this.rotationHandleSymbolizer),d.geometry.move=i,b._rotationHandle=d,k[m/2]=d),b.move=e,b.resize=f,b.rotate=g,c.geometry.move=h,b._handle=c,j[m]=c;this.rotationHandles=k,this.handles=j},createControl:function(){var a=this;this.dragControl=new Tmap.Control.DragFeature(this.layer,{documentDrag:!0,moveFeature:function(b){this.feature===a.feature&&(this.feature=a.box),Tmap.Control.DragFeature.prototype.moveFeature.apply(this,arguments)},onDrag:function(b,c){b===a.box&&a.transformFeature({center:a.center})},onStart:function(b,c){var d=!a.geometryTypes||-1!==Tmap.Util.indexOf(a.geometryTypes,b.geometry.CLASS_NAME),e=Tmap.Util.indexOf(a.handles,b);e+=Tmap.Util.indexOf(a.rotationHandles,b),b!==a.feature&&b!==a.box&&-2==e&&d&&a.setFeature(b)},onComplete:function(b,c){a.events.triggerEvent("transformcomplete",{feature:a.feature})}})},drawHandles:function(){for(var a=this.layer,b=0;8>b;++b)this.rotate&&b%2===0&&a.drawFeature(this.rotationHandles[b/2],this.rotationHandleSymbolizer),a.drawFeature(this.handles[b],this.renderIntent)},transformFeature:function(a){if(!this._setfeature){this.scale*=a.scale||1,this.ratio*=a.ratio||1;var b=this.rotation;if(this.rotation=(this.rotation+(a.rotation||0))%360,this.events.triggerEvent("beforetransform",a)!==!1){var c=this.feature,d=c.geometry,e=this.center;d.rotate(-b,e),a.scale||a.ratio?d.resize(a.scale,e,a.ratio):a.center&&c.move(a.center.getBounds().getCenterLonLat()),d.rotate(this.rotation,e),this.layer.drawFeature(c),c.toState(Tmap.State.UPDATE),this.events.triggerEvent("transform",a)}}this.layer.drawFeature(this.box,this.renderIntent),this.drawHandles()},destroy:function(){for(var a,b=0;8>b;++b)a=this.box.geometry.components[b],a._handle.destroy(),a._handle=null,a._rotationHandle&&a._rotationHandle.destroy(),a._rotationHandle=null;this.center=null,this.feature=null,this.handles=null,this.rotationHandleSymbolizer=null,this.rotationHandles=null,this.box.destroy(),this.box=null,this.layer=null,this.dragControl.destroy(),this.dragControl=null,Tmap.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"Tmap.Control.TransformFeature"}),Tmap.Control.UTFGrid=Tmap.Class(Tmap.Control,{autoActivate:!0,layers:null,defaultHandlerOptions:{delay:300,pixelTolerance:4,stopMove:!1,single:!0,"double":!1,stopSingle:!1,stopDouble:!1},handlerMode:"click",setHandler:function(a){this.handlerMode=a,this.resetHandler()},resetHandler:function(){return this.handler&&(this.handler.deactivate(),this.handler.destroy(),this.handler=null),"hover"==this.handlerMode?this.handler=new Tmap.Handler.Hover(this,{pause:this.handleEvent,move:this.reset},this.handlerOptions):"click"==this.handlerMode?this.handler=new Tmap.Handler.Click(this,{click:this.handleEvent},this.handlerOptions):"move"==this.handlerMode&&(this.handler=new Tmap.Handler.Hover(this,{pause:this.handleEvent,move:this.handleEvent},this.handlerOptions)),this.handler?!0:!1},initialize:function(a){a=a||{},a.handlerOptions=a.handlerOptions||this.defaultHandlerOptions,Tmap.Control.prototype.initialize.apply(this,[a]),this.resetHandler()},handleEvent:function(a){if(null==a)return void this.reset();var b=this.map.getLonLatFromPixel(a.xy);if(b){var c=this.findLayers();if(c.length>0){for(var d,e,f={},g=0,h=c.length;h>g;g++)d=c[g],e=Tmap.Util.indexOf(this.map.layers,d),f[e]=d.getFeatureInfo(b);this.callback(f,b,a.xy)}}},callback:function(a){},reset:function(a){this.callback(null)},findLayers:function(){for(var a,b=this.layers||this.map.layers,c=[],d=b.length-1;d>=0;--d)a=b[d],a instanceof Tmap.Layer.UTFGrid&&c.push(a);return c},CLASS_NAME:"Tmap.Control.UTFGrid"}),Tmap.Control.SLDSelect=Tmap.Class(Tmap.Control,{clearOnDeactivate:!1,layers:null,callbacks:null,selectionSymbolizer:{Polygon:{fillColor:"#FF0000",stroke:!1},Line:{strokeColor:"#FF0000",strokeWidth:2},Point:{graphicName:"square",fillColor:"#FF0000",pointRadius:5}},layerOptions:null,sketchStyle:null,wfsCache:{},layerCache:{},initialize:function(a,b){Tmap.Control.prototype.initialize.apply(this,[b]),this.callbacks=Tmap.Util.extend({done:this.select,click:this.select},this.callbacks),this.handlerOptions=this.handlerOptions||{},this.layerOptions=Tmap.Util.applyDefaults(this.layerOptions,{displayInLayerSwitcher:!1,tileOptions:{maxGetUrlLength:2048}}),this.sketchStyle&&(this.handlerOptions.layerOptions=Tmap.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new Tmap.StyleMap({"default":this.sketchStyle})})),this.handler=new a(this,this.callbacks,this.handlerOptions)},destroy:function(){for(var a in this.layerCache)delete this.layerCache[a];for(var a in this.wfsCache)delete this.wfsCache[a];Tmap.Control.prototype.destroy.apply(this,arguments)},coupleLayerVisiblity:function(a){this.setVisibility(a.object.getVisibility())},createSelectionLayer:function(a){var b;return this.layerCache[a.id]?b=this.layerCache[a.id]:(b=new Tmap.Layer.WMS(a.name,a.url,a.params,Tmap.Util.applyDefaults(this.layerOptions,a.getOptions())),this.layerCache[a.id]=b,this.layerOptions.displayInLayerSwitcher===!1&&a.events.on({visibilitychanged:this.coupleLayerVisiblity,scope:b}),this.map.addLayer(b)),b},createSLD:function(a,b,c){for(var d={version:"1.0.0",namedLayers:{}},e=[a.params.LAYERS].join(",").split(","),f=0,g=e.length;g>f;f++){var h=e[f];d.namedLayers[h]={name:h,userStyles:[]};var i=this.selectionSymbolizer,j=c[f];j.type.indexOf("Polygon")>=0?i={Polygon:this.selectionSymbolizer.Polygon}:j.type.indexOf("LineString")>=0?i={Line:this.selectionSymbolizer.Line}:j.type.indexOf("Point")>=0&&(i={Point:this.selectionSymbolizer.Point});var k=b[f];d.namedLayers[h].userStyles.push({name:"default",rules:[new Tmap.Rule({symbolizer:i,filter:k,maxScaleDenominator:a.options.minScale})]})}return new Tmap.Format.SLD({srsName:this.map.getProjection()}).write(d)},parseDescribeLayer:function(a){var b=new Tmap.Format.WMSDescribeLayer,c=a.responseXML;c&&c.documentElement||(c=a.responseText);for(var d=b.read(c),e=[],f=null,g=0,h=d.length;h>g;g++)"WFS"==d[g].owsType&&(e.push(d[g].typeName),f=d[g].owsURL);var i={url:f,params:{SERVICE:"WFS",TYPENAME:e.toString(),REQUEST:"DescribeFeatureType",VERSION:"1.0.0"},callback:function(a){var b=new Tmap.Format.WFSDescribeFeatureType,c=a.responseXML;c&&c.documentElement||(c=a.responseText);var d=b.read(c);this.control.wfsCache[this.layer.id]=d,this.control._queue&&this.control.applySelection()},scope:this};Tmap.Request.GET(i)},getGeometryAttributes:function(a){for(var b=[],c=this.wfsCache[a.id],d=0,e=c.featureTypes.length;e>d;d++)for(var f=c.featureTypes[d],g=f.properties,h=0,i=g.length;i>h;h++){var j=g[h],k=j.type;(k.indexOf("LineString")>=0||k.indexOf("GeometryAssociationType")>=0||k.indexOf("GeometryPropertyType")>=0||k.indexOf("Point")>=0||k.indexOf("Polygon")>=0)&&b.push(j)}return b},activate:function(){var a=Tmap.Control.prototype.activate.call(this);if(a)for(var b=0,c=this.layers.length;c>b;b++){var d=this.layers[b];if(d&&!this.wfsCache[d.id]){var e={url:d.url,
params:{SERVICE:"WMS",VERSION:d.params.VERSION,LAYERS:d.params.LAYERS,REQUEST:"DescribeLayer"},callback:this.parseDescribeLayer,scope:{layer:d,control:this}};Tmap.Request.GET(e)}}return a},deactivate:function(){var a=Tmap.Control.prototype.deactivate.call(this);if(a)for(var b=0,c=this.layers.length;c>b;b++){var d=this.layers[b];if(d&&this.clearOnDeactivate===!0){var e=this.layerCache,f=e[d.id];f&&(d.events.un({visibilitychanged:this.coupleLayerVisiblity,scope:f}),f.destroy(),delete e[d.id])}}return a},setLayers:function(a){this.active?(this.deactivate(),this.layers=a,this.activate()):this.layers=a},createFilter:function(a,b){var c=null;return this.handler instanceof Tmap.Handler.RegularPolygon?c=this.handler.irregular===!0?new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.BBOX,property:a.name,value:b.getBounds()}):new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof Tmap.Handler.Polygon?c=new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof Tmap.Handler.Path?c=a.type.indexOf("Point")>=0?new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.DWITHIN,property:a.name,distance:.01*this.map.getExtent().getWidth(),distanceUnits:this.map.getUnits(),value:b}):new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.INTERSECTS,property:a.name,value:b}):this.handler instanceof Tmap.Handler.Click&&(c=a.type.indexOf("Polygon")>=0?new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.INTERSECTS,property:a.name,value:b}):new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.DWITHIN,property:a.name,distance:.01*this.map.getExtent().getWidth(),distanceUnits:this.map.getUnits(),value:b})),c},select:function(a){this._queue=function(){for(var b=0,c=this.layers.length;c>b;b++){for(var d=this.layers[b],e=this.getGeometryAttributes(d),f=[],g=0,h=e.length;h>g;g++){var i=e[g];if(null!==i){if(!(a instanceof Tmap.Geometry)){var j=this.map.getLonLatFromPixel(a.xy);a=new Tmap.Geometry.Point(j.lon,j.lat)}var k=this.createFilter(i,a);null!==k&&f.push(k)}}var l=this.createSelectionLayer(d);this.events.triggerEvent("selected",{layer:d,filters:f});var m=this.createSLD(d,f,e);l.mergeNewParams({SLD_BODY:m}),delete this._queue}},this.applySelection()},applySelection:function(){for(var a=!0,b=0,c=this.layers.length;c>b;b++)if(!this.wfsCache[this.layers[b].id]){a=!1;break}a&&this._queue.call(this)},CLASS_NAME:"Tmap.Control.SLDSelect"}),Tmap.Control.Zoom=Tmap.Class(Tmap.Control,{zoomInText:"+",zoomInId:"tmZoomInLink",zoomOutText:"\u2212",zoomOutId:"tmZoomOutLink",draw:function(){var a=Tmap.Control.prototype.draw.apply(this),b=this.getOrCreateLinks(a),c=b.zoomIn,d=b.zoomOut,e=this.map.events;return d.parentNode!==a&&(e=this.events,e.attachToElement(d.parentNode)),e.register("buttonclick",this,this.onZoomClick),this.zoomInLink=c,this.zoomOutLink=d,a},getOrCreateLinks:function(a){var b=document.getElementById(this.zoomInId),c=document.getElementById(this.zoomOutId);return b||(b=document.createElement("a"),b.href="#zoomIn",b.appendChild(document.createTextNode(this.zoomInText)),b.className="tmControlZoomIn",a.appendChild(b)),Tmap.Element.addClass(b,"tmButton"),c||(c=document.createElement("a"),c.href="#zoomOut",c.appendChild(document.createTextNode(this.zoomOutText)),c.className="tmControlZoomOut",a.appendChild(c)),Tmap.Element.addClass(c,"tmButton"),{zoomIn:b,zoomOut:c}},onZoomClick:function(a){var b=a.buttonElement;b===this.zoomInLink?this.map.zoomIn():b===this.zoomOutLink&&this.map.zoomOut()},destroy:function(){this.map&&this.map.events.unregister("buttonclick",this,this.onZoomClick),delete this.zoomInLink,delete this.zoomOutLink,Tmap.Control.prototype.destroy.apply(this)},CLASS_NAME:"Tmap.Control.Zoom"}),Tmap.Geometry=Tmap.Class({id:null,parent:null,bounds:null,initialize:function(){this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.id=null,this.bounds=null},clone:function(){return new Tmap.Geometry},setBounds:function(a){a&&(this.bounds=a.clone())},clearBounds:function(){this.bounds=null,this.parent&&this.parent.clearBounds()},extendBounds:function(a){var b=this.getBounds();b?this.bounds.extend(a):this.setBounds(a)},getBounds:function(){return null==this.bounds&&this.calculateBounds(),this.bounds},calculateBounds:function(){},distanceTo:function(a,b){},getVertices:function(a){},atPoint:function(a,b,c){var d=!1,e=this.getBounds();if(null!=e&&null!=a){var f=null!=b?b:0,g=null!=c?c:0,h=new Tmap.Bounds(this.bounds.left-f,this.bounds.bottom-g,this.bounds.right+f,this.bounds.top+g);d=h.containsLonLat(a)}return d},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){var a;return a=Tmap.Format&&Tmap.Format.WKT?Tmap.Format.WKT.prototype.write(new Tmap.Feature.Vector(this)):Object.prototype.toString.call(this)},CLASS_NAME:"Tmap.Geometry"}),Tmap.Geometry.fromWKT=function(a){var b;if(Tmap.Format&&Tmap.Format.WKT){var c=Tmap.Geometry.fromWKT.format;c||(c=new Tmap.Format.WKT,Tmap.Geometry.fromWKT.format=c);var d=c.read(a);if(d instanceof Tmap.Feature.Vector)b=d.geometry;else if(Tmap.Util.isArray(d)){for(var e=d.length,f=new Array(e),g=0;e>g;++g)f[g]=d[g].geometry;b=new Tmap.Geometry.Collection(f)}}return b},Tmap.Geometry.segmentsIntersect=function(a,b,c){var d=c&&c.point,e=c&&c.tolerance,f=!1,g=a.x1-b.x1,h=a.y1-b.y1,i=a.x2-a.x1,j=a.y2-a.y1,k=b.y2-b.y1,l=b.x2-b.x1,m=k*i-l*j,n=l*h-k*g,o=i*h-j*g;if(0==m)0==n&&0==o&&(f=!0);else{var p=n/m,q=o/m;if(p>=0&&1>=p&&q>=0&&1>=q)if(d){var r=a.x1+p*i,s=a.y1+p*j;f=new Tmap.Geometry.Point(r,s)}else f=!0}if(e){var t;if(f){if(d){var u,r,s,v=[a,b];a:for(var w=0;2>w;++w){u=v[w];for(var x=1;3>x;++x)if(r=u["x"+x],s=u["y"+x],t=Math.sqrt(Math.pow(r-f.x,2)+Math.pow(s-f.y,2)),e>t){f.x=r,f.y=s;break a}}}}else{var y,z,r,s,A,B,v=[a,b];a:for(var w=0;2>w;++w){y=v[w],z=v[(w+1)%2];for(var x=1;3>x;++x)if(A={x:y["x"+x],y:y["y"+x]},B=Tmap.Geometry.distanceToSegment(A,z),B.distance<e){f=d?new Tmap.Geometry.Point(A.x,A.y):!0;break a}}}}return f},Tmap.Geometry.distanceToSegment=function(a,b){var c,d,e=a.x,f=a.y,g=b.x1,h=b.y1,i=b.x2,j=b.y2,k=i-g,l=j-h,m=(k*(e-g)+l*(f-h))/(Math.pow(k,2)+Math.pow(l,2));return 0>=m?(c=g,d=h):m>=1?(c=i,d=j):(c=g+m*k,d=h+m*l),{distance:Math.sqrt(Math.pow(c-e,2)+Math.pow(d-f,2)),x:c,y:d}},Tmap.Geometry.Collection=Tmap.Class(Tmap.Geometry,{components:null,componentTypes:null,initialize:function(a){Tmap.Geometry.prototype.initialize.apply(this,arguments),this.components=[],null!=a&&this.addComponents(a)},destroy:function(){this.components.length=0,this.components=null,Tmap.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var geometry=eval("new "+this.CLASS_NAME+"()"),i=0,len=this.components.length;len>i;i++)geometry.addComponent(this.components[i].clone());return Tmap.Util.applyDefaults(geometry,this),geometry},getComponentsString:function(){for(var a=[],b=0,c=this.components.length;c>b;b++)a.push(this.components[b].toShortString());return a.join(",")},calculateBounds:function(){this.bounds=null;var a=new Tmap.Bounds,b=this.components;if(b)for(var c=0,d=b.length;d>c;c++)a.extend(b[c].getBounds());null!=a.left&&null!=a.bottom&&null!=a.right&&null!=a.top&&this.setBounds(a)},addComponents:function(a){Tmap.Util.isArray(a)||(a=[a]);for(var b=0,c=a.length;c>b;b++)this.addComponent(a[b])},addComponent:function(a,b){var c=!1;if(a&&(null==this.componentTypes||Tmap.Util.indexOf(this.componentTypes,a.CLASS_NAME)>-1)){if(null!=b&&b<this.components.length){var d=this.components.slice(0,b),e=this.components.slice(b,this.components.length);d.push(a),this.components=d.concat(e)}else this.components.push(a);a.parent=this,this.clearBounds(),c=!0}return c},removeComponents:function(a){var b=!1;Tmap.Util.isArray(a)||(a=[a]);for(var c=a.length-1;c>=0;--c)b=this.removeComponent(a[c])||b;return b},removeComponent:function(a){return Tmap.Util.removeItem(this.components,a),this.clearBounds(),!0},getLength:function(){for(var a=0,b=0,c=this.components.length;c>b;b++)a+=this.components[b].getLength();return a},getArea:function(){for(var a=0,b=0,c=this.components.length;c>b;b++)a+=this.components[b].getArea();return a},getGeodesicArea:function(a){for(var b=0,c=0,d=this.components.length;d>c;c++)b+=this.components[c].getGeodesicArea(a);return b},getCentroid:function(a){if(!a)return this.components.length&&this.components[0].getCentroid();var b=this.components.length;if(!b)return!1;for(var c,d=[],e=[],f=0,g=Number.MAX_VALUE,h=0;b>h;++h){c=this.components[h];var i=c.getArea(),j=c.getCentroid(!0);isNaN(i)||isNaN(j.x)||isNaN(j.y)||(d.push(i),f+=i,g=g>i&&i>0?i:g,e.push(j))}if(b=d.length,0===f){for(var h=0;b>h;++h)d[h]=1;f=d.length}else{for(var h=0;b>h;++h)d[h]/=g;f/=g}for(var j,i,k=0,l=0,h=0;b>h;++h)j=e[h],i=d[h],k+=j.x*i,l+=j.y*i;return new Tmap.Geometry.Point(k/f,l/f)},getGeodesicLength:function(a){for(var b=0,c=0,d=this.components.length;d>c;c++)b+=this.components[c].getGeodesicLength(a);return b},move:function(a,b){for(var c=0,d=this.components.length;d>c;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;d>c;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0;d<this.components.length;++d)this.components[d].resize(a,b,c);return this},distanceTo:function(a,b){for(var c,d,e,f=!(b&&b.edge===!1),g=f&&b&&b.details,h=Number.POSITIVE_INFINITY,i=0,j=this.components.length;j>i&&(c=this.components[i].distanceTo(a,b),e=g?c.distance:c,!(h>e&&(h=e,d=c,0==h)));++i);return d},equals:function(a){var b=!0;if(a&&a.CLASS_NAME&&this.CLASS_NAME==a.CLASS_NAME)if(Tmap.Util.isArray(a.components)&&a.components.length==this.components.length){for(var c=0,d=this.components.length;d>c;++c)if(!this.components[c].equals(a.components[c])){b=!1;break}}else b=!1;else b=!1;return b},transform:function(a,b){if(a&&b){for(var c=0,d=this.components.length;d>c;c++){var e=this.components[c];e.transform(a,b)}this.bounds=null}return this},intersects:function(a){for(var b=!1,c=0,d=this.components.length;d>c&&!(b=a.intersects(this.components[c]));++c);return b},getVertices:function(a){for(var b=[],c=0,d=this.components.length;d>c;++c)Array.prototype.push.apply(b,this.components[c].getVertices(a));return b},CLASS_NAME:"Tmap.Geometry.Collection"}),Tmap.Geometry.Point=Tmap.Class(Tmap.Geometry,{x:null,y:null,initialize:function(a,b){Tmap.Geometry.prototype.initialize.apply(this,arguments),this.x=parseFloat(a),this.y=parseFloat(b)},clone:function(a){return null==a&&(a=new Tmap.Geometry.Point(this.x,this.y)),Tmap.Util.applyDefaults(a,this),a},calculateBounds:function(){this.bounds=new Tmap.Bounds(this.x,this.y,this.x,this.y)},distanceTo:function(a,b){var c,d,e,f,g,h,i=!(b&&b.edge===!1),j=i&&b&&b.details;return a instanceof Tmap.Geometry.Point?(d=this.x,e=this.y,f=a.x,g=a.y,c=Math.sqrt(Math.pow(d-f,2)+Math.pow(e-g,2)),h=j?{x0:d,y0:e,x1:f,y1:g,distance:c}:c):(h=a.distanceTo(this,b),j&&(h={x0:h.x1,y0:h.y1,x1:h.x0,y1:h.y0,distance:h.distance})),h},equals:function(a){var b=!1;return null!=a&&(b=this.x==a.x&&this.y==a.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(a.x)&&isNaN(a.y)),b},toShortString:function(){return this.x+", "+this.y},move:function(a,b){this.x=this.x+a,this.y=this.y+b,this.clearBounds()},rotate:function(a,b){a*=Math.PI/180;var c=this.distanceTo(b),d=a+Math.atan2(this.y-b.y,this.x-b.x);this.x=b.x+c*Math.cos(d),this.y=b.y+c*Math.sin(d),this.clearBounds()},getCentroid:function(){return new Tmap.Geometry.Point(this.x,this.y)},resize:function(a,b,c){return c=void 0==c?1:c,this.x=b.x+a*c*(this.x-b.x),this.y=b.y+a*(this.y-b.y),this.clearBounds(),this},intersects:function(a){var b=!1;return b="Tmap.Geometry.Point"==a.CLASS_NAME?this.equals(a):a.intersects(this)},transform:function(a,b){return a&&b&&(Tmap.Projection.transform(this,a,b),this.bounds=null),this},getVertices:function(a){return[this]},CLASS_NAME:"Tmap.Geometry.Point"}),Tmap.Geometry.MultiPoint=Tmap.Class(Tmap.Geometry.Collection,{componentTypes:["Tmap.Geometry.Point"],addPoint:function(a,b){this.addComponent(a,b)},removePoint:function(a){this.removeComponent(a)},CLASS_NAME:"Tmap.Geometry.MultiPoint"}),Tmap.Geometry.Curve=Tmap.Class(Tmap.Geometry.MultiPoint,{componentTypes:["Tmap.Geometry.Point"],getLength:function(){var a=0;if(this.components&&this.components.length>1)for(var b=1,c=this.components.length;c>b;b++)a+=this.components[b-1].distanceTo(this.components[b]);return a},getGeodesicLength:function(a){var b=this;if(a){var c=new Tmap.Projection("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}var d=0;if(b.components&&b.components.length>1)for(var e,f,g=1,h=b.components.length;h>g;g++)e=b.components[g-1],f=b.components[g],d+=Tmap.Util.distVincenty({lon:e.x,lat:e.y},{lon:f.x,lat:f.y});return 1e3*d},CLASS_NAME:"Tmap.Geometry.Curve"}),Tmap.Geometry.LineString=Tmap.Class(Tmap.Geometry.Curve,{removeComponent:function(a){var b=this.components&&this.components.length>2;return b&&Tmap.Geometry.Collection.prototype.removeComponent.apply(this,arguments),b},intersects:function(a){var b=!1,c=a.CLASS_NAME;if("Tmap.Geometry.LineString"==c||"Tmap.Geometry.LinearRing"==c||"Tmap.Geometry.Point"==c){var d,e=this.getSortedSegments();d="Tmap.Geometry.Point"==c?[{x1:a.x,y1:a.y,x2:a.x,y2:a.y}]:a.getSortedSegments();var f,g,h,i,j,k,l,m;a:for(var n=0,o=e.length;o>n;++n){f=e[n],g=f.x1,h=f.x2,i=f.y1,j=f.y2;for(var p=0,q=d.length;q>p&&(k=d[p],!(k.x1>h));++p)if(!(k.x2<g)&&(l=k.y1,m=k.y2,!(Math.min(l,m)>Math.max(i,j))&&!(Math.max(l,m)<Math.min(i,j))&&Tmap.Geometry.segmentsIntersect(f,k))){b=!0;break a}}}else b=a.intersects(this);return b},getSortedSegments:function(){function a(a,b){return a.x1-b.x1}for(var b,c,d=this.components.length-1,e=new Array(d),f=0;d>f;++f)b=this.components[f],c=this.components[f+1],b.x<c.x?e[f]={x1:b.x,y1:b.y,x2:c.x,y2:c.y}:e[f]={x1:c.x,y1:c.y,x2:b.x,y2:b.y};return e.sort(a)},splitWithSegment:function(a,b){for(var c,d,e,f,g,h=!(b&&b.edge===!1),i=b&&b.tolerance,j=[],k=this.getVertices(),l=[],m=[],n=!1,o={point:!0,tolerance:i},p=null,q=0,r=k.length-2;r>=q;++q)if(c=k[q],l.push(c.clone()),d=k[q+1],g={x1:c.x,y1:c.y,x2:d.x,y2:d.y},e=Tmap.Geometry.segmentsIntersect(a,g,o),e instanceof Tmap.Geometry.Point&&(f=e.x===a.x1&&e.y===a.y1||e.x===a.x2&&e.y===a.y2||e.equals(c)||e.equals(d)?!0:!1,f||h)){if(e.equals(m[m.length-1])||m.push(e.clone()),0===q&&e.equals(c))continue;if(e.equals(d))continue;n=!0,e.equals(c)||l.push(e),j.push(new Tmap.Geometry.LineString(l)),l=[e.clone()]}if(n&&(l.push(d.clone()),j.push(new Tmap.Geometry.LineString(l))),m.length>0){var s=a.x1<a.x2?1:-1,t=a.y1<a.y2?1:-1;p={lines:j,points:m.sort(function(a,b){return s*a.x-s*b.x||t*a.y-t*b.y})}}return p},split:function(a,b){var c,d,e,f,g=null,h=b&&b.mutual;if(a instanceof Tmap.Geometry.LineString){var i,j,k,l,m,n,o=this.getVertices(),p=[];e=[];for(var q=0,r=o.length-2;r>=q;++q){i=o[q],j=o[q+1],k={x1:i.x,y1:i.y,x2:j.x,y2:j.y},f=f||[a],h&&p.push(i.clone());for(var s=0;s<f.length;++s)if(l=f[s].splitWithSegment(k,b),l&&(m=l.lines,m.length>0&&(m.unshift(s,1),Array.prototype.splice.apply(f,m),s+=m.length-2),h))for(var t=0,u=l.points.length;u>t;++t)n=l.points[t],n.equals(i)||(p.push(n),e.push(new Tmap.Geometry.LineString(p)),p=n.equals(j)?[]:[n.clone()])}h&&e.length>0&&p.length>0&&(p.push(j.clone()),e.push(new Tmap.Geometry.LineString(p)))}else g=a.splitWith(this,b);return f&&f.length>1?d=!0:f=[],e&&e.length>1?c=!0:e=[],(d||c)&&(g=h?[e,f]:f),g},splitWith:function(a,b){return a.split(this,b)},getVertices:function(a){var b;return b=a===!0?[this.components[0],this.components[this.components.length-1]]:a===!1?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(a,b){var c,d=!(b&&b.edge===!1),e=d&&b&&b.details,f={},g=Number.POSITIVE_INFINITY;if(a instanceof Tmap.Geometry.Point){for(var h,i=this.getSortedSegments(),j=a.x,k=a.y,l=0,m=i.length;m>l;++l)if(h=i[l],c=Tmap.Geometry.distanceToSegment(a,h),c.distance<g){if(g=c.distance,f=c,0===g)break}else if(h.x2>j&&(k>h.y1&&k<h.y2||k<h.y1&&k>h.y2))break;f=e?{distance:f.distance,x0:f.x,y0:f.y,x1:j,y1:k}:f.distance}else if(a instanceof Tmap.Geometry.LineString){var n,o,p,q,r,s=this.getSortedSegments(),t=a.getSortedSegments(),u=t.length,v={point:!0};a:for(var l=0,m=s.length;m>l;++l){n=s[l],q=n.x1,r=n.y1;for(var w=0;u>w;++w){if(o=t[w],p=Tmap.Geometry.segmentsIntersect(n,o,v)){g=0,f={distance:0,x0:p.x,y0:p.y,x1:p.x,y1:p.y};break a}c=Tmap.Geometry.distanceToSegment({x:q,y:r},o),c.distance<g&&(g=c.distance,f={distance:g,x0:q,y0:r,x1:c.x,y1:c.y})}}if(e||(f=f.distance),0!==g&&n){c=a.distanceTo(new Tmap.Geometry.Point(n.x2,n.y2),b);var x=e?c.distance:c;g>x&&(f=e?{distance:g,x0:c.x1,y0:c.y1,x1:c.x0,y1:c.y0}:x)}}else f=a.distanceTo(this,b),e&&(f={distance:f.distance,x0:f.x1,y0:f.y1,x1:f.x0,y1:f.y0});return f},simplify:function(a){if(this&&null!==this){var b=this.getVertices();if(b.length<3)return this;var c=function(a,b){return a-b},d=function(a,b,c,f){for(var g,i=0,j=0,k=b;c>k;k++)g=e(a[b],a[c],a[k]),g>i&&(i=g,j=k);i>f&&j!=b&&(h.push(j),d(a,b,j,f),d(a,j,c,f))},e=function(a,b,c){var d=Math.abs(.5*(a.x*b.y+b.x*c.y+c.x*a.y-b.x*a.y-c.x*b.y-a.x*c.y)),e=Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2)),f=d/e*2;return f},f=0,g=b.length-1,h=[];for(h.push(f),h.push(g);b[f].equals(b[g]);)g--,h.push(g);d(b,f,g,a);var i=[];h.sort(c);for(var j=0;j<h.length;j++)i.push(b[h[j]]);return new Tmap.Geometry.LineString(i)}return this},CLASS_NAME:"Tmap.Geometry.LineString"}),Tmap.Geometry.LinearRing=Tmap.Class(Tmap.Geometry.LineString,{componentTypes:["Tmap.Geometry.Point"],addComponent:function(a,b){var c=!1,d=this.components.pop();null==b&&a.equals(d)||(c=Tmap.Geometry.Collection.prototype.addComponent.apply(this,arguments));var e=this.components[0];return Tmap.Geometry.Collection.prototype.addComponent.apply(this,[e]),c},removeComponent:function(a){var b=this.components&&this.components.length>3;if(b){this.components.pop(),Tmap.Geometry.Collection.prototype.removeComponent.apply(this,arguments);var c=this.components[0];Tmap.Geometry.Collection.prototype.addComponent.apply(this,[c])}return b},move:function(a,b){for(var c=0,d=this.components.length;d-1>c;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;d-1>c;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0,e=this.components.length;e-1>d;++d)this.components[d].resize(a,b,c);return this},transform:function(a,b){if(a&&b){for(var c=0,d=this.components.length;d-1>c;c++){var e=this.components[c];e.transform(a,b)}this.bounds=null}return this},getCentroid:function(){if(this.components){var a=this.components.length;if(a>0&&2>=a)return this.components[0].clone();if(a>2){var b=0,c=0,d=this.components[0].x,e=this.components[0].y,f=-1*this.getArea();if(0!=f){for(var g=0;a-1>g;g++){var h=this.components[g],i=this.components[g+1];b+=(h.x+i.x-2*d)*((h.x-d)*(i.y-e)-(i.x-d)*(h.y-e)),c+=(h.y+i.y-2*e)*((h.x-d)*(i.y-e)-(i.x-d)*(h.y-e))}var j=d+b/(6*f),k=e+c/(6*f)}else{for(var g=0;a-1>g;g++)b+=this.components[g].x,c+=this.components[g].y;var j=b/(a-1),k=c/(a-1)}return new Tmap.Geometry.Point(j,k)}return null}},getArea:function(){var a=0;if(this.components&&this.components.length>2){for(var b=0,c=0,d=this.components.length;d-1>c;c++){var e=this.components[c],f=this.components[c+1];b+=(e.x+f.x)*(f.y-e.y)}a=-b/2}return a},getGeodesicArea:function(a){var b=this;if(a){var c=new Tmap.Projection("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}var d=0,e=b.components&&b.components.length;if(e>2){for(var f,g,h=0;e-1>h;h++)f=b.components[h],g=b.components[h+1],d+=Tmap.Util.rad(g.x-f.x)*(2+Math.sin(Tmap.Util.rad(f.y))+Math.sin(Tmap.Util.rad(g.y)));d=6378137*d*6378137/2}return d},containsPoint:function(a){function b(a,b,c,d,e){return(a-e)*((d-b)/(e-c))+d}for(var c,d,e,f,g,h,i,j=Tmap.Number.limitSigDigs,k=14,l=j(a.x,k),m=j(a.y,k),n=this.components.length-1,o=0,p=0;n>p;++p)if(c=this.components[p],e=j(c.x,k),f=j(c.y,k),d=this.components[p+1],g=j(d.x,k),h=j(d.y,k),f!=h){if(i=j(b(m,e,f,g,h),k),i==l&&(h>f&&m>=f&&h>=m||f>h&&f>=m&&m>=h)){o=-1;break}l>=i||e!=g&&(i<Math.min(e,g)||i>Math.max(e,g))||(h>f&&m>=f&&h>m||f>h&&f>m&&m>=h)&&++o}else if(m==f&&(g>=e&&l>=e&&g>=l||e>=g&&e>=l&&l>=g)){o=-1;break}var q=-1==o?1:!!(1&o);return q},intersects:function(a){var b=!1;if("Tmap.Geometry.Point"==a.CLASS_NAME)b=this.containsPoint(a);else if("Tmap.Geometry.LineString"==a.CLASS_NAME)b=a.intersects(this);else if("Tmap.Geometry.LinearRing"==a.CLASS_NAME)b=Tmap.Geometry.LineString.prototype.intersects.apply(this,[a]);else for(var c=0,d=a.components.length;d>c&&!(b=a.components[c].intersects(this));++c);return b},getVertices:function(a){return a===!0?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"Tmap.Geometry.LinearRing"}),Tmap.Geometry.Polygon=Tmap.Class(Tmap.Geometry.Collection,{componentTypes:["Tmap.Geometry.LinearRing"],getArea:function(){var a=0;if(this.components&&this.components.length>0){a+=Math.abs(this.components[0].getArea());for(var b=1,c=this.components.length;c>b;b++)a-=Math.abs(this.components[b].getArea())}return a},getGeodesicArea:function(a){var b=0;if(this.components&&this.components.length>0){b+=Math.abs(this.components[0].getGeodesicArea(a));for(var c=1,d=this.components.length;d>c;c++)b-=Math.abs(this.components[c].getGeodesicArea(a))}return b},containsPoint:function(a){var b=this.components.length,c=!1;if(b>0&&(c=this.components[0].containsPoint(a),1!==c&&c&&b>1))for(var d,e=1;b>e;++e)if(d=this.components[e].containsPoint(a)){c=1===d?1:!1;break}return c},intersects:function(a){var b,c,d=!1;if("Tmap.Geometry.Point"==a.CLASS_NAME)d=this.containsPoint(a);else if("Tmap.Geometry.LineString"==a.CLASS_NAME||"Tmap.Geometry.LinearRing"==a.CLASS_NAME){for(b=0,c=this.components.length;c>b&&!(d=a.intersects(this.components[b]));++b);if(!d)for(b=0,c=a.components.length;c>b&&!(d=this.containsPoint(a.components[b]));++b);}else for(b=0,c=a.components.length;c>b&&!(d=this.intersects(a.components[b]));++b);if(!d&&"Tmap.Geometry.Polygon"==a.CLASS_NAME){var e=this.components[0];for(b=0,c=e.components.length;c>b&&!(d=a.containsPoint(e.components[b]));++b);}return d},distanceTo:function(a,b){var c,d=!(b&&b.edge===!1);return c=!d&&this.intersects(a)?0:Tmap.Geometry.Collection.prototype.distanceTo.apply(this,[a,b])},CLASS_NAME:"Tmap.Geometry.Polygon"}),Tmap.Geometry.Polygon.createRegularPolygon=function(a,b,c,d){var e=Math.PI*(1/c-.5);d&&(e+=d/180*Math.PI);for(var f,g,h,i=[],j=0;c>j;++j)f=e+2*j*Math.PI/c,g=a.x+b*Math.cos(f),h=a.y+b*Math.sin(f),i.push(new Tmap.Geometry.Point(g,h));var k=new Tmap.Geometry.LinearRing(i);return new Tmap.Geometry.Polygon([k])},Tmap.Geometry.MultiLineString=Tmap.Class(Tmap.Geometry.Collection,{componentTypes:["Tmap.Geometry.LineString"],split:function(a,b){for(var c,d,e,f,g,h=null,i=b&&b.mutual,j=[],k=[a],l=0,m=this.components.length;m>l;++l){d=this.components[l],f=!1;for(var n=0;n<k.length;++n)if(c=d.split(k[n],b)){if(i){e=c[0];for(var o=0,p=e.length;p>o;++o)0===o&&j.length?j[j.length-1].addComponent(e[o]):j.push(new Tmap.Geometry.MultiLineString([e[o]]));f=!0,c=c[1]}if(c.length){c.unshift(n,1),Array.prototype.splice.apply(k,c);break}}f||(j.length?j[j.length-1].addComponent(d.clone()):j=[new Tmap.Geometry.MultiLineString(d.clone())])}return j&&j.length>1?f=!0:j=[],k&&k.length>1?g=!0:k=[],(f||g)&&(h=i?[j,k]:k),h},splitWith:function(a,b){var c,d,e,f,g,h,i,j=null,k=b&&b.mutual;if(a instanceof Tmap.Geometry.LineString){i=[],h=[a];for(var l=0,m=this.components.length;m>l;++l){g=!1,d=this.components[l];for(var n=0;n<h.length;++n)if(c=h[n].split(d,b)){k&&(e=c[0],e.length&&(e.unshift(n,1),Array.prototype.splice.apply(h,e),n+=e.length-2),c=c[1],0===c.length&&(c=[d.clone()]));for(var o=0,p=c.length;p>o;++o)0===o&&i.length?i[i.length-1].addComponent(c[o]):i.push(new Tmap.Geometry.MultiLineString([c[o]]));g=!0}g||(i.length?i[i.length-1].addComponent(d.clone()):i=[new Tmap.Geometry.MultiLineString([d.clone()])])}}else j=a.split(this);return h&&h.length>1?f=!0:h=[],i&&i.length>1?g=!0:i=[],(f||g)&&(j=k?[h,i]:i),j},CLASS_NAME:"Tmap.Geometry.MultiLineString"}),Tmap.Geometry.MultiPolygon=Tmap.Class(Tmap.Geometry.Collection,{componentTypes:["Tmap.Geometry.Polygon"],CLASS_NAME:"Tmap.Geometry.MultiPolygon"}),Tmap.Geometry.Circle=function(a,b,c){var d=50;return c>500&&(d=Math.floor(c/10)),Tmap.Geometry.Polygon.createRegularPolygon(new Tmap.Geometry.Point(a,b),c,d)},Tmap.Renderer=Tmap.Class({container:null,root:null,extent:null,locked:!1,size:null,resolution:null,map:null,featureDx:0,initialize:function(a,b){this.container=Tmap.Util.getElement(a),Tmap.Util.extend(this,b)},destroy:function(){this.container=null,this.extent=null,this.size=null,this.resolution=null,this.map=null},supported:function(){return!1},setExtent:function(a,b){if(this.extent=a.clone(),this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var c=a.getWidth()/this.map.getExtent().getWidth(),a=a.scale(1/c);this.extent=a.wrapDateLine(this.map.getMaxExtent()).scale(c)}return b&&(this.resolution=null),!0},setSize:function(a){this.size=a.clone(),this.resolution=null},getResolution:function(){return this.resolution=this.resolution||this.map.getResolution(),this.resolution},drawFeature:function(a,b){if(null==b&&(b=a.style),a.geometry){var c=a.geometry.getBounds();if(c){var d;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(d=this.map.getMaxExtent()),c.intersectsBounds(this.extent,{worldBounds:d})?this.calculateFeatureDx(c,d):b={display:"none"};var e=this.drawGeometry(a.geometry,b,a.id);if("none"!=b.display&&b.label&&e!==!1){var f=a.geometry.getCentroid();if(b.labelXOffset||b.labelYOffset){var g=isNaN(b.labelXOffset)?0:b.labelXOffset,h=isNaN(b.labelYOffset)?0:b.labelYOffset,i=this.getResolution();f.move(g*i,h*i)}this.drawText(a.id,b,f)}else this.removeText(a.id);return e}}},calculateFeatureDx:function(a,b){if(this.featureDx=0,b){var c=b.getWidth(),d=(this.extent.left+this.extent.right)/2,e=(a.left+a.right)/2,f=Math.round((e-d)/c);this.featureDx=f*c}},drawGeometry:function(a,b,c){},drawText:function(a,b,c){},removeText:function(a){},clear:function(){},getFeatureIdFromEvent:function(a){},eraseFeatures:function(a){Tmap.Util.isArray(a)||(a=[a]);for(var b=0,c=a.length;c>b;++b){var d=a[b];this.eraseGeometry(d.geometry,d.id),this.removeText(d.id)}},eraseGeometry:function(a,b){},moveRoot:function(a){},getRenderLayerId:function(){return this.container.id},applyDefaultSymbolizer:function(a){var b=Tmap.Util.extend({},Tmap.Renderer.defaultSymbolizer);return a.stroke===!1&&(delete b.strokeWidth,delete b.strokeColor),a.fill===!1&&delete b.fillColor,Tmap.Util.extend(b,a),b},CLASS_NAME:"Tmap.Renderer"}),Tmap.Renderer.defaultSymbolizer={fillColor:"#000000",strokeColor:"#000000",strokeWidth:2,fillOpacity:1,strokeOpacity:1,pointRadius:0,labelAlign:"cm"},Tmap.Renderer.symbol={star:[350,75,379,161,469,161,397,215,423,301,350,250,277,301,303,215,231,161,321,161,350,75],cross:[4,0,6,0,6,4,10,4,10,6,6,6,6,10,4,10,4,6,0,6,0,4,4,4,4,0],x:[0,0,25,0,50,35,75,0,100,0,65,50,100,100,75,100,50,65,25,100,0,100,35,50,0,0],square:[0,0,0,1,1,1,1,0,0,0],triangle:[0,10,10,10,5,0,0,10]},Tmap.ElementsIndexer=Tmap.Class({maxZIndex:null,order:null,indices:null,compare:null,initialize:function(a){this.compare=a?Tmap.ElementsIndexer.IndexingMethods.Z_ORDER_Y_ORDER:Tmap.ElementsIndexer.IndexingMethods.Z_ORDER_DRAWING_ORDER,this.clear()},insert:function(a){this.exists(a)&&this.remove(a);var b=a.id;this.determineZIndex(a);for(var c,d=-1,e=this.order.length;e-d>1;){c=parseInt((d+e)/2);var f=this.compare(this,a,Tmap.Util.getElement(this.order[c]));f>0?d=c:e=c}return this.order.splice(e,0,b),this.indices[b]=this.getZIndex(a),this.getNextElement(e)},remove:function(a){var b=a.id,c=Tmap.Util.indexOf(this.order,b);if(c>=0)if(this.order.splice(c,1),delete this.indices[b],this.order.length>0){var d=this.order[this.order.length-1];this.maxZIndex=this.indices[d]}else this.maxZIndex=0},clear:function(){this.order=[],this.indices={},this.maxZIndex=0},exists:function(a){return null!=this.indices[a.id]},getZIndex:function(a){return a._style.graphicZIndex},determineZIndex:function(a){var b=a._style.graphicZIndex;null==b?(b=this.maxZIndex,a._style.graphicZIndex=b):b>this.maxZIndex&&(this.maxZIndex=b)},getNextElement:function(a){var b=a+1;if(b<this.order.length){var c=Tmap.Util.getElement(this.order[b]);return void 0==c&&(c=this.getNextElement(b)),c}return null},CLASS_NAME:"Tmap.ElementsIndexer"}),Tmap.ElementsIndexer.IndexingMethods={Z_ORDER:function(a,b,c){var d=a.getZIndex(b),e=0;if(c){var f=a.getZIndex(c);e=d-f}return e},Z_ORDER_DRAWING_ORDER:function(a,b,c){var d=Tmap.ElementsIndexer.IndexingMethods.Z_ORDER(a,b,c);return c&&0==d&&(d=1),d},Z_ORDER_Y_ORDER:function(a,b,c){var d=Tmap.ElementsIndexer.IndexingMethods.Z_ORDER(a,b,c);if(c&&0===d){var e=c._boundsBottom-b._boundsBottom;d=0===e?1:e}return d}},Tmap.Renderer.Elements=Tmap.Class(Tmap.Renderer,{rendererRoot:null,root:null,vectorRoot:null,textRoot:null,xmlns:null,xOffset:0,indexer:null,BACKGROUND_ID_SUFFIX:"_background",LABEL_ID_SUFFIX:"_label",LABEL_OUTLINE_SUFFIX:"_outline",initialize:function(a,b){Tmap.Renderer.prototype.initialize.apply(this,arguments),this.rendererRoot=this.createRenderRoot(),this.root=this.createRoot("_root"),this.vectorRoot=this.createRoot("_vroot"),this.textRoot=this.createRoot("_troot"),this.root.appendChild(this.vectorRoot),this.root.appendChild(this.textRoot),this.rendererRoot.appendChild(this.root),this.container.appendChild(this.rendererRoot),b&&(b.zIndexing||b.yOrdering)&&(this.indexer=new Tmap.ElementsIndexer(b.yOrdering))},destroy:function(){this.clear(),this.rendererRoot=null,this.root=null,this.xmlns=null,Tmap.Renderer.prototype.destroy.apply(this,arguments)},clear:function(){var a,b=this.vectorRoot;if(b)for(;a=b.firstChild;)b.removeChild(a);if(b=this.textRoot)for(;a=b.firstChild;)b.removeChild(a);this.indexer&&this.indexer.clear()},setExtent:function(a,b){var c=Tmap.Renderer.prototype.setExtent.apply(this,arguments),d=this.getResolution();if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){var e,f=a.getWidth()/this.map.getExtent().getWidth(),a=a.scale(1/f),g=this.map.getMaxExtent();g.right>a.left&&g.right<a.right?e=!0:g.left>a.left&&g.left<a.right&&(e=!1),(e!==this.rightOfDateLine||b)&&(c=!1,this.xOffset=e===!0?g.getWidth()/d:0),this.rightOfDateLine=e}return c},getNodeType:function(a,b){},drawGeometry:function(a,b,c){var d=a.CLASS_NAME,e=!0;if("Tmap.Geometry.Collection"==d||"Tmap.Geometry.MultiPoint"==d||"Tmap.Geometry.MultiLineString"==d||"Tmap.Geometry.MultiPolygon"==d){for(var f=0,g=a.components.length;g>f;f++)e=this.drawGeometry(a.components[f],b,c)&&e;return e}e=!1;var h=!1;if("none"!=b.display&&(b.backgroundGraphic?this.redrawBackgroundNode(a.id,a,b,c):h=!0,e=this.redrawNode(a.id,a,b,c)),0==e){var i=document.getElementById(a.id);i&&(i._style.backgroundGraphic&&(h=!0),i.parentNode.removeChild(i))}if(h){var i=document.getElementById(a.id+this.BACKGROUND_ID_SUFFIX);i&&i.parentNode.removeChild(i)}return e},redrawNode:function(a,b,c,d){c=this.applyDefaultSymbolizer(c);var e=this.nodeFactory(a,this.getNodeType(b,c));e._featureId=d,e._boundsBottom=b.getBounds().bottom,e._geometryClass=b.CLASS_NAME,e._style=c;var f=this.drawGeometryNode(e,b,c);if(f===!1)return!1;if(e=f.node,this.indexer){var g=this.indexer.insert(e);g?this.vectorRoot.insertBefore(e,g):this.vectorRoot.appendChild(e)}else e.parentNode!==this.vectorRoot&&this.vectorRoot.appendChild(e);return this.postDraw(e),f.complete},redrawBackgroundNode:function(a,b,c,d){var e=Tmap.Util.extend({},c);return e.externalGraphic=e.backgroundGraphic,e.graphicXOffset=e.backgroundXOffset,e.graphicYOffset=e.backgroundYOffset,e.graphicZIndex=e.backgroundGraphicZIndex,e.graphicWidth=e.backgroundWidth||e.graphicWidth,e.graphicHeight=e.backgroundHeight||e.graphicHeight,e.backgroundGraphic=null,e.backgroundXOffset=null,e.backgroundYOffset=null,e.backgroundGraphicZIndex=null,this.redrawNode(a+this.BACKGROUND_ID_SUFFIX,b,e,null)},drawGeometryNode:function(a,b,c){c=c||a._style;var d,e={isFilled:void 0===c.fill?!0:c.fill,isStroked:void 0===c.stroke?!!c.strokeWidth:c.stroke};switch(b.CLASS_NAME){case"Tmap.Geometry.Point":c.graphic===!1&&(e.isFilled=!1,
e.isStroked=!1),d=this.drawPoint(a,b);break;case"Tmap.Geometry.LineString":e.isFilled=!1,d=this.drawLineString(a,b);break;case"Tmap.Geometry.LinearRing":d=this.drawLinearRing(a,b);break;case"Tmap.Geometry.Polygon":d=this.drawPolygon(a,b);break;case"Tmap.Geometry.Rectangle":d=this.drawRectangle(a,b)}return a._options=e,0!=d?{node:this.setStyle(a,c,e,b),complete:d}:!1},postDraw:function(a){},drawPoint:function(a,b){},drawLineString:function(a,b){},drawLinearRing:function(a,b){},drawPolygon:function(a,b){},drawRectangle:function(a,b){},drawCircle:function(a,b){},removeText:function(a){var b=document.getElementById(a+this.LABEL_ID_SUFFIX);b&&this.textRoot.removeChild(b);var c=document.getElementById(a+this.LABEL_OUTLINE_SUFFIX);c&&this.textRoot.removeChild(c)},getFeatureIdFromEvent:function(a){var b=a.target,c=b&&b.correspondingUseElement,d=c?c:b||a.srcElement;return d._featureId},eraseGeometry:function(a,b){if("Tmap.Geometry.MultiPoint"==a.CLASS_NAME||"Tmap.Geometry.MultiLineString"==a.CLASS_NAME||"Tmap.Geometry.MultiPolygon"==a.CLASS_NAME||"Tmap.Geometry.Collection"==a.CLASS_NAME)for(var c=0,d=a.components.length;d>c;c++)this.eraseGeometry(a.components[c],b);else{var e=Tmap.Util.getElement(a.id);if(e&&e.parentNode&&(e.geometry&&(e.geometry.destroy(),e.geometry=null),e.parentNode.removeChild(e),this.indexer&&this.indexer.remove(e),e._style.backgroundGraphic)){var f=a.id+this.BACKGROUND_ID_SUFFIX,g=Tmap.Util.getElement(f);g&&g.parentNode&&g.parentNode.removeChild(g)}}},nodeFactory:function(a,b){var c=Tmap.Util.getElement(a);return c?this.nodeTypeCompare(c,b)||(c.parentNode.removeChild(c),c=this.nodeFactory(a,b)):c=this.createNode(b,a),c},nodeTypeCompare:function(a,b){},createNode:function(a,b){},moveRoot:function(a){var b=this.root;a.root.parentNode==this.rendererRoot&&(b=a.root),b.parentNode.removeChild(b),a.rendererRoot.appendChild(b)},getRenderLayerId:function(){return this.root.parentNode.parentNode.id},isComplexSymbol:function(a){return"circle"!=a&&!!a},CLASS_NAME:"Tmap.Renderer.Elements"}),Tmap.Renderer.SVG=Tmap.Class(Tmap.Renderer.Elements,{xmlns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",MAX_PIXEL:15e3,translationParameters:null,symbolMetrics:null,initialize:function(a){this.supported()&&(Tmap.Renderer.Elements.prototype.initialize.apply(this,arguments),this.translationParameters={x:0,y:0},this.symbolMetrics={})},supported:function(){var a="http://www.w3.org/TR/SVG11/feature#";return document.implementation&&(document.implementation.hasFeature("org.w3c.svg","1.0")||document.implementation.hasFeature(a+"SVG","1.1")||document.implementation.hasFeature(a+"BasicStructure","1.1"))},inValidRange:function(a,b,c){var d=a+(c?0:this.translationParameters.x),e=b+(c?0:this.translationParameters.y);return d>=-this.MAX_PIXEL&&d<=this.MAX_PIXEL&&e>=-this.MAX_PIXEL&&e<=this.MAX_PIXEL},setExtent:function(a,b){var c=Tmap.Renderer.Elements.prototype.setExtent.apply(this,arguments),d=this.getResolution(),e=-a.left/d,f=a.top/d;if(b){this.left=e,this.top=f;var g="0 0 "+this.size.w+" "+this.size.h;return this.rendererRoot.setAttributeNS(null,"viewBox",g),this.translate(this.xOffset,0),!0}var h=this.translate(e-this.left+this.xOffset,f-this.top);return h||this.setExtent(a,!0),c&&h},translate:function(a,b){if(this.inValidRange(a,b,!0)){var c="";return(a||b)&&(c="translate("+a+","+b+")"),this.root.setAttributeNS(null,"transform",c),this.translationParameters={x:a,y:b},!0}return!1},setSize:function(a){Tmap.Renderer.prototype.setSize.apply(this,arguments),this.rendererRoot.setAttributeNS(null,"width",this.size.w),this.rendererRoot.setAttributeNS(null,"height",this.size.h)},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case"Tmap.Geometry.Point":c=b.externalGraphic?"image":this.isComplexSymbol(b.graphicName)?"svg":"circle";break;case"Tmap.Geometry.Rectangle":c="rect";break;case"Tmap.Geometry.LineString":c="polyline";break;case"Tmap.Geometry.LinearRing":c="polygon";break;case"Tmap.Geometry.Polygon":case"Tmap.Geometry.Curve":c="path"}return c},setStyle:function(a,b,c){b=b||a._style,c=c||a._options;var d=b.title||b.graphicTitle;if(d){a.setAttributeNS(null,"title",d);var e=a.getElementsByTagName("title");if(e.length>0)e[0].firstChild.textContent=d;else{var f=this.nodeFactory(null,"title");f.textContent=d,a.appendChild(f)}}var g,h=parseFloat(a.getAttributeNS(null,"r")),i=1;if("Tmap.Geometry.Point"==a._geometryClass&&h){if(a.style.visibility="",b.graphic===!1)a.style.visibility="hidden";else if(b.externalGraphic){g=this.getPosition(a),b.graphicWidth&&b.graphicHeight&&a.setAttributeNS(null,"preserveAspectRatio","none");var j=b.graphicWidth||b.graphicHeight,k=b.graphicHeight||b.graphicWidth;j=j?j:2*b.pointRadius,k=k?k:2*b.pointRadius;var l=void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*j),m=void 0!=b.graphicYOffset?b.graphicYOffset:-(.5*k),n=b.graphicOpacity||b.fillOpacity;a.setAttributeNS(null,"x",(g.x+l).toFixed()),a.setAttributeNS(null,"y",(g.y+m).toFixed()),a.setAttributeNS(null,"width",j),a.setAttributeNS(null,"height",k),a.setAttributeNS(this.xlinkns,"xlink:href",b.externalGraphic),a.setAttributeNS(null,"style","opacity: "+n),a.onclick=Tmap.Event.preventDefault}else if(this.isComplexSymbol(b.graphicName)){var o=3*b.pointRadius,p=2*o,q=this.importSymbol(b.graphicName);g=this.getPosition(a),i=3*this.symbolMetrics[q.id][0]/p;var r=a.parentNode,s=a.nextSibling;r&&r.removeChild(a),a.firstChild&&a.removeChild(a.firstChild),a.appendChild(q.firstChild.cloneNode(!0)),a.setAttributeNS(null,"viewBox",q.getAttributeNS(null,"viewBox")),a.setAttributeNS(null,"width",p),a.setAttributeNS(null,"height",p),a.setAttributeNS(null,"x",g.x-o),a.setAttributeNS(null,"y",g.y-o),s?r.insertBefore(a,s):r&&r.appendChild(a)}else a.setAttributeNS(null,"r",b.pointRadius);var t=b.rotation;if((void 0!==t||void 0!==a._rotation)&&g)if(a._rotation=t,t|=0,"svg"!==a.nodeName)a.setAttributeNS(null,"transform","rotate("+t+" "+g.x+" "+g.y+")");else{var u=this.symbolMetrics[q.id];a.firstChild.setAttributeNS(null,"transform","rotate("+t+" "+u[1]+" "+u[2]+")")}}return c.isFilled?(a.setAttributeNS(null,"fill",b.fillColor),a.setAttributeNS(null,"fill-opacity",b.fillOpacity)):a.setAttributeNS(null,"fill","none"),c.isStroked?(a.setAttributeNS(null,"stroke",b.strokeColor),a.setAttributeNS(null,"stroke-opacity",b.strokeOpacity),a.setAttributeNS(null,"stroke-width",b.strokeWidth*i),a.setAttributeNS(null,"stroke-linecap",b.strokeLinecap||"round"),a.setAttributeNS(null,"stroke-linejoin","round"),b.strokeDashstyle&&a.setAttributeNS(null,"stroke-dasharray",this.dashStyle(b,i))):a.setAttributeNS(null,"stroke","none"),b.pointerEvents&&a.setAttributeNS(null,"pointer-events",b.pointerEvents),null!=b.cursor&&a.setAttributeNS(null,"cursor",b.cursor),a},dashStyle:function(a,b){var c=a.strokeWidth*b,d=a.strokeDashstyle;switch(d){case"solid":return"none";case"dot":return[1,4*c].join();case"dash":return[4*c,4*c].join();case"dashdot":return[4*c,4*c,1,4*c].join();case"longdash":return[8*c,4*c].join();case"longdashdot":return[8*c,4*c,1,4*c].join();default:return Tmap.String.trim(d).replace(/\s+/g,",")}},createNode:function(a,b){var c=document.createElementNS(this.xmlns,a);return b&&c.setAttributeNS(null,"id",b),c},nodeTypeCompare:function(a,b){return b==a.nodeName},createRenderRoot:function(){var a=this.nodeFactory(this.container.id+"_svgRoot","svg");return a.style.display="block",a},createRoot:function(a){return this.nodeFactory(this.container.id+a,"g")},createDefs:function(){var a=this.nodeFactory(this.container.id+"_defs","defs");return this.rendererRoot.appendChild(a),a},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(a,b,c){var d=this.getResolution(),e=(b.x-this.featureDx)/d+this.left,f=this.top-b.y/d;return this.inValidRange(e,f)?(a.setAttributeNS(null,"cx",e),a.setAttributeNS(null,"cy",f),a.setAttributeNS(null,"r",c),a):!1},drawLineString:function(a,b){var c=this.getComponentsString(b.components);return c.path?(a.setAttributeNS(null,"points",c.path),c.complete?a:null):!1},drawLinearRing:function(a,b){var c=this.getComponentsString(b.components);return c.path?(a.setAttributeNS(null,"points",c.path),c.complete?a:null):!1},drawPolygon:function(a,b){for(var c,d,e="",f=!0,g=!0,h=0,i=b.components.length;i>h;h++)e+=" M",c=this.getComponentsString(b.components[h].components," "),d=c.path,d?(e+=" "+d,g=c.complete&&g):f=!1;return e+=" z",f?(a.setAttributeNS(null,"d",e),a.setAttributeNS(null,"fill-rule","evenodd"),g?a:null):!1},drawRectangle:function(a,b){var c=this.getResolution(),d=(b.x-this.featureDx)/c+this.left,e=this.top-b.y/c;return this.inValidRange(d,e)?(a.setAttributeNS(null,"x",d),a.setAttributeNS(null,"y",e),a.setAttributeNS(null,"width",b.width/c),a.setAttributeNS(null,"height",b.height/c),a):!1},drawText:function(a,b,c){var d=!!b.labelOutlineWidth;if(d){var e=Tmap.Util.extend({},b);e.fontColor=e.labelOutlineColor,e.fontStrokeColor=e.labelOutlineColor,e.fontStrokeWidth=b.labelOutlineWidth,delete e.labelOutlineWidth,this.drawText(a,e,c)}var f=this.getResolution(),g=(c.x-this.featureDx)/f+this.left,h=c.y/f-this.top,i=d?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,j=this.nodeFactory(a+i,"text");j.setAttributeNS(null,"x",g),j.setAttributeNS(null,"y",-h),b.fontColor&&j.setAttributeNS(null,"fill",b.fontColor),b.fontStrokeColor&&j.setAttributeNS(null,"stroke",b.fontStrokeColor),b.fontStrokeWidth&&j.setAttributeNS(null,"stroke-width",b.fontStrokeWidth),b.fontOpacity&&j.setAttributeNS(null,"opacity",b.fontOpacity),b.fontFamily&&j.setAttributeNS(null,"font-family",b.fontFamily),b.fontSize&&j.setAttributeNS(null,"font-size",b.fontSize),b.fontWeight&&j.setAttributeNS(null,"font-weight",b.fontWeight),b.fontStyle&&j.setAttributeNS(null,"font-style",b.fontStyle),b.labelSelect===!0?(j.setAttributeNS(null,"pointer-events","visible"),j._featureId=a):j.setAttributeNS(null,"pointer-events","none");var k=b.labelAlign||Tmap.Renderer.defaultSymbolizer.labelAlign;j.setAttributeNS(null,"text-anchor",Tmap.Renderer.SVG.LABEL_ALIGN[k[0]]||"middle"),Tmap.IS_GECKO===!0&&j.setAttributeNS(null,"dominant-baseline",Tmap.Renderer.SVG.LABEL_ALIGN[k[1]]||"central");for(var l=b.label.split("\n"),m=l.length;j.childNodes.length>m;)j.removeChild(j.lastChild);for(var n=0;m>n;n++){var o=this.nodeFactory(a+i+"_tspan_"+n,"tspan");if(b.labelSelect===!0&&(o._featureId=a,o._geometry=c,o._geometryClass=c.CLASS_NAME),Tmap.IS_GECKO===!1&&o.setAttributeNS(null,"baseline-shift",Tmap.Renderer.SVG.LABEL_VSHIFT[k[1]]||"-35%"),o.setAttribute("x",g),0==n){var p=Tmap.Renderer.SVG.LABEL_VFACTOR[k[1]];null==p&&(p=-.5),o.setAttribute("dy",p*(m-1)+"em")}else o.setAttribute("dy","1em");o.textContent=""===l[n]?" ":l[n],o.parentNode||j.appendChild(o)}j.parentNode||this.textRoot.appendChild(j)},getComponentsString:function(a,b){for(var c,d,e=[],f=!0,g=a.length,h=[],i=0;g>i;i++)d=a[i],e.push(d),c=this.getShortString(d),c?h.push(c):(i>0&&this.getShortString(a[i-1])&&h.push(this.clipLine(a[i],a[i-1])),g-1>i&&this.getShortString(a[i+1])&&h.push(this.clipLine(a[i],a[i+1])),f=!1);return{path:h.join(b||","),complete:f}},clipLine:function(a,b){if(b.equals(a))return"";var c,d=this.getResolution(),e=this.MAX_PIXEL-this.translationParameters.x,f=this.MAX_PIXEL-this.translationParameters.y,g=(b.x-this.featureDx)/d+this.left,h=this.top-b.y/d,i=(a.x-this.featureDx)/d+this.left,j=this.top-a.y/d;return(-e>i||i>e)&&(c=(j-h)/(i-g),i=0>i?-e:e,j=h+(i-g)*c),(-f>j||j>f)&&(c=(i-g)/(j-h),j=0>j?-f:f,i=g+(j-h)*c),i+","+j},getShortString:function(a){var b=this.getResolution(),c=(a.x-this.featureDx)/b+this.left,d=this.top-a.y/b;return this.inValidRange(c,d)?c+","+d:!1},getPosition:function(a){return{x:parseFloat(a.getAttributeNS(null,"cx")),y:parseFloat(a.getAttributeNS(null,"cy"))}},importSymbol:function(a){this.defs||(this.defs=this.createDefs());var b=this.container.id+"-"+a,c=document.getElementById(b);if(null!=c)return c;var d=Tmap.Renderer.symbol[a];if(!d)throw new Error(a+" is not a valid symbol name");var e=this.nodeFactory(b,"symbol"),f=this.nodeFactory(null,"polygon");e.appendChild(f);for(var g,h,i=new Tmap.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),j=[],k=0;k<d.length;k+=2)g=d[k],h=d[k+1],i.left=Math.min(i.left,g),i.bottom=Math.min(i.bottom,h),i.right=Math.max(i.right,g),i.top=Math.max(i.top,h),j.push(g,",",h);f.setAttributeNS(null,"points",j.join(" "));var l=i.getWidth(),m=i.getHeight(),n=[i.left-l,i.bottom-m,3*l,3*m];return e.setAttributeNS(null,"viewBox",n.join(" ")),this.symbolMetrics[b]=[Math.max(l,m),i.getCenterLonLat().lon,i.getCenterLonLat().lat],this.defs.appendChild(e),e},getFeatureIdFromEvent:function(a){var b=Tmap.Renderer.Elements.prototype.getFeatureIdFromEvent.apply(this,arguments);if(!b){var c=a.target;b=c.parentNode&&c!=this.rendererRoot?c.parentNode._featureId:void 0}return b},CLASS_NAME:"Tmap.Renderer.SVG"}),Tmap.Renderer.SVG.LABEL_ALIGN={l:"start",r:"end",b:"bottom",t:"hanging"},Tmap.Renderer.SVG.LABEL_VSHIFT={t:"-70%",b:"0"},Tmap.Renderer.SVG.LABEL_VFACTOR={t:0,b:-1},Tmap.Renderer.SVG.preventDefault=function(a){Tmap.Event.preventDefault(a)},Tmap.Renderer.Canvas=Tmap.Class(Tmap.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(a,b){Tmap.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){return Tmap.Renderer.prototype.setExtent.apply(this,arguments),!1},eraseGeometry:function(a,b){this.eraseFeatures(this.features[b][0])},supported:function(){return Tmap.CANVAS_SUPPORTED},setSize:function(a){this.size=a.clone();var b=this.root;if(b.style.width=a.w+"px",b.style.height=a.h+"px",b.width=a.w,b.height=a.h,this.resolution=null,this.hitDetection){var c=this.hitCanvas;c.style.width=a.w+"px",c.style.height=a.h+"px",c.width=a.w,c.height=a.h}},drawFeature:function(a,b){var c;if(a.geometry){b=this.applyDefaultSymbolizer(b||a.style);var d,e=a.geometry.getBounds();this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(d=this.map.getMaxExtent());var f=e&&e.intersectsBounds(this.extent,{worldBounds:d});c="none"!==b.display&&!!e&&f,c?this.features[a.id]=[a,b]:delete this.features[a.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),c},drawGeometry:function(a,b,c){var d=a.CLASS_NAME;if("Tmap.Geometry.Collection"!=d&&"Tmap.Geometry.MultiPoint"!=d&&"Tmap.Geometry.MultiLineString"!=d&&"Tmap.Geometry.MultiPolygon"!=d)switch(a.CLASS_NAME){case"Tmap.Geometry.Point":this.drawPoint(a,b,c);break;case"Tmap.Geometry.LineString":this.drawLineString(a,b,c);break;case"Tmap.Geometry.LinearRing":this.drawLinearRing(a,b,c);break;case"Tmap.Geometry.Polygon":this.drawPolygon(a,b,c)}else for(var e=0;e<a.components.length;e++)this.drawGeometry(a.components[e],b,c)},drawExternalGraphic:function(a,b,c){var d=new Image,e=b.title||b.graphicTitle;e&&(d.title=e);var f=b.graphicWidth||b.graphicHeight,g=b.graphicHeight||b.graphicWidth;f=f?f:2*b.pointRadius,g=g?g:2*b.pointRadius;var h=void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*f),i=void 0!=b.graphicYOffset?b.graphicYOffset:-(.5*g),j=b.graphicOpacity||b.fillOpacity,k=function(){if(this.features[c]){var b=this.getLocalXY(a),e=b[0],k=b[1];if(!isNaN(e)&&!isNaN(k)){var l=e+h|0,m=k+i|0,n=this.canvas;n.globalAlpha=j;var o=Tmap.Renderer.Canvas.drawImageScaleFactor||(Tmap.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);n.drawImage(d,l*o,m*o,f*o,g*o),this.hitDetection&&(this.setHitContextStyle("fill",c),this.hitContext.fillRect(l,m,f,g))}}};d.onload=Tmap.Function.bind(k,this),d.src=b.externalGraphic},drawNamedSymbol:function(a,b,c){var d,e,f,g,h,i,j,k,l,m=Math.PI/180,n=Tmap.Renderer.symbol[b.graphicName];if(!n)throw new Error(b.graphicName+" is not a valid symbol name");if(n.length&&!(n.length<2)){var o=this.getLocalXY(a),p=o[0],q=o[1];if(!isNaN(p)&&!isNaN(q)){if(this.canvas.lineCap="round",this.canvas.lineJoin="round",this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round"),b.graphicName in this.cachedSymbolBounds)i=this.cachedSymbolBounds[b.graphicName];else{for(i=new Tmap.Bounds,h=0;h<n.length;h+=2)i.extend(new Tmap.LonLat(n[h],n[h+1]));this.cachedSymbolBounds[b.graphicName]=i}if(this.canvas.save(),this.hitDetection&&this.hitContext.save(),this.canvas.translate(p,q),this.hitDetection&&this.hitContext.translate(p,q),k=m*b.rotation,isNaN(k)||(this.canvas.rotate(k),this.hitDetection&&this.hitContext.rotate(k)),j=2*b.pointRadius/Math.max(i.getWidth(),i.getHeight()),this.canvas.scale(j,j),this.hitDetection&&this.hitContext.scale(j,j),f=i.getCenterLonLat().lon,g=i.getCenterLonLat().lat,this.canvas.translate(-f,-g),this.hitDetection&&this.hitContext.translate(-f,-g),l=b.strokeWidth,b.strokeWidth=l/j,b.fill!==!1){for(this.setCanvasStyle("fill",b),this.canvas.beginPath(),h=0;h<n.length;h+=2)d=n[h],e=n[h+1],0==h&&this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);if(this.canvas.closePath(),this.canvas.fill(),this.hitDetection){for(this.setHitContextStyle("fill",c,b),this.hitContext.beginPath(),h=0;h<n.length;h+=2)d=n[h],e=n[h+1],0==h&&this.canvas.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath(),this.hitContext.fill()}}if(b.stroke!==!1){for(this.setCanvasStyle("stroke",b),this.canvas.beginPath(),h=0;h<n.length;h+=2)d=n[h],e=n[h+1],0==h&&this.canvas.moveTo(d,e),this.canvas.lineTo(d,e);if(this.canvas.closePath(),this.canvas.stroke(),this.hitDetection){for(this.setHitContextStyle("stroke",c,b,j),this.hitContext.beginPath(),h=0;h<n.length;h+=2)d=n[h],e=n[h+1],0==h&&this.hitContext.moveTo(d,e),this.hitContext.lineTo(d,e);this.hitContext.closePath(),this.hitContext.stroke()}}b.strokeWidth=l,this.canvas.restore(),this.hitDetection&&this.hitContext.restore(),this.setCanvasStyle("reset")}}},setCanvasStyle:function(a,b){"fill"===a?(this.canvas.globalAlpha=b.fillOpacity,this.canvas.fillStyle=b.fillColor):"stroke"===a?(this.canvas.globalAlpha=b.strokeOpacity,this.canvas.strokeStyle=b.strokeColor,this.canvas.lineWidth=b.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(a){var b=Number(a.split("_").pop())+1;b>=16777216&&(this.hitOverflow=b-16777215,b=b%16777216+1);var c="000000"+b.toString(16),d=c.length;return c="#"+c.substring(d-6,d)},setHitContextStyle:function(a,b,c,d){var e=this.featureIdToHex(b);"fill"==a?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=e):"stroke"==a?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=e,"undefined"==typeof d?this.hitContext.lineWidth=c.strokeWidth+2:isNaN(d)||(this.hitContext.lineWidth=c.strokeWidth+2/d)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(a,b,c){if(b.graphic!==!1)if(b.externalGraphic)this.drawExternalGraphic(a,b,c);else if(b.graphicName&&"circle"!=b.graphicName)this.drawNamedSymbol(a,b,c);else{var d=this.getLocalXY(a),e=d[0],f=d[1];if(!isNaN(e)&&!isNaN(f)){var g=2*Math.PI,h=b.pointRadius;b.fill!==!1&&(this.setCanvasStyle("fill",b),this.canvas.beginPath(),this.canvas.arc(e,f,h,0,g,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",c,b),this.hitContext.beginPath(),this.hitContext.arc(e,f,h,0,g,!0),this.hitContext.fill())),b.stroke!==!1&&(this.setCanvasStyle("stroke",b),this.canvas.beginPath(),this.canvas.arc(e,f,h,0,g,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",c,b),this.hitContext.beginPath(),this.hitContext.arc(e,f,h,0,g,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(a,b,c){b=Tmap.Util.applyDefaults({fill:!1},b),this.drawLinearRing(a,b,c)},drawLinearRing:function(a,b,c){b.fill!==!1&&(this.setCanvasStyle("fill",b),this.renderPath(this.canvas,a,b,c,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",c,b),this.renderPath(this.hitContext,a,b,c,"fill"))),b.stroke!==!1&&(this.setCanvasStyle("stroke",b),this.renderPath(this.canvas,a,b,c,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",c,b),this.renderPath(this.hitContext,a,b,c,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(a,b,c,d,e){var f=b.components,g=f.length;a.beginPath();var h=this.getLocalXY(f[0]),i=h[0],j=h[1];if(!isNaN(i)&&!isNaN(j)){a.moveTo(h[0],h[1]);for(var k=1;g>k;++k){var l=this.getLocalXY(f[k]);a.lineTo(l[0],l[1])}"fill"===e?a.fill():a.stroke()}},drawPolygon:function(a,b,c){var d=a.components,e=d.length;this.drawLinearRing(d[0],b,c);for(var f=1;e>f;++f)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(d[f],Tmap.Util.applyDefaults({stroke:!1,fillOpacity:1},b),c),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(d[f],Tmap.Util.applyDefaults({fill:!1},b),c)},drawText:function(a,b){var c=this.getLocalXY(a);this.setCanvasStyle("reset"),this.canvas.fillStyle=b.fontColor,this.canvas.globalAlpha=b.fontOpacity||1;var d=[b.fontStyle?b.fontStyle:"normal","normal",b.fontWeight?b.fontWeight:"normal",b.fontSize?b.fontSize:"1em",b.fontFamily?b.fontFamily:"sans-serif"].join(" "),e=b.label.split("\n"),f=e.length;if(this.canvas.fillText){this.canvas.font=d,this.canvas.textAlign=Tmap.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[0]]||"center",this.canvas.textBaseline=Tmap.Renderer.Canvas.LABEL_ALIGN[b.labelAlign[1]]||"middle";var g=Tmap.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];null==g&&(g=-.5);var h=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;c[1]+=h*g*(f-1);for(var i=0;f>i;i++)b.labelOutlineWidth&&(this.canvas.save(),this.canvas.strokeStyle=b.labelOutlineColor,this.canvas.lineWidth=b.labelOutlineWidth,this.canvas.strokeText(e[i],c[0],c[1]+h*i+1),this.canvas.restore()),this.canvas.fillText(e[i],c[0],c[1]+h*i)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=d;var j=Tmap.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[0]];null==j&&(j=-.5);var g=Tmap.Renderer.Canvas.LABEL_FACTOR[b.labelAlign[1]];null==g&&(g=-.5);var h=this.canvas.mozMeasureText("xx");c[1]+=h*(1+g*f);for(var i=0;f>i;i++){var k=c[0]+j*this.canvas.mozMeasureText(e[i]),l=c[1]+i*h;this.canvas.translate(k,l),this.canvas.mozDrawText(e[i]),this.canvas.translate(-k,-l)}}this.setCanvasStyle("reset")},getLocalXY:function(a){var b=this.getResolution(),c=this.extent,d=(a.x-this.featureDx)/b+-c.left/b,e=c.top/b-a.y/b;return[d,e]},clear:function(){var a=this.root.height,b=this.root.width;this.canvas.clearRect(0,0,b,a),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,b,a)},getFeatureIdFromEvent:function(a){var b,c;if(this.hitDetection&&"none"!==this.root.style.display&&!this.map.dragging){var d=a.xy,e=0|d.x,f=0|d.y,g=this.hitContext.getImageData(e,f,1,1).data;if(255===g[3]){var h=g[2]+256*(g[1]+256*g[0]);if(h){b="Tmap_Feature_Vector_"+(h-1+this.hitOverflow);try{c=this.features[b][0]}catch(i){}}}}return c},eraseFeatures:function(a){Tmap.Util.isArray(a)||(a=[a]);for(var b=0;b<a.length;++b)delete this.features[a[b].id];this.redraw()},redraw:function(){if(!this.locked){var a=this.root.height,b=this.root.width;this.canvas.clearRect(0,0,b,a),this.hitDetection&&this.hitContext.clearRect(0,0,b,a);var c,d,e,f=[],g=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var h in this.features)this.features.hasOwnProperty(h)&&(c=this.features[h][0],d=c.geometry,this.calculateFeatureDx(d.getBounds(),g),e=this.features[h][1],this.drawGeometry(d,e,c.id),e.label&&f.push([c,e]));for(var i,j=0,k=f.length;k>j;++j)i=f[j],this.drawText(i[0].geometry.getCentroid(),i[1])}},CLASS_NAME:"Tmap.Renderer.Canvas"}),Tmap.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},Tmap.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},Tmap.Renderer.Canvas.drawImageScaleFactor=null,Tmap.Renderer.VML=Tmap.Class(Tmap.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(a){if(this.supported()){if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);for(var b=document.createStyleSheet(),c=["shape","rect","oval","fill","stroke","imagedata","group","textbox"],d=0,e=c.length;e>d;d++)b.addRule("olv\\:"+c[d],"behavior: url(#default#VML); position: absolute; display: inline-block;")}Tmap.Renderer.Elements.prototype.initialize.apply(this,arguments)}},supported:function(){return!!document.namespaces},setExtent:function(a,b){var c=Tmap.Renderer.Elements.prototype.setExtent.apply(this,arguments),d=this.getResolution(),e=a.left/d|0,f=a.top/d-this.size.h|0;b||!this.offset?(this.offset={x:e,y:f},e=0,f=0):(e-=this.offset.x,f-=this.offset.y);var g=e-this.xOffset+" "+f;this.root.coordorigin=g;for(var h,i=[this.root,this.vectorRoot,this.textRoot],j=0,k=i.length;k>j;++j){h=i[j];var l=this.size.w+" "+this.size.h;h.coordsize=l}return this.root.style.flip="y",c},setSize:function(a){Tmap.Renderer.prototype.setSize.apply(this,arguments);for(var b,c=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],d=this.size.w+"px",e=this.size.h+"px",f=0,g=c.length;g>f;++f)b=c[f],b.style.width=d,b.style.height=e},getNodeType:function(a,b){var c=null;switch(a.CLASS_NAME){case"Tmap.Geometry.Point":c=b.externalGraphic?"olv:rect":this.isComplexSymbol(b.graphicName)?"olv:shape":"olv:oval";break;case"Tmap.Geometry.Rectangle":c="olv:rect";break;case"Tmap.Geometry.LineString":case"Tmap.Geometry.LinearRing":case"Tmap.Geometry.Polygon":case"Tmap.Geometry.Curve":c="olv:shape"}return c},setStyle:function(a,b,c,d){b=b||a._style,c=c||a._options;var e=b.fillColor,f=b.title||b.graphicTitle;if(f&&(a.title=f),"Tmap.Geometry.Point"===a._geometryClass)if(b.externalGraphic){c.isFilled=!0;var g=b.graphicWidth||b.graphicHeight,h=b.graphicHeight||b.graphicWidth;g=g?g:2*b.pointRadius,h=h?h:2*b.pointRadius;var i=this.getResolution(),j=void 0!=b.graphicXOffset?b.graphicXOffset:-(.5*g),k=void 0!=b.graphicYOffset?b.graphicYOffset:-(.5*h);a.style.left=((d.x-this.featureDx)/i-this.offset.x+j|0)+"px",a.style.top=(d.y/i-this.offset.y-(k+h)|0)+"px",a.style.width=g+"px",a.style.height=h+"px",a.style.flip="y",e="none",c.isStroked=!1}else if(this.isComplexSymbol(b.graphicName)){var l=this.importSymbol(b.graphicName);a.path=l.path,a.coordorigin=l.left+","+l.bottom;var m=l.size;a.coordsize=m+","+m,this.drawCircle(a,d,b.pointRadius),a.style.flip="y"}else this.drawCircle(a,d,b.pointRadius);c.isFilled?a.fillcolor=e:a.filled="false";var n=a.getElementsByTagName("fill"),o=0==n.length?null:n[0];c.isFilled?(o||(o=this.createNode("olv:fill",a.id+"_fill")),o.opacity=b.fillOpacity,"Tmap.Geometry.Point"===a._geometryClass&&b.externalGraphic&&(b.graphicOpacity&&(o.opacity=b.graphicOpacity),o.src=b.externalGraphic,o.type="frame",b.graphicWidth&&b.graphicHeight||(o.aspect="atmost")),o.parentNode!=a&&a.appendChild(o)):o&&a.removeChild(o);var p=b.rotation;(void 0!==p||void 0!==a._rotation)&&(a._rotation=p,b.externalGraphic?(this.graphicRotate(a,j,k,b),o.opacity=0):"Tmap.Geometry.Point"===a._geometryClass&&(a.style.rotation=p||0));var q=a.getElementsByTagName("stroke"),r=0==q.length?null:q[0];return c.isStroked?(r||(r=this.createNode("olv:stroke",a.id+"_stroke"),a.appendChild(r)),r.on=!0,r.color=b.strokeColor,r.weight=b.strokeWidth+"px",r.opacity=b.strokeOpacity,r.endcap="butt"==b.strokeLinecap?"flat":b.strokeLinecap||"round",b.strokeDashstyle&&(r.dashstyle=this.dashStyle(b))):(a.stroked=!1,r&&(r.on=!1)),"inherit"!=b.cursor&&null!=b.cursor&&(a.style.cursor=b.cursor),a},graphicRotate:function(a,b,c,d){var e,f,d=d||a._style,g=d.rotation||0;if(!d.graphicWidth||!d.graphicHeight){var h=new Image;return h.onreadystatechange=Tmap.Function.bind(function(){("complete"==h.readyState||"interactive"==h.readyState)&&(e=h.width/h.height,f=Math.max(2*d.pointRadius,d.graphicWidth||0,d.graphicHeight||0),b*=e,d.graphicWidth=f*e,d.graphicHeight=f,this.graphicRotate(a,b,c,d))},this),void(h.src=d.externalGraphic)}f=Math.max(d.graphicWidth,d.graphicHeight),e=d.graphicWidth/d.graphicHeight;var i=Math.round(d.graphicWidth||f*e),j=Math.round(d.graphicHeight||f);a.style.width=i+"px",a.style.height=j+"px";var k=document.getElementById(a.id+"_image");k||(k=this.createNode("olv:imagedata",a.id+"_image"),a.appendChild(k)),k.style.width=i+"px",k.style.height=j+"px",k.src=d.externalGraphic,k.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var l=g*Math.PI/180,m=Math.sin(l),n=Math.cos(l),o="progid:DXImageTransform.Microsoft.Matrix(M11="+n+",M12="+-m+",M21="+m+",M22="+n+",SizingMethod='auto expand')\n",p=d.graphicOpacity||d.fillOpacity;p&&1!=p&&(o+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+p+")\n"),a.style.filter=o;var q=new Tmap.Geometry.Point(-b,-c),r=new Tmap.Bounds(0,0,i,j).toGeometry();r.rotate(d.rotation,q);var s=r.getBounds();a.style.left=Math.round(parseInt(a.style.left)+s.left)+"px",a.style.top=Math.round(parseInt(a.style.top)-s.bottom)+"px"},postDraw:function(a){a.style.visibility="visible";var b=a._style.fillColor,c=a._style.strokeColor;"none"==b&&a.fillcolor!=b&&(a.fillcolor=b),"none"==c&&a.strokecolor!=c&&(a.strokecolor=c)},setNodeDimension:function(a,b){var c=b.getBounds();if(c){var d=this.getResolution(),e=new Tmap.Bounds((c.left-this.featureDx)/d-this.offset.x|0,c.bottom/d-this.offset.y|0,(c.right-this.featureDx)/d-this.offset.x|0,c.top/d-this.offset.y|0);a.style.left=e.left+"px",a.style.top=e.top+"px",a.style.width=e.getWidth()+"px",a.style.height=e.getHeight()+"px",a.coordorigin=e.left+" "+e.top,a.coordsize=e.getWidth()+" "+e.getHeight()}},dashStyle:function(a){var b=a.strokeDashstyle;switch(b){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return b;default:var c=b.split(/[ ,]/);return 2==c.length?1*c[0]>=2*c[1]?"longdash":1==c[0]||1==c[1]?"dot":"dash":4==c.length?1*c[0]>=2*c[1]?"longdashdot":"dashdot":"solid"}},createNode:function(a,b){var c=document.createElement(a);return b&&(c.id=b),c.unselectable="on",c.onselectstart=Tmap.Function.False,c},nodeTypeCompare:function(a,b){var c=b,d=c.indexOf(":");-1!=d&&(c=c.substr(d+1));var e=a.nodeName;return d=e.indexOf(":"),-1!=d&&(e=e.substr(d+1)),c==e},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(a){return this.nodeFactory(this.container.id+a,"olv:group")},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(a,b,c){if(!isNaN(b.x)&&!isNaN(b.y)){var d=this.getResolution();a.style.left=((b.x-this.featureDx)/d-this.offset.x|0)-c+"px",a.style.top=(b.y/d-this.offset.y|0)-c+"px";var e=2*c;return a.style.width=e+"px",a.style.height=e+"px",a}return!1},drawLineString:function(a,b){return this.drawLine(a,b,!1)},drawLinearRing:function(a,b){return this.drawLine(a,b,!0)},drawLine:function(a,b,c){this.setNodeDimension(a,b);for(var d,e,f,g=this.getResolution(),h=b.components.length,i=new Array(h),j=0;h>j;j++)d=b.components[j],e=(d.x-this.featureDx)/g-this.offset.x|0,f=d.y/g-this.offset.y|0,i[j]=" "+e+","+f+" l ";var k=c?" x e":" e";return a.path="m"+i.join("")+k,a},drawPolygon:function(a,b){this.setNodeDimension(a,b);var c,d,e,f,g,h,i,j,k,l,m,n,o=this.getResolution(),p=[];for(c=0,d=b.components.length;d>c;c++){for(p.push("m"),e=b.components[c].components,f=0===c,g=null,h=null,i=0,j=e.length;j>i;i++)k=e[i],m=(k.x-this.featureDx)/o-this.offset.x|0,n=k.y/o-this.offset.y|0,l=" "+m+","+n,p.push(l),0==i&&p.push(" l"),f||(g?g!=l&&(h?h!=l&&(f=!0):h=l):g=l);p.push(f?" x ":" ")}return p.push("e"),a.path=p.join(""),a},drawRectangle:function(a,b){var c=this.getResolution();return a.style.left=((b.x-this.featureDx)/c-this.offset.x|0)+"px",a.style.top=(b.y/c-this.offset.y|0)+"px",a.style.width=(b.width/c|0)+"px",a.style.height=(b.height/c|0)+"px",a},drawText:function(a,b,c){var d=this.nodeFactory(a+this.LABEL_ID_SUFFIX,"olv:rect"),e=this.nodeFactory(a+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),f=this.getResolution();
d.style.left=((c.x-this.featureDx)/f-this.offset.x|0)+"px",d.style.top=(c.y/f-this.offset.y|0)+"px",d.style.flip="y",e.innerText=b.label,"inherit"!=b.cursor&&null!=b.cursor&&(e.style.cursor=b.cursor),b.fontColor&&(e.style.color=b.fontColor),b.fontOpacity&&(e.style.filter="alpha(opacity="+100*b.fontOpacity+")"),b.fontFamily&&(e.style.fontFamily=b.fontFamily),b.fontSize&&(e.style.fontSize=b.fontSize),b.fontWeight&&(e.style.fontWeight=b.fontWeight),b.fontStyle&&(e.style.fontStyle=b.fontStyle),b.labelSelect===!0&&(d._featureId=a,e._featureId=a,e._geometry=c,e._geometryClass=c.CLASS_NAME),e.style.whiteSpace="nowrap",e.inset="1px,0px,0px,0px",d.parentNode||(d.appendChild(e),this.textRoot.appendChild(d));var g=b.labelAlign||"cm";1==g.length&&(g+="m");var h=e.clientWidth*Tmap.Renderer.VML.LABEL_SHIFT[g.substr(0,1)],i=e.clientHeight*Tmap.Renderer.VML.LABEL_SHIFT[g.substr(1,1)];d.style.left=parseInt(d.style.left)-h-1+"px",d.style.top=parseInt(d.style.top)+i+"px"},moveRoot:function(a){var b=this.map.getLayer(a.container.id);b instanceof Tmap.Layer.Vector.RootContainer&&(b=this.map.getLayer(this.container.id)),b&&b.renderer.clear(),Tmap.Renderer.Elements.prototype.moveRoot.apply(this,arguments),b&&b.redraw()},importSymbol:function(a){var b=this.container.id+"-"+a,c=this.symbolCache[b];if(c)return c;var d=Tmap.Renderer.symbol[a];if(!d)throw new Error(a+" is not a valid symbol name");for(var e=new Tmap.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),f=["m"],g=0;g<d.length;g+=2){var h=d[g],i=d[g+1];e.left=Math.min(e.left,h),e.bottom=Math.min(e.bottom,i),e.right=Math.max(e.right,h),e.top=Math.max(e.top,i),f.push(h),f.push(i),0==g&&f.push("l")}f.push("x e");var j=f.join(" "),k=(e.getWidth()-e.getHeight())/2;return k>0?(e.bottom=e.bottom-k,e.top=e.top+k):(e.left=e.left+k,e.right=e.right-k),c={path:j,size:e.getWidth(),left:e.left,bottom:e.bottom},this.symbolCache[b]=c,c},CLASS_NAME:"Tmap.Renderer.VML"}),Tmap.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1},Tmap.Layer.Vector=Tmap.Class(Tmap.Layer,{isBaseLayer:!1,isFixed:!1,features:null,filter:null,selectedFeatures:null,unrenderedFeatures:null,reportError:!0,style:null,styleMap:null,strategies:null,protocol:null,renderers:["SVG","VML","Canvas"],renderer:null,rendererOptions:null,geometryType:null,drawn:!1,ratio:1,initialize:function(a,b){if(Tmap.Layer.prototype.initialize.apply(this,arguments),this.renderer&&this.renderer.supported()||this.assignRenderer(),this.renderer&&this.renderer.supported()||(this.renderer=null,this.displayError()),this.styleMap||(this.styleMap=new Tmap.StyleMap),this.features=[],this.selectedFeatures=[],this.unrenderedFeatures={},this.strategies)for(var c=0,d=this.strategies.length;d>c;c++)this.strategies[c].setLayer(this)},destroy:function(){if(this.strategies){var a,b,c;for(b=0,c=this.strategies.length;c>b;b++)a=this.strategies[b],a.autoDestroy&&a.destroy();this.strategies=null}this.protocol&&(this.protocol.autoDestroy&&this.protocol.destroy(),this.protocol=null),this.destroyFeatures(),this.features=null,this.selectedFeatures=null,this.unrenderedFeatures=null,this.renderer&&this.renderer.destroy(),this.renderer=null,this.geometryType=null,this.drawn=null,Tmap.Layer.prototype.destroy.apply(this,arguments)},clone:function(a){null==a&&(a=new Tmap.Layer.Vector(this.name,this.getOptions())),a=Tmap.Layer.prototype.clone.apply(this,[a]);for(var b=this.features,c=b.length,d=new Array(c),e=0;c>e;++e)d[e]=b[e].clone();return a.features=d,a},refresh:function(a){this.calculateInRange()&&this.visibility&&this.events.triggerEvent("refresh",a)},assignRenderer:function(){for(var a=0,b=this.renderers.length;b>a;a++){var c=this.renderers[a],d="function"==typeof c?c:Tmap.Renderer[c];if(d&&d.prototype.supported()){this.renderer=new d(this.div,this.rendererOptions);break}}},displayError:function(){this.reportError&&Tmap.Console.userError(Tmap.i18n("browserNotSupported",{renderers:this.renderers.join("\n")}))},setMap:function(a){if(Tmap.Layer.prototype.setMap.apply(this,arguments),this.renderer){this.renderer.map=this.map;var b=this.map.getSize();b.w=b.w*this.ratio,b.h=b.h*this.ratio,this.renderer.setSize(b)}else this.map.removeLayer(this)},afterAdd:function(){if(this.strategies){var a,b,c;for(b=0,c=this.strategies.length;c>b;b++)a=this.strategies[b],a.autoActivate&&a.activate()}},removeMap:function(a){if(this.drawn=!1,this.strategies){var b,c,d;for(c=0,d=this.strategies.length;d>c;c++)b=this.strategies[c],b.autoActivate&&b.deactivate()}},onMapResize:function(){Tmap.Layer.prototype.onMapResize.apply(this,arguments);var a=this.map.getSize();a.w=a.w*this.ratio,a.h=a.h*this.ratio,this.renderer.setSize(a)},moveTo:function(a,b,c){Tmap.Layer.prototype.moveTo.apply(this,arguments);var d=!0;if(!c){this.renderer.root.style.visibility="hidden";var e=this.map.getSize(),f=e.w,g=e.h,h=f/2*this.ratio-f/2,i=g/2*this.ratio-g/2;h+=this.map.layerContainerOriginPx.x,h=-Math.round(h),i+=this.map.layerContainerOriginPx.y,i=-Math.round(i),this.div.style.left=h+"px",this.div.style.top=i+"px";var j=this.map.getExtent().scale(this.ratio);if(d=this.renderer.setExtent(j,b),this.renderer.root.style.visibility="visible",Tmap.IS_GECKO===!0&&(this.div.scrollLeft=this.div.scrollLeft),!b&&d)for(var k in this.unrenderedFeatures){var l=this.unrenderedFeatures[k];this.drawFeature(l)}}if(!this.drawn||b||!d){this.drawn=!0;for(var l,k=0,m=this.features.length;m>k;k++)this.renderer.locked=k!==m-1,l=this.features[k],this.drawFeature(l)}},display:function(a){Tmap.Layer.prototype.display.apply(this,arguments);var b=this.div.style.display;b!=this.renderer.root.style.display&&(this.renderer.root.style.display=b)},addFeatures:function(a,b){Tmap.Util.isArray(a)||(a=[a]);var c=!b||!b.silent;if(c){var d={features:a},e=this.events.triggerEvent("beforefeaturesadded",d);if(e===!1)return;a=d.features}for(var f=[],g=0,h=a.length;h>g;g++){g!=a.length-1?this.renderer.locked=!0:this.renderer.locked=!1;var i=a[g];if(this.geometryType&&!(i.geometry instanceof this.geometryType))throw new TypeError("addFeatures: component should be an "+this.geometryType.prototype.CLASS_NAME);if(i.layer=this,!i.style&&this.style&&(i.style=Tmap.Util.extend({},this.style)),c){if(this.events.triggerEvent("beforefeatureadded",{feature:i})===!1)continue;this.preFeatureInsert(i)}f.push(i),this.features.push(i),this.drawFeature(i),c&&(this.events.triggerEvent("featureadded",{feature:i}),this.onFeatureInsert(i))}c&&this.events.triggerEvent("featuresadded",{features:f})},removeFeatures:function(a,b){if(a&&0!==a.length){if(a===this.features)return this.removeAllFeatures(b);Tmap.Util.isArray(a)||(a=[a]),a===this.selectedFeatures&&(a=a.slice());var c=!b||!b.silent;c&&this.events.triggerEvent("beforefeaturesremoved",{features:a});for(var d=a.length-1;d>=0;d--){0!=d&&a[d-1].geometry?this.renderer.locked=!0:this.renderer.locked=!1;var e=a[d];delete this.unrenderedFeatures[e.id],c&&this.events.triggerEvent("beforefeatureremoved",{feature:e}),this.features=Tmap.Util.removeItem(this.features,e),e.layer=null,e.geometry&&this.renderer.eraseFeatures(e),-1!=Tmap.Util.indexOf(this.selectedFeatures,e)&&Tmap.Util.removeItem(this.selectedFeatures,e),c&&this.events.triggerEvent("featureremoved",{feature:e})}c&&this.events.triggerEvent("featuresremoved",{features:a})}},removeAllFeatures:function(a){var b=!a||!a.silent,c=this.features;b&&this.events.triggerEvent("beforefeaturesremoved",{features:c});for(var d,e=c.length-1;e>=0;e--)d=c[e],b&&this.events.triggerEvent("beforefeatureremoved",{feature:d}),d.layer=null,b&&this.events.triggerEvent("featureremoved",{feature:d});this.renderer.clear(),this.features=[],this.unrenderedFeatures={},this.selectedFeatures=[],b&&this.events.triggerEvent("featuresremoved",{features:c})},destroyFeatures:function(a,b){var c=void 0==a;if(c&&(a=this.features),a){this.removeFeatures(a,b);for(var d=a.length-1;d>=0;d--)a[d].destroy()}},drawFeature:function(a,b){if(this.drawn){if("object"!=typeof b){b||a.state!==Tmap.State.DELETE||(b="delete");var c=b||a.renderIntent;b=a.style||this.style,b||(b=this.styleMap.createSymbolizer(a,c))}var d=this.renderer.drawFeature(a,b);d===!1||null===d?this.unrenderedFeatures[a.id]=a:delete this.unrenderedFeatures[a.id]}},eraseFeatures:function(a){this.renderer.eraseFeatures(a)},getFeatureFromEvent:function(a){if(!this.renderer)throw new Error("getFeatureFromEvent called on layer with no renderer. This usually means you destroyed a layer, but not some handler which is associated with it.");var b=null,c=this.renderer.getFeatureIdFromEvent(a);return c&&(b="string"==typeof c?this.getFeatureById(c):c),b},getFeatureBy:function(a,b){for(var c=null,d=0,e=this.features.length;e>d;++d)if(this.features[d][a]==b){c=this.features[d];break}return c},getFeatureById:function(a){return this.getFeatureBy("id",a)},getFeatureByFid:function(a){return this.getFeatureBy("fid",a)},getFeaturesByAttribute:function(a,b){var c,d,e=this.features.length,f=[];for(c=0;e>c;c++)d=this.features[c],d&&d.attributes&&d.attributes[a]===b&&f.push(d);return f},onFeatureInsert:function(a){},preFeatureInsert:function(a){},getDataExtent:function(){var a=null,b=this.features;if(b&&b.length>0)for(var c=null,d=0,e=b.length;e>d;d++)c=b[d].geometry,c&&(null===a&&(a=new Tmap.Bounds),a.extend(c.getBounds()));return a},CLASS_NAME:"Tmap.Layer.Vector"}),Tmap.Layer.PointGrid=Tmap.Class(Tmap.Layer.Vector,{dx:null,dy:null,ratio:1.5,maxFeatures:250,rotation:0,origin:null,gridBounds:null,initialize:function(a){a=a||{},Tmap.Layer.Vector.prototype.initialize.apply(this,[a.name,a])},setMap:function(a){Tmap.Layer.Vector.prototype.setMap.apply(this,arguments),a.events.register("moveend",this,this.onMoveEnd)},removeMap:function(a){a.events.unregister("moveend",this,this.onMoveEnd),Tmap.Layer.Vector.prototype.removeMap.apply(this,arguments)},setRatio:function(a){this.ratio=a,this.updateGrid(!0)},setMaxFeatures:function(a){this.maxFeatures=a,this.updateGrid(!0)},setSpacing:function(a,b){this.dx=a,this.dy=b||a,this.updateGrid(!0)},setOrigin:function(a){this.origin=a,this.updateGrid(!0)},getOrigin:function(){return this.origin||(this.origin=this.map.getExtent().getCenterLonLat()),this.origin},setRotation:function(a){this.rotation=a,this.updateGrid(!0)},onMoveEnd:function(){this.updateGrid()},getViewBounds:function(){var a=this.map.getExtent();if(this.rotation){var b=this.getOrigin(),c=new Tmap.Geometry.Point(b.lon,b.lat),d=a.toGeometry();d.rotate(-this.rotation,c),a=d.getBounds()}return a},updateGrid:function(a){if(a||this.invalidBounds()){var b=this.getViewBounds(),c=this.getOrigin(),d=new Tmap.Geometry.Point(c.lon,c.lat),e=b.getWidth(),f=b.getHeight(),g=e/f,h=Math.sqrt(this.dx*this.dy*this.maxFeatures/g),i=h*g,j=Math.min(e*this.ratio,i),k=Math.min(f*this.ratio,h),l=b.getCenterLonLat();this.gridBounds=new Tmap.Bounds(l.lon-j/2,l.lat-k/2,l.lon+j/2,l.lat+k/2);for(var m,n,o,p=Math.floor(k/this.dy),q=Math.floor(j/this.dx),r=c.lon+this.dx*Math.ceil((this.gridBounds.left-c.lon)/this.dx),s=c.lat+this.dy*Math.ceil((this.gridBounds.bottom-c.lat)/this.dy),t=new Array(p*q),u=0;q>u;++u){m=r+u*this.dx;for(var v=0;p>v;++v)n=s+v*this.dy,o=new Tmap.Geometry.Point(m,n),this.rotation&&o.rotate(this.rotation,d),t[u*p+v]=new Tmap.Feature.Vector(o)}this.destroyFeatures(this.features,{silent:!0}),this.addFeatures(t,{silent:!0})}},invalidBounds:function(){return!this.gridBounds||!this.gridBounds.containsBounds(this.getViewBounds())},CLASS_NAME:"Tmap.Layer.PointGrid"}),Tmap.Layer.Vector.RootContainer=Tmap.Class(Tmap.Layer.Vector,{displayInLayerSwitcher:!1,layers:null,display:function(){},getFeatureFromEvent:function(a){for(var b,c=this.layers,d=0;d<c.length;d++)if(b=c[d].getFeatureFromEvent(a))return b},setMap:function(a){Tmap.Layer.Vector.prototype.setMap.apply(this,arguments),this.collectRoots(),a.events.register("changelayer",this,this.handleChangeLayer)},removeMap:function(a){a.events.unregister("changelayer",this,this.handleChangeLayer),this.resetRoots(),Tmap.Layer.Vector.prototype.removeMap.apply(this,arguments)},collectRoots:function(){for(var a,b=0;b<this.map.layers.length;++b)a=this.map.layers[b],-1!=Tmap.Util.indexOf(this.layers,a)&&a.renderer.moveRoot(this.renderer)},resetRoots:function(){for(var a,b=0;b<this.layers.length;++b)a=this.layers[b],this.renderer&&a.renderer.getRenderLayerId()==this.id&&this.renderer.moveRoot(a.renderer)},handleChangeLayer:function(a){var b=a.layer;"order"==a.property&&-1!=Tmap.Util.indexOf(this.layers,b)&&(this.resetRoots(),this.collectRoots())},CLASS_NAME:"Tmap.Layer.Vector.RootContainer"}),Tmap.Strategy=Tmap.Class({layer:null,options:null,active:null,autoActivate:!0,autoDestroy:!0,initialize:function(a){Tmap.Util.extend(this,a),this.options=a,this.active=!1},destroy:function(){this.deactivate(),this.layer=null,this.options=null},setLayer:function(a){this.layer=a},activate:function(){return this.active?!1:(this.active=!0,!0)},deactivate:function(){return this.active?(this.active=!1,!0):!1},CLASS_NAME:"Tmap.Strategy"}),Tmap.Strategy.Filter=Tmap.Class(Tmap.Strategy,{filter:null,cache:null,caching:!1,activate:function(){var a=Tmap.Strategy.prototype.activate.apply(this,arguments);return a&&(this.cache=[],this.layer.events.on({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this})),a},deactivate:function(){return this.cache=null,this.layer&&this.layer.events&&this.layer.events.un({beforefeaturesadded:this.handleAdd,beforefeaturesremoved:this.handleRemove,scope:this}),Tmap.Strategy.prototype.deactivate.apply(this,arguments)},handleAdd:function(a){if(!this.caching&&this.filter){var b=a.features;a.features=[];for(var c,d=0,e=b.length;e>d;++d)c=b[d],this.filter.evaluate(c)?a.features.push(c):this.cache.push(c)}},handleRemove:function(a){this.caching||(this.cache=[])},setFilter:function(a){this.filter=a;var b=this.cache;if(this.cache=[],this.handleAdd({features:this.layer.features}),this.cache.length>0&&(this.caching=!0,this.layer.removeFeatures(this.cache.slice()),this.caching=!1),b.length>0){var c={features:b};this.handleAdd(c),c.features.length>0&&(this.caching=!0,this.layer.addFeatures(c.features),this.caching=!1)}},CLASS_NAME:"Tmap.Strategy.Filter"}),Tmap.Strategy.Fixed=Tmap.Class(Tmap.Strategy,{preload:!1,activate:function(){return Tmap.Strategy.prototype.activate.apply(this,arguments)?(this.layer.events.on({refresh:this.load,scope:this}),1==this.layer.visibility||this.preload?this.load():this.layer.events.on({visibilitychanged:this.load,scope:this}),!0):!1},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&this.layer.events.un({refresh:this.load,visibilitychanged:this.load,scope:this}),a},load:function(a){var b=this.layer;b.events.triggerEvent("loadstart",{filter:b.filter}),b.protocol.read(Tmap.Util.applyDefaults({callback:Tmap.Function.bind(this.merge,this,b.map.getProjectionObject()),filter:b.filter},a)),b.events.un({visibilitychanged:this.load,scope:this})},merge:function(a,b){var c=this.layer;c.destroyFeatures();var d=b.features;if(d&&d.length>0){if(!a.equals(c.projection))for(var e,f=0,g=d.length;g>f;++f)e=d[f].geometry,e&&e.transform(c.projection,a);c.addFeatures(d)}c.events.triggerEvent("loadend",{response:b})},CLASS_NAME:"Tmap.Strategy.Fixed"}),Tmap.Strategy.Cluster=Tmap.Class(Tmap.Strategy,{distance:20,threshold:null,features:null,clusters:null,clustering:!1,resolution:null,activate:function(){var a=Tmap.Strategy.prototype.activate.call(this);return a&&this.layer.events.on({beforefeaturesadded:this.cacheFeatures,featuresremoved:this.clearCache,moveend:this.cluster,scope:this}),a},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&(this.clearCache(),this.layer.events.un({beforefeaturesadded:this.cacheFeatures,featuresremoved:this.clearCache,moveend:this.cluster,scope:this})),a},cacheFeatures:function(a){var b=!0;return this.clustering||(this.clearCache(),this.features=a.features,this.cluster(),b=!1),b},clearCache:function(){this.clustering||(this.features=null)},cluster:function(a){if((!a||a.zoomChanged)&&this.features){var b=this.layer.map.getResolution();if(b!=this.resolution||!this.clustersExist()){this.resolution=b;for(var c,d,e,f=[],g=0;g<this.features.length;++g)if(c=this.features[g],c.geometry){d=!1;for(var h=f.length-1;h>=0;--h)if(e=f[h],this.shouldCluster(e,c)){this.addToCluster(e,c),d=!0;break}d||f.push(this.createCluster(this.features[g]))}if(this.clustering=!0,this.layer.removeAllFeatures(),this.clustering=!1,f.length>0){if(this.threshold>1){var i=f.slice();f=[];for(var j,g=0,k=i.length;k>g;++g)j=i[g],j.attributes.count<this.threshold?Array.prototype.push.apply(f,j.cluster):f.push(j)}this.clustering=!0,this.layer.addFeatures(f),this.clustering=!1}this.clusters=f}}},clustersExist:function(){var a=!1;if(this.clusters&&this.clusters.length>0&&this.clusters.length==this.layer.features.length){a=!0;for(var b=0;b<this.clusters.length;++b)if(this.clusters[b]!=this.layer.features[b]){a=!1;break}}return a},shouldCluster:function(a,b){var c=a.geometry.getBounds().getCenterLonLat(),d=b.geometry.getBounds().getCenterLonLat(),e=Math.sqrt(Math.pow(c.lon-d.lon,2)+Math.pow(c.lat-d.lat,2))/this.resolution;return e<=this.distance},addToCluster:function(a,b){a.cluster.push(b),a.attributes.count+=1},createCluster:function(a){var b=a.geometry.getBounds().getCenterLonLat(),c=new Tmap.Feature.Vector(new Tmap.Geometry.Point(b.lon,b.lat),{count:1});return c.cluster=[a],c},CLASS_NAME:"Tmap.Strategy.Cluster"}),Tmap.Strategy.Paging=Tmap.Class(Tmap.Strategy,{features:null,length:10,num:null,paging:!1,activate:function(){var a=Tmap.Strategy.prototype.activate.call(this);return a&&this.layer.events.on({beforefeaturesadded:this.cacheFeatures,scope:this}),a},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&(this.clearCache(),this.layer.events.un({beforefeaturesadded:this.cacheFeatures,scope:this})),a},cacheFeatures:function(a){this.paging||(this.clearCache(),this.features=a.features,this.pageNext(a))},clearCache:function(){if(this.features)for(var a=0;a<this.features.length;++a)this.features[a].destroy();this.features=null,this.num=null},pageCount:function(){var a=this.features?this.features.length:0;return Math.ceil(a/this.length)},pageNum:function(){return this.num},pageLength:function(a){return a&&a>0&&(this.length=a),this.length},pageNext:function(a){var b=!1;if(this.features){null===this.num&&(this.num=-1);var c=(this.num+1)*this.length;b=this.page(c,a)}return b},pagePrevious:function(){var a=!1;if(this.features){null===this.num&&(this.num=this.pageCount());var b=(this.num-1)*this.length;a=this.page(b)}return a},page:function(a,b){var c=!1;if(this.features&&a>=0&&a<this.features.length){var d=Math.floor(a/this.length);if(d!=this.num){this.paging=!0;var e=this.features.slice(a,a+this.length);this.layer.removeFeatures(this.layer.features),this.num=d,b&&b.features?b.features=e:this.layer.addFeatures(e),this.paging=!1,c=!0}}return c},CLASS_NAME:"Tmap.Strategy.Paging"}),Tmap.Strategy.BBOX=Tmap.Class(Tmap.Strategy,{bounds:null,resolution:null,ratio:2,resFactor:null,response:null,activate:function(){var a=Tmap.Strategy.prototype.activate.call(this);return a&&(this.layer.events.on({moveend:this.update,refresh:this.update,visibilitychanged:this.update,scope:this}),this.update()),a},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&this.layer.events.un({moveend:this.update,refresh:this.update,visibilitychanged:this.update,scope:this}),a},update:function(a){var b=this.getMapBounds();null!==b&&(a&&a.force||this.layer.visibility&&this.layer.calculateInRange()&&this.invalidBounds(b))&&(this.calculateBounds(b),this.resolution=this.layer.map.getResolution(),this.triggerRead(a))},getMapBounds:function(){if(null===this.layer.map)return null;var a=this.layer.map.getExtent();return a&&!this.layer.projection.equals(this.layer.map.getProjectionObject())&&(a=a.clone().transform(this.layer.map.getProjectionObject(),this.layer.projection)),a},invalidBounds:function(a){a||(a=this.getMapBounds());var b=!this.bounds||!this.bounds.containsBounds(a);if(!b&&this.resFactor){var c=this.resolution/this.layer.map.getResolution();b=c>=this.resFactor||c<=1/this.resFactor}return b},calculateBounds:function(a){a||(a=this.getMapBounds());var b=a.getCenterLonLat(),c=a.getWidth()*this.ratio,d=a.getHeight()*this.ratio;this.bounds=new Tmap.Bounds(b.lon-c/2,b.lat-d/2,b.lon+c/2,b.lat+d/2)},triggerRead:function(a){!this.response||a&&a.noAbort===!0||(this.layer.protocol.abort(this.response),this.layer.events.triggerEvent("loadend"));var b={filter:this.createFilter()};this.layer.events.triggerEvent("loadstart",b),this.response=this.layer.protocol.read(Tmap.Util.applyDefaults({filter:b.filter,callback:this.merge,scope:this},a))},createFilter:function(){var a=new Tmap.Filter.Spatial({type:Tmap.Filter.Spatial.BBOX,value:this.bounds,projection:this.layer.projection});return this.layer.filter&&(a=new Tmap.Filter.Logical({type:Tmap.Filter.Logical.AND,filters:[this.layer.filter,a]})),a},merge:function(a){if(this.layer.destroyFeatures(),a.success()){var b=a.features;if(b&&b.length>0){var c=this.layer.projection,d=this.layer.map.getProjectionObject();if(!d.equals(c))for(var e,f=0,g=b.length;g>f;++f)e=b[f].geometry,e&&e.transform(c,d);this.layer.addFeatures(b)}}else this.bounds=null;this.response=null,this.layer.events.triggerEvent("loadend",{response:a})},CLASS_NAME:"Tmap.Strategy.BBOX"}),Tmap.Strategy.Save=Tmap.Class(Tmap.Strategy,{events:null,auto:!1,timer:null,initialize:function(a){Tmap.Strategy.prototype.initialize.apply(this,[a]),this.events=new Tmap.Events(this)},activate:function(){var a=Tmap.Strategy.prototype.activate.call(this);return a&&this.auto&&("number"==typeof this.auto?this.timer=window.setInterval(Tmap.Function.bind(this.save,this),1e3*this.auto):this.layer.events.on({featureadded:this.triggerSave,afterfeaturemodified:this.triggerSave,scope:this})),a},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&this.auto&&("number"==typeof this.auto?window.clearInterval(this.timer):this.layer.events.un({featureadded:this.triggerSave,afterfeaturemodified:this.triggerSave,scope:this})),a},triggerSave:function(a){var b=a.feature;(b.state===Tmap.State.INSERT||b.state===Tmap.State.UPDATE||b.state===Tmap.State.DELETE)&&this.save([a.feature])},save:function(a){a||(a=this.layer.features),this.events.triggerEvent("start",{features:a});var b=this.layer.projection,c=this.layer.map.getProjectionObject();if(!c.equals(b)){for(var d,e,f=a.length,g=new Array(f),h=0;f>h;++h)d=a[h],e=d.clone(),e.fid=d.fid,e.state=d.state,d.url&&(e.url=d.url),e._original=d,e.geometry.transform(c,b),g[h]=e;a=g}this.layer.protocol.commit(a,{callback:this.onCommit,scope:this})},onCommit:function(a){var b={response:a};if(a.success()){for(var c,d,e=a.reqFeatures,f=[],g=a.insertIds||[],h=0,i=0,j=e.length;j>i;++i)d=e[i],d=d._original||d,c=d.state,c&&(c==Tmap.State.DELETE?f.push(d):c==Tmap.State.INSERT&&(d.fid=g[h],++h),d.state=null);f.length>0&&this.layer.destroyFeatures(f),this.events.triggerEvent("success",b)}else this.events.triggerEvent("fail",b)},CLASS_NAME:"Tmap.Strategy.Save"}),Tmap.Strategy.Refresh=Tmap.Class(Tmap.Strategy,{force:!1,interval:0,timer:null,activate:function(){var a=Tmap.Strategy.prototype.activate.call(this);return a&&(this.layer.visibility===!0&&this.start(),this.layer.events.on({visibilitychanged:this.reset,scope:this})),a},deactivate:function(){var a=Tmap.Strategy.prototype.deactivate.call(this);return a&&(this.stop(),this.layer.events.un({visibilitychanged:this.reset,scope:this})),a},reset:function(){this.layer.visibility===!0?this.start():this.stop()},start:function(){this.interval&&"number"==typeof this.interval&&this.interval>0&&(this.timer=window.setInterval(Tmap.Function.bind(this.refresh,this),this.interval))},refresh:function(){this.layer&&this.layer.refresh&&"function"==typeof this.layer.refresh&&this.layer.refresh({force:this.force})},stop:function(){null!==this.timer&&(window.clearInterval(this.timer),this.timer=null)},CLASS_NAME:"Tmap.Strategy.Refresh"}),Tmap.Filter=Tmap.Class({initialize:function(a){Tmap.Util.extend(this,a)},destroy:function(){},evaluate:function(a){return!0},clone:function(){return null},toString:function(){var a;return a=Tmap.Format&&Tmap.Format.CQL?Tmap.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"Tmap.Filter"}),Tmap.Filter.FeatureId=Tmap.Class(Tmap.Filter,{fids:null,type:"FID",initialize:function(a){this.fids=[],Tmap.Filter.prototype.initialize.apply(this,[a])},evaluate:function(a){for(var b=0,c=this.fids.length;c>b;b++){var d=a.fid||a.id;if(d==this.fids[b])return!0}return!1},clone:function(){var a=new Tmap.Filter.FeatureId;return Tmap.Util.extend(a,this),a.fids=this.fids.slice(),a},CLASS_NAME:"Tmap.Filter.FeatureId"}),Tmap.Filter.Logical=Tmap.Class(Tmap.Filter,{filters:null,type:null,initialize:function(a){this.filters=[],Tmap.Filter.prototype.initialize.apply(this,[a])},destroy:function(){this.filters=null,Tmap.Filter.prototype.destroy.apply(this)},evaluate:function(a){var b,c;switch(this.type){case Tmap.Filter.Logical.AND:for(b=0,c=this.filters.length;c>b;b++)if(0==this.filters[b].evaluate(a))return!1;return!0;case Tmap.Filter.Logical.OR:for(b=0,c=this.filters.length;c>b;b++)if(1==this.filters[b].evaluate(a))return!0;return!1;case Tmap.Filter.Logical.NOT:return!this.filters[0].evaluate(a)}},clone:function(){for(var a=[],b=0,c=this.filters.length;c>b;++b)a.push(this.filters[b].clone());return new Tmap.Filter.Logical({type:this.type,filters:a})},CLASS_NAME:"Tmap.Filter.Logical"}),Tmap.Filter.Logical.AND="&&",Tmap.Filter.Logical.OR="||",Tmap.Filter.Logical.NOT="!",Tmap.Filter.Comparison=Tmap.Class(Tmap.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(a){Tmap.Filter.prototype.initialize.apply(this,[a]),this.type===Tmap.Filter.Comparison.LIKE&&void 0===a.matchCase&&(this.matchCase=null)},evaluate:function(a){a instanceof Tmap.Feature.Vector&&(a=a.attributes);var b,c=!1,d=a[this.property];switch(this.type){case Tmap.Filter.Comparison.EQUAL_TO:b=this.value,c=this.matchCase||"string"!=typeof d||"string"!=typeof b?d==b:d.toUpperCase()==b.toUpperCase();break;case Tmap.Filter.Comparison.NOT_EQUAL_TO:b=this.value,c=this.matchCase||"string"!=typeof d||"string"!=typeof b?d!=b:d.toUpperCase()!=b.toUpperCase();break;case Tmap.Filter.Comparison.LESS_THAN:c=d<this.value;break;case Tmap.Filter.Comparison.GREATER_THAN:c=d>this.value;break;case Tmap.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:c=d<=this.value;break;case Tmap.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:c=d>=this.value;break;case Tmap.Filter.Comparison.BETWEEN:c=d>=this.lowerBoundary&&d<=this.upperBoundary;break;case Tmap.Filter.Comparison.LIKE:var e=new RegExp(this.value,"gi");c=e.test(d);break;case Tmap.Filter.Comparison.IS_NULL:c=null===d}return c},value2regex:function(a,b,c){if("."==a)throw new Error("'.' is an unsupported wildCard character for Tmap.Filter.Comparison");return a=a?a:"*",b=b?b:".",c=c?c:"!",this.value=this.value.replace(new RegExp("\\"+c+"(.|$)","g"),"\\$1"),this.value=this.value.replace(new RegExp("\\"+b,"g"),"."),this.value=this.value.replace(new RegExp("\\"+a,"g"),".*"),this.value=this.value.replace(new RegExp("\\\\.\\*","g"),"\\"+a),this.value=this.value.replace(new RegExp("\\\\\\.","g"),"\\"+b),this.value},regex2value:function(){var a=this.value;return a=a.replace(/!/g,"!!"),a=a.replace(/(\\)?\\\./g,function(a,b){return b?a:"!."}),a=a.replace(/(\\)?\\\*/g,function(a,b){return b?a:"!*"}),a=a.replace(/\\\\/g,"\\"),a=a.replace(/\.\*/g,"*")},clone:function(){return Tmap.Util.extend(new Tmap.Filter.Comparison,this)},CLASS_NAME:"Tmap.Filter.Comparison"}),Tmap.Filter.Comparison.EQUAL_TO="==",Tmap.Filter.Comparison.NOT_EQUAL_TO="!=",Tmap.Filter.Comparison.LESS_THAN="<",Tmap.Filter.Comparison.GREATER_THAN=">",Tmap.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=",Tmap.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=",Tmap.Filter.Comparison.BETWEEN="..",Tmap.Filter.Comparison.LIKE="~",Tmap.Filter.Comparison.IS_NULL="NULL",Tmap.Filter.Spatial=Tmap.Class(Tmap.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(a){var b=!1;switch(this.type){case Tmap.Filter.Spatial.BBOX:case Tmap.Filter.Spatial.INTERSECTS:if(a.geometry){var c=this.value;"Tmap.Bounds"==this.value.CLASS_NAME&&(c=this.value.toGeometry()),a.geometry.intersects(c)&&(b=!0)}break;default:throw new Error("evaluate is not implemented for this filter type.")}return b},clone:function(){var a=Tmap.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new Tmap.Filter.Spatial(a)},CLASS_NAME:"Tmap.Filter.Spatial"}),Tmap.Filter.Spatial.BBOX="BBOX",Tmap.Filter.Spatial.INTERSECTS="INTERSECTS",Tmap.Filter.Spatial.DWITHIN="DWITHIN",Tmap.Filter.Spatial.WITHIN="WITHIN",Tmap.Filter.Spatial.CONTAINS="CONTAINS",Tmap.Filter.Function=Tmap.Class(Tmap.Filter,{name:null,params:null,CLASS_NAME:"Tmap.Filter.Function"}),Tmap.Protocol=Tmap.Class({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(a){a=a||{},Tmap.Util.extend(this,a),this.options=a},mergeWithDefaultFilter:function(a){var b;return b=a&&this.defaultFilter?new Tmap.Filter.Logical({type:Tmap.Filter.Logical.AND,filters:[this.defaultFilter,a]}):a||this.defaultFilter||void 0},destroy:function(){this.options=null,this.format=null},read:function(a){a=a||{},a.filter=this.mergeWithDefaultFilter(a.filter)},create:function(){},update:function(){},"delete":function(){},commit:function(){},abort:function(a){},createCallback:function(a,b,c){return Tmap.Function.bind(function(){a.apply(this,[b,c])},this)},CLASS_NAME:"Tmap.Protocol"}),Tmap.Protocol.Response=Tmap.Class({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(a){Tmap.Util.extend(this,a)},success:function(){return this.code>0},CLASS_NAME:"Tmap.Protocol.Response"}),Tmap.Protocol.Response.SUCCESS=1,Tmap.Protocol.Response.FAILURE=0,Tmap.Protocol.HTTP=Tmap.Class(Tmap.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,updateWithPOST:!1,deleteWithPOST:!1,wildcarded:!1,srsInBBOX:!1,initialize:function(a){if(a=a||{},this.params={},this.headers={},Tmap.Protocol.prototype.initialize.apply(this,arguments),!this.filterToParams&&Tmap.Format.QueryStringFilter){var b=new Tmap.Format.QueryStringFilter({wildcarded:this.wildcarded,srsInBBOX:this.srsInBBOX});this.filterToParams=function(a,c){return b.write(a,c)}}},destroy:function(){this.params=null,this.headers=null,Tmap.Protocol.prototype.destroy.apply(this)},read:function(a){Tmap.Protocol.prototype.read.apply(this,arguments),a=a||{},a.params=Tmap.Util.applyDefaults(a.params,this.options.params),a=Tmap.Util.applyDefaults(a,this.options),a.filter&&this.filterToParams&&(a.params=this.filterToParams(a.filter,a.params));var b=void 0!==a.readWithPOST?a.readWithPOST:this.readWithPOST,c=new Tmap.Protocol.Response({requestType:"read"});if(b){var d=a.headers||{};d["Content-Type"]="application/x-www-form-urlencoded",c.priv=Tmap.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,c,a),data:Tmap.Util.getParameterString(a.params),headers:d})}else c.priv=Tmap.Request.GET({url:a.url,callback:this.createCallback(this.handleRead,c,a),params:a.params,headers:a.headers});return c},handleRead:function(a,b){this.handleResponse(a,b)},create:function(a,b){b=Tmap.Util.applyDefaults(b,this.options);var c=new Tmap.Protocol.Response({reqFeatures:a,requestType:"create"});return c.priv=Tmap.Request.POST({url:b.url,callback:this.createCallback(this.handleCreate,c,b),headers:b.headers,data:this.format.write(a)}),c},handleCreate:function(a,b){this.handleResponse(a,b)},update:function(a,b){b=b||{};var c=b.url||a.url||this.options.url+"/"+a.fid;b=Tmap.Util.applyDefaults(b,this.options);var d=new Tmap.Protocol.Response({reqFeatures:a,requestType:"update"}),e=this.updateWithPOST?"POST":"PUT";return d.priv=Tmap.Request[e]({url:c,callback:this.createCallback(this.handleUpdate,d,b),headers:b.headers,
data:this.format.write(a)}),d},handleUpdate:function(a,b){this.handleResponse(a,b)},"delete":function(a,b){b=b||{};var c=b.url||a.url||this.options.url+"/"+a.fid;b=Tmap.Util.applyDefaults(b,this.options);var d=new Tmap.Protocol.Response({reqFeatures:a,requestType:"delete"}),e=this.deleteWithPOST?"POST":"DELETE",f={url:c,callback:this.createCallback(this.handleDelete,d,b),headers:b.headers};return this.deleteWithPOST&&(f.data=this.format.write(a)),d.priv=Tmap.Request[e](f),d},handleDelete:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){var c=a.priv;b.callback&&(c.status>=200&&c.status<300?("delete"!=a.requestType&&(a.features=this.parseFeatures(c)),a.code=Tmap.Protocol.Response.SUCCESS):a.code=Tmap.Protocol.Response.FAILURE,b.callback.call(b.scope,a))},parseFeatures:function(a){var b=a.responseXML;return b&&b.documentElement||(b=a.responseText),!b||b.length<=0?null:this.format.read(b)},commit:function(a,b){function c(a){for(var b=a.features?a.features.length:0,c=new Array(b),e=0;b>e;++e)c[e]=a.features[e].fid;o.insertIds=c,d.apply(this,[a])}function d(a){this.callUserCallback(a,b),n=n&&a.success(),f++,f>=m&&b.callback&&(o.code=n?Tmap.Protocol.Response.SUCCESS:Tmap.Protocol.Response.FAILURE,b.callback.apply(b.scope,[o]))}b=Tmap.Util.applyDefaults(b,this.options);var e=[],f=0,g={};g[Tmap.State.INSERT]=[],g[Tmap.State.UPDATE]=[],g[Tmap.State.DELETE]=[];for(var h,i,j=[],k=0,l=a.length;l>k;++k)h=a[k],i=g[h.state],i&&(i.push(h),j.push(h));var m=(g[Tmap.State.INSERT].length>0?1:0)+g[Tmap.State.UPDATE].length+g[Tmap.State.DELETE].length,n=!0,o=new Tmap.Protocol.Response({reqFeatures:j}),p=g[Tmap.State.INSERT];p.length>0&&e.push(this.create(p,Tmap.Util.applyDefaults({callback:c,scope:this},b.create))),p=g[Tmap.State.UPDATE];for(var k=p.length-1;k>=0;--k)e.push(this.update(p[k],Tmap.Util.applyDefaults({callback:d,scope:this},b.update)));p=g[Tmap.State.DELETE];for(var k=p.length-1;k>=0;--k)e.push(this["delete"](p[k],Tmap.Util.applyDefaults({callback:d,scope:this},b["delete"])));return e},abort:function(a){a&&a.priv.abort()},callUserCallback:function(a,b){var c=b[a.requestType];c&&c.callback&&c.callback.call(c.scope,a)},CLASS_NAME:"Tmap.Protocol.HTTP"}),Tmap.Protocol.Script=Tmap.Class(Tmap.Protocol,{url:null,params:null,callback:null,callbackTemplate:"Tmap.Protocol.Script.registry.${id}",callbackKey:"callback",callbackPrefix:"",scope:null,format:null,pendingRequests:null,srsInBBOX:!1,initialize:function(a){if(a=a||{},this.params={},this.pendingRequests={},Tmap.Protocol.prototype.initialize.apply(this,arguments),this.format||(this.format=new Tmap.Format.GeoJSON),!this.filterToParams&&Tmap.Format.QueryStringFilter){var b=new Tmap.Format.QueryStringFilter({srsInBBOX:this.srsInBBOX});this.filterToParams=function(a,c){return b.write(a,c)}}},read:function(a){Tmap.Protocol.prototype.read.apply(this,arguments),a=Tmap.Util.applyDefaults(a,this.options),a.params=Tmap.Util.applyDefaults(a.params,this.options.params),a.filter&&this.filterToParams&&(a.params=this.filterToParams(a.filter,a.params));var b=new Tmap.Protocol.Response({requestType:"read"}),c=this.createRequest(a.url,a.params,Tmap.Function.bind(function(c){b.data=c,this.handleRead(b,a)},this));return b.priv=c,b},createRequest:function(a,b,c){var d=Tmap.Protocol.Script.register(c),e=Tmap.String.format(this.callbackTemplate,{id:d});b=Tmap.Util.extend({},b),b[this.callbackKey]=this.callbackPrefix+e,a=Tmap.Util.urlAppend(a,Tmap.Util.getParameterString(b));var f=document.createElement("script");f.type="text/javascript",f.src=a,f.id="Tmap_Protocol_Script_"+d,this.pendingRequests[f.id]=f;var g=document.getElementsByTagName("head")[0];return g.appendChild(f),f},destroyRequest:function(a){Tmap.Protocol.Script.unregister(a.id.split("_").pop()),delete this.pendingRequests[a.id],a.parentNode&&a.parentNode.removeChild(a)},handleRead:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){b.callback&&(a.data?(a.features=this.parseFeatures(a.data),a.code=Tmap.Protocol.Response.SUCCESS):a.code=Tmap.Protocol.Response.FAILURE,this.destroyRequest(a.priv),b.callback.call(b.scope,a))},parseFeatures:function(a){return this.format.read(a)},abort:function(a){if(a)this.destroyRequest(a.priv);else for(var b in this.pendingRequests)this.destroyRequest(this.pendingRequests[b])},destroy:function(){this.abort(),delete this.params,delete this.format,Tmap.Protocol.prototype.destroy.apply(this)},CLASS_NAME:"Tmap.Protocol.Script"}),function(){var a=Tmap.Protocol.Script,b=0;a.registry={},a.register=function(c){var d="c"+ ++b;return a.registry[d]=function(){c.apply(this,arguments)},d},a.unregister=function(b){delete a.registry[b]}}(),Tmap.Layer.PointTrack=Tmap.Class(Tmap.Layer.Vector,{dataFrom:null,styleFrom:null,addNodes:function(a,b){if(a.length<2)throw new Error("At least two point features have to be added to create a line from");for(var c,d,e,f=new Array(a.length-1),g=0,h=a.length;h>g;g++){if(c=a[g],e=c.geometry){if("Tmap.Geometry.Point"!=e.CLASS_NAME)throw new TypeError("Only features with point geometries are supported.")}else{var i=c.lonlat;e=new Tmap.Geometry.Point(i.lon,i.lat)}if(g>0){var j=null!=this.dataFrom?a[g+this.dataFrom].data||a[g+this.dataFrom].attributes:null,k=null!=this.styleFrom?a[g+this.styleFrom].style:null,l=new Tmap.Geometry.LineString([d,e]);f[g-1]=new Tmap.Feature.Vector(l,j,k)}d=e}this.addFeatures(f,b)},CLASS_NAME:"Tmap.Layer.PointTrack"}),Tmap.Layer.PointTrack.SOURCE_NODE=-1,Tmap.Layer.PointTrack.TARGET_NODE=0,Tmap.Layer.PointTrack.dataFrom={SOURCE_NODE:-1,TARGET_NODE:0},Tmap.Style=Tmap.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,context:null,defaultStyle:null,defaultsPerSymbolizer:!1,propertyStyles:null,initialize:function(a,b){Tmap.Util.extend(this,b),this.rules=[],b&&b.rules&&this.addRules(b.rules),this.setDefaultStyle(a||Tmap.Feature.Vector.style["default"]),this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a=0,b=this.rules.length;b>a;a++)this.rules[a].destroy(),this.rules[a]=null;this.rules=null,this.defaultStyle=null},createSymbolizer:function(a){for(var b,c=this.defaultsPerSymbolizer?{}:this.createLiterals(Tmap.Util.extend({},this.defaultStyle),a),d=this.rules,e=[],f=!1,g=0,h=d.length;h>g;g++){b=d[g];var i=b.evaluate(a);i&&(b instanceof Tmap.Rule&&b.elseFilter?e.push(b):(f=!0,this.applySymbolizer(b,c,a)))}if(0==f&&e.length>0){f=!0;for(var g=0,h=e.length;h>g;g++)this.applySymbolizer(e[g],c,a)}return d.length>0&&0==f&&(c.display="none"),null!=c.label&&"string"!=typeof c.label&&(c.label=String(c.label)),c},applySymbolizer:function(a,b,c){var d=c.geometry?this.getSymbolizerPrefix(c.geometry):Tmap.Style.SYMBOLIZER_PREFIXES[0],e=a.symbolizer[d]||a.symbolizer;if(this.defaultsPerSymbolizer===!0){var f=this.defaultStyle;Tmap.Util.applyDefaults(e,{pointRadius:f.pointRadius}),(e.stroke===!0||e.graphic===!0)&&Tmap.Util.applyDefaults(e,{strokeWidth:f.strokeWidth,strokeColor:f.strokeColor,strokeOpacity:f.strokeOpacity,strokeDashstyle:f.strokeDashstyle,strokeLinecap:f.strokeLinecap}),(e.fill===!0||e.graphic===!0)&&Tmap.Util.applyDefaults(e,{fillColor:f.fillColor,fillOpacity:f.fillOpacity}),e.graphic===!0&&Tmap.Util.applyDefaults(e,{pointRadius:this.defaultStyle.pointRadius,externalGraphic:this.defaultStyle.externalGraphic,graphicName:this.defaultStyle.graphicName,graphicOpacity:this.defaultStyle.graphicOpacity,graphicWidth:this.defaultStyle.graphicWidth,graphicHeight:this.defaultStyle.graphicHeight,graphicXOffset:this.defaultStyle.graphicXOffset,graphicYOffset:this.defaultStyle.graphicYOffset})}return this.createLiterals(Tmap.Util.extend(b,e),c)},createLiterals:function(a,b){var c=Tmap.Util.extend({},b.attributes||b.data);Tmap.Util.extend(c,this.context);for(var d in this.propertyStyles)a[d]=Tmap.Style.createLiteral(a[d],c,b,d);return a},findPropertyStyles:function(){var a={},b=this.defaultStyle;this.addPropertyStyles(a,b);for(var c,d,e=this.rules,f=0,g=e.length;g>f;f++){c=e[f].symbolizer;for(var h in c){if(d=c[h],"object"!=typeof d){this.addPropertyStyles(a,c);break}this.addPropertyStyles(a,d)}}return a},addPropertyStyles:function(a,b){var c;for(var d in b)c=b[d],"string"==typeof c&&c.match(/\$\{\w+\}/)&&(a[d]=!0);return a},addRules:function(a){Array.prototype.push.apply(this.rules,a),this.propertyStyles=this.findPropertyStyles()},setDefaultStyle:function(a){this.defaultStyle=a,this.propertyStyles=this.findPropertyStyles()},getSymbolizerPrefix:function(a){for(var b=Tmap.Style.SYMBOLIZER_PREFIXES,c=0,d=b.length;d>c;c++)if(-1!=a.CLASS_NAME.indexOf(b[c]))return b[c]},clone:function(){var a=Tmap.Util.extend({},this);if(this.rules){a.rules=[];for(var b=0,c=this.rules.length;c>b;++b)a.rules.push(this.rules[b].clone())}a.context=this.context&&Tmap.Util.extend({},this.context);var d=Tmap.Util.extend({},this.defaultStyle);return new Tmap.Style(d,a)},CLASS_NAME:"Tmap.Style"}),Tmap.Style.createLiteral=function(a,b,c,d){return"string"==typeof a&&-1!=a.indexOf("${")&&(a=Tmap.String.format(a,b,[c,d]),a=isNaN(a)||!a?a:parseFloat(a)),a},Tmap.Style.SYMBOLIZER_PREFIXES=["Point","Line","Polygon","Text","Raster"],Tmap.Style2=Tmap.Class({id:null,name:null,title:null,description:null,layerName:null,isDefault:!1,rules:null,initialize:function(a){Tmap.Util.extend(this,a),this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a=0,b=this.rules.length;b>a;a++)this.rules[a].destroy();delete this.rules},clone:function(){var a=Tmap.Util.extend({},this);if(this.rules){a.rules=[];for(var b=0,c=this.rules.length;c>b;++b)a.rules.push(this.rules[b].clone())}return new Tmap.Style2(a)},CLASS_NAME:"Tmap.Style2"}),Tmap.StyleMap=Tmap.Class({styles:null,extendDefault:!0,initialize:function(a,b){if(this.styles={"default":new Tmap.Style(Tmap.Feature.Vector.style["default"]),select:new Tmap.Style(Tmap.Feature.Vector.style.select),temporary:new Tmap.Style(Tmap.Feature.Vector.style.temporary),"delete":new Tmap.Style(Tmap.Feature.Vector.style["delete"])},a instanceof Tmap.Style)this.styles["default"]=a,this.styles.select=a,this.styles.temporary=a,this.styles["delete"]=a;else if("object"==typeof a)for(var c in a)if(a[c]instanceof Tmap.Style)this.styles[c]=a[c];else{if("object"!=typeof a[c]){this.styles["default"]=new Tmap.Style(a),this.styles.select=new Tmap.Style(a),this.styles.temporary=new Tmap.Style(a),this.styles["delete"]=new Tmap.Style(a);break}this.styles[c]=new Tmap.Style(a[c])}Tmap.Util.extend(this,b)},destroy:function(){for(var a in this.styles)this.styles[a].destroy();this.styles=null},createSymbolizer:function(a,b){a||(a=new Tmap.Feature.Vector),this.styles[b]||(b="default"),a.renderIntent=b;var c={};return this.extendDefault&&"default"!=b&&(c=this.styles["default"].createSymbolizer(a)),Tmap.Util.extend(c,this.styles[b].createSymbolizer(a))},addUniqueValueRules:function(a,b,c,d){var e=[];for(var f in c)e.push(new Tmap.Rule({symbolizer:c[f],context:d,filter:new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.EQUAL_TO,property:b,value:f})}));this.styles[a].addRules(e)},CLASS_NAME:"Tmap.StyleMap"}),Tmap.Rule=Tmap.Class({id:null,name:null,title:null,description:null,context:null,filter:null,elseFilter:!1,symbolizer:null,symbolizers:null,minScaleDenominator:null,maxScaleDenominator:null,initialize:function(a){this.symbolizer={},Tmap.Util.extend(this,a),this.symbolizers&&delete this.symbolizer,this.id=Tmap.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){for(var a in this.symbolizer)this.symbolizer[a]=null;this.symbolizer=null,delete this.symbolizers},evaluate:function(a){var b=this.getContext(a),c=!0;if(this.minScaleDenominator||this.maxScaleDenominator)var d=a.layer.map.getScale();return this.minScaleDenominator&&(c=d>=Tmap.Style.createLiteral(this.minScaleDenominator,b)),c&&this.maxScaleDenominator&&(c=d<Tmap.Style.createLiteral(this.maxScaleDenominator,b)),c&&this.filter&&(c="Tmap.Filter.FeatureId"==this.filter.CLASS_NAME?this.filter.evaluate(a):this.filter.evaluate(b)),c},getContext:function(a){var b=this.context;return b||(b=a.attributes||a.data),"function"==typeof this.context&&(b=this.context(a)),b},clone:function(){var a=Tmap.Util.extend({},this);if(this.symbolizers){var b=this.symbolizers.length;a.symbolizers=new Array(b);for(var c=0;b>c;++c)a.symbolizers[c]=this.symbolizers[c].clone()}else{a.symbolizer={};var d,e;for(var f in this.symbolizer)d=this.symbolizer[f],e=typeof d,"object"===e?a.symbolizer[f]=Tmap.Util.extend({},d):"string"===e&&(a.symbolizer[f]=d)}return a.filter=this.filter&&this.filter.clone(),a.context=this.context&&Tmap.Util.extend({},this.context),new Tmap.Rule(a)},CLASS_NAME:"Tmap.Rule"});




Tmap.Cluster={};Tmap.Cluster.Marker=function(lonlat,options){var point=new Tmap.Geometry.Point(lonlat.lon,lonlat.lat);var icon=null;var width=20;var label="";var data;var clickHandler=null;if(options){if(options.icon)icon=options.icon;if(options.width)width=options.width;if(options.label)label=options.label;if(options.data)data=options.data;if(options.clickHandler){clickHandler=options.clickHandler}}var feature=new Tmap.Feature.Vector(point);feature.attributes={icon:icon,label:label,width:width,clickHandler:clickHandler};feature.data=data;return feature};Tmap.Cluster.Icon=function(url,options){var url=url;var width=25;var fontSize=15;var fontColor="black";if(options){if(options.width)width=options.width;if(options.fontSize)fontSize=options.fontSize;if(options.fontColor)fontColor=options.fontColor}return{url:url,width:width,fontSize:fontSize,fontColor:fontColor}};Tmap.Cluster.Layer=function(map,options){var cMap,strategy,clusters;var features=[];var icons=[new Tmap.Cluster.Icon("http://topopentile1.tmap.co.kr/tmapicon/map/clusterbg1.png",{width:20,fontColor:"#333333",fontSize:15}),new Tmap.Cluster.Icon("http://topopentile1.tmap.co.kr/tmapicon/map/clusterbg2.png",{width:25,fontColor:"#333333",fontSize:15}),new Tmap.Cluster.Icon("http://topopentile1.tmap.co.kr/tmapicon/map/clusterbg3.png",{width:30,fontColor:"#333333",fontSize:15})];var gap=10;var sDistance=50;var sThreshold=2;var style=new Tmap.Style({pointRadius:"${radius}",fillColor:"#ffcc66",fillOpacity:1,strokeColor:"#cc6633",strokeWidth:"${width}",strokeOpacity:1,fontColor:"${fontColor}",fontSize:"${fontSize}",fontWeight:700,externalGraphic:"${icon}",label:"${label}"},{context:{width:function(feature){return(feature.cluster)?2:1},radius:function(feature){var pix=0;if(feature.cluster&&feature.cluster.length>1){var index=Math.floor(feature.cluster.length/gap);if(index>icons.length-1)index=icons.length-1;pix=icons[index].width}else{pix=feature.attributes.width}return pix},icon:function(feature){if(feature.cluster){var index=Math.floor(feature.cluster.length/gap);if(index>icons.length-1)index=icons.length-1;feature.attributes.icon=icons[index].url;feature.attributes.label=feature.cluster.length}else{feature.attributes.icon=feature.attributes.icon;feature.attributes.label=""}return feature.attributes.icon},label:function(feature){return feature.attributes.label},fontColor:function(feature){if(feature.cluster){var index=Math.floor(feature.cluster.length/gap);if(index>icons.length-1)index=icons.length-1;return icons[index].fontColor}return"black"},fontSize:function(feature){if(feature.cluster){var index=Math.floor(feature.cluster.length/gap);if(index>icons.length-1)index=icons.length-1;return icons[index].fontSize}return 15}}});cMap=map;if(options){if(options.markers){for(var i=0;i<options.markers.length;i++){features.push(options.markers[i])}}if(options.icon){icons=options.icon}if(options.gap){gap=options.gap}if(options.distance){sDistance=options.distance}}strategy=new Tmap.Strategy.Cluster();strategy.distance=sDistance||strategy.distance;strategy.threshold=sThreshold||strategy.threshold;clusters=new Tmap.Layer.Vector("Clusters",{strategies:[strategy],styleMap:new Tmap.StyleMap({"default":style,"select":{fillColor:"#8aeeef",strokeColor:"#32a8a9"}})});var select=new Tmap.Control.SelectFeature(clusters,{click:true,hover:false});cMap.addControl(select);select.activate();clusters.events.on({"featureselected":function(e){var f=e.feature;if(f.attributes.clickHandler){f.attributes.clickHandler(f)}}});cMap.addLayers([clusters]);clusters.removeFeatures(clusters.features);clusters.addFeatures(features);var funcRefresh=function(){strategy.distance=sDistance||strategy.distance;strategy.threshold=sThreshold||strategy.threshold;clusters.removeFeatures(clusters.features);clusters.addFeatures(features)};var funcSetStrategy=function(distance){sDistance=distance};var funcClear=function(){features=[];clusters.removeFeatures(clusters.features)};return{"refresh":funcRefresh,"setStrategy":funcSetStrategy,"clear":funcClear}};
