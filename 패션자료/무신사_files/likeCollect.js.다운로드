/************************************ 
 * DATE : 2022.01.20. Thr.
 * CREATE : Hansol, Heo
 * TEAM : Data Solution 
 * EMAIL : hansol.heo@musinsa.com
 * ***********************************/

 var detail_brand_like_objs = document.querySelectorAll("[class*='gtm-like-click'] > [id^=prd_brand_interest]");

 if( detail_brand_like_objs.length > 0 ) {
     for( var i=0; i<detail_brand_like_objs.length; i++ ) {
         detail_brand_like_objs[i].addEventListener("click", function(e) {
             _ds_set_like_information(this);
         }, false);
     }
 }

$(document).on("click", "[class*='gtm-like-click'], [class*='gtm-catch-click'][class*='like']:not([class*='gtm-like-click']), [onclick^='toggleLike('][class*='like']:not([class*='gtm-like-click'], [class*='gtm-catch-click'][class*='like']), [class*='gtm-catch-click'][data-gtm-action^='like'], [onclick^='toggleBrandLike('][class*='like']:not([class*='gtm-like-click'], [class*='gtm-catch-click'][class*='like'])", function (data) {
    _ds_set_like_information(this);
});

function _ds_find_array_obj(obj) {
    var return_obj;

    var regexp = new RegExp("^" + obj.url_pattern, "gi");

    if (regexp.exec(document.location.pathname) != null) {
        return_obj = true;
    } else {
        return_obj = obj.url_pattern === document.location.pathname;
    }
    return return_obj;
}


function _ds_get_product_information(productID) {
    var _ds_stateAll;

    if (typeof(stateAll) === "undefined") {
        $.ajax({
            type: 'GET',
            url: "https://www.musinsa.com/app/goods/" + productID,
            dataType: 'text',
            async: false,
            success: function (data) {
                const re = new RegExp('var stateAll = (.*)\;');
                var _ds_productInfo = JSON.parse(re.exec(data)[1]).productInfo;

                _ds_stateAll = {
                    "currencyCode": "KRW",
                    "like": {
                        "products": [{
                            "id": _ds_productInfo.goods_no,
                            "name": _ds_productInfo.goods_nm,
                            "price": _ds_productInfo.price,
                            "brand": _ds_productInfo.brand,
                            "category": _ds_productInfo.category,
                            "quantity": 0,
                            "dimension13": _ds_productInfo.season + " " + _ds_productInfo.season_type_nm,
                            "dimension14": _ds_productInfo.sex,
                            "dimension15": _ds_productInfo.goods_type
                        }]
                    }
                };
            }
        });
    } else {
        _ds_stateAll = {
            "currencyCode": "KRW",
            "like": {
                "products": [{
                    "id": stateAll.productInfo.goods_no,
                    "name": stateAll.productInfo.goods_nm,
                    "price": stateAll.productInfo.price,
                    "brand": stateAll.productInfo.brand,
                    "category": stateAll.productInfo.category,
                    "quantity": 0,
                    "dimension13": stateAll.productInfo.season + " " + stateAll.productInfo.season_type_nm,
                    "dimension14": stateAll.productInfo.sex,
                    "dimension15": stateAll.productInfo.goods_type
                }]
            }
        };
    }

    return _ds_stateAll;
}

function _ds_set_like_information(object) {
    /********************************************************** 
     * {
     *     "event": "gtm-like-click",
     *     "gtm-category": {dimension23},
     *     "gtm-action": "like.{category}.{status}",
     *     "gtm-label": {id},
     *     "gtm-cd-19": "button",
     *     "gtm-cd-21": {dimension21},
     *     "gtm-cd-23": {dimension23},
     * }
     * ********************************************************/

    var _ds_like_selector = [
        {
            "url_pattern": "/app/brand_event/views/",
            "selector": "[onclick^='toggleBrandLike('][class*='like']:not([class*='gtm-like-click'], [class*='gtm-catch-click'][class*='like'])",
            "view_name": "new_brand_info",
            "section_no": 2
        },
        {
            "url_pattern": "/app/goods/",
            "selector": "[onclick^='toggleLike('][class*='like']:not([class*='gtm-like-click'], [class*='gtm-catch-click'][class*='like'])",
            "view_name": "상품상세",
            "section_no": 0
        },
        {
            "url_pattern": "/app/goods/",
            "selector": "[class*='gtm-like-click'] > a[id^='prd_brand_interest']",
            "view_name": "product_info",
            "section_no": 1
        },
        {
            "url_pattern": "/app/goods/",
            "selector": "[class*='gtm-like-click']",
            "view_name": "product_buy_depth1",
            "section_no": 13
        },
        {
            "url_pattern": "/dp/brand",
            "selector": "#brand-index-best-brands-wrap .like-box-area",
            "view_name": "brand_best",
            "section_no": 5
        },
        {
            "url_pattern": "/dp/brand",
            "selector": "#brand-index-new-brand-wrap .like-box-area",
            "view_name": "brand_new_event",
            "section_no": 6
        },
        {
            "url_pattern": "/dp/brand",
            "selector": "#brand-index-exclusive-brands-wrap .brand-index__product__like__button",
            "view_name": "",
            "section_no": 8
        },
        {
            "url_pattern": "/brands",
            "selector": "div.like-box-area:not([onclick^='likeManage.toggleLikeBtn('])",
            "view_name": "brand_list",
            "section_no": 2
        },
        {
            "url_pattern": "/brands/",
            "selector": "[onclick^='likeManage.toggleLikeBtn('][onclick*='BRAND']",
            "view_name": "brandshop_top",
            "section_no": 1
        },
        {
            "url_pattern": "/brands/",
            "selector": "[onclick^='likeManage.toggleLikeBtn('][onclick*='GOODS']",
            "view_name": "",
            "section_no": 3
        },
        {
            "url_pattern": "/dp/likes/brands",
            "selector": ".like-brand-v2-like",
            "view_name": "brand_like",
            "section_no": 1
        },
        {
            "url_pattern": "/dp/likes/brands",
            "selector": ".like-brand-v2-relation",
            "view_name": "brand_like_reco",
            "section_no": 2
        },
        {
            "url_pattern": "/dp/likes/brands/onboard",
            "selector": "[class*='gtm-like-click'][data-brand]",
            "view_name": "brand_reco_brandshop",
            "section_no": 7
        },
        {
            "url_pattern": "/dp/flagship",
            "selector": "div[class^='header__'] > button[class*='gtm-like-click']",
            "view_name": "header",
            "section_no": 101
        },
        {
            "url_pattern": "/dp/flagship",
            "selector": "div[class*='like-goods'] > button[class*='gtm-like-click'][data-goods-no]",
            "view_name": "goods",
            "section_no": 5
        },
        {
            "url_pattern": "/dp/flagship",
            "selector": "div[data-gtm-cd-23*='brand_info'] button[class*='gtm-like-click']",
            "view_name": "brand_info",
            "section_no": 6
        }

    ];
    var _ds_like_object = $(object);
    var _ds_find_obj = _ds_like_selector.filter(_ds_find_array_obj);

    var _ds_dimension20 = "";
    var _ds_dimension21 = "";
    var _ds_dimension23 = "";
    var _ds_event_label = "";
    var _ds_dimension22;
    var _ds_ecom_info;


    if (_ds_like_object.attr("data-gtm-label")) {
        _ds_event_label = _ds_like_object.attr("data-gtm-label");
    }

    if (_ds_like_object.attr("data-dimension21") || _ds_like_object.attr("data-gtm-cd-21")) {
        if (_ds_like_object.attr("data-dimension21")) {
            _ds_dimension21 = _ds_like_object.attr("data-dimension21");
        } else if (_ds_like_object.attr("data-gtm-cd-21")) {
            _ds_dimension21 = _ds_like_object.attr("data-gtm-cd-21");
        }
    } else {
        _ds_dimension21 = -1;
    }

    if (_ds_like_object.attr("data-dimension20") || _ds_like_object.attr("data-gtm-cd-20") || _ds_like_object.closest("[data-dimension20]").attr("data-dimension20") || _ds_like_object.closest("[data-gtm-cd-20]").attr("data-gtm-cd-20") ) {
        if (_ds_like_object.attr("data-dimension20") || _ds_like_object.closest("[data-dimension20]").attr("data-dimension20")) {
            _ds_dimension20 = _ds_like_object.attr("data-dimension20") || _ds_like_object.closest("[data-dimension20]").attr("data-dimension20");
        } else if (_ds_like_object.attr("data-gtm-cd-20") || _ds_like_object.closest("[data-gtm-cd-20]").attr("data-gtm-cd-20")) {
            _ds_dimension20 = _ds_like_object.attr("data-gtm-cd-20") || _ds_like_object.closest("[data-gtm-cd-20]").attr("data-gtm-cd-20");
        }
    } else {
        _ds_dimension20 = window["_ga_pageid"];
    }

    if (_ds_like_object.attr("data-dimension23") || _ds_like_object.attr("data-gtm-cd-23") || _ds_like_object.attr("data-dimension18") || _ds_like_object.attr("data-gtm-cd-18")) {
        if (_ds_like_object.attr("data-dimension23")) {
            _ds_dimension23 = _ds_like_object.attr("data-dimension23");
        } else if (_ds_like_object.attr("data-gtm-cd-23")) {
            _ds_dimension23 = _ds_like_object.attr("data-gtm-cd-23");
        } else if (_ds_like_object.attr("data-dimension18")) {
            _ds_dimension23 = _ds_like_object.attr("data-dimension18");
        } else if (_ds_like_object.attr("data-gtm-cd-18")) {
            _ds_dimension23 = _ds_like_object.attr("data-gtm-cd-18");
        }
    } else {
        _ds_dimension23 = document.location.pathname;
    }

    if (_ds_dimension21 == -1 || _ds_dimension23.indexOf("/") > -1) {
        if (_ds_find_obj.length == 0) {
            _ds_dimension21 = _ds_dimension21 == -1 ? -1 : _ds_dimension21;
            _ds_dimension23 = _ds_dimension23.indexOf("/") > -1 ? document.location.pathname : _ds_dimension23;
        } else if (_ds_find_obj.length == 1) {
            if ($(_ds_find_obj[0].selector).index(_ds_like_object) > -1) {
                _ds_dimension21 = _ds_dimension21 == -1 ? _ds_find_obj[0].section_no : _ds_dimension21;
                _ds_dimension23 = _ds_dimension23.indexOf("/") > -1 ? _ds_find_obj[0].view_name : _ds_dimension23;
            }
        } else {
            for (var i = 0; i < _ds_find_obj.length; i++) {
                if ($(_ds_find_obj[i].selector).index(_ds_like_object) > -1) {

                    _ds_dimension21 = _ds_dimension21 == -1 ? _ds_find_obj[i].section_no : _ds_dimension21;
                    _ds_dimension23 = _ds_dimension23.indexOf("/") > -1 ? _ds_find_obj[i].view_name : _ds_dimension23;

                }
            }
        }
    }

    if (_ds_dimension23.indexOf("specialtyshop") > -1) {
        _ds_dimension21 = 1;
    } else if (_ds_dimension23.indexOf("brandshop_goods") > -1) {
        _ds_dimension21 = 3;
    } else if (_ds_dimension23.indexOf("brand_exclusive") > -1) {
        _ds_dimension21 = 8;
    } else if (!_ds_dimension21 && /^\/brands\//gi.exec(document.location.pathname) != null) {
        _ds_dimension21 = 2;
    }

    if (_ds_dimension23 == "brand_reco" && $("[class*='gtm-like-click'][data-brand]").index(_ds_like_object) > -1) {
        _ds_dimension22 = $("[class*='gtm-like-click'][data-brand]").index(_ds_like_object) + 1;
    }

    if ( _ds_dimension23 == "brandshop_top" ) {
        _ds_dimension20 = "/brands/brandshop";
    }

    var _ds_like_dataLayer_object = {
        "event": "gtm-like-click",
        "gtm-category": _ds_dimension23,
        "gtm-cd-19": _ds_dimension23 == "brand_reco" ? "banner" : "button",
        "gtm-cd-21": _ds_dimension21,
        "gtm-cd-23": _ds_dimension23,
        "gtm-cd-22": _ds_dimension22 !== undefined ? _ds_dimension22 : undefined,
        "gtm-cd-20": _ds_dimension20
    };

    $(document).one("ajaxComplete", function (event, xhr, settings) {

        var _ds_like_status = "";
        var _ds_like_category = "";
        var _ds_like_id = "";

        if (xhr.statusText == "success" && xhr.status == 200 && xhr.readyState == 4) {
            // 좋아요 API V1 (브랜드, 상품, 스냅 모두 사용)
            if (/\/like\/api\/v1\/members\/liketypes\/.*\/relations\//gi.exec(settings.url) != null) {
                _ds_like_status = settings.type.toLowerCase();
                _ds_like_id = settings.url.split("/")[settings.url.split("/").length - 1];

                if (/\/GOODS\//gi.exec(settings.url) != null) {
                    _ds_like_category = "product";
                    _ds_ecom_info = _ds_get_product_information(_ds_like_id);
                } else if (/\/BRAND\//gi.exec(settings.url) != null) {
                    _ds_like_category = "brand";
                } else if (/\/SNAP\//gi.exec(settings.url) != null) {
                    _ds_like_category = "snap";
                }
            }
            // 좋아요 Legacy API | wish/svc_ 로 시작하는 건 상품 API
            else if (/\/app\/wish\/svc\_/gi.exec(settings.url) != null) {
                _ds_like_category = "product";
                if (/svc\_add/gi.exec(settings.url) != null) {
                    _ds_like_status = "post";
                    _ds_like_id = settings.url.split("/")[settings.url.split("/").length - 2];
                } else if (/svc\_del/gi.exec(settings.url) != null) {
                    _ds_like_status = "delete";
                    _ds_like_id = JSON.parse(xhr.responseText).goods_no;
                }
                //상품 정보 가져오는 
                _ds_ecom_info = _ds_get_product_information(_ds_like_id);
            }
            // 좋아요 Legacy API | /api/brand 브랜드 API
            else if (/\/app\/api\/brand\/brand\_/gi.exec(settings.url) != null) {
                _ds_like_category = "brand";
                _ds_like_id = settings.url.split("?brand=")[settings.url.split("?brand=").length - 1];
                if (/brand\_like/gi.exec(settings.url) != null) {
                    _ds_like_status = "post";
                } else if (/brand\_unlike/gi.exec(settings.url) != null) {
                    _ds_like_status = "delete";
                }
            }
            // 좋아요 API | /app/wish/add_wish or /app/wish/remove_wish
            else if (/\/app\/wish\//gi.exec(settings.url) != null) {

                if (/add_wish/gi.exec(settings.url) != null) {
                    _ds_like_status = "post";
                    _ds_like_category = "contents";
                    _ds_like_id = settings.url.split("/")[settings.url.split("/").length - 1];
                } else if (/remove_wish/gi.exec(settings.url) != null) {
                    _ds_like_status = "delete";
                    _ds_like_category = "contents";
                    _ds_like_id = JSON.parse(xhr.responseText).relation_id;
                }
            }


            // 이 아래부터는 Object에 필요한 내용을 추가하는 영역
            // status를 기준으로 post는 무조건 좋아요 등록 | delete는 무조건 좋아요 취소
            if (_ds_like_status == "post") {
                _ds_like_dataLayer_object["gtm-action"] = "like." + _ds_like_category + ".ok";
            } else if (_ds_like_status == "delete") {
                _ds_like_dataLayer_object["gtm-action"] = "like." + _ds_like_category + ".cancel";
            }


            if( _ds_event_label != "" ) {
                _ds_like_dataLayer_object["gtm-label"] = _ds_event_label;
            } else {
                _ds_like_dataLayer_object["gtm-label"] = _ds_like_id;
            }
            

            if (_ds_like_category == "product") {
                _ds_like_dataLayer_object["ecommerce"] = _ds_ecom_info;
            }


            window["dataLayer"].push(_ds_like_dataLayer_object);
        }
    });
}