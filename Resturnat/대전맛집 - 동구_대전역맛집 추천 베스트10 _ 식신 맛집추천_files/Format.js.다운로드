Tmap.Format=Tmap.Class({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(a){Tmap.Util.extend(this,a),this.options=a},destroy:function(){},read:function(a){throw new Error("Read not implemented.")},write:function(a){throw new Error("Write not implemented.")},CLASS_NAME:"Tmap.Format"}),Tmap.Format.QueryStringFilter=function(){function a(a){return a=a.replace(/%/g,"\\%"),a=a.replace(/\\\\\.(\*)?/g,function(a,b){return b?a:"\\\\_"}),a=a.replace(/\\\\\.\*/g,"\\\\%"),a=a.replace(/(\\)?\.(\*)?/g,function(a,b,c){return b||c?a:"_"}),a=a.replace(/(\\)?\.\*/g,function(a,b){return b?a:"%"}),a=a.replace(/\\\./g,"."),a=a.replace(/(\\)?\\\*/g,function(a,b){return b?a:"*"})}var b={};return b[Tmap.Filter.Comparison.EQUAL_TO]="eq",b[Tmap.Filter.Comparison.NOT_EQUAL_TO]="ne",b[Tmap.Filter.Comparison.LESS_THAN]="lt",b[Tmap.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte",b[Tmap.Filter.Comparison.GREATER_THAN]="gt",b[Tmap.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte",b[Tmap.Filter.Comparison.LIKE]="ilike",Tmap.Class(Tmap.Format,{wildcarded:!1,srsInBBOX:!1,write:function(c,d){d=d||{};var e=c.CLASS_NAME,f=e.substring(e.lastIndexOf(".")+1);switch(f){case"Spatial":switch(c.type){case Tmap.Filter.Spatial.BBOX:d.bbox=c.value.toArray(),this.srsInBBOX&&c.projection&&d.bbox.push(c.projection.getCode());break;case Tmap.Filter.Spatial.DWITHIN:d.tolerance=c.distance;case Tmap.Filter.Spatial.WITHIN:d.lon=c.value.x,d.lat=c.value.y;break;default:Tmap.Console.warn("Unknown spatial filter type "+c.type)}break;case"Comparison":var g=b[c.type];if(void 0!==g){var h=c.value;c.type==Tmap.Filter.Comparison.LIKE&&(h=a(h),this.wildcarded&&(h="%"+h+"%")),d[c.property+"__"+g]=h,d.queryable=d.queryable||[],d.queryable.push(c.property)}else Tmap.Console.warn("Unknown comparison filter type "+c.type);break;case"Logical":if(c.type===Tmap.Filter.Logical.AND)for(var i=0,j=c.filters.length;j>i;i++)d=this.write(c.filters[i],d);else Tmap.Console.warn("Unsupported logical filter type "+c.type);break;default:Tmap.Console.warn("Unknown filter type "+f)}return d},CLASS_NAME:"Tmap.Format.QueryStringFilter"})}(),Tmap.Format.XML=Tmap.Class(Tmap.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(a){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")),Tmap.Format.prototype.initialize.apply(this,[a]),this.namespaces=Tmap.Util.extend({},this.namespaces),this.namespaceAlias={};for(var b in this.namespaces)this.namespaceAlias[this.namespaces[b]]=b},destroy:function(){this.xmldom=null,Tmap.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(a,b){this.namespaces[a]=b,this.namespaceAlias[b]=a},read:function(a){var b=a.indexOf("<");b>0&&(a=a.substring(b));var c=Tmap.Util.Try(Tmap.Function.bind(function(){var b;return b=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom,b.loadXML(a),b},this),function(){return(new DOMParser).parseFromString(a,"text/xml")},function(){var b=new XMLHttpRequest;return b.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(a),!1),b.overrideMimeType&&b.overrideMimeType("text/xml"),b.send(null),b.responseXML});return this.keepData&&(this.data=c),c},write:function(a){var b;if(this.xmldom)b=a.xml;else{var c=new XMLSerializer;if(1==a.nodeType){var d=document.implementation.createDocument("","",null);d.importNode&&(a=d.importNode(a,!0)),d.appendChild(a),b=c.serializeToString(d)}else b=c.serializeToString(a)}return b},createElementNS:function(a,b){var c;return c=this.xmldom?"string"==typeof a?this.xmldom.createNode(1,b,a):this.xmldom.createNode(1,b,""):document.createElementNS(a,b)},createDocumentFragment:function(){var a;return a=this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(a){var b;return"string"!=typeof a&&(a=String(a)),b=this.xmldom?this.xmldom.createTextNode(a):document.createTextNode(a)},getElementsByTagNameNS:function(a,b,c){var d=[];if(a.getElementsByTagNameNS)d=a.getElementsByTagNameNS(b,c);else for(var e,f,g=a.getElementsByTagName("*"),h=0,i=g.length;i>h;++h)e=g[h],f=e.prefix?e.prefix+":"+c:c,("*"==c||f==e.nodeName)&&("*"==b||b==e.namespaceURI)&&d.push(e);return d},getAttributeNodeNS:function(a,b,c){var d=null;if(a.getAttributeNodeNS)d=a.getAttributeNodeNS(b,c);else for(var e,f,g=a.attributes,h=0,i=g.length;i>h;++h)if(e=g[h],e.namespaceURI==b&&(f=e.prefix?e.prefix+":"+c:c,f==e.nodeName)){d=e;break}return d},getAttributeNS:function(a,b,c){var d="";if(a.getAttributeNS)d=a.getAttributeNS(b,c)||"";else{var e=this.getAttributeNodeNS(a,b,c);e&&(d=e.nodeValue)}return d},getChildValue:function(a,b){var c=b||"";if(a)for(var d=a.firstChild;d;d=d.nextSibling)switch(d.nodeType){case 3:case 4:c+=d.nodeValue}return c},isSimpleContent:function(a){for(var b=!0,c=a.firstChild;c;c=c.nextSibling)if(1===c.nodeType){b=!1;break}return b},contentType:function(a){for(var b=!1,c=!1,d=Tmap.Format.XML.CONTENT_TYPE.EMPTY,e=a.firstChild;e;e=e.nextSibling){switch(e.nodeType){case 1:c=!0;break;case 8:break;default:b=!0}if(c&&b)break}if(c&&b)d=Tmap.Format.XML.CONTENT_TYPE.MIXED;else{if(c)return Tmap.Format.XML.CONTENT_TYPE.COMPLEX;if(b)return Tmap.Format.XML.CONTENT_TYPE.SIMPLE}return d},hasAttributeNS:function(a,b,c){var d=!1;return d=a.hasAttributeNS?a.hasAttributeNS(b,c):!!this.getAttributeNodeNS(a,b,c)},setAttributeNS:function(a,b,c,d){if(a.setAttributeNS)a.setAttributeNS(b,c,d);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(b){var e=a.ownerDocument.createNode(2,c,b);e.nodeValue=d,a.setAttributeNode(e)}else a.setAttribute(c,d)}},createElementNSPlus:function(a,b){b=b||{};var c=b.uri||this.namespaces[b.prefix];if(!c){var d=a.indexOf(":");c=this.namespaces[a.substring(0,d)]}c||(c=this.namespaces[this.defaultPrefix]);var e=this.createElementNS(c,a);b.attributes&&this.setAttributes(e,b.attributes);var f=b.value;return null!=f&&e.appendChild(this.createTextNode(f)),e},setAttributes:function(a,b){var c,d;for(var e in b)null!=b[e]&&b[e].toString&&(c=b[e].toString(),d=this.namespaces[e.substring(0,e.indexOf(":"))]||null,this.setAttributeNS(a,d,e,c))},readNode:function(a,b){b||(b={});var c=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(c){var d=a.localName||a.nodeName.split(":").pop(),e=c[d]||c["*"];e&&e.apply(this,[a,b])}return b},readChildNodes:function(a,b){b||(b={});for(var c,d=a.childNodes,e=0,f=d.length;f>e;++e)c=d[e],1==c.nodeType&&this.readNode(c,b);return b},writeNode:function(a,b,c){var d,e,f=a.indexOf(":");f>0?(d=a.substring(0,f),e=a.substring(f+1)):(d=c?this.namespaceAlias[c.namespaceURI]:this.defaultPrefix,e=a);var g=this.writers[d][e].apply(this,[b]);return c&&c.appendChild(g),g},getChildEl:function(a,b,c){return a&&this.getThisOrNextEl(a.firstChild,b,c)},getNextEl:function(a,b,c){return a&&this.getThisOrNextEl(a.nextSibling,b,c)},getThisOrNextEl:function(a,b,c){a:for(var d=a;d;d=d.nextSibling)switch(d.nodeType){case 1:if(!(b&&b!==(d.localName||d.nodeName.split(":").pop())||c&&c!==d.namespaceURI))break a;d=null;break a;case 3:if(/^\s*$/.test(d.nodeValue))break;case 4:case 6:case 12:case 10:case 11:d=null;break a}return d||null},lookupNamespaceURI:function(a,b){var c=null;if(a)if(a.lookupNamespaceURI)c=a.lookupNamespaceURI(b);else a:switch(a.nodeType){case 1:if(null!==a.namespaceURI&&a.prefix===b){c=a.namespaceURI;break a}var d=a.attributes.length;if(d)for(var e,f=0;d>f;++f){if(e=a.attributes[f],"xmlns"===e.prefix&&e.name==="xmlns:"+b){c=e.value||null;break a}if("xmlns"===e.name&&null===b){c=e.value||null;break a}}c=this.lookupNamespaceURI(a.parentNode,b);break a;case 2:c=this.lookupNamespaceURI(a.ownerElement,b);break a;case 9:c=this.lookupNamespaceURI(a.documentElement,b);break a;case 6:case 12:case 10:case 11:break a;default:c=this.lookupNamespaceURI(a.parentNode,b)}return c},getXMLDoc:function(){return Tmap.Format.XML.document||this.xmldom||(document.implementation&&document.implementation.createDocument?Tmap.Format.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"))),Tmap.Format.XML.document||this.xmldom},CLASS_NAME:"Tmap.Format.XML"}),Tmap.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3},Tmap.Format.XML.lookupNamespaceURI=Tmap.Function.bind(Tmap.Format.XML.prototype.lookupNamespaceURI,Tmap.Format.XML.prototype),Tmap.Format.XML.document=null,Tmap.Format.XML.VersionedOGC=Tmap.Class(Tmap.Format.XML,{defaultVersion:null,version:null,profile:null,allowFallback:!1,name:null,stringifyOutput:!1,parser:null,initialize:function(a){Tmap.Format.XML.prototype.initialize.apply(this,[a]);var b=this.CLASS_NAME;this.name=b.substring(b.lastIndexOf(".")+1)},getVersion:function(a,b){var c;return a?(c=this.version,c||(c=a.getAttribute("version"),c||(c=this.defaultVersion))):c=b&&b.version||this.version||this.defaultVersion,c},getParser:function(a){a=a||this.defaultVersion;var b=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=a){var c=Tmap.Format[this.name]["v"+a.replace(/\./g,"_")+b];if(!c&&(""!==b&&this.allowFallback&&(b="",c=Tmap.Format[this.name]["v"+a.replace(/\./g,"_")]),!c))throw"Can't find a "+this.name+" parser for version "+a+b;this.parser=new c(this.options)}return this.parser},write:function(a,b){var c=this.getVersion(null,b);this.parser=this.getParser(c);var d=this.parser.write(a,b);return this.stringifyOutput===!1?d:Tmap.Format.XML.prototype.write.apply(this,[d])},read:function(a,b){"string"==typeof a&&(a=Tmap.Format.XML.prototype.read.apply(this,[a]));var c=a.documentElement,d=this.getVersion(c);this.parser=this.getParser(d);var e=this.parser.read(a,b),f=this.parser.errorProperty||null;if(null!==f&&void 0===e[f]){var g=new Tmap.Format.OGCExceptionReport;e.error=g.read(a)}return e.version=d,e},CLASS_NAME:"Tmap.Format.XML.VersionedOGC"}),Tmap.Format.GML=Tmap.Class(Tmap.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},Tmap.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){"string"==typeof a&&(a=Tmap.Format.XML.prototype.read.apply(this,[a]));for(var b=this.getElementsByTagNameNS(a.documentElement,this.gmlns,this.featureName),c=[],d=0;d<b.length;d++){var e=this.parseFeature(b[d]);e&&c.push(e)}return c},parseFeature:function(a){for(var b,c,d,e,f=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],g=0;g<f.length;++g)if(b=f[g],c=this.getElementsByTagNameNS(a,this.gmlns,b),c.length>0){if(e=this.parseGeometry[b.toLowerCase()],!e)throw new TypeError("Unsupported geometry type: "+b);d=e.apply(this,[c[0]]),this.internalProjection&&this.externalProjection&&d.transform(this.externalProjection,this.internalProjection);break}var h,i=this.getElementsByTagNameNS(a,this.gmlns,"Box");for(g=0;g<i.length;++g){var j=i[g],k=this.parseGeometry.box.apply(this,[j]),l=j.parentNode,m=l.localName||l.nodeName.split(":").pop();"boundedBy"===m?h=k:d=k.toGeometry()}var n;this.extractAttributes&&(n=this.parseAttributes(a));var o=new Tmap.Feature.Vector(d,n);o.bounds=h,o.gml={featureType:a.firstChild.nodeName.split(":")[1],featureNS:a.firstChild.namespaceURI,featureNSPrefix:a.firstChild.prefix};for(var p,q=a.firstChild;q&&(1!=q.nodeType||!(p=q.getAttribute("fid")||q.getAttribute("id")));)q=q.nextSibling;return o.fid=p,o},parseGeometry:{point:function(a){var b,c,d=[],b=this.getElementsByTagNameNS(a,this.gmlns,"pos");if(b.length>0&&(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),d=c.split(this.regExes.splitSpace)),0==d.length&&(b=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),b.length>0&&(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.removeSpace,""),d=c.split(","))),0==d.length&&(b=this.getElementsByTagNameNS(a,this.gmlns,"coord"),b.length>0)){var e=this.getElementsByTagNameNS(b[0],this.gmlns,"X"),f=this.getElementsByTagNameNS(b[0],this.gmlns,"Y");e.length>0&&f.length>0&&(d=[e[0].firstChild.nodeValue,f[0].firstChild.nodeValue])}return 2==d.length&&(d[2]=null),this.xy?new Tmap.Geometry.Point(d[0],d[1],d[2]):new Tmap.Geometry.Point(d[1],d[0],d[2])},multipoint:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"Point"),c=[];if(b.length>0)for(var d,e=0;e<b.length;++e)d=this.parseGeometry.point.apply(this,[b[e]]),d&&c.push(d);return new Tmap.Geometry.MultiPoint(c)},linestring:function(a,b){var c,d,e=[],f=[];if(c=this.getElementsByTagNameNS(a,this.gmlns,"posList"),c.length>0){d=this.getChildValue(c[0]),d=d.replace(this.regExes.trimSpace,""),e=d.split(this.regExes.splitSpace);for(var g,h,i,j,k=parseInt(c[0].getAttribute("dimension")),l=0;l<e.length/k;++l)g=l*k,h=e[g],i=e[g+1],j=2==k?null:e[g+2],this.xy?f.push(new Tmap.Geometry.Point(h,i,j)):f.push(new Tmap.Geometry.Point(i,h,j))}if(0==e.length&&(c=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),c.length>0)){d=this.getChildValue(c[0]),d=d.replace(this.regExes.trimSpace,""),d=d.replace(this.regExes.trimComma,",");for(var m=d.split(this.regExes.splitSpace),l=0;l<m.length;++l)e=m[l].split(","),2==e.length&&(e[2]=null),this.xy?f.push(new Tmap.Geometry.Point(e[0],e[1],e[2])):f.push(new Tmap.Geometry.Point(e[1],e[0],e[2]))}var n=null;return 0!=f.length&&(n=b?new Tmap.Geometry.LinearRing(f):new Tmap.Geometry.LineString(f)),n},multilinestring:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"LineString"),c=[];if(b.length>0)for(var d,e=0;e<b.length;++e)d=this.parseGeometry.linestring.apply(this,[b[e]]),d&&c.push(d);return new Tmap.Geometry.MultiLineString(c)},polygon:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"LinearRing"),c=[];if(b.length>0)for(var d,e=0;e<b.length;++e)d=this.parseGeometry.linestring.apply(this,[b[e],!0]),d&&c.push(d);return new Tmap.Geometry.Polygon(c)},multipolygon:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"Polygon"),c=[];if(b.length>0)for(var d,e=0;e<b.length;++e)d=this.parseGeometry.polygon.apply(this,[b[e]]),d&&c.push(d);return new Tmap.Geometry.MultiPolygon(c)},envelope:function(a){var b,c,d=[],e=this.getElementsByTagNameNS(a,this.gmlns,"lowerCorner");if(e.length>0){var f=[];if(e.length>0&&(b=e[0].firstChild.nodeValue,b=b.replace(this.regExes.trimSpace,""),f=b.split(this.regExes.splitSpace)),2==f.length&&(f[2]=null),this.xy)var g=new Tmap.Geometry.Point(f[0],f[1],f[2]);else var g=new Tmap.Geometry.Point(f[1],f[0],f[2])}var h=this.getElementsByTagNameNS(a,this.gmlns,"upperCorner");if(h.length>0){var f=[];if(h.length>0&&(b=h[0].firstChild.nodeValue,b=b.replace(this.regExes.trimSpace,""),f=b.split(this.regExes.splitSpace)),2==f.length&&(f[2]=null),this.xy)var i=new Tmap.Geometry.Point(f[0],f[1],f[2]);else var i=new Tmap.Geometry.Point(f[1],f[0],f[2])}if(g&&i){d.push(new Tmap.Geometry.Point(g.x,g.y)),d.push(new Tmap.Geometry.Point(i.x,g.y)),d.push(new Tmap.Geometry.Point(i.x,i.y)),d.push(new Tmap.Geometry.Point(g.x,i.y)),d.push(new Tmap.Geometry.Point(g.x,g.y));var j=new Tmap.Geometry.LinearRing(d);c=new Tmap.Geometry.Polygon([j])}return c},box:function(a){var b,c,d=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),e=null,f=null;return d.length>0&&(b=d[0].firstChild.nodeValue,c=b.split(" "),2==c.length&&(e=c[0].split(","),f=c[1].split(","))),null!==e&&null!==f?new Tmap.Bounds(parseFloat(e[0]),parseFloat(e[1]),parseFloat(f[0]),parseFloat(f[1])):void 0}},parseAttributes:function(a){for(var b,c,d,e,f,g,h,i={},j=a.firstChild;j;){if(1==j.nodeType){for(b=j.childNodes,c=0;c<b.length;++c)d=b[c],1==d.nodeType&&(e=d.childNodes,1==e.length?(f=e[0],(3==f.nodeType||4==f.nodeType)&&(g=d.prefix?d.nodeName.split(":")[1]:d.nodeName,h=f.nodeValue.replace(this.regExes.trimSpace,""),i[g]=h)):i[d.nodeName.split(":").pop()]=null);break}j=j.nextSibling}return i},write:function(a){Tmap.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),c=0;c<a.length;c++)b.appendChild(this.createFeatureXML(a[c]));return Tmap.Format.XML.prototype.write.apply(this,[b])},createFeatureXML:function(a){var b=a.geometry,c=this.buildGeometryNode(b),d=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);d.appendChild(c);var e=this.createElementNS(this.gmlns,"gml:"+this.featureName),f=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),g=a.fid||a.id;f.setAttribute("fid",g),f.appendChild(d);for(var h in a.attributes){var i=this.createTextNode(a.attributes[h]),j=h.substring(h.lastIndexOf(":")+1),k=this.createElementNS(this.featureNS,this.featurePrefix+":"+j);k.appendChild(i),f.appendChild(k)}return e.appendChild(f),e},buildGeometryNode:function(a){this.externalProjection&&this.internalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME,c=b.substring(b.lastIndexOf(".")+1),d=this.buildGeometry[c.toLowerCase()];return d.apply(this,[a])},buildGeometry:{point:function(a){var b=this.createElementNS(this.gmlns,"gml:Point");return b.appendChild(this.buildCoordinatesNode(a)),b},multipoint:function(a){for(var b,c,d=this.createElementNS(this.gmlns,"gml:MultiPoint"),e=a.components,f=0;f<e.length;f++)b=this.createElementNS(this.gmlns,"gml:pointMember"),c=this.buildGeometry.point.apply(this,[e[f]]),b.appendChild(c),d.appendChild(b);return d},linestring:function(a){var b=this.createElementNS(this.gmlns,"gml:LineString");return b.appendChild(this.buildCoordinatesNode(a)),b},multilinestring:function(a){for(var b,c,d=this.createElementNS(this.gmlns,"gml:MultiLineString"),e=a.components,f=0;f<e.length;++f)b=this.createElementNS(this.gmlns,"gml:lineStringMember"),c=this.buildGeometry.linestring.apply(this,[e[f]]),b.appendChild(c),d.appendChild(b);return d},linearring:function(a){var b=this.createElementNS(this.gmlns,"gml:LinearRing");return b.appendChild(this.buildCoordinatesNode(a)),b},polygon:function(a){for(var b,c,d,e=this.createElementNS(this.gmlns,"gml:Polygon"),f=a.components,g=0;g<f.length;++g)d=0==g?"outerBoundaryIs":"innerBoundaryIs",b=this.createElementNS(this.gmlns,"gml:"+d),c=this.buildGeometry.linearring.apply(this,[f[g]]),b.appendChild(c),e.appendChild(b);return e},multipolygon:function(a){for(var b,c,d=this.createElementNS(this.gmlns,"gml:MultiPolygon"),e=a.components,f=0;f<e.length;++f)b=this.createElementNS(this.gmlns,"gml:polygonMember"),c=this.buildGeometry.polygon.apply(this,[e[f]]),b.appendChild(c),d.appendChild(b);return d},bounds:function(a){var b=this.createElementNS(this.gmlns,"gml:Box");return b.appendChild(this.buildCoordinatesNode(a)),b}},buildCoordinatesNode:function(a){var b=this.createElementNS(this.gmlns,"gml:coordinates");b.setAttribute("decimal","."),b.setAttribute("cs",","),b.setAttribute("ts"," ");var c=[];if(a instanceof Tmap.Bounds)c.push(a.left+","+a.bottom),c.push(a.right+","+a.top);else for(var d=a.components?a.components:[a],e=0;e<d.length;e++)c.push(d[e].x+","+d[e].y);var f=this.createTextNode(c.join(" "));return b.appendChild(f),b},CLASS_NAME:"Tmap.Format.GML"}),Tmap.Format.GML||(Tmap.Format.GML={}),Tmap.Format.GML.Base=Tmap.Class(Tmap.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},initialize:function(a){Tmap.Format.XML.prototype.initialize.apply(this,[a]),this.setGeometryTypes(),a&&a.featureNS&&this.setNamespace("feature",a.featureNS),this.singleFeatureType=!a||"string"==typeof a.featureType},read:function(a){"string"==typeof a&&(a=Tmap.Format.XML.prototype.read.apply(this,[a])),a&&9==a.nodeType&&(a=a.documentElement);var b=[];if(this.readNode(a,{features:b},!0),0==b.length){var c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMember");if(c.length)for(var d=0,e=c.length;e>d;++d)this.readNode(c[d],{features:b},!0);else{var c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMembers");c.length&&this.readNode(c[0],{features:b},!0)}}return b},readNode:function(a,b,c){return c===!0&&this.autoConfig===!0&&(this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null),this.featureNS||a.prefix in this.namespaces||a.parentNode.namespaceURI!=this.namespaces.gml||!this.regExes.featureMember.test(a.parentNode.nodeName)||(this.featureType=a.nodeName.split(":").pop(),this.setNamespace("feature",a.namespaceURI),this.featureNS=a.namespaceURI,this.autoConfig=!0),Tmap.Format.XML.prototype.readNode.apply(this,[a,b])},readers:{gml:{_inherit:function(a,b,c){},featureMember:function(a,b){this.readChildNodes(a,b)},featureMembers:function(a,b){this.readChildNodes(a,b)},name:function(a,b){b.name=this.getChildValue(a)},boundedBy:function(a,b){var c={};this.readChildNodes(a,c),c.components&&c.components.length>0&&(b.bounds=c.components[0])},Point:function(a,b){var c={points:[]};this.readChildNodes(a,c),b.components||(b.components=[]),b.components.push(c.points[0])},coordinates:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"");c=c.replace(this.regExes.trimComma,",");for(var d,e=c.split(this.regExes.splitSpace),f=e.length,g=new Array(f),h=0;f>h;++h)d=e[h].split(","),this.xy?g[h]=new Tmap.Geometry.Point(d[0],d[1],d[2]):g[h]=new Tmap.Geometry.Point(d[1],d[0],d[2]);b.points=g},coord:function(a,b){var c={};this.readChildNodes(a,c),b.points||(b.points=[]),b.points.push(new Tmap.Geometry.Point(c.x,c.y,c.z))},X:function(a,b){b.x=this.getChildValue(a)},Y:function(a,b){b.y=this.getChildValue(a)},Z:function(a,b){b.z=this.getChildValue(a)},MultiPoint:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components=[new Tmap.Geometry.MultiPoint(c.components)]},pointMember:function(a,b){this.readChildNodes(a,b)},LineString:function(a,b){var c={};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components||(b.components=[]),b.components.push(new Tmap.Geometry.LineString(c.points))},MultiLineString:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components=[new Tmap.Geometry.MultiLineString(c.components)]},lineStringMember:function(a,b){this.readChildNodes(a,b)},Polygon:function(a,b){var c={outer:null,inner:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),c.inner.unshift(c.outer),b.components||(b.components=[]),b.components.push(new Tmap.Geometry.Polygon(c.inner))},LinearRing:function(a,b){var c={};this.readers.gml._inherit.apply(this,[a,c]),this.readChildNodes(a,c),b.components=[new Tmap.Geometry.LinearRing(c.points)]},MultiPolygon:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components=[new Tmap.Geometry.MultiPolygon(c.components)]},polygonMember:function(a,b){this.readChildNodes(a,b)},GeometryCollection:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components=[new Tmap.Geometry.Collection(c.components)]},geometryMember:function(a,b){this.readChildNodes(a,b)}},feature:{"*":function(a,b){var c,d=a.localName||a.nodeName.split(":").pop();b.features?this.singleFeatureType||-1===Tmap.Util.indexOf(this.featureType,d)?d===this.featureType&&(c="_typeName"):c="_typeName":0==a.childNodes.length||1==a.childNodes.length&&3==a.firstChild.nodeType?this.extractAttributes&&(c="_attribute"):c="_geometry",c&&this.readers.feature[c].apply(this,[a,b])},_typeName:function(a,b){var c={components:[],attributes:{}};this.readChildNodes(a,c),c.name&&(c.attributes.name=c.name);var d=new Tmap.Feature.Vector(c.components[0],c.attributes);this.singleFeatureType||(d.type=a.nodeName.split(":").pop(),d.namespace=a.namespaceURI);var e=a.getAttribute("fid")||this.getAttributeNS(a,this.namespaces.gml,"id");e&&(d.fid=e),this.internalProjection&&this.externalProjection&&d.geometry&&d.geometry.transform(this.externalProjection,this.internalProjection),c.bounds&&(d.bounds=c.bounds),b.features.push(d)},_geometry:function(a,b){this.geometryName||(this.geometryName=a.nodeName.split(":").pop()),this.readChildNodes(a,b)},_attribute:function(a,b){var c=a.localName||a.nodeName.split(":").pop(),d=this.getChildValue(a);b.attributes[c]=d}},wfs:{FeatureCollection:function(a,b){this.readChildNodes(a,b)}}},write:function(a){var b;b=Tmap.Util.isArray(a)?"featureMembers":"featureMember";var c=this.writeNode("gml:"+b,a);return this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),Tmap.Format.XML.prototype.write.apply(this,[c])},writers:{gml:{featureMember:function(a){var b=this.createElementNSPlus("gml:featureMember");return this.writeNode("feature:_typeName",a,b),b},MultiPoint:function(a){for(var b=this.createElementNSPlus("gml:MultiPoint"),c=a.components||[a],d=0,e=c.length;e>d;++d)this.writeNode("pointMember",c[d],b);return b},pointMember:function(a){var b=this.createElementNSPlus("gml:pointMember");return this.writeNode("Point",a,b),b},MultiLineString:function(a){for(var b=this.createElementNSPlus("gml:MultiLineString"),c=a.components||[a],d=0,e=c.length;e>d;++d)this.writeNode("lineStringMember",c[d],b);return b},lineStringMember:function(a){var b=this.createElementNSPlus("gml:lineStringMember");return this.writeNode("LineString",a,b),b},MultiPolygon:function(a){for(var b=this.createElementNSPlus("gml:MultiPolygon"),c=a.components||[a],d=0,e=c.length;e>d;++d)this.writeNode("polygonMember",c[d],b);return b},polygonMember:function(a){var b=this.createElementNSPlus("gml:polygonMember");return this.writeNode("Polygon",a,b),b},GeometryCollection:function(a){for(var b=this.createElementNSPlus("gml:GeometryCollection"),c=0,d=a.components.length;d>c;++c)this.writeNode("geometryMember",a.components[c],b);return b},geometryMember:function(a){var b=this.createElementNSPlus("gml:geometryMember"),c=this.writeNode("feature:_geometry",a);return b.appendChild(c.firstChild),b}},feature:{_typeName:function(a){var b=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:a.fid}});a.geometry&&this.writeNode("feature:_geometry",a.geometry,b);for(var c in a.attributes){var d=a.attributes[c];null!=d&&this.writeNode("feature:_attribute",{name:c,value:d},b)}return b},_geometry:function(a){this.externalProjection&&this.internalProjection&&(a=a.clone().transform(this.internalProjection,this.externalProjection));var b=this.createElementNSPlus("feature:"+this.geometryName),c=this.geometryTypes[a.CLASS_NAME],d=this.writeNode("gml:"+c,a,b);return this.srsName&&d.setAttribute("srsName",this.srsName),b},_attribute:function(a){return this.createElementNSPlus("feature:"+a.name,{value:a.value})}},wfs:{FeatureCollection:function(a){for(var b=this.createElementNSPlus("wfs:FeatureCollection"),c=0,d=a.length;d>c;++c)this.writeNode("gml:featureMember",a[c],b);return b}}},setGeometryTypes:function(){this.geometryTypes={"Tmap.Geometry.Point":"Point","Tmap.Geometry.MultiPoint":"MultiPoint","Tmap.Geometry.LineString":"LineString","Tmap.Geometry.MultiLineString":"MultiLineString","Tmap.Geometry.Polygon":"Polygon","Tmap.Geometry.MultiPolygon":"MultiPolygon","Tmap.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"Tmap.Format.GML.Base"}),Tmap.Format.GML.v2=Tmap.Class(Tmap.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(a){Tmap.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:Tmap.Util.applyDefaults({outerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c),b.outer=c.components[0]},innerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c),b.inner.push(c.components[0])},Box:function(a,b){var c={};this.readChildNodes(a,c),b.components||(b.components=[]);var d=c.points[0],e=c.points[1];b.components.push(new Tmap.Bounds(d.x,d.y,e.x,e.y))}},Tmap.Format.GML.Base.prototype.readers.gml),feature:Tmap.Format.GML.Base.prototype.readers.feature,wfs:Tmap.Format.GML.Base.prototype.readers.wfs},write:function(a){var b;b=Tmap.Util.isArray(a)?"wfs:FeatureCollection":"gml:featureMember";var c=this.writeNode(b,a);return this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),Tmap.Format.XML.prototype.write.apply(this,[c])},writers:{gml:Tmap.Util.applyDefaults({Point:function(a){var b=this.createElementNSPlus("gml:Point");return this.writeNode("coordinates",[a],b),b},coordinates:function(a){for(var b,c=a.length,d=new Array(c),e=0;c>e;++e)b=a[e],this.xy?d[e]=b.x+","+b.y:d[e]=b.y+","+b.x,void 0!=b.z&&(d[e]+=","+b.z);return this.createElementNSPlus("gml:coordinates",{attributes:{decimal:".",cs:",",ts:" "},value:1==c?d[0]:d.join(" ")})},LineString:function(a){var b=this.createElementNSPlus("gml:LineString");return this.writeNode("coordinates",a.components,b),b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("outerBoundaryIs",a.components[0],b);for(var c=1;c<a.components.length;++c)this.writeNode("innerBoundaryIs",a.components[c],b);return b},outerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:outerBoundaryIs");return this.writeNode("LinearRing",a,b),b},innerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:innerBoundaryIs");return this.writeNode("LinearRing",a,b),b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");return this.writeNode("coordinates",a.components,b),b},Box:function(a){var b=this.createElementNSPlus("gml:Box");return this.writeNode("coordinates",[{x:a.left,y:a.bottom},{x:a.right,y:a.top}],b),this.srsName&&b.setAttribute("srsName",this.srsName),b}},Tmap.Format.GML.Base.prototype.writers.gml),feature:Tmap.Format.GML.Base.prototype.writers.feature,wfs:Tmap.Format.GML.Base.prototype.writers.wfs},CLASS_NAME:"Tmap.Format.GML.v2"}),Tmap.Format.GML.v3=Tmap.Class(Tmap.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(a){Tmap.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:Tmap.Util.applyDefaults({_inherit:function(a,b,c){var d=parseInt(a.getAttribute("srsDimension"),10)||c&&c.srsDimension;d&&(b.srsDimension=d)},featureMembers:function(a,b){this.readChildNodes(a,b)},Curve:function(a,b){var c={points:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),b.components||(b.components=[]),b.components.push(new Tmap.Geometry.LineString(c.points))},segments:function(a,b){this.readChildNodes(a,b)},LineStringSegment:function(a,b){var c={};this.readChildNodes(a,c),c.points&&Array.prototype.push.apply(b.points,c.points)},pos:function(a,b){var c,d=this.getChildValue(a).replace(this.regExes.trimSpace,""),e=d.split(this.regExes.splitSpace);c=this.xy?new Tmap.Geometry.Point(e[0],e[1],e[2]):new Tmap.Geometry.Point(e[1],e[0],e[2]),b.points=[c]},posList:function(a,b){for(var c,d,e,f=this.getChildValue(a).replace(this.regExes.trimSpace,""),g=f.split(this.regExes.splitSpace),h=b.srsDimension||parseInt(a.getAttribute("srsDimension")||a.getAttribute("dimension"),10)||2,i=g.length/h,j=new Array(i),k=0,l=g.length;l>k;k+=h)c=g[k],d=g[k+1],e=2==h?void 0:g[k+2],this.xy?j[k/h]=new Tmap.Geometry.Point(c,d,e):j[k/h]=new Tmap.Geometry.Point(d,c,e);b.points=j},Surface:function(a,b){this.readChildNodes(a,b)},patches:function(a,b){this.readChildNodes(a,b)},PolygonPatch:function(a,b){this.readers.gml.Polygon.apply(this,[a,b])},exterior:function(a,b){var c={};this.readChildNodes(a,c),b.outer=c.components[0];
},interior:function(a,b){var c={};this.readChildNodes(a,c),b.inner.push(c.components[0])},MultiCurve:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),c.components.length>0&&(b.components=[new Tmap.Geometry.MultiLineString(c.components)])},curveMember:function(a,b){this.readChildNodes(a,b)},MultiSurface:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]),this.readChildNodes(a,c),c.components.length>0&&(b.components=[new Tmap.Geometry.MultiPolygon(c.components)])},surfaceMember:function(a,b){this.readChildNodes(a,b)},surfaceMembers:function(a,b){this.readChildNodes(a,b)},pointMembers:function(a,b){this.readChildNodes(a,b)},lineStringMembers:function(a,b){this.readChildNodes(a,b)},polygonMembers:function(a,b){this.readChildNodes(a,b)},geometryMembers:function(a,b){this.readChildNodes(a,b)},Envelope:function(a,b){var c={points:new Array(2)};this.readChildNodes(a,c),b.components||(b.components=[]);var d=c.points[0],e=c.points[1];b.components.push(new Tmap.Bounds(d.x,d.y,e.x,e.y))},lowerCorner:function(a,b){var c={};this.readers.gml.pos.apply(this,[a,c]),b.points[0]=c.points[0]},upperCorner:function(a,b){var c={};this.readers.gml.pos.apply(this,[a,c]),b.points[1]=c.points[0]}},Tmap.Format.GML.Base.prototype.readers.gml),feature:Tmap.Format.GML.Base.prototype.readers.feature,wfs:Tmap.Format.GML.Base.prototype.readers.wfs},write:function(a){var b;b=Tmap.Util.isArray(a)?"featureMembers":"featureMember";var c=this.writeNode("gml:"+b,a);return this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation),Tmap.Format.XML.prototype.write.apply(this,[c])},writers:{gml:Tmap.Util.applyDefaults({featureMembers:function(a){for(var b=this.createElementNSPlus("gml:featureMembers"),c=0,d=a.length;d>c;++c)this.writeNode("feature:_typeName",a[c],b);return b},Point:function(a){var b=this.createElementNSPlus("gml:Point");return this.writeNode("pos",a,b),b},pos:function(a){var b=this.xy?a.x+" "+a.y:a.y+" "+a.x;return this.createElementNSPlus("gml:pos",{value:b})},LineString:function(a){var b=this.createElementNSPlus("gml:LineString");return this.writeNode("posList",a.components,b),b},Curve:function(a){var b=this.createElementNSPlus("gml:Curve");return this.writeNode("segments",a,b),b},segments:function(a){var b=this.createElementNSPlus("gml:segments");return this.writeNode("LineStringSegment",a,b),b},LineStringSegment:function(a){var b=this.createElementNSPlus("gml:LineStringSegment");return this.writeNode("posList",a.components,b),b},posList:function(a){for(var b,c=a.length,d=new Array(c),e=0;c>e;++e)b=a[e],this.xy?d[e]=b.x+" "+b.y:d[e]=b.y+" "+b.x;return this.createElementNSPlus("gml:posList",{value:d.join(" ")})},Surface:function(a){var b=this.createElementNSPlus("gml:Surface");return this.writeNode("patches",a,b),b},patches:function(a){var b=this.createElementNSPlus("gml:patches");return this.writeNode("PolygonPatch",a,b),b},PolygonPatch:function(a){var b=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",a.components[0],b);for(var c=1,d=a.components.length;d>c;++c)this.writeNode("interior",a.components[c],b);return b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",a.components[0],b);for(var c=1,d=a.components.length;d>c;++c)this.writeNode("interior",a.components[c],b);return b},exterior:function(a){var b=this.createElementNSPlus("gml:exterior");return this.writeNode("LinearRing",a,b),b},interior:function(a){var b=this.createElementNSPlus("gml:interior");return this.writeNode("LinearRing",a,b),b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");return this.writeNode("posList",a.components,b),b},MultiCurve:function(a){for(var b=this.createElementNSPlus("gml:MultiCurve"),c=a.components||[a],d=0,e=c.length;e>d;++d)this.writeNode("curveMember",c[d],b);return b},curveMember:function(a){var b=this.createElementNSPlus("gml:curveMember");return this.curve?this.writeNode("Curve",a,b):this.writeNode("LineString",a,b),b},MultiSurface:function(a){for(var b=this.createElementNSPlus("gml:MultiSurface"),c=a.components||[a],d=0,e=c.length;e>d;++d)this.writeNode("surfaceMember",c[d],b);return b},surfaceMember:function(a){var b=this.createElementNSPlus("gml:surfaceMember");return this.surface?this.writeNode("Surface",a,b):this.writeNode("Polygon",a,b),b},Envelope:function(a){var b=this.createElementNSPlus("gml:Envelope");return this.writeNode("lowerCorner",a,b),this.writeNode("upperCorner",a,b),this.srsName&&b.setAttribute("srsName",this.srsName),b},lowerCorner:function(a){var b=this.xy?a.left+" "+a.bottom:a.bottom+" "+a.left;return this.createElementNSPlus("gml:lowerCorner",{value:b})},upperCorner:function(a){var b=this.xy?a.right+" "+a.top:a.top+" "+a.right;return this.createElementNSPlus("gml:upperCorner",{value:b})}},Tmap.Format.GML.Base.prototype.writers.gml),feature:Tmap.Format.GML.Base.prototype.writers.feature,wfs:Tmap.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"Tmap.Geometry.Point":"Point","Tmap.Geometry.MultiPoint":"MultiPoint","Tmap.Geometry.LineString":this.curve===!0?"Curve":"LineString","Tmap.Geometry.MultiLineString":this.multiCurve===!1?"MultiLineString":"MultiCurve","Tmap.Geometry.Polygon":this.surface===!0?"Surface":"Polygon","Tmap.Geometry.MultiPolygon":this.multiSurface===!1?"MultiPolygon":"MultiSurface","Tmap.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"Tmap.Format.GML.v3"}),Tmap.Format.EncodedPolyline=Tmap.Class(Tmap.Format,{geometryType:"linestring",initialize:function(a){Tmap.Format.prototype.initialize.apply(this,[a])},read:function(a){var b;if("linestring"==this.geometryType)b=Tmap.Geometry.LineString;else if("linearring"==this.geometryType)b=Tmap.Geometry.LinearRing;else if("multipoint"==this.geometryType)b=Tmap.Geometry.MultiPoint;else if("point"!=this.geometryType&&"polygon"!=this.geometryType)return null;for(var c=this.decodeDeltas(a,2),d=c.length,e=[],f=0;d>f+1;){var g=c[f++],h=c[f++];e.push(new Tmap.Geometry.Point(h,g))}return"point"==this.geometryType?new Tmap.Feature.Vector(e[0]):"polygon"==this.geometryType?new Tmap.Feature.Vector(new Tmap.Geometry.Polygon([new Tmap.Geometry.LinearRing(e)])):new Tmap.Feature.Vector(new b(e))},decode:function(a,b){for(var c=this.decodeDeltas(a,b,1),d=c.length,e=[],f=0;d>f+(b-1);){for(var g=[],h=0;b>h;++h)g.push(c[f++]);e.push(g)}return e},write:function(a){var b;b=a.constructor==Array?a[0]:a;var c,d=b.geometry,e=d.CLASS_NAME.split(".")[2].toLowerCase();if("point"==e)c=new Array(d);else if("linestring"==e||"linearring"==e||"multipoint"==e)c=d.components;else{if("polygon"!=e)return null;c=d.components[0].components}for(var f=[],g=c.length,h=0;g>h;++h){var i=c[h];f.push(i.y),f.push(i.x)}return this.encodeDeltas(f,2)},encode:function(a,b){for(var c=[],d=a.length,e=0;d>e;++e)for(var f=a[e],g=0;b>g;++g)c.push(f[g]);return this.encodeDeltas(c,b,1)},encodeDeltas:function(a,b,c){var d,e=c||1e5,f=new Array(b);for(d=0;b>d;++d)f[d]=0;for(var g=a.length,h=0;g>h;)for(d=0;b>d;++d,++h){var i=a[h],j=i-f[d];f[d]=i,a[h]=j}return this.encodeFloats(a,e)},decodeDeltas:function(a,b,c){var d,e=c||1e5,f=new Array(b);for(d=0;b>d;++d)f[d]=0;for(var g=this.decodeFloats(a,e),h=g.length,i=0;h>i;)for(d=0;b>d;++d,++i)f[d]+=g[i],g[i]=f[d];return g},encodeFloats:function(a,b){for(var c=b||1e5,d=a.length,e=0;d>e;++e)a[e]=Math.round(a[e]*c);return this.encodeSignedIntegers(a)},decodeFloats:function(a,b){for(var c=b||1e5,d=this.decodeSignedIntegers(a),e=d.length,f=0;e>f;++f)d[f]/=c;return d},encodeSignedIntegers:function(a){for(var b=a.length,c=0;b>c;++c){var d=a[c],e=d<<1;0>d&&(e=~e),a[c]=e}return this.encodeUnsignedIntegers(a)},decodeSignedIntegers:function(a){for(var b=this.decodeUnsignedIntegers(a),c=b.length,d=0;c>d;++d){var e=b[d];b[d]=1&e?~(e>>1):e>>1}return b},encodeUnsignedIntegers:function(a){for(var b="",c=a.length,d=0;c>d;++d)b+=this.encodeUnsignedInteger(a[d]);return b},decodeUnsignedIntegers:function(a){for(var b=[],c=0,d=0,e=a.length,f=0;e>f;++f){var g=a.charCodeAt(f)-63;c|=(31&g)<<d,32>g?(b.push(c),c=0,d=0):d+=5}return b},encodeFloat:function(a,b){return a=Math.round(a*(b||1e5)),this.encodeSignedInteger(a)},decodeFloat:function(a,b){var c=this.decodeSignedInteger(a);return c/(b||1e5)},encodeSignedInteger:function(a){var b=a<<1;return 0>a&&(b=~b),this.encodeUnsignedInteger(b)},decodeSignedInteger:function(a){var b=this.decodeUnsignedInteger(a);return 1&b?~(b>>1):b>>1},encodeUnsignedInteger:function(a){for(var b,c="";a>=32;)b=(32|31&a)+63,c+=String.fromCharCode(b),a>>=5;return b=a+63,c+=String.fromCharCode(b)},decodeUnsignedInteger:function(a){for(var b=0,c=0,d=a.length,e=0;d>e;++e){var f=a.charCodeAt(e)-63;if(b|=(31&f)<<c,32>f)break;c+=5}return b},CLASS_NAME:"Tmap.Format.EncodedPolyline"}),Tmap.Format.KML=Tmap.Class(Tmap.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"Tmap export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,trafficParseYn:false,trafficDefaultColor:"#000000",trafficType1Color:"#009900",trafficType2Color:"#FF5E00",trafficType3Color:"#FF0000",initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g},this.externalProjection=new Tmap.Projection("EPSG:4326"),Tmap.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){this.features=[],this.styles={},this.fetched={};var b={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(a,b)},readTraffic:function(data){this.features=[];this.styles={};this.fetched={};this.trafficParseYn=true;var options={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseTrafficData(data,options)},parseData:function(a,b){"string"==typeof a&&(a=Tmap.Format.XML.prototype.read.apply(this,[a]));for(var c=["Link","NetworkLink","Style","StyleMap","Placemark"],d=0,e=c.length;e>d;++d){var f=c[d],g=this.getElementsByTagNameNS(a,"*",f);if(0!=g.length)switch(f.toLowerCase()){case"link":case"networklink":this.parseLinks(g,b);break;case"style":this.extractStyles&&this.parseStyles(g,b);break;case"stylemap":this.extractStyles&&this.parseStyleMaps(g,b);break;case"placemark":this.parseFeatures(g,b)}}return this.features},parseTrafficData:function(data,options){if(typeof data=="string"){data=Tmap.Format.XML.prototype.read.apply(this,[data])}var types=["Link","NetworkLink","Style","StyleMap","Placemark"];for(var i=0,len=types.length;i<len;++i){var type=types[i];var nodes=this.getElementsByTagNameNS(data,"*",type);if(nodes.length==0){continue}switch(type.toLowerCase()){case"link":case"networklink":this.parseLinks(nodes,options);break;case"style":if(this.extractStyles){this.parseStyles(nodes,options)}break;case"stylemap":if(this.extractStyles){this.parseStyleMaps(nodes,options)}break;case"placemark":this.parseTrafficFeatures(nodes,options);break}}return this.features},parseLinks:function(a,b){if(b.depth>=this.maxDepth)return!1;var c=Tmap.Util.extend({},b);c.depth++;for(var d=0,e=a.length;e>d;d++){var f=this.parseProperty(a[d],"*","href");if(f&&!this.fetched[f]){this.fetched[f]=!0;var g=this.fetchLink(f);g&&this.parseData(g,c)}}},fetchLink:function(a){var b=Tmap.Request.GET({url:a,async:!1});return b?b.responseText:void 0},parseStyles:function(a,b){for(var c=0,d=a.length;d>c;c++){var e=this.parseStyle(a[c]);if(e){var f=(b.styleBaseUrl||"")+"#"+e.id;this.styles[f]=e}}},parseKmlColor:function(a){var b=null;if(a){var c=a.match(this.regExes.kmlColor);c&&(b={color:"#"+c[4]+c[3]+c[2],opacity:parseInt(c[1],16)/255})}return b},parseStyle:function(a){for(var b,c,d={},e=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],f=0,g=e.length;g>f;++f)if(b=e[f],c=this.getElementsByTagNameNS(a,"*",b)[0])switch(b.toLowerCase()){case"linestyle":var h=this.parseProperty(c,"*","color"),i=this.parseKmlColor(h);i&&(d.strokeColor=i.color,d.strokeOpacity=i.opacity);var j=this.parseProperty(c,"*","width");j&&(d.strokeWidth=j);break;case"polystyle":var h=this.parseProperty(c,"*","color"),i=this.parseKmlColor(h);i&&(d.fillOpacity=i.opacity,d.fillColor=i.color);var k=this.parseProperty(c,"*","fill");"0"==k&&(d.fillColor="none");var l=this.parseProperty(c,"*","outline");"0"==l&&(d.strokeWidth="0");break;case"iconstyle":var m=parseFloat(this.parseProperty(c,"*","scale")||1),j=32*m,n=32*m,o=this.getElementsByTagNameNS(c,"*","Icon")[0];if(o){var p=this.parseProperty(o,"*","href");if(p){var q=this.parseProperty(o,"*","w"),r=this.parseProperty(o,"*","h"),s="http://maps.google.com/mapfiles/kml";!Tmap.String.startsWith(p,s)||q||r||(q=64,r=64,m/=2),q=q||r,r=r||q,q&&(j=parseInt(q)*m),r&&(n=parseInt(r)*m);var t=p.match(this.regExes.kmlIconPalette);if(t){var u=t[1],v=t[2],w=this.parseProperty(o,"*","x"),x=this.parseProperty(o,"*","y"),y=w?w/32:0,z=x?7-x/32:7,A=8*z+y;p="http://maps.google.com/mapfiles/kml/pal"+u+"/icon"+A+v}d.graphicOpacity=1,d.externalGraphic=p}}var B=this.getElementsByTagNameNS(c,"*","hotSpot")[0];if(B){var w=parseFloat(B.getAttribute("x")),x=parseFloat(B.getAttribute("y")),C=B.getAttribute("xunits");"pixels"==C?d.graphicXOffset=-w*m:"insetPixels"==C?d.graphicXOffset=-j+w*m:"fraction"==C&&(d.graphicXOffset=-j*w);var D=B.getAttribute("yunits");"pixels"==D?d.graphicYOffset=-n+x*m+1:"insetPixels"==D?d.graphicYOffset=-(x*m)+1:"fraction"==D&&(d.graphicYOffset=-n*(1-x)+1)}d.graphicWidth=j,d.graphicHeight=n;break;case"balloonstyle":var E=Tmap.Util.getXmlNodeValue(c);E&&(d.balloonStyle=E.replace(this.regExes.straightBracket,"${$1}"));break;case"labelstyle":var h=this.parseProperty(c,"*","color"),i=this.parseKmlColor(h);i&&(d.fontColor=i.color,d.fontOpacity=i.opacity)}!d.strokeColor&&d.fillColor&&(d.strokeColor=d.fillColor);var F=a.getAttribute("id");return F&&d&&(d.id=F),d},parseStyleMaps:function(a,b){for(var c=0,d=a.length;d>c;c++)for(var e=a[c],f=this.getElementsByTagNameNS(e,"*","Pair"),g=e.getAttribute("id"),h=0,i=f.length;i>h;h++){var j=f[h],k=this.parseProperty(j,"*","key"),l=this.parseProperty(j,"*","styleUrl");l&&"normal"==k&&(this.styles[(b.styleBaseUrl||"")+"#"+g]=this.styles[(b.styleBaseUrl||"")+l])}},parseFeatures:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=a[d],g=this.parseFeature.apply(this,[f]);if(!g)throw"Bad Placemark: "+d;if(this.extractStyles&&g.attributes&&g.attributes.styleUrl&&(g.style=this.getStyle(g.attributes.styleUrl,b)),this.extractStyles){var h=this.getElementsByTagNameNS(f,"*","Style")[0];if(h){var i=this.parseStyle(h);i&&(g.style=Tmap.Util.extend(g.style,i))}}if(this.extractTracks){var j=this.getElementsByTagNameNS(f,this.namespaces.gx,"Track");if(j&&j.length>0){var k=j[0],l={features:[],feature:g};this.readNode(k,l),l.features.length>0&&c.push.apply(c,l.features)}}else c.push(g)}this.features=this.features.concat(c)},parseTrafficFeatures:function(nodes,options){var features=[];var startfeatures,endfeatures;for(var i=0,len=nodes.length;i<len;i++){var featureNode=nodes[i];this.internalns=featureNode.namespaceURI?featureNode.namespaceURI:this.kmlns;var nodetype=(this.getElementsByTagNameNS(featureNode,this.internalns,"LineString")).length;var LineStringTraffic=false;var LineStringTrafficChk=false;var trafficData="";if(nodetype>0){trafficData=this.getElementsByTagNameNS(featureNode,this.internalns,"traffic");LineStringTrafficChk=true;if(trafficData.length>0&&trafficData[0].firstChild!=null){LineStringTraffic=true}}if(LineStringTrafficChk||LineStringTraffic){var setTrafficDatas=[];var setTrafficCnt=0;var nodeList=this.getElementsByTagNameNS(featureNode,this.internalns,"coordinates");var coordString=this.getChildValue(nodeList[0]);coordString=coordString.replace(this.regExes.trimSpace,"");coordString=coordString.replace(this.regExes.trimComma,",");var pointList=coordString.split(this.regExes.splitSpace);var numPoints=pointList.length;if(LineStringTraffic){var trafficString=(trafficData[0].firstChild.nodeValue).replace(/\s+$/,"");var trafficcoords=trafficString.split(" ");var trafficcoordsLang=trafficcoords.length;for(var trchk=0;trchk<trafficcoordsLang;trchk++){var trafficList=trafficcoords[trchk].split(",");var startcnt=parseInt(trafficList[0]);var endcnt=parseInt(trafficList[1]);if(trchk==0){if(startcnt==trchk){setTrafficDatas[setTrafficCnt++]=trafficcoords[0]}else{setTrafficDatas[setTrafficCnt++]="0,"+startcnt+",0,0";setTrafficDatas[setTrafficCnt++]=trafficcoords[0]}}else{var trafficList=trafficcoords[trchk-1].split(",");var before_endcnt=parseInt(trafficList[1]);if(before_endcnt==startcnt){setTrafficDatas[setTrafficCnt++]=trafficcoords[trchk]}else{setTrafficDatas[setTrafficCnt++]=before_endcnt+","+startcnt+",0,0";setTrafficDatas[setTrafficCnt++]=trafficcoords[trchk]}}if(trchk==trafficcoordsLang-1){if(endcnt!=numPoints-1){setTrafficDatas[setTrafficCnt++]=endcnt+","+(numPoints-1)+",0,0"}}}}else{setTrafficDatas[setTrafficCnt++]="0,"+(numPoints-1)+",0,0"}trafficcoordsLang=setTrafficDatas.length;for(var trno=0;trno<trafficcoordsLang;trno++){featureNode.trafficData=setTrafficDatas[trno];var feature=this.parseTrafficCheck.apply(this,[featureNode]);if(feature){if(this.extractStyles&&feature.attributes&&feature.attributes.styleUrl){feature.style=this.getStyle(feature.attributes.styleUrl,options)}var cutTraffic=setTrafficDatas[trno].split(",");feature.style.strokeOpacity=1;if("1"==cutTraffic[2]){feature.style.strokeColor=this.trafficType1Color}else if("2"==cutTraffic[2]){feature.style.strokeColor=this.trafficType2Color}else if("4"==cutTraffic[2]){feature.style.strokeColor=this.trafficType3Color}else{feature.style.strokeColor=this.trafficDefaultColor}features.push(feature)}else{throw"Bad Placemark: "+i+"/ Bad TrafficData: "+trno;}}}else{var feature=this.parseTrafficFeature.apply(this,[featureNode]);if(feature){if(this.extractStyles&&feature.attributes&&feature.attributes.styleUrl){feature.style=this.getStyle(feature.attributes.styleUrl,options)}if(this.extractStyles){var inlineStyleNode=this.getElementsByTagNameNS(featureNode,"*","Style")[0];if(inlineStyleNode){var inlineStyle=this.parseStyle(inlineStyleNode);if(inlineStyle){feature.style=Tmap.Util.extend(feature.style,inlineStyle)}}}if(this.extractTracks){var tracks=this.getElementsByTagNameNS(featureNode,this.namespaces.gx,"Track");if(tracks&&tracks.length>0){var track=tracks[0];var container={features:[],feature:feature};this.readNode(track,container);if(container.features.length>0){features.push.apply(features,container.features)}}}else{if(feature.attributes.styleUrl=="#startPointStyle"||feature.attributes.styleUrl=="#endPointStyle"){if(feature.attributes.styleUrl=="#startPointStyle"){startfeatures=feature}else{endfeatures=feature}}}}else{throw"Bad Placemark: "+i;}}}features.push(startfeatures);features.push(endfeatures);this.features=this.features.concat(features)},readers:{kml:{when:function(a,b){b.whens.push(Tmap.Date.parse(this.getChildValue(a)))},_trackPointAttribute:function(a,b){var c=a.nodeName.split(":").pop();b.attributes[c].push(this.getChildValue(a))}},gx:{Track:function(a,b){var c={whens:[],points:[],angles:[]};if(this.trackAttributes){var d;c.attributes={};for(var e=0,f=this.trackAttributes.length;f>e;++e)d=this.trackAttributes[e],c.attributes[d]=[],d in this.readers.kml||(this.readers.kml[d]=this.readers.kml._trackPointAttribute)}if(this.readChildNodes(a,c),c.whens.length!==c.points.length)throw new Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:coord ("+c.points.length+") elements.");var g=c.angles.length>0;if(g&&c.whens.length!==c.angles.length)throw new Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:angles ("+c.angles.length+") elements.");for(var h,i,j,e=0,f=c.whens.length;f>e;++e){if(h=b.feature.clone(),h.fid=b.feature.fid||b.feature.id,i=c.points[e],h.geometry=i,"z"in i&&(h.attributes.altitude=i.z),this.internalProjection&&this.externalProjection&&h.geometry.transform(this.externalProjection,this.internalProjection),this.trackAttributes)for(var k=0,l=this.trackAttributes.length;l>k;++k){var d=this.trackAttributes[k];h.attributes[d]=c.attributes[d][e]}h.attributes.when=c.whens[e],h.attributes.trackId=b.feature.id,g&&(j=c.angles[e],h.attributes.heading=parseFloat(j[0]),h.attributes.tilt=parseFloat(j[1]),h.attributes.roll=parseFloat(j[2])),b.features.push(h)}},coord:function(a,b){var c=this.getChildValue(a),d=c.replace(this.regExes.trimSpace,"").split(/\s+/),e=new Tmap.Geometry.Point(d[0],d[1]);d.length>2&&(e.z=parseFloat(d[2])),b.points.push(e)},angles:function(a,b){var c=this.getChildValue(a),d=c.replace(this.regExes.trimSpace,"").split(/\s+/);b.angles.push(d)}}},parseFeature:function(a){for(var b,c,d,e,f=["MultiGeometry","Polygon","LineString","Point"],g=0,h=f.length;h>g;++g)if(b=f[g],this.internalns=a.namespaceURI?a.namespaceURI:this.kmlns,c=this.getElementsByTagNameNS(a,this.internalns,b),c.length>0){var e=this.parseGeometry[b.toLowerCase()];if(!e)throw new TypeError("Unsupported geometry type: "+b);d=e.apply(this,[c[0]]),this.internalProjection&&this.externalProjection&&d.transform(this.externalProjection,this.internalProjection);break}var i;this.extractAttributes&&(i=this.parseAttributes(a));var j=new Tmap.Feature.Vector(d,i),k=a.getAttribute("id")||a.getAttribute("name");return null!=k&&(j.fid=k),j},parseTrafficCheck:function(node){var type="LineString";var nodeList,geometry,parser,traffic,trafficString,trafficcoords;this.internalns=node.namespaceURI?node.namespaceURI:this.kmlns;nodeList=this.getElementsByTagNameNS(node,this.internalns,type);if(nodeList.length>0){var parser=this.parseGeometry["trafficlinestring"];if(parser){nodeList[0].traffic=node.trafficData;geometry=parser.apply(this,[nodeList[0]]);if(this.internalProjection&&this.externalProjection){geometry.transform(this.externalProjection,this.internalProjection)}}else{throw new TypeError("Unsupported geometry type: "+type);}}var attributes;if(this.extractAttributes){attributes=this.parseAttributes(node)}var feature=new Tmap.Feature.Vector(geometry,attributes);var fid=node.getAttribute("id")||node.getAttribute("name");if(fid!=null){feature.fid=fid}if(traffic!=null){feature.traffic=trafficString}return feature},parseTrafficFeature:function(node){var order=["MultiGeometry","Polygon","LineString","Point"];var type,nodeList,geometry,parser,traffic;for(var i=0,len=order.length;i<len;++i){type=order[i];this.internalns=node.namespaceURI?node.namespaceURI:this.kmlns;nodeList=this.getElementsByTagNameNS(node,this.internalns,type);if(nodeList.length>0){var parser=this.parseGeometry[type.toLowerCase()];if(parser){geometry=parser.apply(this,[nodeList[0]]);traffic=this.getElementsByTagNameNS(node,this.internalns,"traffic");if(traffic.length>0&&traffic[0].firstChild!=null){var trafficString=traffic[0].firstChild.nodeValue}if(this.internalProjection&&this.externalProjection){geometry.transform(this.externalProjection,this.internalProjection)}}else{throw new TypeError("Unsupported geometry type: "+type);}break}}var attributes;if(this.extractAttributes){attributes=this.parseAttributes(node)}var feature=new Tmap.Feature.Vector(geometry,attributes);var fid=node.getAttribute("id")||node.getAttribute("name");if(fid!=null){feature.fid=fid}if(traffic!=null){feature.traffic=trafficString}return feature},getStyle:function(a,b){var c=Tmap.Util.removeTail(a),d=Tmap.Util.extend({},b);if(d.depth++,d.styleBaseUrl=c,!this.styles[a]&&!Tmap.String.startsWith(a,"#")&&d.depth<=this.maxDepth&&!this.fetched[c]){var e=this.fetchLink(c);e&&this.parseData(e,d)}var f=Tmap.Util.extend({},this.styles[a]);return f},parseGeometry:{point:function(a){var b=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),c=[];if(b.length>0){var d=b[0].firstChild.nodeValue;d=d.replace(this.regExes.removeSpace,""),c=d.split(",")}var e=null;if(!(c.length>1))throw"Bad coordinate string: "+d;return 2==c.length&&(c[2]=null),e=new Tmap.Geometry.Point(c[0],c[1],c[2])},trafficlinestring:function(node){var nodeList=this.getElementsByTagNameNS(node,this.internalns,"coordinates");var line=null;var nodetraffic=node.traffic;if(nodeList.length>0){var coordString=this.getChildValue(nodeList[0]);coordString=coordString.replace(this.regExes.trimSpace,"");coordString=coordString.replace(this.regExes.trimComma,",");var pointList=coordString.split(this.regExes.splitSpace);var numPoints=pointList.length;var points=new Array(numPoints);var coords,numCoords;var trafficList=nodetraffic.split(",");var startcnt=parseInt(trafficList[0]);var endcnt=parseInt(trafficList[1]);for(var i=startcnt;i<endcnt+1;++i){coords=pointList[i].split(",");numCoords=coords.length;if(numCoords>1){if(coords.length==2){coords[2]=null}points[i]=new Tmap.Geometry.Point(coords[0],coords[1],coords[2])}else{throw"Bad LineString point coordinates: "+pointList[i];}}if(numPoints){line=new Tmap.Geometry.LineString(points)}else{throw"Bad LineString coordinates: "+coordString;}}return line},linestring:function(a,b){var c=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),d=null;if(c.length>0){var e=this.getChildValue(c[0]);e=e.replace(this.regExes.trimSpace,""),e=e.replace(this.regExes.trimComma,",");for(var f,g,h=e.split(this.regExes.splitSpace),i=h.length,j=new Array(i),k=0;i>k;++k){if(f=h[k].split(","),g=f.length,!(g>1))throw"Bad LineString point coordinates: "+h[k];2==f.length&&(f[2]=null),j[k]=new Tmap.Geometry.Point(f[0],f[1],f[2])}if(!i)throw"Bad LineString coordinates: "+e;d=b?new Tmap.Geometry.LinearRing(j):new Tmap.Geometry.LineString(j)}return d},polygon:function(a){var b=this.getElementsByTagNameNS(a,this.internalns,"LinearRing"),c=b.length,d=new Array(c);if(c>0)for(var e,f=0,g=b.length;g>f;++f){if(e=this.parseGeometry.linestring.apply(this,[b[f],!0]),!e)throw"Bad LinearRing geometry: "+f;d[f]=e}return new Tmap.Geometry.Polygon(d)},multigeometry:function(a){for(var b,c,d=[],e=a.childNodes,f=0,g=e.length;g>f;++f)if(b=e[f],1==b.nodeType){var h=b.prefix?b.nodeName.split(":")[1]:b.nodeName,c=this.parseGeometry[h.toLowerCase()];c&&d.push(c.apply(this,[b]))}return new Tmap.Geometry.Collection(d)}},parseAttributes:function(a){var b={},c=a.getElementsByTagName("ExtendedData");c.length&&(b=this.parseExtendedData(c[0]));for(var d,e,f,g=a.childNodes,h=0,i=g.length;i>h;++h)if(d=g[h],1==d.nodeType&&(e=d.childNodes,e.length>=1&&e.length<=3)){var f;switch(e.length){case 1:f=e[0];break;case 2:var j=e[0],k=e[1];f=3==j.nodeType||4==j.nodeType?j:k;break;case 3:default:f=e[1]}if(3==f.nodeType||4==f.nodeType){var l=d.prefix?d.nodeName.split(":")[1]:d.nodeName,m=Tmap.Util.getXmlNodeValue(f);m&&(m=m.replace(this.regExes.trimSpace,""),b[l]=m)}}return b},parseExtendedData:function(a){var b,c,d,e,f={},g=a.getElementsByTagName("Data");for(b=0,c=g.length;c>b;b++){d=g[b],e=d.getAttribute("name");var h={},i=d.getElementsByTagName("value");if(i.length&&(h.value=this.getChildValue(i[0])),this.kvpAttributes)f[e]=h.value;else{var j=d.getElementsByTagName("displayName");j.length&&(h.displayName=this.getChildValue(j[0])),f[e]=h}}var k=a.getElementsByTagName("SimpleData");for(b=0,c=k.length;c>b;b++){var h={};d=k[b],e=d.getAttribute("name"),h.value=this.getChildValue(d),this.kvpAttributes?f[e]=h.value:(h.displayName=e,f[e]=h)}return f},parseProperty:function(a,b,c){var d,e=this.getElementsByTagNameNS(a,b,c);try{d=Tmap.Util.getXmlNodeValue(e[0])}catch(f){d=null}return d},write:function(a){Tmap.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS(this.kmlns,"kml"),c=this.createFolderXML(),d=0,e=a.length;e>d;++d)c.appendChild(this.createPlacemarkXML(a[d]));return b.appendChild(c),Tmap.Format.XML.prototype.write.apply(this,[b])},createFolderXML:function(){var a=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var b=this.createElementNS(this.kmlns,"name"),c=this.createTextNode(this.foldersName);b.appendChild(c),a.appendChild(b)}if(this.foldersDesc){var d=this.createElementNS(this.kmlns,"description"),e=this.createTextNode(this.foldersDesc);d.appendChild(e),a.appendChild(d)}return a},createPlacemarkXML:function(a){var b=this.createElementNS(this.kmlns,"name"),c=a.style&&a.style.label?a.style.label:a.id,d=a.attributes.name||c;b.appendChild(this.createTextNode(d));var e=this.createElementNS(this.kmlns,"description"),f=a.attributes.description||this.placemarksDesc;e.appendChild(this.createTextNode(f));var g=this.createElementNS(this.kmlns,"Placemark");null!=a.fid&&g.setAttribute("id",a.fid),g.appendChild(b),g.appendChild(e);var h=this.buildGeometryNode(a.geometry);if(g.appendChild(h),a.attributes){var i=this.buildExtendedData(a.attributes);i&&g.appendChild(i)}return g},buildGeometryNode:function(a){var b=a.CLASS_NAME,c=b.substring(b.lastIndexOf(".")+1),d=this.buildGeometry[c.toLowerCase()],e=null;return d&&(e=d.apply(this,[a])),e},buildGeometry:{point:function(a){var b=this.createElementNS(this.kmlns,"Point");return b.appendChild(this.buildCoordinatesNode(a)),b},multipoint:function(a){return this.buildGeometry.collection.apply(this,[a])},linestring:function(a){var b=this.createElementNS(this.kmlns,"LineString");return b.appendChild(this.buildCoordinatesNode(a)),b},multilinestring:function(a){return this.buildGeometry.collection.apply(this,[a])},linearring:function(a){var b=this.createElementNS(this.kmlns,"LinearRing");return b.appendChild(this.buildCoordinatesNode(a)),b},polygon:function(a){for(var b,c,d,e=this.createElementNS(this.kmlns,"Polygon"),f=a.components,g=0,h=f.length;h>g;++g)d=0==g?"outerBoundaryIs":"innerBoundaryIs",b=this.createElementNS(this.kmlns,d),c=this.buildGeometry.linearring.apply(this,[f[g]]),b.appendChild(c),e.appendChild(b);return e},multipolygon:function(a){return this.buildGeometry.collection.apply(this,[a])},collection:function(a){for(var b,c=this.createElementNS(this.kmlns,"MultiGeometry"),d=0,e=a.components.length;e>d;++d)b=this.buildGeometryNode.apply(this,[a.components[d]]),b&&c.appendChild(b);return c}},buildCoordinatesNode:function(a){var b,c=this.createElementNS(this.kmlns,"coordinates"),d=a.components;if(d){for(var e,f=d.length,g=new Array(f),h=0;f>h;++h)e=d[h],g[h]=this.buildCoordinates(e);b=g.join(" ")}else b=this.buildCoordinates(a);var i=this.createTextNode(b);return c.appendChild(i),c},buildCoordinates:function(a){return this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection)),a.x+","+a.y},buildExtendedData:function(a){var b=this.createElementNS(this.kmlns,"ExtendedData");for(var c in a)if(a[c]&&"name"!=c&&"description"!=c&&"styleUrl"!=c){var d=this.createElementNS(this.kmlns,"Data");d.setAttribute("name",c);var e=this.createElementNS(this.kmlns,"value");if("object"==typeof a[c]){if(a[c].value&&e.appendChild(this.createTextNode(a[c].value)),a[c].displayName){var f=this.createElementNS(this.kmlns,"displayName");f.appendChild(this.getXMLDoc().createCDATASection(a[c].displayName)),d.appendChild(f)}}else e.appendChild(this.createTextNode(a[c]));d.appendChild(e),b.appendChild(d)}return this.isSimpleContent(b)?null:b},CLASS_NAME:"Tmap.Format.KML"}),Tmap.Format.Filter=Tmap.Class(Tmap.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"Tmap.Format.Filter"}),Tmap.Format.Filter.v1=Tmap.Class(Tmap.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(a){Tmap.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b={};return this.readers.ogc.Filter.apply(this,[a,b]),b.filter},readers:{ogc:{_expression:function(a){for(var b,c="",d=a.firstChild;d;d=d.nextSibling)switch(d.nodeType){case 1:b=this.readNode(d),b.property?c+="${"+b.property+"}":void 0!==b.value&&(c+=b.value);break;case 3:case 4:c+=d.nodeValue}return c},Filter:function(a,b){var c={fids:[],filters:[]};this.readChildNodes(a,c),c.fids.length>0?b.filter=new Tmap.Filter.FeatureId({fids:c.fids}):c.filters.length>0&&(b.filter=c.filters[0])},FeatureId:function(a,b){var c=a.getAttribute("fid");c&&b.fids.push(c)},And:function(a,b){var c=new Tmap.Filter.Logical({type:Tmap.Filter.Logical.AND});this.readChildNodes(a,c),b.filters.push(c)},Or:function(a,b){var c=new Tmap.Filter.Logical({type:Tmap.Filter.Logical.OR});this.readChildNodes(a,c),b.filters.push(c)},Not:function(a,b){var c=new Tmap.Filter.Logical({type:Tmap.Filter.Logical.NOT});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsLessThan:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.LESS_THAN});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsGreaterThan:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.GREATER_THAN});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsLessThanOrEqualTo:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsGreaterThanOrEqualTo:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsBetween:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.BETWEEN});this.readChildNodes(a,c),b.filters.push(c)},Literal:function(a,b){b.value=Tmap.String.numericIf(this.getChildValue(a),!0)},PropertyName:function(a,b){b.property=this.getChildValue(a)},LowerBoundary:function(a,b){b.lowerBoundary=Tmap.String.numericIf(this.readers.ogc._expression.call(this,a),!0)},UpperBoundary:function(a,b){b.upperBoundary=Tmap.String.numericIf(this.readers.ogc._expression.call(this,a),!0)},Intersects:function(a,b){this.readSpatial(a,b,Tmap.Filter.Spatial.INTERSECTS)},Within:function(a,b){this.readSpatial(a,b,Tmap.Filter.Spatial.WITHIN)},Contains:function(a,b){this.readSpatial(a,b,Tmap.Filter.Spatial.CONTAINS)},DWithin:function(a,b){this.readSpatial(a,b,Tmap.Filter.Spatial.DWITHIN)},Distance:function(a,b){b.distance=parseInt(this.getChildValue(a)),b.distanceUnits=a.getAttribute("units")},Function:function(a,b){},PropertyIsNull:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.IS_NULL});this.readChildNodes(a,c),b.filters.push(c)}}},readSpatial:function(a,b,c){var d=new Tmap.Filter.Spatial({type:c});this.readChildNodes(a,d),d.value=d.components[0],delete d.components,b.filters.push(d)},encodeLiteral:function(a){return a instanceof Date&&(a=Tmap.Date.toISOString(a)),a},writeOgcExpression:function(a,b){return a instanceof Tmap.Filter.Function?this.writeNode("Function",a,b):this.writeNode("Literal",a,b),b},write:function(a){return this.writers.ogc.Filter.apply(this,[a])},writers:{ogc:{Filter:function(a){var b=this.createElementNSPlus("ogc:Filter");return this.writeNode(this.getFilterType(a),a,b),b},_featureIds:function(a){for(var b=this.createDocumentFragment(),c=0,d=a.fids.length;d>c;++c)this.writeNode("ogc:FeatureId",a.fids[c],b);return b},FeatureId:function(a){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:a}})},And:function(a){for(var b,c=this.createElementNSPlus("ogc:And"),d=0,e=a.filters.length;e>d;++d)b=a.filters[d],this.writeNode(this.getFilterType(b),b,c);return c},Or:function(a){for(var b,c=this.createElementNSPlus("ogc:Or"),d=0,e=a.filters.length;e>d;++d)b=a.filters[d],this.writeNode(this.getFilterType(b),b,c);return c},Not:function(a){var b=this.createElementNSPlus("ogc:Not"),c=a.filters[0];return this.writeNode(this.getFilterType(c),c,b),b},PropertyIsLessThan:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThan");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsGreaterThan:function(a){var b=this.createElementNSPlus("ogc:PropertyIsGreaterThan");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsLessThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsGreaterThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsBetween:function(a){var b=this.createElementNSPlus("ogc:PropertyIsBetween");return this.writeNode("PropertyName",a,b),this.writeNode("LowerBoundary",a,b),this.writeNode("UpperBoundary",a,b),b},PropertyName:function(a){return this.createElementNSPlus("ogc:PropertyName",{value:a.property})},Literal:function(a){var b=this.encodeLiteral||Tmap.Format.Filter.v1.prototype.encodeLiteral;return this.createElementNSPlus("ogc:Literal",{value:b(a)})},LowerBoundary:function(a){var b=this.createElementNSPlus("ogc:LowerBoundary");return this.writeOgcExpression(a.lowerBoundary,b),b},UpperBoundary:function(a){var b=this.createElementNSPlus("ogc:UpperBoundary");return this.writeNode("Literal",a.upperBoundary,b),b},INTERSECTS:function(a){return this.writeSpatial(a,"Intersects")},WITHIN:function(a){return this.writeSpatial(a,"Within")},CONTAINS:function(a){return this.writeSpatial(a,"Contains")},DWITHIN:function(a){var b=this.writeSpatial(a,"DWithin");return this.writeNode("Distance",a,b),b},Distance:function(a){return this.createElementNSPlus("ogc:Distance",{attributes:{units:a.distanceUnits},value:a.distance})},Function:function(a){for(var b=this.createElementNSPlus("ogc:Function",{attributes:{name:a.name}}),c=a.params,d=0,e=c.length;e>d;d++)this.writeOgcExpression(c[d],b);return b},PropertyIsNull:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNull");return this.writeNode("PropertyName",a,b),b}}},getFilterType:function(a){var b=this.filterMap[a.type];if(!b)throw"Filter writing not supported for rule type: "+a.type;return b},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",NULL:"PropertyIsNull",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"_featureIds"},CLASS_NAME:"Tmap.Format.Filter.v1"}),Tmap.Format.Filter.v1_0_0=Tmap.Class(Tmap.Format.GML.v2,Tmap.Format.Filter.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.0.0/filter.xsd",initialize:function(a){Tmap.Format.GML.v2.prototype.initialize.apply(this,[a])},readers:{ogc:Tmap.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.EQUAL_TO});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsNotEqualTo:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.NOT_EQUAL_TO});this.readChildNodes(a,c),b.filters.push(c)},PropertyIsLike:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escape");c.value2regex(d,e,f),b.filters.push(c)}},Tmap.Format.Filter.v1.prototype.readers.ogc),gml:Tmap.Format.GML.v2.prototype.readers.gml,feature:Tmap.Format.GML.v2.prototype.readers.feature},writers:{ogc:Tmap.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo");return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{wildCard:"*",singleChar:".",escape:"!"}});return this.writeNode("PropertyName",a,b),this.writeNode("Literal",a.regex2value(),b),
b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&&this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Box",a.value,b);return a.projection&&c.setAttribute("srsName",a.projection),b}},Tmap.Format.Filter.v1.prototype.writers.ogc),gml:Tmap.Format.GML.v2.prototype.writers.gml,feature:Tmap.Format.GML.v2.prototype.writers.feature},writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+b);if(this.writeNode("PropertyName",a,c),a.value instanceof Tmap.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof Tmap.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Box",a.value),a.projection&&d.setAttribute("srsName",a.projection),c.appendChild(d)}return c},CLASS_NAME:"Tmap.Format.Filter.v1_0_0"}),Tmap.Format.Filter.v1_1_0=Tmap.Class(Tmap.Format.GML.v3,Tmap.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(a){Tmap.Format.GML.v3.prototype.initialize.apply(this,[a])},readers:{ogc:Tmap.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=a.getAttribute("matchCase"),d=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.EQUAL_TO,matchCase:!("false"===c||"0"===c)});this.readChildNodes(a,d),b.filters.push(d)},PropertyIsNotEqualTo:function(a,b){var c=a.getAttribute("matchCase"),d=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.NOT_EQUAL_TO,matchCase:!("false"===c||"0"===c)});this.readChildNodes(a,d),b.filters.push(d)},PropertyIsLike:function(a,b){var c=new Tmap.Filter.Comparison({type:Tmap.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escapeChar");c.value2regex(d,e,f),b.filters.push(c)}},Tmap.Format.Filter.v1.prototype.readers.ogc),gml:Tmap.Format.GML.v3.prototype.readers.gml,feature:Tmap.Format.GML.v3.prototype.readers.feature},writers:{ogc:Tmap.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:a.matchCase}});return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:a.matchCase}});return this.writeNode("PropertyName",a,b),this.writeOgcExpression(a.value,b),b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:a.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});return this.writeNode("PropertyName",a,b),this.writeNode("Literal",a.regex2value(),b),b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&&this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Envelope",a.value);return a.projection&&c.setAttribute("srsName",a.projection),b.appendChild(c),b},SortBy:function(a){for(var b=this.createElementNSPlus("ogc:SortBy"),c=0,d=a.length;d>c;c++)this.writeNode("ogc:SortProperty",a[c],b);return b},SortProperty:function(a){var b=this.createElementNSPlus("ogc:SortProperty");return this.writeNode("ogc:PropertyName",a,b),this.writeNode("ogc:SortOrder","DESC"==a.order?"DESC":"ASC",b),b},SortOrder:function(a){var b=this.createElementNSPlus("ogc:SortOrder",{value:a});return b}},Tmap.Format.Filter.v1.prototype.writers.ogc),gml:Tmap.Format.GML.v3.prototype.writers.gml,feature:Tmap.Format.GML.v3.prototype.writers.feature},writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+b);if(this.writeNode("PropertyName",a,c),a.value instanceof Tmap.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof Tmap.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Envelope",a.value),a.projection&&d.setAttribute("srsName",a.projection),c.appendChild(d)}return c},CLASS_NAME:"Tmap.Format.Filter.v1_1_0"}),Tmap.Format.Text=Tmap.Class(Tmap.Format,{defaultStyle:null,extractStyles:!0,initialize:function(a){a=a||{},a.extractStyles!==!1&&(a.defaultStyle={externalGraphic:Tmap.Util.getImageLocation("marker.png"),graphicWidth:21,graphicHeight:25,graphicXOffset:-10.5,graphicYOffset:-12.5}),Tmap.Format.prototype.initialize.apply(this,[a])},read:function(a){for(var b,c=a.split("\n"),d=[],e=0;e<c.length-1;e++){var f=c[e].replace(/^\s*/,"").replace(/\s*$/,"");if("#"!=f.charAt(0))if(b){for(var g=f.split("	"),h=new Tmap.Geometry.Point(0,0),i={},j=this.defaultStyle?Tmap.Util.applyDefaults({},this.defaultStyle):null,k=!1,l=0;l<g.length;l++)if(g[l])if("point"==b[l]){var m=g[l].split(",");h.y=parseFloat(m[0]),h.x=parseFloat(m[1]),k=!0}else if("lat"==b[l])h.y=parseFloat(g[l]),k=!0;else if("lon"==b[l])h.x=parseFloat(g[l]),k=!0;else if("title"==b[l])i.title=g[l];else if("image"==b[l]||"icon"==b[l]&&j)j.externalGraphic=g[l];else if("iconSize"==b[l]&&j){var n=g[l].split(",");j.graphicWidth=parseFloat(n[0]),j.graphicHeight=parseFloat(n[1])}else if("iconOffset"==b[l]&&j){var o=g[l].split(",");j.graphicXOffset=parseFloat(o[0]),j.graphicYOffset=parseFloat(o[1])}else"description"==b[l]?i.description=g[l]:"overflow"==b[l]?i.overflow=g[l]:i[b[l]]=g[l];if(k){this.internalProjection&&this.externalProjection&&h.transform(this.externalProjection,this.internalProjection);var p=new Tmap.Feature.Vector(h,i,j);d.push(p)}}else b=f.split("	")}return d},CLASS_NAME:"Tmap.Format.Text"}),Tmap.Format.JSON=Tmap.Class(Tmap.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:function(){return!(!window.JSON||"function"!=typeof JSON.parse||"function"!=typeof JSON.stringify)}(),read:function(json,filter){function walk(a,b){if(b&&"object"==typeof b)for(var c in b)b.hasOwnProperty(c)&&(b[c]=walk(c,b[c]));return filter(a,b)}var object;if(this.nativeJSON)object=JSON.parse(json,filter);else try{/^[\],:{}\s]*$/.test(json.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&&(object=eval("("+json+")"),"function"==typeof filter&&(object=walk("",object)))}catch(e){}return this.keepData&&(this.data=object),object},write:function(a,b){this.pretty=!!b;var c=null,d=typeof a;if(this.serialize[d])try{c=!this.pretty&&this.nativeJSON?JSON.stringify(a):this.serialize[d].apply(this,[a])}catch(e){Tmap.Console.error("Trouble serializing: "+e)}return c},writeIndent:function(){var a=[];if(this.pretty)for(var b=0;b<this.level;++b)a.push(this.indent);return a.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(a){if(null==a)return"null";if(a.constructor==Date)return this.serialize.date.apply(this,[a]);if(a.constructor==Array)return this.serialize.array.apply(this,[a]);var b=["{"];this.level+=1;var c,d,e,f=!1;for(c in a)a.hasOwnProperty(c)&&(d=Tmap.Format.JSON.prototype.write.apply(this,[c,this.pretty]),e=Tmap.Format.JSON.prototype.write.apply(this,[a[c],this.pretty]),null!=d&&null!=e&&(f&&b.push(","),b.push(this.writeNewline(),this.writeIndent(),d,":",this.writeSpace(),e),f=!0));return this.level-=1,b.push(this.writeNewline(),this.writeIndent(),"}"),b.join("")},array:function(a){var b,c=["["];this.level+=1;for(var d=0,e=a.length;e>d;++d)b=Tmap.Format.JSON.prototype.write.apply(this,[a[d],this.pretty]),null!=b&&(d>0&&c.push(","),c.push(this.writeNewline(),this.writeIndent(),b));return this.level-=1,c.push(this.writeNewline(),this.writeIndent(),"]"),c.join("")},string:function(a){var b={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,c){var d=b[c];return d?d:(d=c.charCodeAt(),"\\u00"+Math.floor(d/16).toString(16)+(d%16).toString(16))})+'"':'"'+a+'"'},number:function(a){return isFinite(a)?String(a):"null"},"boolean":function(a){return String(a)},date:function(a){function b(a){return 10>a?"0"+a:a}return'"'+a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+'"'}},CLASS_NAME:"Tmap.Format.JSON"}),Tmap.Format.GeoJSON=Tmap.Class(Tmap.Format.JSON,{ignoreExtraDims:!1,read:function(a,b,c){b=b?b:"FeatureCollection";var d=null,e=null;if(e="string"==typeof a?Tmap.Format.JSON.prototype.read.apply(this,[a,c]):a){if("string"!=typeof e.type)Tmap.Console.error("Bad GeoJSON - no type: "+a);else if(this.isValidType(e,b))switch(b){case"Geometry":try{d=this.parseGeometry(e)}catch(f){Tmap.Console.error(f)}break;case"Feature":try{d=this.parseFeature(e),d.type="Feature"}catch(f){Tmap.Console.error(f)}break;case"FeatureCollection":switch(d=[],e.type){case"Feature":try{d.push(this.parseFeature(e))}catch(f){d=null,Tmap.Console.error(f)}break;case"FeatureCollection":for(var g=0,h=e.features.length;h>g;++g)try{d.push(this.parseFeature(e.features[g]))}catch(f){d=null,Tmap.Console.error(f)}break;default:try{var i=this.parseGeometry(e);d.push(new Tmap.Feature.Vector(i))}catch(f){d=null,Tmap.Console.error(f)}}}}else Tmap.Console.error("Bad JSON: "+a);return d},isValidType:function(a,b){var c=!1;switch(b){case"Geometry":-1==Tmap.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],a.type)?Tmap.Console.error("Unsupported geometry type: "+a.type):c=!0;break;case"FeatureCollection":c=!0;break;default:a.type==b?c=!0:Tmap.Console.error("Cannot convert types from "+a.type+" to "+b)}return c},parseFeature:function(a){var b,c,d,e;d=a.properties?a.properties:{},e=a.geometry&&a.geometry.bbox||a.bbox;try{c=this.parseGeometry(a.geometry)}catch(f){throw f}return b=new Tmap.Feature.Vector(c,d),e&&(b.bounds=Tmap.Bounds.fromArray(e)),a.id&&(b.fid=a.id),b},parseGeometry:function(a){if(null==a)return null;var b,c=!1;if("GeometryCollection"==a.type){if(!Tmap.Util.isArray(a.geometries))throw"GeometryCollection must have geometries array: "+a;for(var d=a.geometries.length,e=new Array(d),f=0;d>f;++f)e[f]=this.parseGeometry.apply(this,[a.geometries[f]]);b=new Tmap.Geometry.Collection(e),c=!0}else{if(!Tmap.Util.isArray(a.coordinates))throw"Geometry must have coordinates array: "+a;if(!this.parseCoords[a.type.toLowerCase()])throw"Unsupported geometry type: "+a.type;try{b=this.parseCoords[a.type.toLowerCase()].apply(this,[a.coordinates])}catch(g){throw g}}return this.internalProjection&&this.externalProjection&&!c&&b.transform(this.externalProjection,this.internalProjection),b},parseCoords:{point:function(a){if(0==this.ignoreExtraDims&&2!=a.length)throw"Only 2D points are supported: "+a;return new Tmap.Geometry.Point(a[0],a[1])},multipoint:function(a){for(var b=[],c=null,d=0,e=a.length;e>d;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f}b.push(c)}return new Tmap.Geometry.MultiPoint(b)},linestring:function(a){for(var b=[],c=null,d=0,e=a.length;e>d;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f}b.push(c)}return new Tmap.Geometry.LineString(b)},multilinestring:function(a){for(var b=[],c=null,d=0,e=a.length;e>d;++d){try{c=this.parseCoords.linestring.apply(this,[a[d]])}catch(f){throw f}b.push(c)}return new Tmap.Geometry.MultiLineString(b)},polygon:function(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e){try{c=this.parseCoords.linestring.apply(this,[a[e]])}catch(g){throw g}b=new Tmap.Geometry.LinearRing(c.components),d.push(b)}return new Tmap.Geometry.Polygon(d)},multipolygon:function(a){for(var b=[],c=null,d=0,e=a.length;e>d;++d){try{c=this.parseCoords.polygon.apply(this,[a[d]])}catch(f){throw f}b.push(c)}return new Tmap.Geometry.MultiPolygon(b)},box:function(a){if(2!=a.length)throw"GeoJSON box coordinates must have 2 elements";return new Tmap.Geometry.Polygon([new Tmap.Geometry.LinearRing([new Tmap.Geometry.Point(a[0][0],a[0][1]),new Tmap.Geometry.Point(a[1][0],a[0][1]),new Tmap.Geometry.Point(a[1][0],a[1][1]),new Tmap.Geometry.Point(a[0][0],a[1][1]),new Tmap.Geometry.Point(a[0][0],a[0][1])])])}},write:function(a,b){var c={type:null};if(Tmap.Util.isArray(a)){c.type="FeatureCollection";var d=a.length;c.features=new Array(d);for(var e=0;d>e;++e){var f=a[e];if(!f instanceof Tmap.Feature.Vector){var g="FeatureCollection only supports collections of features: "+f;throw g}c.features[e]=this.extract.feature.apply(this,[f])}}else 0==a.CLASS_NAME.indexOf("Tmap.Geometry")?c=this.extract.geometry.apply(this,[a]):a instanceof Tmap.Feature.Vector&&(c=this.extract.feature.apply(this,[a]),a.layer&&a.layer.projection&&(c.crs=this.createCRSObject(a)));return Tmap.Format.JSON.prototype.write.apply(this,[c,b])},createCRSObject:function(a){var b=a.layer.projection.toString(),c={};if(b.match(/epsg:/i)){var d=parseInt(b.substring(b.indexOf(":")+1));c=4326==d?{type:"name",properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+d}}}return c},extract:{feature:function(a){var b=this.extract.geometry.apply(this,[a.geometry]),c={type:"Feature",properties:a.attributes,geometry:b};return null!=a.fid&&(c.id=a.fid),c},geometry:function(a){if(null==a)return null;this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b,c=a.CLASS_NAME.split(".")[2],d=this.extract[c.toLowerCase()].apply(this,[a]);return b="Collection"==c?{type:"GeometryCollection",geometries:d}:{type:c,coordinates:d}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;d>c;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;d>c;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;d>c;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;d>c;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},multipolygon:function(a){for(var b=[],c=0,d=a.components.length;d>c;++c)b.push(this.extract.polygon.apply(this,[a.components[c]]));return b},collection:function(a){for(var b=a.components.length,c=new Array(b),d=0;b>d;++d)c[d]=this.extract.geometry.apply(this,[a.components[d]]);return c}},CLASS_NAME:"Tmap.Format.GeoJSON"}),Tmap.Format.ReverseLabel=Tmap.Class(Tmap.Format.XML,{namespaces:{xml:"http://www.w3.org/2001/XMLSchema"},nodeValues:{},initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,straightBracket:/\$\[(.*?)\]/g},this.externalProjection=new Tmap.Projection("EPSG:3857"),Tmap.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){return this.nodeValues={},this.parseData(a)},parseData:function(a){"string"==typeof a&&(a=Tmap.Format.XML.prototype.read.apply(this,[a]));for(var b=["id","name","poiLat","poiLon","buildingName","floorName"],c=0,d=b.length;d>c;++c){var e=b[c],f=this.getElementsByTagNameNS(a,"*",e);0!=f.length&&(this.nodeValues[e]=f[0].firstChild.nodeValue)}return this.nodeValues},CLASS_NAME:"Tmap.Format.ReverseLabel"});